<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>OSPFN: bgpd/bgp_packet.h File Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>


</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">OSPFN
   &#160;<span id="projectnumber">1.1</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('bgp__packet_8h.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#define-members">Defines</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">bgpd/bgp_packet.h File Reference</div>  </div>
</div>
<div class="contents">
<div class="textblock"><div class="dynheader">
This graph shows which files directly or indirectly include this file:</div>
<div class="dyncontent">
<div class="center"><img src="bgp__packet_8h__dep__incl.png" border="0" usemap="#bgpd_2bgp__packet_8hdep" alt=""/></div>
<map name="bgpd_2bgp__packet_8hdep" id="bgpd_2bgp__packet_8hdep">
<area shape="rect" id="node3" href="bgp__advertise_8c.html" title="bgpd/bgp_advertise.c" alt="" coords="5,80,160,107"/><area shape="rect" id="node5" href="bgp__attr_8c.html" title="bgpd/bgp_attr.c" alt="" coords="185,80,305,107"/><area shape="rect" id="node7" href="bgp__fsm_8c.html" title="bgpd/bgp_fsm.c" alt="" coords="330,80,451,107"/><area shape="rect" id="node9" href="bgp__open_8c.html" title="bgpd/bgp_open.c" alt="" coords="476,80,607,107"/><area shape="rect" id="node11" href="bgp__packet_8c.html" title="bgpd/bgp_packet.c" alt="" coords="631,80,771,107"/><area shape="rect" id="node13" href="bgp__route_8c.html" title="bgpd/bgp_route.c" alt="" coords="796,80,927,107"/><area shape="rect" id="node15" href="bgpd_8c.html" title="bgpd/bgpd.c" alt="" coords="951,80,1051,107"/></map>
</div>
</div>
<p><a href="bgp__packet_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="define-members"></a>
Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bgp__packet_8h.html#a0ea4158b5023b844b3ef24ae90760d18">BGP_NLRI_LENGTH</a>&#160;&#160;&#160;1U</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bgp__packet_8h.html#ad6c5e016e5a245f6b2c271e930c632cf">BGP_TOTAL_ATTR_LEN</a>&#160;&#160;&#160;2U</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bgp__packet_8h.html#a5f87d076829c52f458d31bbd1b32bacf">BGP_UNFEASIBLE_LEN</a>&#160;&#160;&#160;2U</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bgp__packet_8h.html#a69f0a11991c18cd78e31d458dfb2ec33">BGP_WRITE_PACKET_MAX</a>&#160;&#160;&#160;10U</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bgp__packet_8h.html#aea8b89e482c433839e04fcb2c59f022c">REFRESH_IMMEDIATE</a>&#160;&#160;&#160;1</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bgp__packet_8h.html#a4dc1e6799b406a23e99cfaf8e680df70">REFRESH_DEFER</a>&#160;&#160;&#160;2</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bgp__packet_8h.html#a739d323f7e1d604a5bc1777c99e3a663">ORF_COMMON_PART_ADD</a>&#160;&#160;&#160;0x00</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bgp__packet_8h.html#a15d6c72a4ef5d887b537e19d100f516b">ORF_COMMON_PART_REMOVE</a>&#160;&#160;&#160;0x80</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bgp__packet_8h.html#aaa55ed31dd48f7faf00c0f0b83740c05">ORF_COMMON_PART_REMOVE_ALL</a>&#160;&#160;&#160;0xC0</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bgp__packet_8h.html#aa62477116e8caf3e21fb37a789cd03a9">ORF_COMMON_PART_PERMIT</a>&#160;&#160;&#160;0x00</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bgp__packet_8h.html#ad4dae47ed99f26afef0dbdbee312094e">ORF_COMMON_PART_DENY</a>&#160;&#160;&#160;0x20</td></tr>
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bgp__packet_8h.html#adbe52245bb6b37108b50cfc04ac7d5f7">bgp_read</a> (struct <a class="el" href="structthread.html">thread</a> *)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bgp__packet_8h.html#a013cbe8fe89b4ea4ec6c0712c66a6f8b">bgp_write</a> (struct <a class="el" href="structthread.html">thread</a> *)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bgp__packet_8h.html#a1883265fe49e8119b3ae22e199cf4e47">bgp_keepalive_send</a> (struct <a class="el" href="structpeer.html">peer</a> *)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bgp__packet_8h.html#a326ef30c2b162a786eec36bdc4f95d1f">bgp_open_send</a> (struct <a class="el" href="structpeer.html">peer</a> *)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bgp__packet_8h.html#adab4d4fe710a9ee5d157396355aa6df3">bgp_notify_send</a> (struct <a class="el" href="structpeer.html">peer</a> *, u_int8_t, u_int8_t)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bgp__packet_8h.html#a470d13ca4aa789d5edca71efbc4ad83a">bgp_notify_send_with_data</a> (struct <a class="el" href="structpeer.html">peer</a> *, u_int8_t, u_int8_t, u_int8_t *, size_t)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bgp__packet_8h.html#a870a5d11961cbf10e87da7aad659b956">bgp_route_refresh_send</a> (struct <a class="el" href="structpeer.html">peer</a> *, <a class="el" href="zebra_8h.html#a0a34f9bd6bbc49876614d274005c6ff1">afi_t</a>, <a class="el" href="zebra_8h.html#a195af4129e055b63a1b67529674bb998">safi_t</a>, u_char, u_char, int)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bgp__packet_8h.html#aef3f231f3119b455ce617b22743365d3">bgp_capability_send</a> (struct <a class="el" href="structpeer.html">peer</a> *, <a class="el" href="zebra_8h.html#a0a34f9bd6bbc49876614d274005c6ff1">afi_t</a>, <a class="el" href="zebra_8h.html#a195af4129e055b63a1b67529674bb998">safi_t</a>, int, int)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bgp__packet_8h.html#a2b4a8721996b1474ea60e02670db19da">bgp_default_update_send</a> (struct <a class="el" href="structpeer.html">peer</a> *, struct <a class="el" href="structattr.html">attr</a> *, <a class="el" href="zebra_8h.html#a0a34f9bd6bbc49876614d274005c6ff1">afi_t</a>, <a class="el" href="zebra_8h.html#a195af4129e055b63a1b67529674bb998">safi_t</a>, struct <a class="el" href="structpeer.html">peer</a> *)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bgp__packet_8h.html#aed5ce3f1b8569b363df083eb01b3a961">bgp_default_withdraw_send</a> (struct <a class="el" href="structpeer.html">peer</a> *, <a class="el" href="zebra_8h.html#a0a34f9bd6bbc49876614d274005c6ff1">afi_t</a>, <a class="el" href="zebra_8h.html#a195af4129e055b63a1b67529674bb998">safi_t</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bgp__packet_8h.html#a4415e92559b00c48e22ac0fe77bdce10">bgp_capability_receive</a> (struct <a class="el" href="structpeer.html">peer</a> *, <a class="el" href="bgpd_8h.html#ae2ac1a1db99d420f5a214c418552fd1e">bgp_size_t</a>)</td></tr>
</table>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="a0ea4158b5023b844b3ef24ae90760d18"></a><!-- doxytag: member="bgp_packet.h::BGP_NLRI_LENGTH" ref="a0ea4158b5023b844b3ef24ae90760d18" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define BGP_NLRI_LENGTH&#160;&#160;&#160;1U</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="bgp__packet_8h_source.html#l00024">24</a> of file <a class="el" href="bgp__packet_8h_source.html">bgp_packet.h</a>.</p>

</div>
</div>
<a class="anchor" id="ad6c5e016e5a245f6b2c271e930c632cf"></a><!-- doxytag: member="bgp_packet.h::BGP_TOTAL_ATTR_LEN" ref="ad6c5e016e5a245f6b2c271e930c632cf" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define BGP_TOTAL_ATTR_LEN&#160;&#160;&#160;2U</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="bgp__packet_8h_source.html#l00025">25</a> of file <a class="el" href="bgp__packet_8h_source.html">bgp_packet.h</a>.</p>

</div>
</div>
<a class="anchor" id="a5f87d076829c52f458d31bbd1b32bacf"></a><!-- doxytag: member="bgp_packet.h::BGP_UNFEASIBLE_LEN" ref="a5f87d076829c52f458d31bbd1b32bacf" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define BGP_UNFEASIBLE_LEN&#160;&#160;&#160;2U</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="bgp__packet_8h_source.html#l00026">26</a> of file <a class="el" href="bgp__packet_8h_source.html">bgp_packet.h</a>.</p>

</div>
</div>
<a class="anchor" id="a69f0a11991c18cd78e31d458dfb2ec33"></a><!-- doxytag: member="bgp_packet.h::BGP_WRITE_PACKET_MAX" ref="a69f0a11991c18cd78e31d458dfb2ec33" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define BGP_WRITE_PACKET_MAX&#160;&#160;&#160;10U</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="bgp__packet_8h_source.html#l00027">27</a> of file <a class="el" href="bgp__packet_8h_source.html">bgp_packet.h</a>.</p>

</div>
</div>
<a class="anchor" id="a739d323f7e1d604a5bc1777c99e3a663"></a><!-- doxytag: member="bgp_packet.h::ORF_COMMON_PART_ADD" ref="a739d323f7e1d604a5bc1777c99e3a663" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define ORF_COMMON_PART_ADD&#160;&#160;&#160;0x00</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="bgp__packet_8h_source.html#l00034">34</a> of file <a class="el" href="bgp__packet_8h_source.html">bgp_packet.h</a>.</p>

</div>
</div>
<a class="anchor" id="ad4dae47ed99f26afef0dbdbee312094e"></a><!-- doxytag: member="bgp_packet.h::ORF_COMMON_PART_DENY" ref="ad4dae47ed99f26afef0dbdbee312094e" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define ORF_COMMON_PART_DENY&#160;&#160;&#160;0x20</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="bgp__packet_8h_source.html#l00038">38</a> of file <a class="el" href="bgp__packet_8h_source.html">bgp_packet.h</a>.</p>

</div>
</div>
<a class="anchor" id="aa62477116e8caf3e21fb37a789cd03a9"></a><!-- doxytag: member="bgp_packet.h::ORF_COMMON_PART_PERMIT" ref="aa62477116e8caf3e21fb37a789cd03a9" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define ORF_COMMON_PART_PERMIT&#160;&#160;&#160;0x00</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="bgp__packet_8h_source.html#l00037">37</a> of file <a class="el" href="bgp__packet_8h_source.html">bgp_packet.h</a>.</p>

</div>
</div>
<a class="anchor" id="a15d6c72a4ef5d887b537e19d100f516b"></a><!-- doxytag: member="bgp_packet.h::ORF_COMMON_PART_REMOVE" ref="a15d6c72a4ef5d887b537e19d100f516b" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define ORF_COMMON_PART_REMOVE&#160;&#160;&#160;0x80</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="bgp__packet_8h_source.html#l00035">35</a> of file <a class="el" href="bgp__packet_8h_source.html">bgp_packet.h</a>.</p>

</div>
</div>
<a class="anchor" id="aaa55ed31dd48f7faf00c0f0b83740c05"></a><!-- doxytag: member="bgp_packet.h::ORF_COMMON_PART_REMOVE_ALL" ref="aaa55ed31dd48f7faf00c0f0b83740c05" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define ORF_COMMON_PART_REMOVE_ALL&#160;&#160;&#160;0xC0</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="bgp__packet_8h_source.html#l00036">36</a> of file <a class="el" href="bgp__packet_8h_source.html">bgp_packet.h</a>.</p>

</div>
</div>
<a class="anchor" id="a4dc1e6799b406a23e99cfaf8e680df70"></a><!-- doxytag: member="bgp_packet.h::REFRESH_DEFER" ref="a4dc1e6799b406a23e99cfaf8e680df70" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define REFRESH_DEFER&#160;&#160;&#160;2</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="bgp__packet_8h_source.html#l00031">31</a> of file <a class="el" href="bgp__packet_8h_source.html">bgp_packet.h</a>.</p>

</div>
</div>
<a class="anchor" id="aea8b89e482c433839e04fcb2c59f022c"></a><!-- doxytag: member="bgp_packet.h::REFRESH_IMMEDIATE" ref="aea8b89e482c433839e04fcb2c59f022c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define REFRESH_IMMEDIATE&#160;&#160;&#160;1</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="bgp__packet_8h_source.html#l00030">30</a> of file <a class="el" href="bgp__packet_8h_source.html">bgp_packet.h</a>.</p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a4415e92559b00c48e22ac0fe77bdce10"></a><!-- doxytag: member="bgp_packet.h::bgp_capability_receive" ref="a4415e92559b00c48e22ac0fe77bdce10" args="(struct peer *, bgp_size_t)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int bgp_capability_receive </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structpeer.html">peer</a> *&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="bgpd_8h.html#ae2ac1a1db99d420f5a214c418552fd1e">bgp_size_t</a>&#160;</td>
          <td class="paramname">&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="bgp__packet_8c_source.html#l02223">2223</a> of file <a class="el" href="bgp__packet_8c_source.html">bgp_packet.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  u_char *pnt;

  <span class="comment">/* Fetch pointer. */</span>
  pnt = <a class="code" href="stream_8c.html#ad176a69ba2571f53673903a3429da3b6">stream_pnt</a> (<a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#ad56414663c798719e3a10e6c62a37003">ibuf</a>);

  <span class="keywordflow">if</span> (<a class="code" href="bgp__debug_8h.html#a3652951eb4451c498ae4be9890d4b7a4">BGP_DEBUG</a> (normal, NORMAL))
    <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;%s rcv CAPABILITY&quot;</span>, <a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#ac3e4ca25642ebcc52b2d4b2143fa74fa">host</a>);

  <span class="comment">/* If peer does not have the capability, send notification. */</span>
  <span class="keywordflow">if</span> (! <a class="code" href="zebra_8h.html#a9310812ac92febfb7d1eb10127aea1a8">CHECK_FLAG</a> (<a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#a64eadd546a8c50dfe6a6dcb635c3822d">cap</a>, <a class="code" href="bgpd_8h.html#a3836f3a28c34e009bf7c06d7ea751686">PEER_CAP_DYNAMIC_ADV</a>))
    {
      <a class="code" href="log_8h.html#a4dac9f1d742f56610c76fb86e160a28f">plog_err</a> (<a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#a8042cd53718885196f47ee66b471ec3d">log</a>, <span class="stringliteral">&quot;%s [Error] BGP dynamic capability is not enabled&quot;</span>,
        <a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#ac3e4ca25642ebcc52b2d4b2143fa74fa">host</a>);
      <a class="code" href="bgp__packet_8c.html#ac17989ee6afabce09c9d326fbbf6607b">bgp_notify_send</a> (<a class="code" href="structpeer.html">peer</a>,
               <a class="code" href="bgpd_8h.html#a8a435e0e2033f183fcd82cfe4ed59443">BGP_NOTIFY_HEADER_ERR</a>,
               <a class="code" href="bgpd_8h.html#a61d92861d20bda6984fa61f01a59fb16">BGP_NOTIFY_HEADER_BAD_MESTYPE</a>);
      <span class="keywordflow">return</span> -1;
    }

  <span class="comment">/* Status must be Established. */</span>
  <span class="keywordflow">if</span> (<a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#ae39d16f69d65fec0f4f1908b4a33e6c6">status</a> != <a class="code" href="bgpd_8h.html#aa87809ec7dea97b0e970e98ae6c181ea">Established</a>)
    {
      <a class="code" href="log_8h.html#a4dac9f1d742f56610c76fb86e160a28f">plog_err</a> (<a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#a8042cd53718885196f47ee66b471ec3d">log</a>,
        <span class="stringliteral">&quot;%s [Error] Dynamic capability packet received under status %s&quot;</span>, <a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#ac3e4ca25642ebcc52b2d4b2143fa74fa">host</a>, <a class="code" href="log_8h.html#a3a4b1cad85aa6752f39580944e24a868">LOOKUP</a> (<a class="code" href="bgp__debug_8c.html#adfa19d3216f6254be62df3c23e338ad9">bgp_status_msg</a>, <a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#ae39d16f69d65fec0f4f1908b4a33e6c6">status</a>));
      <a class="code" href="bgp__packet_8c.html#ac17989ee6afabce09c9d326fbbf6607b">bgp_notify_send</a> (<a class="code" href="structpeer.html">peer</a>, <a class="code" href="bgpd_8h.html#af56552e5c55a4c8733dfee55beddb2f8">BGP_NOTIFY_FSM_ERR</a>, 0);
      <span class="keywordflow">return</span> -1;
    }

  <span class="comment">/* Parse packet. */</span>
  <span class="keywordflow">return</span> <a class="code" href="bgp__packet_8c.html#a82eb04635adbeab2d9def6dacd24f3b5">bgp_capability_msg_parse</a> (<a class="code" href="structpeer.html">peer</a>, pnt, size);
}
</pre></div>
</div>
</div>
<a class="anchor" id="aef3f231f3119b455ce617b22743365d3"></a><!-- doxytag: member="bgp_packet.h::bgp_capability_send" ref="aef3f231f3119b455ce617b22743365d3" args="(struct peer *, afi_t, safi_t, int, int)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void bgp_capability_send </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structpeer.html">peer</a> *&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="zebra_8h.html#a0a34f9bd6bbc49876614d274005c6ff1">afi_t</a>&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="zebra_8h.html#a195af4129e055b63a1b67529674bb998">safi_t</a>&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname">&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="bgp__packet_8c_source.html#l01022">1022</a> of file <a class="el" href="bgp__packet_8c_source.html">bgp_packet.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keyword">struct </span><a class="code" href="structstream.html">stream</a> *<a class="code" href="spgrid_8c.html#a5d97d3b42a0d6c9ec9a3e56f2616a6a5">s</a>;
  <span class="keyword">struct </span><a class="code" href="structstream.html">stream</a> *packet;
  <span class="keywordtype">int</span> <a class="code" href="isis__pdu_8h.html#a64ed70bbcb4536e2af22a1aaf5209d18">length</a>;

  <span class="comment">/* Adjust safi code. */</span>
  <span class="keywordflow">if</span> (safi == <a class="code" href="zebra_8h.html#aea6a248ae05b01f7ff8faf6d8c8c6c10">SAFI_MPLS_VPN</a>)
    safi = <a class="code" href="bgpd_8h.html#a597e9437c3d1c7d5551d8232a70e89ae">BGP_SAFI_VPNV4</a>;

  s = <a class="code" href="stream_8c.html#a7117cdad9fa5e5ae633e0cf08d047459">stream_new</a> (<a class="code" href="bgpd_8h.html#a87f2b928735fc26743eecf3ff55c065f">BGP_MAX_PACKET_SIZE</a>);

  <span class="comment">/* Make BGP update packet. */</span>
  <a class="code" href="bgp__packet_8c.html#abd97bf221857a76aedb9e136d8271ad2">bgp_packet_set_marker</a> (s, <a class="code" href="bgpd_8h.html#af521d3eb65a5e825d4cfd69e1b558176">BGP_MSG_CAPABILITY</a>);

  <span class="comment">/* Encode MP_EXT capability. */</span>
  <span class="keywordflow">if</span> (capability_code == <a class="code" href="bgp__open_8h.html#af424a8035e635455eb7ca17c86506601">CAPABILITY_CODE_MP</a>)
    {
      <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (s, action);
      <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (s, <a class="code" href="bgp__open_8h.html#af424a8035e635455eb7ca17c86506601">CAPABILITY_CODE_MP</a>);
      <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (s, <a class="code" href="bgp__open_8h.html#ac7fce6558271318759ea5dff7971efcb">CAPABILITY_CODE_MP_LEN</a>);
      <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a> (s, afi);
      <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (s, 0);
      <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (s, safi);

      <span class="keywordflow">if</span> (<a class="code" href="bgp__debug_8h.html#a3652951eb4451c498ae4be9890d4b7a4">BGP_DEBUG</a> (normal, NORMAL))
        <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;%s sending CAPABILITY has %s MP_EXT CAP for afi/safi: %d/%d&quot;</span>,
           <a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#ac3e4ca25642ebcc52b2d4b2143fa74fa">host</a>, action == <a class="code" href="bgp__open_8h.html#abd786897d5906606e48d7815943c8c54">CAPABILITY_ACTION_SET</a> ?
           <span class="stringliteral">&quot;Advertising&quot;</span> : <span class="stringliteral">&quot;Removing&quot;</span>, afi, safi);
    }

  <span class="comment">/* Set packet size. */</span>
  length = <a class="code" href="bgp__packet_8c.html#a7e9932216f445778d1c21dd471a6ef3a">bgp_packet_set_size</a> (s);

  <span class="comment">/* Make real packet. */</span>
  packet = <a class="code" href="stream_8c.html#ad4c81d1449a5c97aa37c0acb4a5c7815">stream_dup</a> (s);
  <a class="code" href="stream_8c.html#ac25ca0f9b32a76b4ea34ecb3c9d62481">stream_free</a> (s);

  <span class="comment">/* Add packet to the peer. */</span>
  <a class="code" href="bgp__packet_8c.html#ac1112a3a8cf02e203843a0beaa7b465f">bgp_packet_add</a> (<a class="code" href="structpeer.html">peer</a>, packet);

  <span class="keywordflow">if</span> (<a class="code" href="bgp__debug_8h.html#a3652951eb4451c498ae4be9890d4b7a4">BGP_DEBUG</a> (normal, NORMAL))
    <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;%s send message type %d, length (incl. header) %d&quot;</span>,
           <a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#ac3e4ca25642ebcc52b2d4b2143fa74fa">host</a>, <a class="code" href="bgpd_8h.html#af521d3eb65a5e825d4cfd69e1b558176">BGP_MSG_CAPABILITY</a>, length);

  <a class="code" href="bgp__fsm_8h.html#a441b8dfef999d79ac1c3e3b9573fe516">BGP_WRITE_ON</a> (<a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#af1b52e357fd1c6aa0bc8360cf57485e4">t_write</a>, <a class="code" href="bgp__packet_8c.html#ad43cdddbeb3aa17bb2aa199409455c1c">bgp_write</a>, <a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#a593c49b1167d88eb2d2900db47eb5d9d">fd</a>);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a2b4a8721996b1474ea60e02670db19da"></a><!-- doxytag: member="bgp_packet.h::bgp_default_update_send" ref="a2b4a8721996b1474ea60e02670db19da" args="(struct peer *, struct attr *, afi_t, safi_t, struct peer *)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void bgp_default_update_send </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structpeer.html">peer</a> *&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structattr.html">attr</a> *&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="zebra_8h.html#a0a34f9bd6bbc49876614d274005c6ff1">afi_t</a>&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="zebra_8h.html#a195af4129e055b63a1b67529674bb998">safi_t</a>&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structpeer.html">peer</a> *&#160;</td>
          <td class="paramname">&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="bgp__packet_8c_source.html#l00360">360</a> of file <a class="el" href="bgp__packet_8c_source.html">bgp_packet.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keyword">struct </span><a class="code" href="structstream.html">stream</a> *<a class="code" href="spgrid_8c.html#a5d97d3b42a0d6c9ec9a3e56f2616a6a5">s</a>;
  <span class="keyword">struct </span><a class="code" href="structstream.html">stream</a> *packet;
  <span class="keyword">struct </span><a class="code" href="structprefix.html">prefix</a> <a class="code" href="spgrid_8c.html#a931bc2aa940ac2a4d1601cf842336926">p</a>;
  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> pos;
  <a class="code" href="bgpd_8h.html#ae2ac1a1db99d420f5a214c418552fd1e">bgp_size_t</a> total_attr_len;
  <span class="keywordtype">char</span> attrstr[BUFSIZ];
  <span class="keywordtype">char</span> buf[BUFSIZ];

  <span class="keywordflow">if</span> (DISABLE_BGP_ANNOUNCE)
    <span class="keywordflow">return</span>;

  <span class="keywordflow">if</span> (afi == <a class="code" href="zebra_8h.html#a192fcc8cbfb7b9d03c6562c48941a4bd">AFI_IP</a>)
    <a class="code" href="prefix_8c.html#a35f57d44562d00baaf5d227d03214786">str2prefix</a> (<span class="stringliteral">&quot;0.0.0.0/0&quot;</span>, &amp;<a class="code" href="spgrid_8c.html#a931bc2aa940ac2a4d1601cf842336926">p</a>);
<span class="preprocessor">#ifdef HAVE_IPV6</span>
<span class="preprocessor"></span>  <span class="keywordflow">else</span> 
    <a class="code" href="prefix_8c.html#a35f57d44562d00baaf5d227d03214786">str2prefix</a> (<span class="stringliteral">&quot;::/0&quot;</span>, &amp;<a class="code" href="spgrid_8c.html#a931bc2aa940ac2a4d1601cf842336926">p</a>);
<span class="preprocessor">#endif </span><span class="comment">/* HAVE_IPV6 */</span>

  <span class="comment">/* Logging the attribute. */</span>
  <span class="keywordflow">if</span> (<a class="code" href="bgp__debug_8h.html#a3652951eb4451c498ae4be9890d4b7a4">BGP_DEBUG</a> (update, UPDATE_OUT))
    {
      <a class="code" href="bgp__debug_8c.html#a32d8ae5f48b2bf76b0a7c13182b2943f">bgp_dump_attr</a> (<a class="code" href="structpeer.html">peer</a>, <a class="code" href="structattr.html">attr</a>, attrstr, BUFSIZ);
      <a class="code" href="log_8c.html#a34f80af784b8ec394e7a7154a7ec7364">zlog</a> (<a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#a8042cd53718885196f47ee66b471ec3d">log</a>, LOG_DEBUG, <span class="stringliteral">&quot;%s send UPDATE %s/%d %s&quot;</span>,
        <a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#ac3e4ca25642ebcc52b2d4b2143fa74fa">host</a>, <a class="code" href="sockunion_8c.html#a5bfb767e8fa3f9ff5d2a1e19d71791f4">inet_ntop</a>(<a class="code" href="spgrid_8c.html#a931bc2aa940ac2a4d1601cf842336926">p</a>.family, &amp;(<a class="code" href="spgrid_8c.html#a931bc2aa940ac2a4d1601cf842336926">p</a>.u.prefix), buf, BUFSIZ),
        <a class="code" href="spgrid_8c.html#a931bc2aa940ac2a4d1601cf842336926">p</a>.prefixlen, attrstr);
    }

  s = <a class="code" href="stream_8c.html#a7117cdad9fa5e5ae633e0cf08d047459">stream_new</a> (<a class="code" href="bgpd_8h.html#a87f2b928735fc26743eecf3ff55c065f">BGP_MAX_PACKET_SIZE</a>);

  <span class="comment">/* Make BGP update packet. */</span>
  <a class="code" href="bgp__packet_8c.html#abd97bf221857a76aedb9e136d8271ad2">bgp_packet_set_marker</a> (s, <a class="code" href="bgpd_8h.html#a295372f9038c0a36cb9622d5d7f5ff7e">BGP_MSG_UPDATE</a>);

  <span class="comment">/* Unfeasible Routes Length. */</span>
  <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a> (s, 0);

  <span class="comment">/* Make place for total attribute length.  */</span>
  pos = <a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (s);
  <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a> (s, 0);
  total_attr_len = <a class="code" href="bgp__attr_8c.html#afa6f3d227d043fc17b75503ec1b840f6">bgp_packet_attribute</a> (<a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="structpeer.html">peer</a>, s, <a class="code" href="structattr.html">attr</a>, &amp;<a class="code" href="spgrid_8c.html#a931bc2aa940ac2a4d1601cf842336926">p</a>, afi, safi, from, <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);

  <span class="comment">/* Set Total Path Attribute Length. */</span>
  <a class="code" href="stream_8c.html#a41de70a7383bac6220b787d740c0b261">stream_putw_at</a> (s, pos, total_attr_len);

  <span class="comment">/* NLRI set. */</span>
  <span class="keywordflow">if</span> (<a class="code" href="spgrid_8c.html#a931bc2aa940ac2a4d1601cf842336926">p</a>.family == AF_INET &amp;&amp; safi == <a class="code" href="zebra_8h.html#afb8a63d76f4951ff8d73c32256b4a497">SAFI_UNICAST</a>)
    <a class="code" href="bgp__attr_8c.html#a003809094eb7833898bd97bf6da16d3b">stream_put_prefix</a> (s, &amp;<a class="code" href="spgrid_8c.html#a931bc2aa940ac2a4d1601cf842336926">p</a>);

  <span class="comment">/* Set size. */</span>
  <a class="code" href="bgp__packet_8c.html#a7e9932216f445778d1c21dd471a6ef3a">bgp_packet_set_size</a> (s);

  packet = <a class="code" href="stream_8c.html#ad4c81d1449a5c97aa37c0acb4a5c7815">stream_dup</a> (s);
  <a class="code" href="stream_8c.html#ac25ca0f9b32a76b4ea34ecb3c9d62481">stream_free</a> (s);

  <span class="comment">/* Dump packet if debug option is set. */</span>
<span class="preprocessor">#ifdef DEBUG</span>
<span class="preprocessor"></span>  <span class="comment">/* bgp_packet_dump (packet); */</span>
<span class="preprocessor">#endif </span><span class="comment">/* DEBUG */</span>

  <span class="comment">/* Add packet to the peer. */</span>
  <a class="code" href="bgp__packet_8c.html#ac1112a3a8cf02e203843a0beaa7b465f">bgp_packet_add</a> (<a class="code" href="structpeer.html">peer</a>, packet);

  <a class="code" href="bgp__fsm_8h.html#a441b8dfef999d79ac1c3e3b9573fe516">BGP_WRITE_ON</a> (<a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#af1b52e357fd1c6aa0bc8360cf57485e4">t_write</a>, <a class="code" href="bgp__packet_8c.html#ad43cdddbeb3aa17bb2aa199409455c1c">bgp_write</a>, <a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#a593c49b1167d88eb2d2900db47eb5d9d">fd</a>);
}
</pre></div>
</div>
</div>
<a class="anchor" id="aed5ce3f1b8569b363df083eb01b3a961"></a><!-- doxytag: member="bgp_packet.h::bgp_default_withdraw_send" ref="aed5ce3f1b8569b363df083eb01b3a961" args="(struct peer *, afi_t, safi_t)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void bgp_default_withdraw_send </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structpeer.html">peer</a> *&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="zebra_8h.html#a0a34f9bd6bbc49876614d274005c6ff1">afi_t</a>&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="zebra_8h.html#a195af4129e055b63a1b67529674bb998">safi_t</a>&#160;</td>
          <td class="paramname">&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="bgp__packet_8c_source.html#l00428">428</a> of file <a class="el" href="bgp__packet_8c_source.html">bgp_packet.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keyword">struct </span><a class="code" href="structstream.html">stream</a> *<a class="code" href="spgrid_8c.html#a5d97d3b42a0d6c9ec9a3e56f2616a6a5">s</a>;
  <span class="keyword">struct </span><a class="code" href="structstream.html">stream</a> *packet;
  <span class="keyword">struct </span><a class="code" href="structprefix.html">prefix</a> <a class="code" href="spgrid_8c.html#a931bc2aa940ac2a4d1601cf842336926">p</a>;
  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> pos;
  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> cp;
  <a class="code" href="bgpd_8h.html#ae2ac1a1db99d420f5a214c418552fd1e">bgp_size_t</a> unfeasible_len;
  <a class="code" href="bgpd_8h.html#ae2ac1a1db99d420f5a214c418552fd1e">bgp_size_t</a> total_attr_len;
  <span class="keywordtype">char</span> buf[BUFSIZ];

  <span class="keywordflow">if</span> (DISABLE_BGP_ANNOUNCE)
    <span class="keywordflow">return</span>;

  <span class="keywordflow">if</span> (afi == <a class="code" href="zebra_8h.html#a192fcc8cbfb7b9d03c6562c48941a4bd">AFI_IP</a>)
    <a class="code" href="prefix_8c.html#a35f57d44562d00baaf5d227d03214786">str2prefix</a> (<span class="stringliteral">&quot;0.0.0.0/0&quot;</span>, &amp;<a class="code" href="spgrid_8c.html#a931bc2aa940ac2a4d1601cf842336926">p</a>);
<span class="preprocessor">#ifdef HAVE_IPV6</span>
<span class="preprocessor"></span>  <span class="keywordflow">else</span> 
    <a class="code" href="prefix_8c.html#a35f57d44562d00baaf5d227d03214786">str2prefix</a> (<span class="stringliteral">&quot;::/0&quot;</span>, &amp;<a class="code" href="spgrid_8c.html#a931bc2aa940ac2a4d1601cf842336926">p</a>);
<span class="preprocessor">#endif </span><span class="comment">/* HAVE_IPV6 */</span>

  total_attr_len = 0;
  pos = 0;

  <span class="keywordflow">if</span> (<a class="code" href="bgp__debug_8h.html#a3652951eb4451c498ae4be9890d4b7a4">BGP_DEBUG</a> (update, UPDATE_OUT))
    <a class="code" href="log_8c.html#a34f80af784b8ec394e7a7154a7ec7364">zlog</a> (<a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#a8042cd53718885196f47ee66b471ec3d">log</a>, LOG_DEBUG, <span class="stringliteral">&quot;%s send UPDATE %s/%d -- unreachable&quot;</span>,
          <a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#ac3e4ca25642ebcc52b2d4b2143fa74fa">host</a>, <a class="code" href="sockunion_8c.html#a5bfb767e8fa3f9ff5d2a1e19d71791f4">inet_ntop</a>(<a class="code" href="spgrid_8c.html#a931bc2aa940ac2a4d1601cf842336926">p</a>.family, &amp;(<a class="code" href="spgrid_8c.html#a931bc2aa940ac2a4d1601cf842336926">p</a>.u.prefix), buf, BUFSIZ),
          <a class="code" href="spgrid_8c.html#a931bc2aa940ac2a4d1601cf842336926">p</a>.prefixlen);

  s = <a class="code" href="stream_8c.html#a7117cdad9fa5e5ae633e0cf08d047459">stream_new</a> (<a class="code" href="bgpd_8h.html#a87f2b928735fc26743eecf3ff55c065f">BGP_MAX_PACKET_SIZE</a>);

  <span class="comment">/* Make BGP update packet. */</span>
  <a class="code" href="bgp__packet_8c.html#abd97bf221857a76aedb9e136d8271ad2">bgp_packet_set_marker</a> (s, <a class="code" href="bgpd_8h.html#a295372f9038c0a36cb9622d5d7f5ff7e">BGP_MSG_UPDATE</a>);

  <span class="comment">/* Unfeasible Routes Length. */</span>;
  cp = <a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (s);
  <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a> (s, 0);

  <span class="comment">/* Withdrawn Routes. */</span>
  <span class="keywordflow">if</span> (<a class="code" href="spgrid_8c.html#a931bc2aa940ac2a4d1601cf842336926">p</a>.family == AF_INET &amp;&amp; safi == <a class="code" href="zebra_8h.html#afb8a63d76f4951ff8d73c32256b4a497">SAFI_UNICAST</a>)
    {
      <a class="code" href="bgp__attr_8c.html#a003809094eb7833898bd97bf6da16d3b">stream_put_prefix</a> (s, &amp;<a class="code" href="spgrid_8c.html#a931bc2aa940ac2a4d1601cf842336926">p</a>);

      unfeasible_len = <a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (s) - cp - 2;

      <span class="comment">/* Set unfeasible len.  */</span>
      <a class="code" href="stream_8c.html#a41de70a7383bac6220b787d740c0b261">stream_putw_at</a> (s, cp, unfeasible_len);

      <span class="comment">/* Set total path attribute length. */</span>
      <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a> (s, 0);
    }
  <span class="keywordflow">else</span>
    {
      pos = <a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (s);
      <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a> (s, 0);
      total_attr_len = <a class="code" href="bgp__attr_8c.html#a307ab4e45f577239562b43a73ef8f3a3">bgp_packet_withdraw</a> (<a class="code" href="structpeer.html">peer</a>, s, &amp;<a class="code" href="spgrid_8c.html#a931bc2aa940ac2a4d1601cf842336926">p</a>, afi, safi, <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);

      <span class="comment">/* Set total path attribute length. */</span>
      <a class="code" href="stream_8c.html#a41de70a7383bac6220b787d740c0b261">stream_putw_at</a> (s, pos, total_attr_len);
    }

  <a class="code" href="bgp__packet_8c.html#a7e9932216f445778d1c21dd471a6ef3a">bgp_packet_set_size</a> (s);

  packet = <a class="code" href="stream_8c.html#ad4c81d1449a5c97aa37c0acb4a5c7815">stream_dup</a> (s);
  <a class="code" href="stream_8c.html#ac25ca0f9b32a76b4ea34ecb3c9d62481">stream_free</a> (s);

  <span class="comment">/* Add packet to the peer. */</span>
  <a class="code" href="bgp__packet_8c.html#ac1112a3a8cf02e203843a0beaa7b465f">bgp_packet_add</a> (<a class="code" href="structpeer.html">peer</a>, packet);

  <a class="code" href="bgp__fsm_8h.html#a441b8dfef999d79ac1c3e3b9573fe516">BGP_WRITE_ON</a> (<a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#af1b52e357fd1c6aa0bc8360cf57485e4">t_write</a>, <a class="code" href="bgp__packet_8c.html#ad43cdddbeb3aa17bb2aa199409455c1c">bgp_write</a>, <a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#a593c49b1167d88eb2d2900db47eb5d9d">fd</a>);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a1883265fe49e8119b3ae22e199cf4e47"></a><!-- doxytag: member="bgp_packet.h::bgp_keepalive_send" ref="a1883265fe49e8119b3ae22e199cf4e47" args="(struct peer *)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void bgp_keepalive_send </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structpeer.html">peer</a> *&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="bgp__packet_8c_source.html#l00749">749</a> of file <a class="el" href="bgp__packet_8c_source.html">bgp_packet.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keyword">struct </span><a class="code" href="structstream.html">stream</a> *<a class="code" href="spgrid_8c.html#a5d97d3b42a0d6c9ec9a3e56f2616a6a5">s</a>;
  <span class="keywordtype">int</span> <a class="code" href="isis__pdu_8h.html#a64ed70bbcb4536e2af22a1aaf5209d18">length</a>;

  s = <a class="code" href="stream_8c.html#a7117cdad9fa5e5ae633e0cf08d047459">stream_new</a> (<a class="code" href="bgpd_8h.html#a87f2b928735fc26743eecf3ff55c065f">BGP_MAX_PACKET_SIZE</a>);

  <span class="comment">/* Make keepalive packet. */</span>
  <a class="code" href="bgp__packet_8c.html#abd97bf221857a76aedb9e136d8271ad2">bgp_packet_set_marker</a> (s, <a class="code" href="bgpd_8h.html#a08fb2d7ea18582e949c71c575ba06b76">BGP_MSG_KEEPALIVE</a>);

  <span class="comment">/* Set packet size. */</span>
  length = <a class="code" href="bgp__packet_8c.html#a7e9932216f445778d1c21dd471a6ef3a">bgp_packet_set_size</a> (s);

  <span class="comment">/* Dump packet if debug option is set. */</span>
  <span class="comment">/* bgp_packet_dump (s); */</span>
 
  <span class="keywordflow">if</span> (<a class="code" href="bgp__debug_8h.html#a3652951eb4451c498ae4be9890d4b7a4">BGP_DEBUG</a> (keepalive, KEEPALIVE))  
    <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;%s sending KEEPALIVE&quot;</span>, <a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#ac3e4ca25642ebcc52b2d4b2143fa74fa">host</a>); 
  <span class="keywordflow">if</span> (<a class="code" href="bgp__debug_8h.html#a3652951eb4451c498ae4be9890d4b7a4">BGP_DEBUG</a> (normal, NORMAL))
    <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;%s send message type %d, length (incl. header) %d&quot;</span>,
               <a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#ac3e4ca25642ebcc52b2d4b2143fa74fa">host</a>, <a class="code" href="bgpd_8h.html#a08fb2d7ea18582e949c71c575ba06b76">BGP_MSG_KEEPALIVE</a>, length);

  <span class="comment">/* Add packet to the peer. */</span>
  <a class="code" href="bgp__packet_8c.html#ac1112a3a8cf02e203843a0beaa7b465f">bgp_packet_add</a> (<a class="code" href="structpeer.html">peer</a>, s);

  <a class="code" href="bgp__fsm_8h.html#a441b8dfef999d79ac1c3e3b9573fe516">BGP_WRITE_ON</a> (<a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#af1b52e357fd1c6aa0bc8360cf57485e4">t_write</a>, <a class="code" href="bgp__packet_8c.html#ad43cdddbeb3aa17bb2aa199409455c1c">bgp_write</a>, <a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#a593c49b1167d88eb2d2900db47eb5d9d">fd</a>);
}
</pre></div>
</div>
</div>
<a class="anchor" id="adab4d4fe710a9ee5d157396355aa6df3"></a><!-- doxytag: member="bgp_packet.h::bgp_notify_send" ref="adab4d4fe710a9ee5d157396355aa6df3" args="(struct peer *, u_int8_t, u_int8_t)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void bgp_notify_send </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structpeer.html">peer</a> *&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">u_int8_t&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">u_int8_t&#160;</td>
          <td class="paramname">&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a470d13ca4aa789d5edca71efbc4ad83a"></a><!-- doxytag: member="bgp_packet.h::bgp_notify_send_with_data" ref="a470d13ca4aa789d5edca71efbc4ad83a" args="(struct peer *, u_int8_t, u_int8_t, u_int8_t *, size_t)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void bgp_notify_send_with_data </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structpeer.html">peer</a> *&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">u_int8_t&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">u_int8_t&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">u_int8_t *&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname">&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a326ef30c2b162a786eec36bdc4f95d1f"></a><!-- doxytag: member="bgp_packet.h::bgp_open_send" ref="a326ef30c2b162a786eec36bdc4f95d1f" args="(struct peer *)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void bgp_open_send </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structpeer.html">peer</a> *&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="bgp__packet_8c_source.html#l00779">779</a> of file <a class="el" href="bgp__packet_8c_source.html">bgp_packet.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keyword">struct </span><a class="code" href="structstream.html">stream</a> *<a class="code" href="spgrid_8c.html#a5d97d3b42a0d6c9ec9a3e56f2616a6a5">s</a>;
  <span class="keywordtype">int</span> <a class="code" href="isis__pdu_8h.html#a64ed70bbcb4536e2af22a1aaf5209d18">length</a>;
  u_int16_t send_holdtime;
  <a class="code" href="bgpd_8h.html#ae54756b75cc699532543e4e2214c1c57">as_t</a> local_as;

  <span class="keywordflow">if</span> (<a class="code" href="zebra_8h.html#a9310812ac92febfb7d1eb10127aea1a8">CHECK_FLAG</a> (<a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#add88f88547df15dd579f2001840a5ffe">config</a>, <a class="code" href="bgpd_8h.html#a0a38ee681fef67382b59bcacf7e71acc">PEER_CONFIG_TIMER</a>))
    send_holdtime = <a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#a94b9ef3bd3f901c67be200f2b394c206">holdtime</a>;
  <span class="keywordflow">else</span>
    send_holdtime = <a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#aaff7e2f66146a076913d2fe3217edf2c">bgp</a>-&gt;<a class="code" href="structbgp.html#a019cdc9f6a2587ee4d4a271e5add5db4">default_holdtime</a>;

  <span class="comment">/* local-as Change */</span>
  <span class="keywordflow">if</span> (<a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#ae70f6bd98dc2d9ddc6ad6343804789b6">change_local_as</a>)
    local_as = <a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#ae70f6bd98dc2d9ddc6ad6343804789b6">change_local_as</a>; 
  <span class="keywordflow">else</span>
    local_as = <a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#a4d33d4449107287106341b423f5a7498">local_as</a>; 

  s = <a class="code" href="stream_8c.html#a7117cdad9fa5e5ae633e0cf08d047459">stream_new</a> (<a class="code" href="bgpd_8h.html#a87f2b928735fc26743eecf3ff55c065f">BGP_MAX_PACKET_SIZE</a>);

  <span class="comment">/* Make open packet. */</span>
  <a class="code" href="bgp__packet_8c.html#abd97bf221857a76aedb9e136d8271ad2">bgp_packet_set_marker</a> (s, <a class="code" href="bgpd_8h.html#afe744c7cfcd031af46264e8adc9a985e">BGP_MSG_OPEN</a>);

  <span class="comment">/* Set open packet values. */</span>
  <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (s, <a class="code" href="bgpd_8h.html#a9379703a2ec6cf40b147ec96a7777ef3">BGP_VERSION_4</a>);        <span class="comment">/* BGP version */</span>
  <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a> (s, (local_as &lt;= <a class="code" href="bgp__aspath_8h.html#a5a3365c8e7924ca85bd9675dc6597908">BGP_AS_MAX</a>) ? (u_int16_t) local_as 
                                           : <a class="code" href="bgp__aspath_8h.html#a9fab3268cc31ac1c5faeff01f7518ba6">BGP_AS_TRANS</a>);
  <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a> (s, send_holdtime);        <span class="comment">/* Hold Time */</span>
  <a class="code" href="stream_8c.html#a9019a5de70c1b6c2715cf24103109632">stream_put_in_addr</a> (s, &amp;<a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#a1c986a18124938ad666b58d06bf3254c">local_id</a>); <span class="comment">/* BGP Identifier */</span>

  <span class="comment">/* Set capability code. */</span>
  <a class="code" href="bgp__open_8c.html#aa7660eff88133071e216cf984179877e">bgp_open_capability</a> (s, <a class="code" href="structpeer.html">peer</a>);

  <span class="comment">/* Set BGP packet length. */</span>
  length = <a class="code" href="bgp__packet_8c.html#a7e9932216f445778d1c21dd471a6ef3a">bgp_packet_set_size</a> (s);

  <span class="keywordflow">if</span> (<a class="code" href="bgp__debug_8h.html#a3652951eb4451c498ae4be9890d4b7a4">BGP_DEBUG</a> (normal, NORMAL))
    <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;%s sending OPEN, version %d, my as %u, holdtime %d, id %s&quot;</span>, 
           <a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#ac3e4ca25642ebcc52b2d4b2143fa74fa">host</a>, <a class="code" href="bgpd_8h.html#a9379703a2ec6cf40b147ec96a7777ef3">BGP_VERSION_4</a>, local_as,
           send_holdtime, inet_ntoa (<a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#a1c986a18124938ad666b58d06bf3254c">local_id</a>));

  <span class="keywordflow">if</span> (<a class="code" href="bgp__debug_8h.html#a3652951eb4451c498ae4be9890d4b7a4">BGP_DEBUG</a> (normal, NORMAL))
    <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;%s send message type %d, length (incl. header) %d&quot;</span>,
           <a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#ac3e4ca25642ebcc52b2d4b2143fa74fa">host</a>, <a class="code" href="bgpd_8h.html#afe744c7cfcd031af46264e8adc9a985e">BGP_MSG_OPEN</a>, length);

  <span class="comment">/* Dump packet if debug option is set. */</span>
  <span class="comment">/* bgp_packet_dump (s); */</span>

  <span class="comment">/* Add packet to the peer. */</span>
  <a class="code" href="bgp__packet_8c.html#ac1112a3a8cf02e203843a0beaa7b465f">bgp_packet_add</a> (<a class="code" href="structpeer.html">peer</a>, s);

  <a class="code" href="bgp__fsm_8h.html#a441b8dfef999d79ac1c3e3b9573fe516">BGP_WRITE_ON</a> (<a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#af1b52e357fd1c6aa0bc8360cf57485e4">t_write</a>, <a class="code" href="bgp__packet_8c.html#ad43cdddbeb3aa17bb2aa199409455c1c">bgp_write</a>, <a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#a593c49b1167d88eb2d2900db47eb5d9d">fd</a>);
}
</pre></div>
</div>
</div>
<a class="anchor" id="adbe52245bb6b37108b50cfc04ac7d5f7"></a><!-- doxytag: member="bgp_packet.h::bgp_read" ref="adbe52245bb6b37108b50cfc04ac7d5f7" args="(struct thread *)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int bgp_read </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structthread.html">thread</a> *&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="bgp__packet_8c_source.html#l02341">2341</a> of file <a class="el" href="bgp__packet_8c_source.html">bgp_packet.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> ret;
  u_char <a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a> = 0;
  <span class="keyword">struct </span><a class="code" href="structpeer.html">peer</a> *<a class="code" href="structpeer.html">peer</a>;
  <a class="code" href="bgpd_8h.html#ae2ac1a1db99d420f5a214c418552fd1e">bgp_size_t</a> size;
  <span class="keywordtype">char</span> notify_data_length[2];

  <span class="comment">/* Yes first of all get peer pointer. */</span>
  peer = <a class="code" href="thread_8h.html#a78f2ae47a7a334f7f74bfed7fda48e5a">THREAD_ARG</a> (<a class="code" href="structthread.html">thread</a>);
  peer-&gt;<a class="code" href="structpeer.html#a51f641e77c077e7e3355a65bd3e51dac">t_read</a> = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;

  <span class="comment">/* For non-blocking IO check. */</span>
  <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structpeer.html#ae39d16f69d65fec0f4f1908b4a33e6c6">status</a> == <a class="code" href="bgpd_8h.html#a58672521fe155cead3bd1f0653be62ee">Connect</a>)
    {
      <a class="code" href="bgp__packet_8c.html#afa3f4ee76734007f952c560c6e6d3124">bgp_connect_check</a> (peer);
      <span class="keywordflow">goto</span> done;
    }
  <span class="keywordflow">else</span>
    {
      <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structpeer.html#a593c49b1167d88eb2d2900db47eb5d9d">fd</a> &lt; 0)
    {
      <a class="code" href="log_8h.html#aaf50b52a949696adb9e77153b08545ad">zlog_err</a> (<span class="stringliteral">&quot;bgp_read peer&#39;s fd is negative value %d&quot;</span>, peer-&gt;<a class="code" href="structpeer.html#a593c49b1167d88eb2d2900db47eb5d9d">fd</a>);
      <span class="keywordflow">return</span> -1;
    }
      <a class="code" href="bgp__fsm_8h.html#a62b5746c9e6a92bffde54f2dc61557d7">BGP_READ_ON</a> (peer-&gt;<a class="code" href="structpeer.html#a51f641e77c077e7e3355a65bd3e51dac">t_read</a>, <a class="code" href="bgp__packet_8c.html#a3a37390260357b584d8fd7b3591b2058">bgp_read</a>, peer-&gt;<a class="code" href="structpeer.html#a593c49b1167d88eb2d2900db47eb5d9d">fd</a>);
    }

  <span class="comment">/* Read packet header to determine type of the packet */</span>
  <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structpeer.html#a21bd941bc82fe85b016335eaf9ff8140">packet_size</a> == 0)
    peer-&gt;<a class="code" href="structpeer.html#a21bd941bc82fe85b016335eaf9ff8140">packet_size</a> = <a class="code" href="bgpd_8h.html#a68412752c6355f0f46f03966ba07142a">BGP_HEADER_SIZE</a>;

  <span class="keywordflow">if</span> (<a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (peer-&gt;<a class="code" href="structpeer.html#ad56414663c798719e3a10e6c62a37003">ibuf</a>) &lt; <a class="code" href="bgpd_8h.html#a68412752c6355f0f46f03966ba07142a">BGP_HEADER_SIZE</a>)
    {
      ret = <a class="code" href="bgp__packet_8c.html#a88e8d1d76630adbf1345f4f64560e377">bgp_read_packet</a> (peer);

      <span class="comment">/* Header read error or partial read packet. */</span>
      <span class="keywordflow">if</span> (ret &lt; 0) 
    <span class="keywordflow">goto</span> done;

      <span class="comment">/* Get size and type. */</span>
      <a class="code" href="stream_8c.html#a1deb508ba8ee96eeea12f1b690373260">stream_forward_getp</a> (peer-&gt;<a class="code" href="structpeer.html#ad56414663c798719e3a10e6c62a37003">ibuf</a>, <a class="code" href="bgpd_8h.html#a446cef03639f8fbcd85962258810a518">BGP_MARKER_SIZE</a>);
      <a class="code" href="regex_8c.html#aed653b4838032a2c5ce8960421c8cfd7">memcpy</a> (notify_data_length, <a class="code" href="stream_8c.html#ad176a69ba2571f53673903a3429da3b6">stream_pnt</a> (peer-&gt;<a class="code" href="structpeer.html#ad56414663c798719e3a10e6c62a37003">ibuf</a>), 2);
      size = <a class="code" href="stream_8c.html#a66155fa63acd1f377a5b9e98aba7b888">stream_getw</a> (peer-&gt;<a class="code" href="structpeer.html#ad56414663c798719e3a10e6c62a37003">ibuf</a>);
      type = <a class="code" href="stream_8c.html#a7902a86d9a749707c535840654ded3f6">stream_getc</a> (peer-&gt;<a class="code" href="structpeer.html#ad56414663c798719e3a10e6c62a37003">ibuf</a>);

      <span class="keywordflow">if</span> (<a class="code" href="bgp__debug_8h.html#a3652951eb4451c498ae4be9890d4b7a4">BGP_DEBUG</a> (normal, NORMAL) &amp;&amp; type != 2 &amp;&amp; type != 0)
    <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;%s rcv message type %d, length (excl. header) %d&quot;</span>,
           peer-&gt;<a class="code" href="structpeer.html#ac3e4ca25642ebcc52b2d4b2143fa74fa">host</a>, type, size - <a class="code" href="bgpd_8h.html#a68412752c6355f0f46f03966ba07142a">BGP_HEADER_SIZE</a>);

      <span class="comment">/* Marker check */</span>
      <span class="keywordflow">if</span> (((type == <a class="code" href="bgpd_8h.html#afe744c7cfcd031af46264e8adc9a985e">BGP_MSG_OPEN</a>) || (type == <a class="code" href="bgpd_8h.html#a08fb2d7ea18582e949c71c575ba06b76">BGP_MSG_KEEPALIVE</a>))
      &amp;&amp; ! <a class="code" href="bgp__packet_8c.html#ae3982eb6a6b11aa51844ea259f63aa49">bgp_marker_all_one</a> (peer-&gt;<a class="code" href="structpeer.html#ad56414663c798719e3a10e6c62a37003">ibuf</a>, <a class="code" href="bgpd_8h.html#a446cef03639f8fbcd85962258810a518">BGP_MARKER_SIZE</a>))
    {
      <a class="code" href="bgp__packet_8c.html#ac17989ee6afabce09c9d326fbbf6607b">bgp_notify_send</a> (peer,
               <a class="code" href="bgpd_8h.html#a8a435e0e2033f183fcd82cfe4ed59443">BGP_NOTIFY_HEADER_ERR</a>, 
               <a class="code" href="bgpd_8h.html#a25225385b28d64a38e2ae07eceb4bf0d">BGP_NOTIFY_HEADER_NOT_SYNC</a>);
      <span class="keywordflow">goto</span> done;
    }

      <span class="comment">/* BGP type check. */</span>
      <span class="keywordflow">if</span> (type != <a class="code" href="bgpd_8h.html#afe744c7cfcd031af46264e8adc9a985e">BGP_MSG_OPEN</a> &amp;&amp; type != <a class="code" href="bgpd_8h.html#a295372f9038c0a36cb9622d5d7f5ff7e">BGP_MSG_UPDATE</a> 
      &amp;&amp; type != <a class="code" href="bgpd_8h.html#a0e3044d33a574fd401dd138ca43e0726">BGP_MSG_NOTIFY</a> &amp;&amp; type != <a class="code" href="bgpd_8h.html#a08fb2d7ea18582e949c71c575ba06b76">BGP_MSG_KEEPALIVE</a> 
      &amp;&amp; type != <a class="code" href="bgpd_8h.html#ab658cfa8991a976023a4a50d00e7ada5">BGP_MSG_ROUTE_REFRESH_NEW</a>
      &amp;&amp; type != <a class="code" href="bgpd_8h.html#a6f8a3d1a9c4e630e9ddca1fbca3adfcd">BGP_MSG_ROUTE_REFRESH_OLD</a>
      &amp;&amp; type != <a class="code" href="bgpd_8h.html#af521d3eb65a5e825d4cfd69e1b558176">BGP_MSG_CAPABILITY</a>)
    {
      <span class="keywordflow">if</span> (<a class="code" href="bgp__debug_8h.html#a3652951eb4451c498ae4be9890d4b7a4">BGP_DEBUG</a> (normal, NORMAL))
        <a class="code" href="log_8h.html#a901efa2487b25c3a74846a52de919565">plog_debug</a> (peer-&gt;<a class="code" href="structpeer.html#a8042cd53718885196f47ee66b471ec3d">log</a>,
              <span class="stringliteral">&quot;%s unknown message type 0x%02x&quot;</span>,
              peer-&gt;<a class="code" href="structpeer.html#ac3e4ca25642ebcc52b2d4b2143fa74fa">host</a>, type);
      <a class="code" href="bgp__packet_8c.html#a451c099a790874d1bca55ccb2c4a4057">bgp_notify_send_with_data</a> (peer,
                     <a class="code" href="bgpd_8h.html#a8a435e0e2033f183fcd82cfe4ed59443">BGP_NOTIFY_HEADER_ERR</a>,
                     <a class="code" href="bgpd_8h.html#a61d92861d20bda6984fa61f01a59fb16">BGP_NOTIFY_HEADER_BAD_MESTYPE</a>,
                     &amp;type, 1);
      <span class="keywordflow">goto</span> done;
    }
      <span class="comment">/* Mimimum packet length check. */</span>
      <span class="keywordflow">if</span> ((size &lt; <a class="code" href="bgpd_8h.html#a68412752c6355f0f46f03966ba07142a">BGP_HEADER_SIZE</a>)
      || (size &gt; <a class="code" href="bgpd_8h.html#a87f2b928735fc26743eecf3ff55c065f">BGP_MAX_PACKET_SIZE</a>)
      || (type == <a class="code" href="bgpd_8h.html#afe744c7cfcd031af46264e8adc9a985e">BGP_MSG_OPEN</a> &amp;&amp; size &lt; <a class="code" href="bgpd_8h.html#a4f6499d62f6a3b2f694149912d9c8988">BGP_MSG_OPEN_MIN_SIZE</a>)
      || (type == <a class="code" href="bgpd_8h.html#a295372f9038c0a36cb9622d5d7f5ff7e">BGP_MSG_UPDATE</a> &amp;&amp; size &lt; <a class="code" href="bgpd_8h.html#a0ef011551c8692b5c2fc86c9ab8abc11">BGP_MSG_UPDATE_MIN_SIZE</a>)
      || (type == <a class="code" href="bgpd_8h.html#a0e3044d33a574fd401dd138ca43e0726">BGP_MSG_NOTIFY</a> &amp;&amp; size &lt; <a class="code" href="bgpd_8h.html#a8ec4c7e03d72e64bccae551622d5b3b0">BGP_MSG_NOTIFY_MIN_SIZE</a>)
      || (type == <a class="code" href="bgpd_8h.html#a08fb2d7ea18582e949c71c575ba06b76">BGP_MSG_KEEPALIVE</a> &amp;&amp; size != <a class="code" href="bgpd_8h.html#a797b79580c983a81b6b752afbf9e6506">BGP_MSG_KEEPALIVE_MIN_SIZE</a>)
      || (type == <a class="code" href="bgpd_8h.html#ab658cfa8991a976023a4a50d00e7ada5">BGP_MSG_ROUTE_REFRESH_NEW</a> &amp;&amp; size &lt; <a class="code" href="bgpd_8h.html#abbeda9e0f7ccb8484e9a3de2b83586bf">BGP_MSG_ROUTE_REFRESH_MIN_SIZE</a>)
      || (type == <a class="code" href="bgpd_8h.html#a6f8a3d1a9c4e630e9ddca1fbca3adfcd">BGP_MSG_ROUTE_REFRESH_OLD</a> &amp;&amp; size &lt; <a class="code" href="bgpd_8h.html#abbeda9e0f7ccb8484e9a3de2b83586bf">BGP_MSG_ROUTE_REFRESH_MIN_SIZE</a>)
      || (type == <a class="code" href="bgpd_8h.html#af521d3eb65a5e825d4cfd69e1b558176">BGP_MSG_CAPABILITY</a> &amp;&amp; size &lt; <a class="code" href="bgpd_8h.html#a832757f94a322ba227a4f2f386aeb046">BGP_MSG_CAPABILITY_MIN_SIZE</a>))
    {
      <span class="keywordflow">if</span> (<a class="code" href="bgp__debug_8h.html#a3652951eb4451c498ae4be9890d4b7a4">BGP_DEBUG</a> (normal, NORMAL))
        <a class="code" href="log_8h.html#a901efa2487b25c3a74846a52de919565">plog_debug</a> (peer-&gt;<a class="code" href="structpeer.html#a8042cd53718885196f47ee66b471ec3d">log</a>,
              <span class="stringliteral">&quot;%s bad message length - %d for %s&quot;</span>,
              peer-&gt;<a class="code" href="structpeer.html#ac3e4ca25642ebcc52b2d4b2143fa74fa">host</a>, size, 
              type == 128 ? <span class="stringliteral">&quot;ROUTE-REFRESH&quot;</span> :
              <a class="code" href="bgp__debug_8c.html#ab3ba22219d24863d590cda1738f6ec1b">bgp_type_str</a>[(<span class="keywordtype">int</span>) type]);
      <a class="code" href="bgp__packet_8c.html#a451c099a790874d1bca55ccb2c4a4057">bgp_notify_send_with_data</a> (peer,
                     <a class="code" href="bgpd_8h.html#a8a435e0e2033f183fcd82cfe4ed59443">BGP_NOTIFY_HEADER_ERR</a>,
                     <a class="code" href="bgpd_8h.html#af913f37e5cd1375f2f3948a2946de262">BGP_NOTIFY_HEADER_BAD_MESLEN</a>,
                     (u_char *) notify_data_length, 2);
      <span class="keywordflow">goto</span> done;
    }

      <span class="comment">/* Adjust size to message length. */</span>
      peer-&gt;<a class="code" href="structpeer.html#a21bd941bc82fe85b016335eaf9ff8140">packet_size</a> = size;
    }

  ret = <a class="code" href="bgp__packet_8c.html#a88e8d1d76630adbf1345f4f64560e377">bgp_read_packet</a> (peer);
  <span class="keywordflow">if</span> (ret &lt; 0) 
    <span class="keywordflow">goto</span> done;

  <span class="comment">/* Get size and type again. */</span>
  size = <a class="code" href="stream_8c.html#ac14f5ef12c68d16e2a654e3922f7c03b">stream_getw_from</a> (peer-&gt;<a class="code" href="structpeer.html#ad56414663c798719e3a10e6c62a37003">ibuf</a>, <a class="code" href="bgpd_8h.html#a446cef03639f8fbcd85962258810a518">BGP_MARKER_SIZE</a>);
  type = <a class="code" href="stream_8c.html#af7a4ed58eb43625677649eb111f52feb">stream_getc_from</a> (peer-&gt;<a class="code" href="structpeer.html#ad56414663c798719e3a10e6c62a37003">ibuf</a>, <a class="code" href="bgpd_8h.html#a446cef03639f8fbcd85962258810a518">BGP_MARKER_SIZE</a> + 2);

  <span class="comment">/* BGP packet dump function. */</span>
  <a class="code" href="bgp__dump_8c.html#aa97689fd779f7eaaaad6d74bb3ffc837">bgp_dump_packet</a> (peer, type, peer-&gt;<a class="code" href="structpeer.html#ad56414663c798719e3a10e6c62a37003">ibuf</a>);
  
  size = (peer-&gt;<a class="code" href="structpeer.html#a21bd941bc82fe85b016335eaf9ff8140">packet_size</a> - <a class="code" href="bgpd_8h.html#a68412752c6355f0f46f03966ba07142a">BGP_HEADER_SIZE</a>);

  <span class="comment">/* Read rest of the packet and call each sort of packet routine */</span>
  <span class="keywordflow">switch</span> (type) 
    {
    <span class="keywordflow">case</span> <a class="code" href="bgpd_8h.html#afe744c7cfcd031af46264e8adc9a985e">BGP_MSG_OPEN</a>:
      peer-&gt;<a class="code" href="structpeer.html#a76ca0a8b7f67bf4d7abab5609ec90aca">open_in</a>++;
      <a class="code" href="bgp__packet_8c.html#a97f0b0875f50fbbba10f0938e820075e">bgp_open_receive</a> (peer, size); <span class="comment">/* XXX return value ignored! */</span>
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="bgpd_8h.html#a295372f9038c0a36cb9622d5d7f5ff7e">BGP_MSG_UPDATE</a>:
      peer-&gt;<a class="code" href="structpeer.html#a9006b32a7b8b2dbd8aa09c2b193efa57">readtime</a> = time(<a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);    <span class="comment">/* Last read timer reset */</span>
      <a class="code" href="bgp__packet_8c.html#a43a9bbf186d894f26c76480c541ca436">bgp_update_receive</a> (peer, size);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="bgpd_8h.html#a0e3044d33a574fd401dd138ca43e0726">BGP_MSG_NOTIFY</a>:
      <a class="code" href="bgp__packet_8c.html#a695a91d3e1f6a6ec619c0397c27c7e71">bgp_notify_receive</a> (peer, size);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="bgpd_8h.html#a08fb2d7ea18582e949c71c575ba06b76">BGP_MSG_KEEPALIVE</a>:
      peer-&gt;<a class="code" href="structpeer.html#a9006b32a7b8b2dbd8aa09c2b193efa57">readtime</a> = time(<a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);    <span class="comment">/* Last read timer reset */</span>
      <a class="code" href="bgp__packet_8c.html#a7541e468418602cf15e6e5244f880ca5">bgp_keepalive_receive</a> (peer, size);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="bgpd_8h.html#ab658cfa8991a976023a4a50d00e7ada5">BGP_MSG_ROUTE_REFRESH_NEW</a>:
    <span class="keywordflow">case</span> <a class="code" href="bgpd_8h.html#a6f8a3d1a9c4e630e9ddca1fbca3adfcd">BGP_MSG_ROUTE_REFRESH_OLD</a>:
      peer-&gt;<a class="code" href="structpeer.html#a2d6e4e26d5cc36e86e0c35e992273035">refresh_in</a>++;
      <a class="code" href="bgp__packet_8c.html#a74d7b10930867d6ff40854fba54736a3">bgp_route_refresh_receive</a> (peer, size);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="bgpd_8h.html#af521d3eb65a5e825d4cfd69e1b558176">BGP_MSG_CAPABILITY</a>:
      peer-&gt;<a class="code" href="structpeer.html#a0a23af24ef314346a4522804b82290e8">dynamic_cap_in</a>++;
      <a class="code" href="bgp__packet_8c.html#ad9b67c079a9d84a3091831acc2a15e2f">bgp_capability_receive</a> (peer, size);
      <span class="keywordflow">break</span>;
    }

  <span class="comment">/* Clear input buffer. */</span>
  peer-&gt;<a class="code" href="structpeer.html#a21bd941bc82fe85b016335eaf9ff8140">packet_size</a> = 0;
  <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structpeer.html#ad56414663c798719e3a10e6c62a37003">ibuf</a>)
    <a class="code" href="stream_8c.html#aee8fd31485ebc2f0a556a6a5d5c2d1e6">stream_reset</a> (peer-&gt;<a class="code" href="structpeer.html#ad56414663c798719e3a10e6c62a37003">ibuf</a>);

 done:
  <span class="keywordflow">if</span> (<a class="code" href="zebra_8h.html#a9310812ac92febfb7d1eb10127aea1a8">CHECK_FLAG</a> (peer-&gt;<a class="code" href="structpeer.html#a8dd1d16a0890967ee343e1bc70292e4f">sflags</a>, <a class="code" href="bgpd_8h.html#a4b52af7b570cb9bf7c57f3bd5ea71b73">PEER_STATUS_ACCEPT_PEER</a>))
    {
      <span class="keywordflow">if</span> (<a class="code" href="bgp__debug_8h.html#a3652951eb4451c498ae4be9890d4b7a4">BGP_DEBUG</a> (events, EVENTS))
    <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;%s [Event] Accepting BGP peer delete&quot;</span>, peer-&gt;<a class="code" href="structpeer.html#ac3e4ca25642ebcc52b2d4b2143fa74fa">host</a>);
      <a class="code" href="bgpd_8c.html#a3cf7aaaf69048554d000a576ecb0cc9c">peer_delete</a> (peer);
    }
  <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a870a5d11961cbf10e87da7aad659b956"></a><!-- doxytag: member="bgp_packet.h::bgp_route_refresh_send" ref="a870a5d11961cbf10e87da7aad659b956" args="(struct peer *, afi_t, safi_t, u_char, u_char, int)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void bgp_route_refresh_send </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structpeer.html">peer</a> *&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="zebra_8h.html#a0a34f9bd6bbc49876614d274005c6ff1">afi_t</a>&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="zebra_8h.html#a195af4129e055b63a1b67529674bb998">safi_t</a>&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">u_char&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">u_char&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname">&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="bgp__packet_8c_source.html#l00925">925</a> of file <a class="el" href="bgp__packet_8c_source.html">bgp_packet.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keyword">struct </span><a class="code" href="structstream.html">stream</a> *<a class="code" href="spgrid_8c.html#a5d97d3b42a0d6c9ec9a3e56f2616a6a5">s</a>;
  <span class="keyword">struct </span><a class="code" href="structstream.html">stream</a> *packet;
  <span class="keywordtype">int</span> <a class="code" href="isis__pdu_8h.html#a64ed70bbcb4536e2af22a1aaf5209d18">length</a>;
  <span class="keyword">struct </span><a class="code" href="structbgp__filter.html">bgp_filter</a> *<a class="code" href="structfilter.html">filter</a>;
  <span class="keywordtype">int</span> orf_refresh = 0;

  <span class="keywordflow">if</span> (DISABLE_BGP_ANNOUNCE)
    <span class="keywordflow">return</span>;

  filter = &amp;<a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#a8ae54829ca91f5860216eb326f264727">filter</a>[afi][safi];

  <span class="comment">/* Adjust safi code. */</span>
  <span class="keywordflow">if</span> (safi == <a class="code" href="zebra_8h.html#aea6a248ae05b01f7ff8faf6d8c8c6c10">SAFI_MPLS_VPN</a>)
    safi = <a class="code" href="bgpd_8h.html#a597e9437c3d1c7d5551d8232a70e89ae">BGP_SAFI_VPNV4</a>;
  
  s = <a class="code" href="stream_8c.html#a7117cdad9fa5e5ae633e0cf08d047459">stream_new</a> (<a class="code" href="bgpd_8h.html#a87f2b928735fc26743eecf3ff55c065f">BGP_MAX_PACKET_SIZE</a>);

  <span class="comment">/* Make BGP update packet. */</span>
  <span class="keywordflow">if</span> (<a class="code" href="zebra_8h.html#a9310812ac92febfb7d1eb10127aea1a8">CHECK_FLAG</a> (<a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#a64eadd546a8c50dfe6a6dcb635c3822d">cap</a>, <a class="code" href="bgpd_8h.html#ac1d6ee4b70cb694a4f70664fe966a014">PEER_CAP_REFRESH_NEW_RCV</a>))
    <a class="code" href="bgp__packet_8c.html#abd97bf221857a76aedb9e136d8271ad2">bgp_packet_set_marker</a> (s, <a class="code" href="bgpd_8h.html#ab658cfa8991a976023a4a50d00e7ada5">BGP_MSG_ROUTE_REFRESH_NEW</a>);
  <span class="keywordflow">else</span>
    <a class="code" href="bgp__packet_8c.html#abd97bf221857a76aedb9e136d8271ad2">bgp_packet_set_marker</a> (s, <a class="code" href="bgpd_8h.html#a6f8a3d1a9c4e630e9ddca1fbca3adfcd">BGP_MSG_ROUTE_REFRESH_OLD</a>);

  <span class="comment">/* Encode Route Refresh message. */</span>
  <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a> (s, afi);
  <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (s, 0);
  <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (s, safi);
 
  <span class="keywordflow">if</span> (orf_type == <a class="code" href="bgp__open_8h.html#adc5dbdce1a3677ba56d250c98f0d56ff">ORF_TYPE_PREFIX</a>
      || orf_type == <a class="code" href="bgp__open_8h.html#a08c45b6907c24b44c5db40587b4abb15">ORF_TYPE_PREFIX_OLD</a>)
    <span class="keywordflow">if</span> (<span class="keyword">remove</span> || filter-&gt;<a class="code" href="structbgp__filter.html#aee2c2fc293d876506dc349b65d82278a">plist</a>[<a class="code" href="zebra_8h.html#a0e7bd0ab44045fec6bfba480babaf207">FILTER_IN</a>].plist)
      {
    u_int16_t orf_len;
    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> orfp;

    orf_refresh = 1; 
    <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (s, when_to_refresh);
    <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (s, orf_type);
    orfp = <a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (s);
    <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a> (s, 0);

    <span class="keywordflow">if</span> (<span class="keyword">remove</span>)
      {
        <a class="code" href="zebra_8h.html#ab1ec1b6701a70280e13876cf1f6ae51d">UNSET_FLAG</a> (<a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#ab49d7e30a6869bf9f0753afe25b17c6a">af_sflags</a>[afi][safi], <a class="code" href="bgpd_8h.html#ad1a4beaaf01dc6e5e251aebab1615a8a">PEER_STATUS_ORF_PREFIX_SEND</a>);
        <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (s, <a class="code" href="bgp__packet_8h.html#aaa55ed31dd48f7faf00c0f0b83740c05">ORF_COMMON_PART_REMOVE_ALL</a>);
        <span class="keywordflow">if</span> (<a class="code" href="bgp__debug_8h.html#a3652951eb4451c498ae4be9890d4b7a4">BGP_DEBUG</a> (normal, NORMAL))
          <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;%s sending REFRESH_REQ to remove ORF(%d) (%s) for afi/safi: %d/%d&quot;</span>, 
             <a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#ac3e4ca25642ebcc52b2d4b2143fa74fa">host</a>, orf_type,
             (when_to_refresh == <a class="code" href="bgp__packet_8h.html#a4dc1e6799b406a23e99cfaf8e680df70">REFRESH_DEFER</a> ? <span class="stringliteral">&quot;defer&quot;</span> : <span class="stringliteral">&quot;immediate&quot;</span>),
             afi, safi);
      }
    <span class="keywordflow">else</span>
      {
        <a class="code" href="zebra_8h.html#a7c593725d5bbf27a37a922ae84b02333">SET_FLAG</a> (<a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#ab49d7e30a6869bf9f0753afe25b17c6a">af_sflags</a>[afi][safi], <a class="code" href="bgpd_8h.html#ad1a4beaaf01dc6e5e251aebab1615a8a">PEER_STATUS_ORF_PREFIX_SEND</a>);
        <a class="code" href="plist_8c.html#afc282a7288efb63da57b4d55d144fff7">prefix_bgp_orf_entry</a> (s, filter-&gt;<a class="code" href="structbgp__filter.html#aee2c2fc293d876506dc349b65d82278a">plist</a>[<a class="code" href="zebra_8h.html#a0e7bd0ab44045fec6bfba480babaf207">FILTER_IN</a>].plist,
                  <a class="code" href="bgp__packet_8h.html#a739d323f7e1d604a5bc1777c99e3a663">ORF_COMMON_PART_ADD</a>, <a class="code" href="bgp__packet_8h.html#aa62477116e8caf3e21fb37a789cd03a9">ORF_COMMON_PART_PERMIT</a>,
                  <a class="code" href="bgp__packet_8h.html#ad4dae47ed99f26afef0dbdbee312094e">ORF_COMMON_PART_DENY</a>);
        <span class="keywordflow">if</span> (<a class="code" href="bgp__debug_8h.html#a3652951eb4451c498ae4be9890d4b7a4">BGP_DEBUG</a> (normal, NORMAL))
          <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;%s sending REFRESH_REQ with pfxlist ORF(%d) (%s) for afi/safi: %d/%d&quot;</span>, 
             <a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#ac3e4ca25642ebcc52b2d4b2143fa74fa">host</a>, orf_type,
             (when_to_refresh == <a class="code" href="bgp__packet_8h.html#a4dc1e6799b406a23e99cfaf8e680df70">REFRESH_DEFER</a> ? <span class="stringliteral">&quot;defer&quot;</span> : <span class="stringliteral">&quot;immediate&quot;</span>),
             afi, safi);
      }

    <span class="comment">/* Total ORF Entry Len. */</span>
    orf_len = <a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (s) - orfp - 2;
    <a class="code" href="stream_8c.html#a41de70a7383bac6220b787d740c0b261">stream_putw_at</a> (s, orfp, orf_len);
      }

  <span class="comment">/* Set packet size. */</span>
  length = <a class="code" href="bgp__packet_8c.html#a7e9932216f445778d1c21dd471a6ef3a">bgp_packet_set_size</a> (s);

  <span class="keywordflow">if</span> (<a class="code" href="bgp__debug_8h.html#a3652951eb4451c498ae4be9890d4b7a4">BGP_DEBUG</a> (normal, NORMAL))
    {
      <span class="keywordflow">if</span> (! orf_refresh)
    <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;%s sending REFRESH_REQ for afi/safi: %d/%d&quot;</span>, 
           <a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#ac3e4ca25642ebcc52b2d4b2143fa74fa">host</a>, afi, safi);
      <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;%s send message type %d, length (incl. header) %d&quot;</span>,
         <a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#ac3e4ca25642ebcc52b2d4b2143fa74fa">host</a>, <a class="code" href="zebra_8h.html#a9310812ac92febfb7d1eb10127aea1a8">CHECK_FLAG</a> (<a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#a64eadd546a8c50dfe6a6dcb635c3822d">cap</a>, <a class="code" href="bgpd_8h.html#ac1d6ee4b70cb694a4f70664fe966a014">PEER_CAP_REFRESH_NEW_RCV</a>) ?
         <a class="code" href="bgpd_8h.html#ab658cfa8991a976023a4a50d00e7ada5">BGP_MSG_ROUTE_REFRESH_NEW</a> : <a class="code" href="bgpd_8h.html#a6f8a3d1a9c4e630e9ddca1fbca3adfcd">BGP_MSG_ROUTE_REFRESH_OLD</a>, length);
    }

  <span class="comment">/* Make real packet. */</span>
  packet = <a class="code" href="stream_8c.html#ad4c81d1449a5c97aa37c0acb4a5c7815">stream_dup</a> (s);
  <a class="code" href="stream_8c.html#ac25ca0f9b32a76b4ea34ecb3c9d62481">stream_free</a> (s);

  <span class="comment">/* Add packet to the peer. */</span>
  <a class="code" href="bgp__packet_8c.html#ac1112a3a8cf02e203843a0beaa7b465f">bgp_packet_add</a> (<a class="code" href="structpeer.html">peer</a>, packet);

  <a class="code" href="bgp__fsm_8h.html#a441b8dfef999d79ac1c3e3b9573fe516">BGP_WRITE_ON</a> (<a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#af1b52e357fd1c6aa0bc8360cf57485e4">t_write</a>, <a class="code" href="bgp__packet_8c.html#ad43cdddbeb3aa17bb2aa199409455c1c">bgp_write</a>, <a class="code" href="structpeer.html">peer</a>-&gt;<a class="code" href="structpeer.html#a593c49b1167d88eb2d2900db47eb5d9d">fd</a>);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a013cbe8fe89b4ea4ec6c0712c66a6f8b"></a><!-- doxytag: member="bgp_packet.h::bgp_write" ref="a013cbe8fe89b4ea4ec6c0712c66a6f8b" args="(struct thread *)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int bgp_write </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structthread.html">thread</a> *&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="bgp__packet_8c_source.html#l00593">593</a> of file <a class="el" href="bgp__packet_8c_source.html">bgp_packet.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keyword">struct </span><a class="code" href="structpeer.html">peer</a> *<a class="code" href="structpeer.html">peer</a>;
  u_char <a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a>;
  <span class="keyword">struct </span><a class="code" href="structstream.html">stream</a> *<a class="code" href="spgrid_8c.html#a5d97d3b42a0d6c9ec9a3e56f2616a6a5">s</a>; 
  <span class="keywordtype">int</span> <a class="code" href="bgp__open_8h.html#ab4570498c4316aa5f7b4852c778b3320">num</a>;
  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="spgrid_8c.html#a66e3fedede6aa372e5196e55e5e8d5c1">count</a> = 0;
  <span class="keywordtype">int</span> write_errno;

  <span class="comment">/* Yes first of all get peer pointer. */</span>
  peer = <a class="code" href="thread_8h.html#a78f2ae47a7a334f7f74bfed7fda48e5a">THREAD_ARG</a> (<a class="code" href="structthread.html">thread</a>);
  peer-&gt;<a class="code" href="structpeer.html#af1b52e357fd1c6aa0bc8360cf57485e4">t_write</a> = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;

  <span class="comment">/* For non-blocking IO check. */</span>
  <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structpeer.html#ae39d16f69d65fec0f4f1908b4a33e6c6">status</a> == <a class="code" href="bgpd_8h.html#a58672521fe155cead3bd1f0653be62ee">Connect</a>)
    {
      <a class="code" href="bgp__packet_8c.html#afa3f4ee76734007f952c560c6e6d3124">bgp_connect_check</a> (peer);
      <span class="keywordflow">return</span> 0;
    }

    <span class="comment">/* Nonblocking write until TCP output buffer is full.  */</span>
  <span class="keywordflow">while</span> (1)
    {
      <span class="keywordtype">int</span> writenum;
      <span class="keywordtype">int</span> <a class="code" href="prefix_8h.html#a43e03366be2dd9176e91229d76541ce9">val</a>;

      s = <a class="code" href="bgp__packet_8c.html#a379c7164298b8b6294eec50512466660">bgp_write_packet</a> (peer);
      <span class="keywordflow">if</span> (! s)
    <span class="keywordflow">return</span> 0;
      
      <span class="comment">/* XXX: FIXME, the socket should be NONBLOCK from the start</span>
<span class="comment">       * status shouldnt need to be toggled on each write</span>
<span class="comment">       */</span>
      val = fcntl (peer-&gt;<a class="code" href="structpeer.html#a593c49b1167d88eb2d2900db47eb5d9d">fd</a>, F_GETFL, 0);
      fcntl (peer-&gt;<a class="code" href="structpeer.html#a593c49b1167d88eb2d2900db47eb5d9d">fd</a>, F_SETFL, val|O_NONBLOCK);

      <span class="comment">/* Number of bytes to be sent.  */</span>
      writenum = <a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (s) - <a class="code" href="stream_8c.html#a717f15645000d42a15034f5ec83fc9a5">stream_get_getp</a> (s);

      <span class="comment">/* Call write() system call.  */</span>
      num = write (peer-&gt;<a class="code" href="structpeer.html#a593c49b1167d88eb2d2900db47eb5d9d">fd</a>, <a class="code" href="stream_8h.html#a4bb95ef1391c2b8b7b97678a5ad87cb7">STREAM_PNT</a> (s), writenum);
      write_errno = errno;
      fcntl (peer-&gt;<a class="code" href="structpeer.html#a593c49b1167d88eb2d2900db47eb5d9d">fd</a>, F_SETFL, val);
      <span class="keywordflow">if</span> (num &lt;= 0)
    {
      <span class="comment">/* Partial write. */</span>
      <span class="keywordflow">if</span> (write_errno == EWOULDBLOCK || write_errno == EAGAIN)
          <span class="keywordflow">break</span>;

      <a class="code" href="bgp__fsm_8h.html#a20f7fd10817508149783bf6729dd6727">BGP_EVENT_ADD</a> (peer, <a class="code" href="bgpd_8h.html#ab37344e5380c17e5b2c9be898d63ca67">TCP_fatal_error</a>);
      <span class="keywordflow">return</span> 0;
    }
      <span class="keywordflow">if</span> (num != writenum)
    {
      <a class="code" href="stream_8c.html#a1deb508ba8ee96eeea12f1b690373260">stream_forward_getp</a> (s, num);

      <span class="keywordflow">if</span> (write_errno == EAGAIN)
        <span class="keywordflow">break</span>;

      <span class="keywordflow">continue</span>;
    }

      <span class="comment">/* Retrieve BGP packet type. */</span>
      <a class="code" href="stream_8c.html#a5506a87bd79df66accb6ad8fbbd5857c">stream_set_getp</a> (s, <a class="code" href="bgpd_8h.html#a446cef03639f8fbcd85962258810a518">BGP_MARKER_SIZE</a> + 2);
      type = <a class="code" href="stream_8c.html#a7902a86d9a749707c535840654ded3f6">stream_getc</a> (s);

      <span class="keywordflow">switch</span> (type)
    {
    <span class="keywordflow">case</span> <a class="code" href="bgpd_8h.html#afe744c7cfcd031af46264e8adc9a985e">BGP_MSG_OPEN</a>:
      peer-&gt;<a class="code" href="structpeer.html#a6372a52ffefb71ae6e45658ba6961c48">open_out</a>++;
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="bgpd_8h.html#a295372f9038c0a36cb9622d5d7f5ff7e">BGP_MSG_UPDATE</a>:
      peer-&gt;<a class="code" href="structpeer.html#ae471ee06ab605d6101199ec38f06f3b6">update_out</a>++;
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="bgpd_8h.html#a0e3044d33a574fd401dd138ca43e0726">BGP_MSG_NOTIFY</a>:
      peer-&gt;<a class="code" href="structpeer.html#a3c2d072c10be8fbf3d56dad221b799cc">notify_out</a>++;
      <span class="comment">/* Double start timer. */</span>
      peer-&gt;<a class="code" href="structpeer.html#a82d93e09c2e715abdb362fa6b5059908">v_start</a> *= 2;

      <span class="comment">/* Overflow check. */</span>
      <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structpeer.html#a82d93e09c2e715abdb362fa6b5059908">v_start</a> &gt;= (60 * 2))
        peer-&gt;<a class="code" href="structpeer.html#a82d93e09c2e715abdb362fa6b5059908">v_start</a> = (60 * 2);

      <span class="comment">/* Flush any existing events */</span>
      <a class="code" href="bgp__fsm_8h.html#a20f7fd10817508149783bf6729dd6727">BGP_EVENT_ADD</a> (peer, <a class="code" href="bgpd_8h.html#afffcc626edea20680a6ba32cf6436cef">BGP_Stop</a>);
      <span class="keywordflow">return</span> 0;
    <span class="keywordflow">case</span> <a class="code" href="bgpd_8h.html#a08fb2d7ea18582e949c71c575ba06b76">BGP_MSG_KEEPALIVE</a>:
      peer-&gt;<a class="code" href="structpeer.html#af879557d041a38f1603e09a38834f241">keepalive_out</a>++;
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="bgpd_8h.html#ab658cfa8991a976023a4a50d00e7ada5">BGP_MSG_ROUTE_REFRESH_NEW</a>:
    <span class="keywordflow">case</span> <a class="code" href="bgpd_8h.html#a6f8a3d1a9c4e630e9ddca1fbca3adfcd">BGP_MSG_ROUTE_REFRESH_OLD</a>:
      peer-&gt;<a class="code" href="structpeer.html#abba30cc4402a799a43f4eb7bd04e4dfe">refresh_out</a>++;
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="bgpd_8h.html#af521d3eb65a5e825d4cfd69e1b558176">BGP_MSG_CAPABILITY</a>:
      peer-&gt;<a class="code" href="structpeer.html#a787d4c08df4bb74dbd15d58f206f6768">dynamic_cap_out</a>++;
      <span class="keywordflow">break</span>;
    }

      <span class="comment">/* OK we send packet so delete it. */</span>
      <a class="code" href="bgp__packet_8c.html#aa529c538a0a9df61107f11602ca3c524">bgp_packet_delete</a> (peer);

      <span class="keywordflow">if</span> (++count &gt;= <a class="code" href="bgp__packet_8h.html#a69f0a11991c18cd78e31d458dfb2ec33">BGP_WRITE_PACKET_MAX</a>)
    <span class="keywordflow">break</span>;
    }
  
  <span class="keywordflow">if</span> (<a class="code" href="bgp__packet_8c.html#a2f88d64d5a585237b317b5a98d9fdf29">bgp_write_proceed</a> (peer))
    <a class="code" href="bgp__fsm_8h.html#a441b8dfef999d79ac1c3e3b9573fe516">BGP_WRITE_ON</a> (peer-&gt;<a class="code" href="structpeer.html#af1b52e357fd1c6aa0bc8360cf57485e4">t_write</a>, <a class="code" href="bgp__packet_8c.html#ad43cdddbeb3aa17bb2aa199409455c1c">bgp_write</a>, peer-&gt;<a class="code" href="structpeer.html#a593c49b1167d88eb2d2900db47eb5d9d">fd</a>);
  
  <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
</div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="bgp__packet_8h.html">bgp_packet.h</a>      </li>

    <li class="footer">Generated on Tue Apr 24 2012 10:41:12 for OSPFN by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.5.1 </li>
   </ul>
 </div>


</body>
</html>
