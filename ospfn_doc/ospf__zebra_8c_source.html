<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>OSPFN: ospfd/ospf_zebra.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>


</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">OSPFN
   &#160;<span id="projectnumber">1.1</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('ospf__zebra_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">ospfd/ospf_zebra.c</div>  </div>
</div>
<div class="contents">
<a href="ospf__zebra_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Zebra connect library for OSPFd</span>
<a name="l00003"></a>00003 <span class="comment"> * Copyright (C) 1997, 98, 99, 2000 Kunihiro Ishiguro, Toshiaki Takada</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * This file is part of GNU Zebra.</span>
<a name="l00006"></a>00006 <span class="comment"> *</span>
<a name="l00007"></a>00007 <span class="comment"> * GNU Zebra is free software; you can redistribute it and/or modify it</span>
<a name="l00008"></a>00008 <span class="comment"> * under the terms of the GNU General Public License as published by the</span>
<a name="l00009"></a>00009 <span class="comment"> * Free Software Foundation; either version 2, or (at your option) any</span>
<a name="l00010"></a>00010 <span class="comment"> * later version.</span>
<a name="l00011"></a>00011 <span class="comment"> *</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU Zebra is distributed in the hope that it will be useful, but</span>
<a name="l00013"></a>00013 <span class="comment"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00014"></a>00014 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<a name="l00015"></a>00015 <span class="comment"> * General Public License for more details.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00018"></a>00018 <span class="comment"> * along with GNU Zebra; see the file COPYING.  If not, write to the</span>
<a name="l00019"></a>00019 <span class="comment"> * Free Software Foundation, Inc., 59 Temple Place - Suite 330,</span>
<a name="l00020"></a>00020 <span class="comment"> * Boston, MA 02111-1307, USA. </span>
<a name="l00021"></a>00021 <span class="comment"> */</span>
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;<a class="code" href="zebra_8h.html">zebra.h</a>&gt;</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="thread_8h.html">thread.h</a>&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="command_8h.html">command.h</a>&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="network_8h.html">network.h</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="prefix_8h.html">prefix.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="routemap_8h.html">routemap.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="table_8h.html">table.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="stream_8h.html">stream.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="memory_8h.html">memory.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="zclient_8h.html">zclient.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="filter_8h.html">filter.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="plist_8h.html">plist.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="log_8h.html">log.h</a>&quot;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="ospfd_8h.html">ospfd/ospfd.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="ospf__interface_8h.html">ospfd/ospf_interface.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="ospf__ism_8h.html">ospfd/ospf_ism.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="ospf__asbr_8h.html">ospfd/ospf_asbr.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="ospf__asbr_8h.html">ospfd/ospf_asbr.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="ospf__abr_8h.html">ospfd/ospf_abr.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="ospf__lsa_8h.html">ospfd/ospf_lsa.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="ospf__dump_8h.html">ospfd/ospf_dump.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="ospf__route_8h.html">ospfd/ospf_route.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="ospf__zebra_8h.html">ospfd/ospf_zebra.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#ifdef HAVE_SNMP</span>
<a name="l00049"></a>00049 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="ospf__snmp_8h.html">ospfd/ospf_snmp.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_SNMP */</span>
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="comment">/* Zebra structure to hold current status. */</span>
<a name="l00053"></a><a class="code" href="ospf__zebra_8c.html#abe1502972ba9aa40adc080e419c496bf">00053</a> <span class="keyword">struct </span><a class="code" href="structzclient.html">zclient</a> *<a class="code" href="structzclient.html">zclient</a> = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="comment">/* For registering threads. */</span>
<a name="l00056"></a>00056 <span class="keyword">extern</span> <span class="keyword">struct </span><a class="code" href="structthread__master.html">thread_master</a> *<a class="code" href="bgp__main_8c.html#af7f9077bc08df049beb65a1c09cde5fa">master</a>;
<a name="l00057"></a><a class="code" href="ospf__zebra_8c.html#a5ff73fe88ce576fe7fc3877984367add">00057</a> <span class="keyword">struct </span>in_addr <a class="code" href="bgp__vty_8c.html#a5ff73fe88ce576fe7fc3877984367add">router_id_zebra</a>;
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="comment">/* Router-id update message from zebra. */</span>
<a name="l00060"></a>00060 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00061"></a><a class="code" href="ospf__zebra_8c.html#ac766e7564bdf5781398b1b1723b7d078">00061</a> <a class="code" href="ospf__zebra_8c.html#ac766e7564bdf5781398b1b1723b7d078">ospf_router_id_update_zebra</a> (<span class="keywordtype">int</span> command, <span class="keyword">struct</span> zclient *zclient,
<a name="l00062"></a>00062                  <a class="code" href="zebra_8h.html#a6cbec281d30ae59db10d5b28b5d1cc03">zebra_size_t</a> <a class="code" href="isis__pdu_8h.html#a64ed70bbcb4536e2af22a1aaf5209d18">length</a>)
<a name="l00063"></a>00063 {
<a name="l00064"></a>00064   <span class="keyword">struct </span><a class="code" href="structospf.html">ospf</a> *<a class="code" href="structospf.html">ospf</a>;
<a name="l00065"></a>00065   <span class="keyword">struct </span><a class="code" href="structprefix.html">prefix</a> router_id;
<a name="l00066"></a>00066   <a class="code" href="zclient_8c.html#a6adcd87e46d205582c81673f669067f3">zebra_router_id_update_read</a>(zclient-&gt;<a class="code" href="structzclient.html#a1b9d2a1e869c1008c2bc70d14ce2bf49">ibuf</a>,&amp;router_id);
<a name="l00067"></a>00067 
<a name="l00068"></a>00068   <span class="keywordflow">if</span> (<a class="code" href="ospf__dump_8h.html#a065e478fcd8bd7a409804fc9e9e67e70">IS_DEBUG_OSPF</a> (<a class="code" href="bgp__debug_8c.html#aacd09dfe4b60fac4ec1c5e2895066f07">zebra</a>, ZEBRA_INTERFACE))
<a name="l00069"></a>00069     {
<a name="l00070"></a>00070       <span class="keywordtype">char</span> buf[128];
<a name="l00071"></a>00071       <a class="code" href="prefix_8c.html#a8b848557695ae5694bd2282eba23e367">prefix2str</a>(&amp;router_id, buf, <span class="keyword">sizeof</span>(buf));
<a name="l00072"></a>00072       <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a>(<span class="stringliteral">&quot;Zebra rcvd: router id update %s&quot;</span>, buf);
<a name="l00073"></a>00073     }
<a name="l00074"></a>00074 
<a name="l00075"></a>00075   <a class="code" href="bgp__vty_8c.html#a5ff73fe88ce576fe7fc3877984367add">router_id_zebra</a> = router_id.u.<a class="code" href="structprefix.html#ab37b8922554b41b7dc2417d8f37e7829">prefix4</a>;
<a name="l00076"></a>00076 
<a name="l00077"></a>00077   ospf = <a class="code" href="ospfd_8c.html#a8ea0c935a4862c1469bc962e93fee74b">ospf_lookup</a> ();
<a name="l00078"></a>00078   
<a name="l00079"></a>00079   <span class="keywordflow">if</span> (ospf != <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00080"></a>00080     <a class="code" href="ospfd_8c.html#a0d1cbe02041ecd44cfc37a94718ca69a">ospf_router_id_update</a> (ospf);
<a name="l00081"></a>00081   
<a name="l00082"></a>00082   <span class="keywordflow">return</span> 0;
<a name="l00083"></a>00083 }
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 <span class="comment">/* Inteface addition message from zebra. */</span>
<a name="l00086"></a>00086 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00087"></a><a class="code" href="ospf__zebra_8c.html#affcb29b33003244d9d1464bc907eda20">00087</a> <a class="code" href="ospf__zebra_8c.html#affcb29b33003244d9d1464bc907eda20">ospf_interface_add</a> (<span class="keywordtype">int</span> command, <span class="keyword">struct</span> zclient *zclient, <a class="code" href="zebra_8h.html#a6cbec281d30ae59db10d5b28b5d1cc03">zebra_size_t</a> <a class="code" href="isis__pdu_8h.html#a64ed70bbcb4536e2af22a1aaf5209d18">length</a>)
<a name="l00088"></a>00088 {
<a name="l00089"></a>00089   <span class="keyword">struct </span><a class="code" href="structinterface.html">interface</a> *ifp;
<a name="l00090"></a>00090 
<a name="l00091"></a>00091   ifp = <a class="code" href="zclient_8c.html#af2dbed49848c57eaae1185751ec18648">zebra_interface_add_read</a> (zclient-&gt;<a class="code" href="structzclient.html#a1b9d2a1e869c1008c2bc70d14ce2bf49">ibuf</a>);
<a name="l00092"></a>00092 
<a name="l00093"></a>00093   <span class="keywordflow">if</span> (<a class="code" href="ospf__dump_8h.html#a065e478fcd8bd7a409804fc9e9e67e70">IS_DEBUG_OSPF</a> (<a class="code" href="bgp__debug_8c.html#aacd09dfe4b60fac4ec1c5e2895066f07">zebra</a>, ZEBRA_INTERFACE))
<a name="l00094"></a>00094     <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;Zebra: interface add %s index %d flags %llx metric %d mtu %d&quot;</span>,
<a name="l00095"></a>00095                ifp-&gt;<a class="code" href="structinterface.html#a98cadce768ec5aacb4c5fc4ca2c3eaa8">name</a>, ifp-&gt;<a class="code" href="structinterface.html#ae4c4a0eca6642e37e29e1177a39872ea">ifindex</a>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>)ifp-&gt;<a class="code" href="structinterface.html#a09ed96b900f31d769a76a32b67217c8f">flags</a>,
<a name="l00096"></a>00096                ifp-&gt;<a class="code" href="structinterface.html#adbb7ad89b817a388e9442e85f1e72cc8">metric</a>, ifp-&gt;<a class="code" href="structinterface.html#aadd24df2d261a3bfcbdfe4797e639afb">mtu</a>);
<a name="l00097"></a>00097 
<a name="l00098"></a>00098   <a class="code" href="regex_8c.html#ad6d5aaa966ca7424f7cb9bd01f2c838b">assert</a> (ifp-&gt;<a class="code" href="structinterface.html#a580b288c96c34d57028bfecee2b912c8">info</a>);
<a name="l00099"></a>00099 
<a name="l00100"></a>00100   <span class="keywordflow">if</span> (!<a class="code" href="ospf__interface_8h.html#afe6a1e2fe03d1bd93a1deab41d6eb8e1">OSPF_IF_PARAM_CONFIGURED</a> (<a class="code" href="ospf__interface_8h.html#aa0b2fa68b7fc94f71356893c7e03770a">IF_DEF_PARAMS</a> (ifp), <a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a>))
<a name="l00101"></a>00101     {
<a name="l00102"></a>00102       <a class="code" href="ospf__interface_8h.html#abf54ad522ce6b3724bd2c7959e0a6d6a">SET_IF_PARAM</a> (<a class="code" href="ospf__interface_8h.html#aa0b2fa68b7fc94f71356893c7e03770a">IF_DEF_PARAMS</a> (ifp), <a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a>);
<a name="l00103"></a>00103       <a class="code" href="ospf__interface_8h.html#aa0b2fa68b7fc94f71356893c7e03770a">IF_DEF_PARAMS</a> (ifp)-&gt;type = <a class="code" href="ospf__interface_8c.html#a492149baf1a156aaeb909b62384fc7ef">ospf_default_iftype</a>(ifp);
<a name="l00104"></a>00104     }
<a name="l00105"></a>00105 
<a name="l00106"></a>00106   <a class="code" href="ospfd_8c.html#a9d40c9fe8a5fd9ec7add909556c5bd3f">ospf_if_update</a> (<a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ifp);
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 <span class="preprocessor">#ifdef HAVE_SNMP</span>
<a name="l00109"></a>00109 <span class="preprocessor"></span>  <a class="code" href="ospf__snmp_8h.html#ac794e2fa68a7229faab5403263339aa0">ospf_snmp_if_update</a> (ifp);
<a name="l00110"></a>00110 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_SNMP */</span>
<a name="l00111"></a>00111 
<a name="l00112"></a>00112   <span class="keywordflow">return</span> 0;
<a name="l00113"></a>00113 }
<a name="l00114"></a>00114 
<a name="l00115"></a>00115 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00116"></a><a class="code" href="ospf__zebra_8c.html#afbcd5a399d377db72f8e11faa2b84b59">00116</a> <a class="code" href="ospf__zebra_8c.html#afbcd5a399d377db72f8e11faa2b84b59">ospf_interface_delete</a> (<span class="keywordtype">int</span> command, <span class="keyword">struct</span> zclient *zclient,
<a name="l00117"></a>00117                        <a class="code" href="zebra_8h.html#a6cbec281d30ae59db10d5b28b5d1cc03">zebra_size_t</a> <a class="code" href="isis__pdu_8h.html#a64ed70bbcb4536e2af22a1aaf5209d18">length</a>)
<a name="l00118"></a>00118 {
<a name="l00119"></a>00119   <span class="keyword">struct </span><a class="code" href="structinterface.html">interface</a> *ifp;
<a name="l00120"></a>00120   <span class="keyword">struct </span><a class="code" href="structstream.html">stream</a> *<a class="code" href="spgrid_8c.html#a5d97d3b42a0d6c9ec9a3e56f2616a6a5">s</a>;
<a name="l00121"></a>00121   <span class="keyword">struct </span><a class="code" href="structroute__node.html">route_node</a> *rn;
<a name="l00122"></a>00122 
<a name="l00123"></a>00123   s = zclient-&gt;<a class="code" href="structzclient.html#a1b9d2a1e869c1008c2bc70d14ce2bf49">ibuf</a>;
<a name="l00124"></a>00124   <span class="comment">/* zebra_interface_state_read() updates interface structure in iflist */</span>
<a name="l00125"></a>00125   ifp = <a class="code" href="zclient_8c.html#a989f3e044d41b4e18463027a94b846e7">zebra_interface_state_read</a> (s);
<a name="l00126"></a>00126 
<a name="l00127"></a>00127   <span class="keywordflow">if</span> (ifp == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00128"></a>00128     <span class="keywordflow">return</span> 0;
<a name="l00129"></a>00129 
<a name="l00130"></a>00130   <span class="keywordflow">if</span> (<a class="code" href="if_8c.html#ade77fc67f30030f539906dad43c239ab">if_is_up</a> (ifp))
<a name="l00131"></a>00131     <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;Zebra: got delete of %s, but interface is still up&quot;</span>,
<a name="l00132"></a>00132                ifp-&gt;<a class="code" href="structinterface.html#a98cadce768ec5aacb4c5fc4ca2c3eaa8">name</a>);
<a name="l00133"></a>00133 
<a name="l00134"></a>00134   <span class="keywordflow">if</span> (<a class="code" href="ospf__dump_8h.html#a065e478fcd8bd7a409804fc9e9e67e70">IS_DEBUG_OSPF</a> (<a class="code" href="bgp__debug_8c.html#aacd09dfe4b60fac4ec1c5e2895066f07">zebra</a>, ZEBRA_INTERFACE))
<a name="l00135"></a>00135     <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a>
<a name="l00136"></a>00136       (<span class="stringliteral">&quot;Zebra: interface delete %s index %d flags %lld metric %d mtu %d&quot;</span>,
<a name="l00137"></a>00137        ifp-&gt;<a class="code" href="structinterface.html#a98cadce768ec5aacb4c5fc4ca2c3eaa8">name</a>, ifp-&gt;<a class="code" href="structinterface.html#ae4c4a0eca6642e37e29e1177a39872ea">ifindex</a>, ifp-&gt;<a class="code" href="structinterface.html#a09ed96b900f31d769a76a32b67217c8f">flags</a>, ifp-&gt;<a class="code" href="structinterface.html#adbb7ad89b817a388e9442e85f1e72cc8">metric</a>, ifp-&gt;<a class="code" href="structinterface.html#aadd24df2d261a3bfcbdfe4797e639afb">mtu</a>);
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 <span class="preprocessor">#ifdef HAVE_SNMP</span>
<a name="l00140"></a>00140 <span class="preprocessor"></span>  <a class="code" href="ospf__snmp_8h.html#aba5a9cfd31a7e2217c91a3d5715e9523">ospf_snmp_if_delete</a> (ifp);
<a name="l00141"></a>00141 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_SNMP */</span>
<a name="l00142"></a>00142 
<a name="l00143"></a>00143   <span class="keywordflow">for</span> (rn = <a class="code" href="table_8c.html#aee1d06c531794df326d946bdac647fb2">route_top</a> (<a class="code" href="ospf__interface_8h.html#ad330e5d357fd1cb85883ed422291a332">IF_OIFS</a> (ifp)); rn; rn = <a class="code" href="table_8c.html#ad2addc694ecf6cd0cce57cb3a7d96902">route_next</a> (rn))
<a name="l00144"></a>00144     <span class="keywordflow">if</span> (rn-&gt;<a class="code" href="structroute__node.html#a20aabb1a6fbe9de363a1c57fe3124c87">info</a>)
<a name="l00145"></a>00145       <a class="code" href="ospf__interface_8c.html#aa06699fd3d9034f239d51f2ea6098b3b">ospf_if_free</a> ((<span class="keyword">struct</span> <a class="code" href="structospf__interface.html">ospf_interface</a> *) rn-&gt;<a class="code" href="structroute__node.html#a20aabb1a6fbe9de363a1c57fe3124c87">info</a>);
<a name="l00146"></a>00146 
<a name="l00147"></a>00147   ifp-&gt;<a class="code" href="structinterface.html#ae4c4a0eca6642e37e29e1177a39872ea">ifindex</a> = <a class="code" href="if_8h.html#a18949aeeb4a8fbe7e3be43e6bbe86527">IFINDEX_INTERNAL</a>;
<a name="l00148"></a>00148   <span class="keywordflow">return</span> 0;
<a name="l00149"></a>00149 }
<a name="l00150"></a>00150 
<a name="l00151"></a>00151 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structinterface.html">interface</a> *
<a name="l00152"></a><a class="code" href="ospf__zebra_8c.html#a5b145abf4342f5655667f9359ced89d0">00152</a> <a class="code" href="ospf__zebra_8c.html#a5b145abf4342f5655667f9359ced89d0">zebra_interface_if_lookup</a> (<span class="keyword">struct</span> <a class="code" href="structstream.html">stream</a> *<a class="code" href="spgrid_8c.html#a5d97d3b42a0d6c9ec9a3e56f2616a6a5">s</a>)
<a name="l00153"></a>00153 {
<a name="l00154"></a>00154   <span class="keywordtype">char</span> ifname_tmp[<a class="code" href="if_8h.html#ab819b6f1f4d393be3e866af97297b9cb">INTERFACE_NAMSIZ</a>];
<a name="l00155"></a>00155 
<a name="l00156"></a>00156   <span class="comment">/* Read interface name. */</span>
<a name="l00157"></a>00157   <a class="code" href="stream_8c.html#ab7101e57ef0d9dc1a33e7f7e30c91b9a">stream_get</a> (ifname_tmp, s, <a class="code" href="if_8h.html#ab819b6f1f4d393be3e866af97297b9cb">INTERFACE_NAMSIZ</a>);
<a name="l00158"></a>00158 
<a name="l00159"></a>00159   <span class="comment">/* And look it up. */</span>
<a name="l00160"></a>00160   <span class="keywordflow">return</span> <a class="code" href="if_8c.html#a8ae0929167c87a44b1933994a0254d29">if_lookup_by_name_len</a>(ifname_tmp,
<a name="l00161"></a>00161                    <a class="code" href="str_8c.html#afc92d2231e45d19988c7894aa2a07f0c">strnlen</a>(ifname_tmp, <a class="code" href="if_8h.html#ab819b6f1f4d393be3e866af97297b9cb">INTERFACE_NAMSIZ</a>));
<a name="l00162"></a>00162 }
<a name="l00163"></a>00163 
<a name="l00164"></a>00164 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00165"></a><a class="code" href="ospf__zebra_8c.html#ac5a236e0c7105013a377deda755a3a9f">00165</a> <a class="code" href="ospf__zebra_8c.html#ac5a236e0c7105013a377deda755a3a9f">ospf_interface_state_up</a> (<span class="keywordtype">int</span> command, <span class="keyword">struct</span> zclient *zclient,
<a name="l00166"></a>00166                          <a class="code" href="zebra_8h.html#a6cbec281d30ae59db10d5b28b5d1cc03">zebra_size_t</a> <a class="code" href="isis__pdu_8h.html#a64ed70bbcb4536e2af22a1aaf5209d18">length</a>)
<a name="l00167"></a>00167 {
<a name="l00168"></a>00168   <span class="keyword">struct </span><a class="code" href="structinterface.html">interface</a> *ifp;
<a name="l00169"></a>00169   <span class="keyword">struct </span><a class="code" href="structospf__interface.html">ospf_interface</a> *oi;
<a name="l00170"></a>00170   <span class="keyword">struct </span><a class="code" href="structroute__node.html">route_node</a> *rn;
<a name="l00171"></a>00171 
<a name="l00172"></a>00172   ifp = <a class="code" href="ospf__zebra_8c.html#a5b145abf4342f5655667f9359ced89d0">zebra_interface_if_lookup</a> (zclient-&gt;<a class="code" href="structzclient.html#a1b9d2a1e869c1008c2bc70d14ce2bf49">ibuf</a>);
<a name="l00173"></a>00173 
<a name="l00174"></a>00174   <span class="keywordflow">if</span> (ifp == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00175"></a>00175     <span class="keywordflow">return</span> 0;
<a name="l00176"></a>00176 
<a name="l00177"></a>00177   <span class="comment">/* Interface is already up. */</span>
<a name="l00178"></a>00178   <span class="keywordflow">if</span> (<a class="code" href="if_8c.html#a96741fba2059f7591f57d18325664b7b">if_is_operative</a> (ifp))
<a name="l00179"></a>00179     {
<a name="l00180"></a>00180       <span class="comment">/* Temporarily keep ifp values. */</span>
<a name="l00181"></a>00181       <span class="keyword">struct </span><a class="code" href="structinterface.html">interface</a> if_tmp;
<a name="l00182"></a>00182       <a class="code" href="regex_8c.html#aed653b4838032a2c5ce8960421c8cfd7">memcpy</a> (&amp;if_tmp, ifp, <span class="keyword">sizeof</span> (<span class="keyword">struct</span> <a class="code" href="structinterface.html">interface</a>));
<a name="l00183"></a>00183 
<a name="l00184"></a>00184       <a class="code" href="zclient_8c.html#a2366afba487613909591ecadd8985f1a">zebra_interface_if_set_value</a> (zclient-&gt;<a class="code" href="structzclient.html#a1b9d2a1e869c1008c2bc70d14ce2bf49">ibuf</a>, ifp);
<a name="l00185"></a>00185 
<a name="l00186"></a>00186       <span class="keywordflow">if</span> (<a class="code" href="ospf__dump_8h.html#a065e478fcd8bd7a409804fc9e9e67e70">IS_DEBUG_OSPF</a> (<a class="code" href="bgp__debug_8c.html#aacd09dfe4b60fac4ec1c5e2895066f07">zebra</a>, ZEBRA_INTERFACE))
<a name="l00187"></a>00187         <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;Zebra: Interface[%s] state update.&quot;</span>, ifp-&gt;<a class="code" href="structinterface.html#a98cadce768ec5aacb4c5fc4ca2c3eaa8">name</a>);
<a name="l00188"></a>00188 
<a name="l00189"></a>00189       <span class="keywordflow">if</span> (if_tmp.<a class="code" href="structinterface.html#a324b6a80459775b1e5e254369649e075">bandwidth</a> != ifp-&gt;<a class="code" href="structinterface.html#a324b6a80459775b1e5e254369649e075">bandwidth</a>)
<a name="l00190"></a>00190         {
<a name="l00191"></a>00191           <span class="keywordflow">if</span> (<a class="code" href="ospf__dump_8h.html#a065e478fcd8bd7a409804fc9e9e67e70">IS_DEBUG_OSPF</a> (<a class="code" href="bgp__debug_8c.html#aacd09dfe4b60fac4ec1c5e2895066f07">zebra</a>, ZEBRA_INTERFACE))
<a name="l00192"></a>00192             <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;Zebra: Interface[%s] bandwidth change %d -&gt; %d.&quot;</span>,
<a name="l00193"></a>00193                        ifp-&gt;<a class="code" href="structinterface.html#a98cadce768ec5aacb4c5fc4ca2c3eaa8">name</a>, if_tmp.<a class="code" href="structinterface.html#a324b6a80459775b1e5e254369649e075">bandwidth</a>, ifp-&gt;<a class="code" href="structinterface.html#a324b6a80459775b1e5e254369649e075">bandwidth</a>);
<a name="l00194"></a>00194 
<a name="l00195"></a>00195           <a class="code" href="ospf__interface_8c.html#a7b1ed4ce1af4c1513f7bd6c6fcc817a3">ospf_if_recalculate_output_cost</a> (ifp);
<a name="l00196"></a>00196         }
<a name="l00197"></a>00197 
<a name="l00198"></a>00198       <span class="keywordflow">if</span> (if_tmp.<a class="code" href="structinterface.html#aadd24df2d261a3bfcbdfe4797e639afb">mtu</a> != ifp-&gt;<a class="code" href="structinterface.html#aadd24df2d261a3bfcbdfe4797e639afb">mtu</a>)
<a name="l00199"></a>00199         {
<a name="l00200"></a>00200           <span class="keywordflow">if</span> (<a class="code" href="ospf__dump_8h.html#a065e478fcd8bd7a409804fc9e9e67e70">IS_DEBUG_OSPF</a> (<a class="code" href="bgp__debug_8c.html#aacd09dfe4b60fac4ec1c5e2895066f07">zebra</a>, ZEBRA_INTERFACE))
<a name="l00201"></a>00201             <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;Zebra: Interface[%s] MTU change %u -&gt; %u.&quot;</span>,
<a name="l00202"></a>00202                        ifp-&gt;<a class="code" href="structinterface.html#a98cadce768ec5aacb4c5fc4ca2c3eaa8">name</a>, if_tmp.<a class="code" href="structinterface.html#aadd24df2d261a3bfcbdfe4797e639afb">mtu</a>, ifp-&gt;<a class="code" href="structinterface.html#aadd24df2d261a3bfcbdfe4797e639afb">mtu</a>);
<a name="l00203"></a>00203 
<a name="l00204"></a>00204       <span class="comment">/* Must reset the interface (simulate down/up) when MTU changes. */</span>
<a name="l00205"></a>00205           <a class="code" href="ospf__interface_8c.html#ac5faa00cb6266621add9342300b4fdd8">ospf_if_reset</a>(ifp);
<a name="l00206"></a>00206     }
<a name="l00207"></a>00207       <span class="keywordflow">return</span> 0;
<a name="l00208"></a>00208     }
<a name="l00209"></a>00209 
<a name="l00210"></a>00210   <a class="code" href="zclient_8c.html#a2366afba487613909591ecadd8985f1a">zebra_interface_if_set_value</a> (zclient-&gt;<a class="code" href="structzclient.html#a1b9d2a1e869c1008c2bc70d14ce2bf49">ibuf</a>, ifp);
<a name="l00211"></a>00211 
<a name="l00212"></a>00212   <span class="keywordflow">if</span> (<a class="code" href="ospf__dump_8h.html#a065e478fcd8bd7a409804fc9e9e67e70">IS_DEBUG_OSPF</a> (<a class="code" href="bgp__debug_8c.html#aacd09dfe4b60fac4ec1c5e2895066f07">zebra</a>, ZEBRA_INTERFACE))
<a name="l00213"></a>00213     <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;Zebra: Interface[%s] state change to up.&quot;</span>, ifp-&gt;<a class="code" href="structinterface.html#a98cadce768ec5aacb4c5fc4ca2c3eaa8">name</a>);
<a name="l00214"></a>00214 
<a name="l00215"></a>00215   <span class="keywordflow">for</span> (rn = <a class="code" href="table_8c.html#aee1d06c531794df326d946bdac647fb2">route_top</a> (<a class="code" href="ospf__interface_8h.html#ad330e5d357fd1cb85883ed422291a332">IF_OIFS</a> (ifp)); rn; rn = <a class="code" href="table_8c.html#ad2addc694ecf6cd0cce57cb3a7d96902">route_next</a> (rn))
<a name="l00216"></a>00216     {
<a name="l00217"></a>00217       <span class="keywordflow">if</span> ((oi = rn-&gt;<a class="code" href="structroute__node.html#a20aabb1a6fbe9de363a1c57fe3124c87">info</a>) == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00218"></a>00218         <span class="keywordflow">continue</span>;
<a name="l00219"></a>00219 
<a name="l00220"></a>00220       <a class="code" href="ospf__interface_8c.html#a5a63d5d3af1629d69c380eb09f3e8b7b">ospf_if_up</a> (oi);
<a name="l00221"></a>00221     }
<a name="l00222"></a>00222 
<a name="l00223"></a>00223   <span class="keywordflow">return</span> 0;
<a name="l00224"></a>00224 }
<a name="l00225"></a>00225 
<a name="l00226"></a>00226 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00227"></a><a class="code" href="ospf__zebra_8c.html#a8d0747b0991dedc055bf79a824a25834">00227</a> <a class="code" href="ospf__zebra_8c.html#a8d0747b0991dedc055bf79a824a25834">ospf_interface_state_down</a> (<span class="keywordtype">int</span> command, <span class="keyword">struct</span> zclient *zclient,
<a name="l00228"></a>00228                            <a class="code" href="zebra_8h.html#a6cbec281d30ae59db10d5b28b5d1cc03">zebra_size_t</a> <a class="code" href="isis__pdu_8h.html#a64ed70bbcb4536e2af22a1aaf5209d18">length</a>)
<a name="l00229"></a>00229 {
<a name="l00230"></a>00230   <span class="keyword">struct </span><a class="code" href="structinterface.html">interface</a> *ifp;
<a name="l00231"></a>00231   <span class="keyword">struct </span><a class="code" href="structospf__interface.html">ospf_interface</a> *oi;
<a name="l00232"></a>00232   <span class="keyword">struct </span><a class="code" href="structroute__node.html">route_node</a> *node;
<a name="l00233"></a>00233 
<a name="l00234"></a>00234   ifp = <a class="code" href="zclient_8c.html#a989f3e044d41b4e18463027a94b846e7">zebra_interface_state_read</a> (zclient-&gt;<a class="code" href="structzclient.html#a1b9d2a1e869c1008c2bc70d14ce2bf49">ibuf</a>);
<a name="l00235"></a>00235 
<a name="l00236"></a>00236   <span class="keywordflow">if</span> (ifp == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00237"></a>00237     <span class="keywordflow">return</span> 0;
<a name="l00238"></a>00238 
<a name="l00239"></a>00239   <span class="keywordflow">if</span> (<a class="code" href="ospf__dump_8h.html#a065e478fcd8bd7a409804fc9e9e67e70">IS_DEBUG_OSPF</a> (<a class="code" href="bgp__debug_8c.html#aacd09dfe4b60fac4ec1c5e2895066f07">zebra</a>, ZEBRA_INTERFACE))
<a name="l00240"></a>00240     <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;Zebra: Interface[%s] state change to down.&quot;</span>, ifp-&gt;<a class="code" href="structinterface.html#a98cadce768ec5aacb4c5fc4ca2c3eaa8">name</a>);
<a name="l00241"></a>00241 
<a name="l00242"></a>00242   <span class="keywordflow">for</span> (node = <a class="code" href="table_8c.html#aee1d06c531794df326d946bdac647fb2">route_top</a> (<a class="code" href="ospf__interface_8h.html#ad330e5d357fd1cb85883ed422291a332">IF_OIFS</a> (ifp)); node; node = <a class="code" href="table_8c.html#ad2addc694ecf6cd0cce57cb3a7d96902">route_next</a> (node))
<a name="l00243"></a>00243     {
<a name="l00244"></a>00244       <span class="keywordflow">if</span> ((oi = node-&gt;<a class="code" href="structroute__node.html#a20aabb1a6fbe9de363a1c57fe3124c87">info</a>) == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00245"></a>00245         <span class="keywordflow">continue</span>;
<a name="l00246"></a>00246       <a class="code" href="ospf__interface_8c.html#ac40adc9d92baa831a8ea1cde67defbb2">ospf_if_down</a> (oi);
<a name="l00247"></a>00247     }
<a name="l00248"></a>00248 
<a name="l00249"></a>00249   <span class="keywordflow">return</span> 0;
<a name="l00250"></a>00250 }
<a name="l00251"></a>00251 
<a name="l00252"></a>00252 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00253"></a><a class="code" href="ospf__zebra_8c.html#ab73bf4f6f734469a4d35cd112c74265a">00253</a> <a class="code" href="ospf__zebra_8c.html#ab73bf4f6f734469a4d35cd112c74265a">ospf_interface_address_add</a> (<span class="keywordtype">int</span> command, <span class="keyword">struct</span> zclient *zclient,
<a name="l00254"></a>00254                             <a class="code" href="zebra_8h.html#a6cbec281d30ae59db10d5b28b5d1cc03">zebra_size_t</a> <a class="code" href="isis__pdu_8h.html#a64ed70bbcb4536e2af22a1aaf5209d18">length</a>)
<a name="l00255"></a>00255 {
<a name="l00256"></a>00256   <span class="keyword">struct </span><a class="code" href="structconnected.html">connected</a> *c;
<a name="l00257"></a>00257 
<a name="l00258"></a>00258   c = <a class="code" href="zclient_8c.html#a361d54ec3dad267afc3335fe155367a2">zebra_interface_address_read</a> (command, zclient-&gt;<a class="code" href="structzclient.html#a1b9d2a1e869c1008c2bc70d14ce2bf49">ibuf</a>);
<a name="l00259"></a>00259 
<a name="l00260"></a>00260   <span class="keywordflow">if</span> (c == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00261"></a>00261     <span class="keywordflow">return</span> 0;
<a name="l00262"></a>00262 
<a name="l00263"></a>00263   <span class="keywordflow">if</span> (<a class="code" href="ospf__dump_8h.html#a065e478fcd8bd7a409804fc9e9e67e70">IS_DEBUG_OSPF</a> (<a class="code" href="bgp__debug_8c.html#aacd09dfe4b60fac4ec1c5e2895066f07">zebra</a>, ZEBRA_INTERFACE))
<a name="l00264"></a>00264     {
<a name="l00265"></a>00265       <span class="keywordtype">char</span> buf[128];
<a name="l00266"></a>00266       <a class="code" href="prefix_8c.html#a8b848557695ae5694bd2282eba23e367">prefix2str</a>(c-&gt;<a class="code" href="structconnected.html#a288d9248b21b8e3999e03ceaa9bb70db">address</a>, buf, <span class="keyword">sizeof</span>(buf));
<a name="l00267"></a>00267       <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a>(<span class="stringliteral">&quot;Zebra: interface %s address add %s&quot;</span>, c-&gt;<a class="code" href="structconnected.html#a93c575385a71507f8c29ec26344d09d3">ifp</a>-&gt;<a class="code" href="structinterface.html#a98cadce768ec5aacb4c5fc4ca2c3eaa8">name</a>, buf);
<a name="l00268"></a>00268     }
<a name="l00269"></a>00269 
<a name="l00270"></a>00270   <a class="code" href="ospfd_8c.html#a9d40c9fe8a5fd9ec7add909556c5bd3f">ospf_if_update</a> (<a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, c-&gt;<a class="code" href="structconnected.html#a93c575385a71507f8c29ec26344d09d3">ifp</a>);
<a name="l00271"></a>00271 
<a name="l00272"></a>00272 <span class="preprocessor">#ifdef HAVE_SNMP</span>
<a name="l00273"></a>00273 <span class="preprocessor"></span>  <a class="code" href="ospf__snmp_8h.html#ac794e2fa68a7229faab5403263339aa0">ospf_snmp_if_update</a> (c-&gt;<a class="code" href="structconnected.html#a93c575385a71507f8c29ec26344d09d3">ifp</a>);
<a name="l00274"></a>00274 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_SNMP */</span>
<a name="l00275"></a>00275 
<a name="l00276"></a>00276   <span class="keywordflow">return</span> 0;
<a name="l00277"></a>00277 }
<a name="l00278"></a>00278 
<a name="l00279"></a>00279 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00280"></a><a class="code" href="ospf__zebra_8c.html#aef874b4b32cf37d7176a9f929de61d21">00280</a> <a class="code" href="ospf__zebra_8c.html#aef874b4b32cf37d7176a9f929de61d21">ospf_interface_address_delete</a> (<span class="keywordtype">int</span> command, <span class="keyword">struct</span> zclient *zclient,
<a name="l00281"></a>00281                                <a class="code" href="zebra_8h.html#a6cbec281d30ae59db10d5b28b5d1cc03">zebra_size_t</a> <a class="code" href="isis__pdu_8h.html#a64ed70bbcb4536e2af22a1aaf5209d18">length</a>)
<a name="l00282"></a>00282 {
<a name="l00283"></a>00283   <span class="keyword">struct </span><a class="code" href="structconnected.html">connected</a> *c;
<a name="l00284"></a>00284   <span class="keyword">struct </span><a class="code" href="structinterface.html">interface</a> *ifp;
<a name="l00285"></a>00285   <span class="keyword">struct </span><a class="code" href="structospf__interface.html">ospf_interface</a> *oi;
<a name="l00286"></a>00286   <span class="keyword">struct </span><a class="code" href="structroute__node.html">route_node</a> *rn;
<a name="l00287"></a>00287   <span class="keyword">struct </span><a class="code" href="structprefix.html">prefix</a> p;
<a name="l00288"></a>00288 
<a name="l00289"></a>00289   c = <a class="code" href="zclient_8c.html#a361d54ec3dad267afc3335fe155367a2">zebra_interface_address_read</a> (command, zclient-&gt;<a class="code" href="structzclient.html#a1b9d2a1e869c1008c2bc70d14ce2bf49">ibuf</a>);
<a name="l00290"></a>00290 
<a name="l00291"></a>00291   <span class="keywordflow">if</span> (c == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00292"></a>00292     <span class="keywordflow">return</span> 0;
<a name="l00293"></a>00293 
<a name="l00294"></a>00294   <span class="keywordflow">if</span> (<a class="code" href="ospf__dump_8h.html#a065e478fcd8bd7a409804fc9e9e67e70">IS_DEBUG_OSPF</a> (<a class="code" href="bgp__debug_8c.html#aacd09dfe4b60fac4ec1c5e2895066f07">zebra</a>, ZEBRA_INTERFACE))
<a name="l00295"></a>00295     {
<a name="l00296"></a>00296       <span class="keywordtype">char</span> buf[128];
<a name="l00297"></a>00297       <a class="code" href="prefix_8c.html#a8b848557695ae5694bd2282eba23e367">prefix2str</a>(c-&gt;address, buf, <span class="keyword">sizeof</span>(buf));
<a name="l00298"></a>00298       <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a>(<span class="stringliteral">&quot;Zebra: interface %s address delete %s&quot;</span>, c-&gt;ifp-&gt;name, buf);
<a name="l00299"></a>00299     }
<a name="l00300"></a>00300 
<a name="l00301"></a>00301   ifp = c-&gt;ifp;
<a name="l00302"></a>00302   p = *c-&gt;address;
<a name="l00303"></a>00303   p.<a class="code" href="structprefix.html#aae8dafba4797d25cf1d141780d87ff02">prefixlen</a> = <a class="code" href="prefix_8h.html#ab98d836bf20a06de7a7358ab17832002">IPV4_MAX_PREFIXLEN</a>;
<a name="l00304"></a>00304 
<a name="l00305"></a>00305   rn = <a class="code" href="table_8c.html#ab99d86b40440c8f18d4f2b31b5b8f1c7">route_node_lookup</a> (<a class="code" href="ospf__interface_8h.html#ad330e5d357fd1cb85883ed422291a332">IF_OIFS</a> (ifp), &amp;p);
<a name="l00306"></a>00306   <span class="keywordflow">if</span> (!rn)
<a name="l00307"></a>00307     {
<a name="l00308"></a>00308       <a class="code" href="if_8c.html#aefcfc40d0358af75f26135eb0a33903d">connected_free</a> (c);
<a name="l00309"></a>00309       <span class="keywordflow">return</span> 0;
<a name="l00310"></a>00310     }
<a name="l00311"></a>00311 
<a name="l00312"></a>00312   <a class="code" href="regex_8c.html#ad6d5aaa966ca7424f7cb9bd01f2c838b">assert</a> (rn-&gt;<a class="code" href="structroute__node.html#a20aabb1a6fbe9de363a1c57fe3124c87">info</a>);
<a name="l00313"></a>00313   oi = rn-&gt;<a class="code" href="structroute__node.html#a20aabb1a6fbe9de363a1c57fe3124c87">info</a>;
<a name="l00314"></a>00314 
<a name="l00315"></a>00315   <span class="comment">/* Call interface hook functions to clean up */</span>
<a name="l00316"></a>00316   <a class="code" href="ospf__interface_8c.html#aa06699fd3d9034f239d51f2ea6098b3b">ospf_if_free</a> (oi);
<a name="l00317"></a>00317 
<a name="l00318"></a>00318 <span class="preprocessor">#ifdef HAVE_SNMP</span>
<a name="l00319"></a>00319 <span class="preprocessor"></span>  <a class="code" href="ospf__snmp_8h.html#ac794e2fa68a7229faab5403263339aa0">ospf_snmp_if_update</a> (c-&gt;ifp);
<a name="l00320"></a>00320 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_SNMP */</span>
<a name="l00321"></a>00321 
<a name="l00322"></a>00322   <a class="code" href="if_8c.html#aefcfc40d0358af75f26135eb0a33903d">connected_free</a> (c);
<a name="l00323"></a>00323 
<a name="l00324"></a>00324   <span class="keywordflow">return</span> 0;
<a name="l00325"></a>00325 }
<a name="l00326"></a>00326 
<a name="l00327"></a>00327 <span class="keywordtype">void</span>
<a name="l00328"></a><a class="code" href="ospf__zebra_8h.html#a1eb6da07083106d928826c5e9f54ceb2">00328</a> <a class="code" href="ospf__zebra_8c.html#a8045c2db458b9ad1e679863cf369e5be">ospf_zebra_add</a> (<span class="keyword">struct</span> <a class="code" href="structprefix__ipv4.html">prefix_ipv4</a> *<a class="code" href="spgrid_8c.html#a931bc2aa940ac2a4d1601cf842336926">p</a>, <span class="keyword">struct</span> <a class="code" href="structospf__route.html">ospf_route</a> *or)
<a name="l00329"></a>00329 {
<a name="l00330"></a>00330   u_char <a class="code" href="structmessage.html">message</a>;
<a name="l00331"></a>00331   u_char <a class="code" href="zebra__rib_8c.html#afb9412686cd344ad61757c1c19ba8a87">distance</a>;
<a name="l00332"></a>00332   u_char <a class="code" href="structflags.html">flags</a>;
<a name="l00333"></a>00333   <span class="keywordtype">int</span> psize;
<a name="l00334"></a>00334   <span class="keyword">struct </span><a class="code" href="structstream.html">stream</a> *<a class="code" href="spgrid_8c.html#a5d97d3b42a0d6c9ec9a3e56f2616a6a5">s</a>;
<a name="l00335"></a>00335   <span class="keyword">struct </span><a class="code" href="structospf__path.html">ospf_path</a> *path;
<a name="l00336"></a>00336   <span class="keyword">struct </span><a class="code" href="structlistnode.html">listnode</a> *node;
<a name="l00337"></a>00337 
<a name="l00338"></a>00338   <span class="keywordflow">if</span> (zclient-&gt;<a class="code" href="structzclient.html#a7c76c66fcb4fee1303f834ea9fea0fc5">redist</a>[<a class="code" href="zebra_8h.html#a35ba23125eb2c360943b1bad51673ab0">ZEBRA_ROUTE_OSPF</a>])
<a name="l00339"></a>00339     {
<a name="l00340"></a>00340       message = 0;
<a name="l00341"></a>00341       flags = 0;
<a name="l00342"></a>00342 
<a name="l00343"></a>00343       <span class="comment">/* OSPF pass nexthop and metric */</span>
<a name="l00344"></a>00344       <a class="code" href="zebra_8h.html#a7c593725d5bbf27a37a922ae84b02333">SET_FLAG</a> (message, <a class="code" href="zclient_8h.html#a321bbeaddad8bc9bffaf57f7ac6cf8fd">ZAPI_MESSAGE_NEXTHOP</a>);
<a name="l00345"></a>00345       <a class="code" href="zebra_8h.html#a7c593725d5bbf27a37a922ae84b02333">SET_FLAG</a> (message, <a class="code" href="zclient_8h.html#a4a5d60df1ef02f794476ea1daa6ba024">ZAPI_MESSAGE_METRIC</a>);
<a name="l00346"></a>00346 
<a name="l00347"></a>00347       <span class="comment">/* Distance value. */</span>
<a name="l00348"></a>00348       distance = <a class="code" href="ospf__zebra_8c.html#a41cbdfc85156d98b745b25d652cb35a3">ospf_distance_apply</a> (p, or);
<a name="l00349"></a>00349       <span class="keywordflow">if</span> (distance)
<a name="l00350"></a>00350         <a class="code" href="zebra_8h.html#a7c593725d5bbf27a37a922ae84b02333">SET_FLAG</a> (message, <a class="code" href="zclient_8h.html#abe498bb81bfbda17757173ef23e25179">ZAPI_MESSAGE_DISTANCE</a>);
<a name="l00351"></a>00351 
<a name="l00352"></a>00352       <span class="comment">/* Make packet. */</span>
<a name="l00353"></a>00353       s = zclient-&gt;<a class="code" href="structzclient.html#a6ad60dd1b329d25af807f1517634b71f">obuf</a>;
<a name="l00354"></a>00354       <a class="code" href="stream_8c.html#aee8fd31485ebc2f0a556a6a5d5c2d1e6">stream_reset</a> (s);
<a name="l00355"></a>00355 
<a name="l00356"></a>00356       <span class="comment">/* Put command, type, flags, message. */</span>
<a name="l00357"></a>00357       <a class="code" href="zclient_8c.html#a70fa712bf570d588ea3b3c464bc5156f">zclient_create_header</a> (s, <a class="code" href="zebra_8h.html#aa2913a6b1e5fbc598479aa282343a5e1">ZEBRA_IPV4_ROUTE_ADD</a>);
<a name="l00358"></a>00358       <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (s, <a class="code" href="zebra_8h.html#a35ba23125eb2c360943b1bad51673ab0">ZEBRA_ROUTE_OSPF</a>);
<a name="l00359"></a>00359       <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (s, flags);
<a name="l00360"></a>00360       <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (s, message);
<a name="l00361"></a>00361 
<a name="l00362"></a>00362       <span class="comment">/* Put prefix information. */</span>
<a name="l00363"></a>00363       psize = <a class="code" href="bgpd_8h.html#a472145011d944606a257487e80cc3ace">PSIZE</a> (p-&gt;<a class="code" href="structprefix__ipv4.html#ab96da4bf1eb37195bd564bcf1126a16a">prefixlen</a>);
<a name="l00364"></a>00364       <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (s, p-&gt;<a class="code" href="structprefix__ipv4.html#ab96da4bf1eb37195bd564bcf1126a16a">prefixlen</a>);
<a name="l00365"></a>00365       <a class="code" href="stream_8c.html#a39121b19ef0be09e9a5598a1ea1371c0">stream_write</a> (s, (u_char *) &amp; p-&gt;prefix, psize);
<a name="l00366"></a>00366 
<a name="l00367"></a>00367       <span class="comment">/* Nexthop count. */</span>
<a name="l00368"></a>00368       <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (s, or-&gt;<a class="code" href="structospf__route.html#af687c07f0e39d7c3a29813777032b075">paths</a>-&gt;<a class="code" href="structlist.html#ac9c4d4d7c65e726bd9ee0c8884b6349b">count</a>);
<a name="l00369"></a>00369 
<a name="l00370"></a>00370       <span class="comment">/* Nexthop, ifindex, distance and metric information. */</span>
<a name="l00371"></a>00371       <span class="keywordflow">for</span> (<a class="code" href="linklist_8h.html#a80a3f4035be83abbb709d17412993226">ALL_LIST_ELEMENTS_RO</a> (or-&gt;<a class="code" href="structospf__route.html#af687c07f0e39d7c3a29813777032b075">paths</a>, node, path))
<a name="l00372"></a>00372         {
<a name="l00373"></a>00373           <span class="keywordflow">if</span> (path-&gt;<a class="code" href="structospf__path.html#a01fa8433844b50cd272e6e082114c257">nexthop</a>.s_addr != INADDR_ANY)
<a name="l00374"></a>00374             {
<a name="l00375"></a>00375               <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (s, <a class="code" href="zebra_8h.html#ae603faed81a38b4507ffd9b6f9586b44">ZEBRA_NEXTHOP_IPV4</a>);
<a name="l00376"></a>00376               <a class="code" href="stream_8c.html#a9019a5de70c1b6c2715cf24103109632">stream_put_in_addr</a> (s, &amp;path-&gt;<a class="code" href="structospf__path.html#a01fa8433844b50cd272e6e082114c257">nexthop</a>);
<a name="l00377"></a>00377             }
<a name="l00378"></a>00378           <span class="keywordflow">else</span>
<a name="l00379"></a>00379             {
<a name="l00380"></a>00380               <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (s, <a class="code" href="zebra_8h.html#a8b5777b74f2584912603090de989e564">ZEBRA_NEXTHOP_IFINDEX</a>);
<a name="l00381"></a>00381               <span class="keywordflow">if</span> (path-&gt;<a class="code" href="structospf__path.html#a7275881f3f46eace28604c8ebc0ed654">ifindex</a>)
<a name="l00382"></a>00382                 <a class="code" href="stream_8c.html#af366d780a14cb8de53279378a8a4faeb">stream_putl</a> (s, path-&gt;<a class="code" href="structospf__path.html#a7275881f3f46eace28604c8ebc0ed654">ifindex</a>);
<a name="l00383"></a>00383               <span class="keywordflow">else</span>
<a name="l00384"></a>00384                 <a class="code" href="stream_8c.html#af366d780a14cb8de53279378a8a4faeb">stream_putl</a> (s, 0);
<a name="l00385"></a>00385             }
<a name="l00386"></a>00386 
<a name="l00387"></a>00387           <span class="keywordflow">if</span> (<a class="code" href="ospf__dump_8h.html#a065e478fcd8bd7a409804fc9e9e67e70">IS_DEBUG_OSPF</a> (<a class="code" href="bgp__debug_8c.html#aacd09dfe4b60fac4ec1c5e2895066f07">zebra</a>, ZEBRA_REDISTRIBUTE))
<a name="l00388"></a>00388             {
<a name="l00389"></a>00389           <span class="keywordtype">char</span> buf[2][<a class="code" href="prefix_8h.html#a93b37007689284fd9c4bde1a8f4b9199">INET_ADDRSTRLEN</a>];
<a name="l00390"></a>00390           <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a>(<span class="stringliteral">&quot;Zebra: Route add %s/%d nexthop %s&quot;</span>,
<a name="l00391"></a>00391              <a class="code" href="sockunion_8c.html#a5bfb767e8fa3f9ff5d2a1e19d71791f4">inet_ntop</a>(AF_INET, &amp;p-&gt;prefix,
<a name="l00392"></a>00392                    buf[0], <span class="keyword">sizeof</span>(buf[0])),
<a name="l00393"></a>00393              p-&gt;<a class="code" href="structprefix__ipv4.html#ab96da4bf1eb37195bd564bcf1126a16a">prefixlen</a>,
<a name="l00394"></a>00394              <a class="code" href="sockunion_8c.html#a5bfb767e8fa3f9ff5d2a1e19d71791f4">inet_ntop</a>(AF_INET, &amp;path-&gt;<a class="code" href="structospf__path.html#a01fa8433844b50cd272e6e082114c257">nexthop</a>,
<a name="l00395"></a>00395                    buf[1], <span class="keyword">sizeof</span>(buf[1])));
<a name="l00396"></a>00396             }
<a name="l00397"></a>00397         }
<a name="l00398"></a>00398 
<a name="l00399"></a>00399       <span class="keywordflow">if</span> (<a class="code" href="zebra_8h.html#a9310812ac92febfb7d1eb10127aea1a8">CHECK_FLAG</a> (message, <a class="code" href="zclient_8h.html#abe498bb81bfbda17757173ef23e25179">ZAPI_MESSAGE_DISTANCE</a>))
<a name="l00400"></a>00400         <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (s, distance);
<a name="l00401"></a>00401       <span class="keywordflow">if</span> (<a class="code" href="zebra_8h.html#a9310812ac92febfb7d1eb10127aea1a8">CHECK_FLAG</a> (message, <a class="code" href="zclient_8h.html#a4a5d60df1ef02f794476ea1daa6ba024">ZAPI_MESSAGE_METRIC</a>))
<a name="l00402"></a>00402         {
<a name="l00403"></a>00403           <span class="keywordflow">if</span> (or-&gt;<a class="code" href="structospf__route.html#a599273b0e8bc1a908cbedd22dcd78bbd">path_type</a> == <a class="code" href="ospf__route_8h.html#a15dab014460164847059902ea4535834">OSPF_PATH_TYPE1_EXTERNAL</a>)
<a name="l00404"></a>00404             <a class="code" href="stream_8c.html#af366d780a14cb8de53279378a8a4faeb">stream_putl</a> (s, or-&gt;<a class="code" href="structospf__route.html#a78ed87939e621a405c66aeb71fa1944d">cost</a> + or-&gt;<a class="code" href="structospf__route.html#ab37ba617082e6dec95c8f67eb9b66d7a">u</a>.<a class="code" href="structospf__route.html#a1bf8ff97df95625684ecc9fda5ee8e52">ext</a>.<a class="code" href="structroute__external.html#a93319cd5451e479e19c4e1b3e7d33b54">type2_cost</a>);
<a name="l00405"></a>00405           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (or-&gt;<a class="code" href="structospf__route.html#a599273b0e8bc1a908cbedd22dcd78bbd">path_type</a> == <a class="code" href="ospf__route_8h.html#aa9752c4570157da8a3258dc4cdf23ce5">OSPF_PATH_TYPE2_EXTERNAL</a>)
<a name="l00406"></a>00406             <a class="code" href="stream_8c.html#af366d780a14cb8de53279378a8a4faeb">stream_putl</a> (s, or-&gt;<a class="code" href="structospf__route.html#ab37ba617082e6dec95c8f67eb9b66d7a">u</a>.<a class="code" href="structospf__route.html#a1bf8ff97df95625684ecc9fda5ee8e52">ext</a>.<a class="code" href="structroute__external.html#a93319cd5451e479e19c4e1b3e7d33b54">type2_cost</a>);
<a name="l00407"></a>00407           <span class="keywordflow">else</span>
<a name="l00408"></a>00408             <a class="code" href="stream_8c.html#af366d780a14cb8de53279378a8a4faeb">stream_putl</a> (s, or-&gt;<a class="code" href="structospf__route.html#a78ed87939e621a405c66aeb71fa1944d">cost</a>);
<a name="l00409"></a>00409         }
<a name="l00410"></a>00410 
<a name="l00411"></a>00411       <a class="code" href="stream_8c.html#a41de70a7383bac6220b787d740c0b261">stream_putw_at</a> (s, 0, <a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (s));
<a name="l00412"></a>00412 
<a name="l00413"></a>00413       <a class="code" href="zclient_8c.html#ad395166e549bd33dcc253052ac0bbd7d">zclient_send_message</a>(zclient);
<a name="l00414"></a>00414     }
<a name="l00415"></a>00415 }
<a name="l00416"></a>00416 
<a name="l00417"></a>00417 <span class="keywordtype">void</span>
<a name="l00418"></a><a class="code" href="ospf__zebra_8h.html#a9a2007100217595f7fa1ad5412b10afc">00418</a> <a class="code" href="ospf__zebra_8c.html#a083ae682548f0d7eb0761a2469c8d3f3">ospf_zebra_delete</a> (<span class="keyword">struct</span> <a class="code" href="structprefix__ipv4.html">prefix_ipv4</a> *<a class="code" href="spgrid_8c.html#a931bc2aa940ac2a4d1601cf842336926">p</a>, <span class="keyword">struct</span> <a class="code" href="structospf__route.html">ospf_route</a> *or)
<a name="l00419"></a>00419 {
<a name="l00420"></a>00420   <span class="keyword">struct </span><a class="code" href="structzapi__ipv4.html">zapi_ipv4</a> api;
<a name="l00421"></a>00421   <span class="keyword">struct </span><a class="code" href="structospf__path.html">ospf_path</a> *path;
<a name="l00422"></a>00422   <span class="keyword">struct </span>in_addr *<a class="code" href="structnexthop.html">nexthop</a>;
<a name="l00423"></a>00423   <span class="keyword">struct </span><a class="code" href="structlistnode.html">listnode</a> *node, *nnode;
<a name="l00424"></a>00424 
<a name="l00425"></a>00425   <span class="keywordflow">if</span> (zclient-&gt;<a class="code" href="structzclient.html#a7c76c66fcb4fee1303f834ea9fea0fc5">redist</a>[<a class="code" href="zebra_8h.html#a35ba23125eb2c360943b1bad51673ab0">ZEBRA_ROUTE_OSPF</a>])
<a name="l00426"></a>00426     {
<a name="l00427"></a>00427       api.<a class="code" href="structzapi__ipv4.html#ae4c29fc6652367a6546104010802ac2f">type</a> = <a class="code" href="zebra_8h.html#a35ba23125eb2c360943b1bad51673ab0">ZEBRA_ROUTE_OSPF</a>;
<a name="l00428"></a>00428       api.<a class="code" href="structzapi__ipv4.html#af27235a3df3f1e86cdbd91bce4e0a2c9">flags</a> = 0;
<a name="l00429"></a>00429       api.<a class="code" href="structzapi__ipv4.html#a5d958982406b8e5c5792fa61d30dad2d">message</a> = 0;
<a name="l00430"></a>00430       api.<a class="code" href="structzapi__ipv4.html#ae831960c79c5bbf79345fe148c202641">ifindex_num</a> = 0;
<a name="l00431"></a>00431       api.<a class="code" href="structzapi__ipv4.html#a7af9e3fe513c80387289b433e33dfd7b">nexthop_num</a> = 0;
<a name="l00432"></a>00432 
<a name="l00433"></a>00433       <span class="keywordflow">for</span> (<a class="code" href="linklist_8h.html#a71512a873b8f0e2b4c84d3c949a9bbaf">ALL_LIST_ELEMENTS</a> (or-&gt;<a class="code" href="structospf__route.html#af687c07f0e39d7c3a29813777032b075">paths</a>, node, nnode, path))
<a name="l00434"></a>00434         {
<a name="l00435"></a>00435           <span class="keywordflow">if</span> (path-&gt;<a class="code" href="structospf__path.html#a01fa8433844b50cd272e6e082114c257">nexthop</a>.s_addr != INADDR_ANY)
<a name="l00436"></a>00436             {
<a name="l00437"></a>00437               <a class="code" href="zebra_8h.html#a7c593725d5bbf27a37a922ae84b02333">SET_FLAG</a> (api.<a class="code" href="structzapi__ipv4.html#a5d958982406b8e5c5792fa61d30dad2d">message</a>, <a class="code" href="zclient_8h.html#a321bbeaddad8bc9bffaf57f7ac6cf8fd">ZAPI_MESSAGE_NEXTHOP</a>);
<a name="l00438"></a>00438               api.<a class="code" href="structzapi__ipv4.html#a7af9e3fe513c80387289b433e33dfd7b">nexthop_num</a> = 1;
<a name="l00439"></a>00439               nexthop = &amp;path-&gt;<a class="code" href="structospf__path.html#a01fa8433844b50cd272e6e082114c257">nexthop</a>;
<a name="l00440"></a>00440               api.<a class="code" href="structzapi__ipv4.html#a3864c7fed7dfc94e19405d9d0fef2f9c">nexthop</a> = &amp;nexthop;
<a name="l00441"></a>00441             }
<a name="l00442"></a>00442           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="if_8c.html#a424dd1e971aee548383cca2b770e2859">if_lookup_by_index</a>(path-&gt;<a class="code" href="structospf__path.html#a7275881f3f46eace28604c8ebc0ed654">ifindex</a>))
<a name="l00443"></a>00443             {
<a name="l00444"></a>00444               <a class="code" href="zebra_8h.html#a7c593725d5bbf27a37a922ae84b02333">SET_FLAG</a> (api.<a class="code" href="structzapi__ipv4.html#a5d958982406b8e5c5792fa61d30dad2d">message</a>, <a class="code" href="zclient_8h.html#a321bbeaddad8bc9bffaf57f7ac6cf8fd">ZAPI_MESSAGE_NEXTHOP</a>);
<a name="l00445"></a>00445               api.<a class="code" href="structzapi__ipv4.html#ae831960c79c5bbf79345fe148c202641">ifindex_num</a> = 1;
<a name="l00446"></a>00446               api.<a class="code" href="structzapi__ipv4.html#a7043b2c08d10a58daa5e6e7800ff8a29">ifindex</a> = &amp;path-&gt;<a class="code" href="structospf__path.html#a7275881f3f46eace28604c8ebc0ed654">ifindex</a>;
<a name="l00447"></a>00447             }
<a name="l00448"></a>00448           <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="ospf__dump_8h.html#a065e478fcd8bd7a409804fc9e9e67e70">IS_DEBUG_OSPF</a>(<a class="code" href="bgp__debug_8c.html#aacd09dfe4b60fac4ec1c5e2895066f07">zebra</a>,ZEBRA_REDISTRIBUTE) )
<a name="l00449"></a>00449             {
<a name="l00450"></a>00450               <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a>(<span class="stringliteral">&quot;Zebra: no ifp %s %d&quot;</span>,
<a name="l00451"></a>00451                          inet_ntoa(p-&gt;prefix),
<a name="l00452"></a>00452                          p-&gt;<a class="code" href="structprefix__ipv4.html#ab96da4bf1eb37195bd564bcf1126a16a">prefixlen</a>);
<a name="l00453"></a>00453             }
<a name="l00454"></a>00454 
<a name="l00455"></a>00455           <a class="code" href="zclient_8c.html#ad9a398f43faa79a0bab620c985fb476a">zapi_ipv4_route</a> (<a class="code" href="zebra_8h.html#a0c9efcc3f61219a6697f5da18d8de992">ZEBRA_IPV4_ROUTE_DELETE</a>, zclient, p, &amp;api);
<a name="l00456"></a>00456 
<a name="l00457"></a>00457           <span class="keywordflow">if</span> (<a class="code" href="ospf__dump_8h.html#a065e478fcd8bd7a409804fc9e9e67e70">IS_DEBUG_OSPF</a> (<a class="code" href="bgp__debug_8c.html#aacd09dfe4b60fac4ec1c5e2895066f07">zebra</a>, ZEBRA_REDISTRIBUTE) &amp;&amp; api.<a class="code" href="structzapi__ipv4.html#a7af9e3fe513c80387289b433e33dfd7b">nexthop_num</a>)
<a name="l00458"></a>00458             {
<a name="l00459"></a>00459           <span class="keywordtype">char</span> buf[2][<a class="code" href="prefix_8h.html#a93b37007689284fd9c4bde1a8f4b9199">INET_ADDRSTRLEN</a>];
<a name="l00460"></a>00460           <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a>(<span class="stringliteral">&quot;Zebra: Route delete %s/%d nexthop %s&quot;</span>,
<a name="l00461"></a>00461              <a class="code" href="sockunion_8c.html#a5bfb767e8fa3f9ff5d2a1e19d71791f4">inet_ntop</a>(AF_INET, &amp;p-&gt;prefix, buf[0], <span class="keyword">sizeof</span>(buf[0])),
<a name="l00462"></a>00462              p-&gt;<a class="code" href="structprefix__ipv4.html#ab96da4bf1eb37195bd564bcf1126a16a">prefixlen</a>,
<a name="l00463"></a>00463              <a class="code" href="sockunion_8c.html#a5bfb767e8fa3f9ff5d2a1e19d71791f4">inet_ntop</a>(AF_INET, *api.<a class="code" href="structzapi__ipv4.html#a3864c7fed7dfc94e19405d9d0fef2f9c">nexthop</a>,
<a name="l00464"></a>00464                    buf[1], <span class="keyword">sizeof</span>(buf[1])));
<a name="l00465"></a>00465             }
<a name="l00466"></a>00466           <span class="keywordflow">if</span> (<a class="code" href="ospf__dump_8h.html#a065e478fcd8bd7a409804fc9e9e67e70">IS_DEBUG_OSPF</a> (<a class="code" href="bgp__debug_8c.html#aacd09dfe4b60fac4ec1c5e2895066f07">zebra</a>, ZEBRA_REDISTRIBUTE) &amp;&amp; api.<a class="code" href="structzapi__ipv4.html#ae831960c79c5bbf79345fe148c202641">ifindex_num</a>)
<a name="l00467"></a>00467             {
<a name="l00468"></a>00468               <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;Zebra: Route delete %s/%d ifindex %d&quot;</span>,
<a name="l00469"></a>00469                          inet_ntoa (p-&gt;prefix),
<a name="l00470"></a>00470                          p-&gt;<a class="code" href="structprefix__ipv4.html#ab96da4bf1eb37195bd564bcf1126a16a">prefixlen</a>, *api.<a class="code" href="structzapi__ipv4.html#a7043b2c08d10a58daa5e6e7800ff8a29">ifindex</a>);
<a name="l00471"></a>00471             }
<a name="l00472"></a>00472         }
<a name="l00473"></a>00473     }
<a name="l00474"></a>00474 }
<a name="l00475"></a>00475 
<a name="l00476"></a>00476 <span class="keywordtype">void</span>
<a name="l00477"></a><a class="code" href="ospf__zebra_8h.html#a405c8fcb9701ae80e76599ea41bfb755">00477</a> <a class="code" href="ospf__zebra_8c.html#a49ea785a614ca3ddf8878814cd58681a">ospf_zebra_add_discard</a> (<span class="keyword">struct</span> <a class="code" href="structprefix__ipv4.html">prefix_ipv4</a> *<a class="code" href="spgrid_8c.html#a931bc2aa940ac2a4d1601cf842336926">p</a>)
<a name="l00478"></a>00478 {
<a name="l00479"></a>00479   <span class="keyword">struct </span><a class="code" href="structzapi__ipv4.html">zapi_ipv4</a> api;
<a name="l00480"></a>00480 
<a name="l00481"></a>00481   <span class="keywordflow">if</span> (zclient-&gt;<a class="code" href="structzclient.html#a7c76c66fcb4fee1303f834ea9fea0fc5">redist</a>[<a class="code" href="zebra_8h.html#a35ba23125eb2c360943b1bad51673ab0">ZEBRA_ROUTE_OSPF</a>])
<a name="l00482"></a>00482     {
<a name="l00483"></a>00483       api.<a class="code" href="structzapi__ipv4.html#ae4c29fc6652367a6546104010802ac2f">type</a> = <a class="code" href="zebra_8h.html#a35ba23125eb2c360943b1bad51673ab0">ZEBRA_ROUTE_OSPF</a>;
<a name="l00484"></a>00484       api.<a class="code" href="structzapi__ipv4.html#af27235a3df3f1e86cdbd91bce4e0a2c9">flags</a> = <a class="code" href="zebra_8h.html#ab3b7a4bd090244ae1b882b9003810713">ZEBRA_FLAG_BLACKHOLE</a>;
<a name="l00485"></a>00485       api.<a class="code" href="structzapi__ipv4.html#a5d958982406b8e5c5792fa61d30dad2d">message</a> = 0;
<a name="l00486"></a>00486       <a class="code" href="zebra_8h.html#a7c593725d5bbf27a37a922ae84b02333">SET_FLAG</a> (api.<a class="code" href="structzapi__ipv4.html#a5d958982406b8e5c5792fa61d30dad2d">message</a>, <a class="code" href="zclient_8h.html#a321bbeaddad8bc9bffaf57f7ac6cf8fd">ZAPI_MESSAGE_NEXTHOP</a>);
<a name="l00487"></a>00487       api.<a class="code" href="structzapi__ipv4.html#a7af9e3fe513c80387289b433e33dfd7b">nexthop_num</a> = 0;
<a name="l00488"></a>00488       api.<a class="code" href="structzapi__ipv4.html#ae831960c79c5bbf79345fe148c202641">ifindex_num</a> = 0;
<a name="l00489"></a>00489 
<a name="l00490"></a>00490       <a class="code" href="zclient_8c.html#ad9a398f43faa79a0bab620c985fb476a">zapi_ipv4_route</a> (<a class="code" href="zebra_8h.html#aa2913a6b1e5fbc598479aa282343a5e1">ZEBRA_IPV4_ROUTE_ADD</a>, zclient, p, &amp;api);
<a name="l00491"></a>00491 
<a name="l00492"></a>00492       <span class="keywordflow">if</span> (<a class="code" href="ospf__dump_8h.html#a065e478fcd8bd7a409804fc9e9e67e70">IS_DEBUG_OSPF</a> (<a class="code" href="bgp__debug_8c.html#aacd09dfe4b60fac4ec1c5e2895066f07">zebra</a>, ZEBRA_REDISTRIBUTE))
<a name="l00493"></a>00493         <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;Zebra: Route add discard %s/%d&quot;</span>,
<a name="l00494"></a>00494                    inet_ntoa (p-&gt;prefix), p-&gt;<a class="code" href="structprefix__ipv4.html#ab96da4bf1eb37195bd564bcf1126a16a">prefixlen</a>);
<a name="l00495"></a>00495     }
<a name="l00496"></a>00496 }
<a name="l00497"></a>00497 
<a name="l00498"></a>00498 <span class="keywordtype">void</span>
<a name="l00499"></a><a class="code" href="ospf__zebra_8h.html#a263f719b14f359f582ff1d3fa7aa85d6">00499</a> <a class="code" href="ospf__zebra_8c.html#aa80b8cdd0a2f3e0273c456de9bd553e2">ospf_zebra_delete_discard</a> (<span class="keyword">struct</span> <a class="code" href="structprefix__ipv4.html">prefix_ipv4</a> *<a class="code" href="spgrid_8c.html#a931bc2aa940ac2a4d1601cf842336926">p</a>)
<a name="l00500"></a>00500 {
<a name="l00501"></a>00501   <span class="keyword">struct </span><a class="code" href="structzapi__ipv4.html">zapi_ipv4</a> api;
<a name="l00502"></a>00502 
<a name="l00503"></a>00503   <span class="keywordflow">if</span> (zclient-&gt;<a class="code" href="structzclient.html#a7c76c66fcb4fee1303f834ea9fea0fc5">redist</a>[<a class="code" href="zebra_8h.html#a35ba23125eb2c360943b1bad51673ab0">ZEBRA_ROUTE_OSPF</a>])
<a name="l00504"></a>00504     {
<a name="l00505"></a>00505       api.<a class="code" href="structzapi__ipv4.html#ae4c29fc6652367a6546104010802ac2f">type</a> = <a class="code" href="zebra_8h.html#a35ba23125eb2c360943b1bad51673ab0">ZEBRA_ROUTE_OSPF</a>;
<a name="l00506"></a>00506       api.<a class="code" href="structzapi__ipv4.html#af27235a3df3f1e86cdbd91bce4e0a2c9">flags</a> = <a class="code" href="zebra_8h.html#ab3b7a4bd090244ae1b882b9003810713">ZEBRA_FLAG_BLACKHOLE</a>;
<a name="l00507"></a>00507       api.<a class="code" href="structzapi__ipv4.html#a5d958982406b8e5c5792fa61d30dad2d">message</a> = 0;
<a name="l00508"></a>00508       <a class="code" href="zebra_8h.html#a7c593725d5bbf27a37a922ae84b02333">SET_FLAG</a> (api.<a class="code" href="structzapi__ipv4.html#a5d958982406b8e5c5792fa61d30dad2d">message</a>, <a class="code" href="zclient_8h.html#a321bbeaddad8bc9bffaf57f7ac6cf8fd">ZAPI_MESSAGE_NEXTHOP</a>);
<a name="l00509"></a>00509       api.<a class="code" href="structzapi__ipv4.html#a7af9e3fe513c80387289b433e33dfd7b">nexthop_num</a> = 0;
<a name="l00510"></a>00510       api.<a class="code" href="structzapi__ipv4.html#ae831960c79c5bbf79345fe148c202641">ifindex_num</a> = 0;
<a name="l00511"></a>00511 
<a name="l00512"></a>00512       <a class="code" href="zclient_8c.html#ad9a398f43faa79a0bab620c985fb476a">zapi_ipv4_route</a> (<a class="code" href="zebra_8h.html#a0c9efcc3f61219a6697f5da18d8de992">ZEBRA_IPV4_ROUTE_DELETE</a>, zclient, p, &amp;api);
<a name="l00513"></a>00513 
<a name="l00514"></a>00514       <span class="keywordflow">if</span> (<a class="code" href="ospf__dump_8h.html#a065e478fcd8bd7a409804fc9e9e67e70">IS_DEBUG_OSPF</a> (<a class="code" href="bgp__debug_8c.html#aacd09dfe4b60fac4ec1c5e2895066f07">zebra</a>, ZEBRA_REDISTRIBUTE))
<a name="l00515"></a>00515         <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;Zebra: Route delete discard %s/%d&quot;</span>,
<a name="l00516"></a>00516                    inet_ntoa (p-&gt;prefix), p-&gt;<a class="code" href="structprefix__ipv4.html#ab96da4bf1eb37195bd564bcf1126a16a">prefixlen</a>);
<a name="l00517"></a>00517 
<a name="l00518"></a>00518     }
<a name="l00519"></a>00519 }
<a name="l00520"></a>00520 
<a name="l00521"></a>00521 <span class="keywordtype">int</span>
<a name="l00522"></a><a class="code" href="ospf__zebra_8h.html#a12868e9c56b5620053d86e3090eb9890">00522</a> <a class="code" href="ospf__zebra_8c.html#a0b61d95e6baf19bdd9d8a7705788a226">ospf_is_type_redistributed</a> (<span class="keywordtype">int</span> <a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a>)
<a name="l00523"></a>00523 {
<a name="l00524"></a>00524   <span class="keywordflow">return</span> (<a class="code" href="ospf__zebra_8h.html#a3ccd23195e60a2a4007fafb6a54e1a4e">DEFAULT_ROUTE_TYPE</a> (type)) ?
<a name="l00525"></a>00525     zclient-&gt;<a class="code" href="structzclient.html#a9d77c71b907f0f130f467edaefed93e9">default_information</a> : zclient-&gt;<a class="code" href="structzclient.html#a7c76c66fcb4fee1303f834ea9fea0fc5">redist</a>[<a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a>];
<a name="l00526"></a>00526 }
<a name="l00527"></a>00527 
<a name="l00528"></a>00528 <span class="keywordtype">int</span>
<a name="l00529"></a><a class="code" href="ospf__zebra_8h.html#aa2d4bff5fdda61f7b3a3612b74ee7396">00529</a> <a class="code" href="ospf__zebra_8c.html#a0748b5b07dfb6ba653a5cb0e62fefef1">ospf_redistribute_set</a> (<span class="keyword">struct</span> <a class="code" href="structospf.html">ospf</a> *<a class="code" href="structospf.html">ospf</a>, <span class="keywordtype">int</span> <a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a>, <span class="keywordtype">int</span> mtype, <span class="keywordtype">int</span> mvalue)
<a name="l00530"></a>00530 {
<a name="l00531"></a>00531   <span class="keywordtype">int</span> force = 0;
<a name="l00532"></a>00532 
<a name="l00533"></a>00533   <span class="keywordflow">if</span> (<a class="code" href="ospf__zebra_8c.html#a0b61d95e6baf19bdd9d8a7705788a226">ospf_is_type_redistributed</a> (type))
<a name="l00534"></a>00534     {
<a name="l00535"></a>00535       <span class="keywordflow">if</span> (mtype != ospf-&gt;<a class="code" href="structospf.html#a469871fc51798a2de7e3b19ada21d8ce">dmetric</a>[type].<a class="code" href="structospf.html#adcc2e8439120b1f4144a6be8d702f638">type</a>)
<a name="l00536"></a>00536         {
<a name="l00537"></a>00537           ospf-&gt;<a class="code" href="structospf.html#a469871fc51798a2de7e3b19ada21d8ce">dmetric</a>[<a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a>].<a class="code" href="structospf.html#adcc2e8439120b1f4144a6be8d702f638">type</a> = mtype;
<a name="l00538"></a>00538           force = <a class="code" href="ospf__lsa_8h.html#a389234e05af4a29be76c63dc46576791">LSA_REFRESH_FORCE</a>;
<a name="l00539"></a>00539         }
<a name="l00540"></a>00540       <span class="keywordflow">if</span> (mvalue != ospf-&gt;<a class="code" href="structospf.html#a469871fc51798a2de7e3b19ada21d8ce">dmetric</a>[type].<a class="code" href="structospf.html#a2bd05e59ebe8b6b342e19562d55a8a10">value</a>)
<a name="l00541"></a>00541         {
<a name="l00542"></a>00542           ospf-&gt;<a class="code" href="structospf.html#a469871fc51798a2de7e3b19ada21d8ce">dmetric</a>[<a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a>].<a class="code" href="structospf.html#a2bd05e59ebe8b6b342e19562d55a8a10">value</a> = mvalue;
<a name="l00543"></a>00543           force = <a class="code" href="ospf__lsa_8h.html#a389234e05af4a29be76c63dc46576791">LSA_REFRESH_FORCE</a>;
<a name="l00544"></a>00544         }
<a name="l00545"></a>00545 
<a name="l00546"></a>00546       <a class="code" href="ospf__lsa_8c.html#aef94b25c2a2fad9088e82a85ee71f226">ospf_external_lsa_refresh_type</a> (ospf, type, force);
<a name="l00547"></a>00547 
<a name="l00548"></a>00548       <span class="keywordflow">if</span> (<a class="code" href="ospf__dump_8h.html#a065e478fcd8bd7a409804fc9e9e67e70">IS_DEBUG_OSPF</a> (<a class="code" href="bgp__debug_8c.html#aacd09dfe4b60fac4ec1c5e2895066f07">zebra</a>, ZEBRA_REDISTRIBUTE))
<a name="l00549"></a>00549         <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;Redistribute[%s]: Refresh  Type[%d], Metric[%d]&quot;</span>,
<a name="l00550"></a>00550                    <a class="code" href="ospf__dump_8c.html#ac9f0bcaf160e328b6acb2c361dfa5002">ospf_redist_string</a>(type),
<a name="l00551"></a>00551                    <a class="code" href="ospf__lsa_8c.html#a10781678cf0418caa60ce806cb18f7f1">metric_type</a> (ospf, type), <a class="code" href="ospf__lsa_8c.html#aebf4067916a42ca176b32e7dbb15621d">metric_value</a> (ospf, type));
<a name="l00552"></a>00552 
<a name="l00553"></a>00553       <span class="keywordflow">return</span> <a class="code" href="command_8h.html#aa2008c1bc36d9ef42571a6ec52516d02">CMD_SUCCESS</a>;
<a name="l00554"></a>00554     }
<a name="l00555"></a>00555 
<a name="l00556"></a>00556   ospf-&gt;<a class="code" href="structospf.html#a469871fc51798a2de7e3b19ada21d8ce">dmetric</a>[<a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a>].<a class="code" href="structospf.html#adcc2e8439120b1f4144a6be8d702f638">type</a> = mtype;
<a name="l00557"></a>00557   ospf-&gt;<a class="code" href="structospf.html#a469871fc51798a2de7e3b19ada21d8ce">dmetric</a>[<a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a>].<a class="code" href="structospf.html#a2bd05e59ebe8b6b342e19562d55a8a10">value</a> = mvalue;
<a name="l00558"></a>00558 
<a name="l00559"></a>00559   <a class="code" href="zclient_8c.html#a4381afa78256a1211fe7881394d7e666">zclient_redistribute</a> (<a class="code" href="zebra_8h.html#aaf00306d6060095dd258463ee7cb0cc1">ZEBRA_REDISTRIBUTE_ADD</a>, zclient, type);
<a name="l00560"></a>00560 
<a name="l00561"></a>00561   <span class="keywordflow">if</span> (<a class="code" href="ospf__dump_8h.html#a065e478fcd8bd7a409804fc9e9e67e70">IS_DEBUG_OSPF</a> (<a class="code" href="bgp__debug_8c.html#aacd09dfe4b60fac4ec1c5e2895066f07">zebra</a>, ZEBRA_REDISTRIBUTE))
<a name="l00562"></a>00562     <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;Redistribute[%s]: Start  Type[%d], Metric[%d]&quot;</span>,
<a name="l00563"></a>00563                <a class="code" href="ospf__dump_8c.html#ac9f0bcaf160e328b6acb2c361dfa5002">ospf_redist_string</a>(type),
<a name="l00564"></a>00564                <a class="code" href="ospf__lsa_8c.html#a10781678cf0418caa60ce806cb18f7f1">metric_type</a> (ospf, type), <a class="code" href="ospf__lsa_8c.html#aebf4067916a42ca176b32e7dbb15621d">metric_value</a> (ospf, type));
<a name="l00565"></a>00565 
<a name="l00566"></a>00566   <a class="code" href="ospf__asbr_8c.html#a15ef7b9d7fd4f1120453e770c076160a">ospf_asbr_status_update</a> (ospf, ++ospf-&gt;<a class="code" href="structospf.html#a298631df5a443358670e6415175f2251">redistribute</a>);
<a name="l00567"></a>00567 
<a name="l00568"></a>00568   <span class="keywordflow">return</span> <a class="code" href="command_8h.html#aa2008c1bc36d9ef42571a6ec52516d02">CMD_SUCCESS</a>;
<a name="l00569"></a>00569 }
<a name="l00570"></a>00570 
<a name="l00571"></a>00571 <span class="keywordtype">int</span>
<a name="l00572"></a><a class="code" href="ospf__zebra_8h.html#ac4ae9d6022d66a288a10b9c4d92c72f3">00572</a> <a class="code" href="ospf__zebra_8c.html#ad4e2f81ba398e7d54e102e7f8b8715be">ospf_redistribute_unset</a> (<span class="keyword">struct</span> <a class="code" href="structospf.html">ospf</a> *<a class="code" href="structospf.html">ospf</a>, <span class="keywordtype">int</span> <a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a>)
<a name="l00573"></a>00573 {
<a name="l00574"></a>00574   <span class="keywordflow">if</span> (type == zclient-&gt;<a class="code" href="structzclient.html#a7c2ac97dd71c8f3a0db036c6c0216208">redist_default</a>)
<a name="l00575"></a>00575     <span class="keywordflow">return</span> <a class="code" href="command_8h.html#aa2008c1bc36d9ef42571a6ec52516d02">CMD_SUCCESS</a>;
<a name="l00576"></a>00576 
<a name="l00577"></a>00577   <span class="keywordflow">if</span> (!<a class="code" href="ospf__zebra_8c.html#a0b61d95e6baf19bdd9d8a7705788a226">ospf_is_type_redistributed</a> (type))
<a name="l00578"></a>00578     <span class="keywordflow">return</span> <a class="code" href="command_8h.html#aa2008c1bc36d9ef42571a6ec52516d02">CMD_SUCCESS</a>;
<a name="l00579"></a>00579 
<a name="l00580"></a>00580   <a class="code" href="zclient_8c.html#a4381afa78256a1211fe7881394d7e666">zclient_redistribute</a> (<a class="code" href="zebra_8h.html#a1dce1941aae01a8a16dace7591398a0d">ZEBRA_REDISTRIBUTE_DELETE</a>, zclient, type);
<a name="l00581"></a>00581 
<a name="l00582"></a>00582   <span class="keywordflow">if</span> (<a class="code" href="ospf__dump_8h.html#a065e478fcd8bd7a409804fc9e9e67e70">IS_DEBUG_OSPF</a> (<a class="code" href="bgp__debug_8c.html#aacd09dfe4b60fac4ec1c5e2895066f07">zebra</a>, ZEBRA_REDISTRIBUTE))
<a name="l00583"></a>00583     <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;Redistribute[%s]: Stop&quot;</span>,
<a name="l00584"></a>00584                <a class="code" href="ospf__dump_8c.html#ac9f0bcaf160e328b6acb2c361dfa5002">ospf_redist_string</a>(type));
<a name="l00585"></a>00585 
<a name="l00586"></a>00586   ospf-&gt;<a class="code" href="structospf.html#a469871fc51798a2de7e3b19ada21d8ce">dmetric</a>[<a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a>].<a class="code" href="structospf.html#adcc2e8439120b1f4144a6be8d702f638">type</a> = -1;
<a name="l00587"></a>00587   ospf-&gt;<a class="code" href="structospf.html#a469871fc51798a2de7e3b19ada21d8ce">dmetric</a>[<a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a>].<a class="code" href="structospf.html#a2bd05e59ebe8b6b342e19562d55a8a10">value</a> = -1;
<a name="l00588"></a>00588 
<a name="l00589"></a>00589   <span class="comment">/* Remove the routes from OSPF table. */</span>
<a name="l00590"></a>00590   <a class="code" href="ospf__asbr_8c.html#a2e66aff41931c30bba7072e26e34bf12">ospf_redistribute_withdraw</a> (ospf, type);
<a name="l00591"></a>00591 
<a name="l00592"></a>00592   <a class="code" href="ospf__asbr_8c.html#a15ef7b9d7fd4f1120453e770c076160a">ospf_asbr_status_update</a> (ospf, --ospf-&gt;<a class="code" href="structospf.html#a298631df5a443358670e6415175f2251">redistribute</a>);
<a name="l00593"></a>00593 
<a name="l00594"></a>00594   <span class="keywordflow">return</span> <a class="code" href="command_8h.html#aa2008c1bc36d9ef42571a6ec52516d02">CMD_SUCCESS</a>;
<a name="l00595"></a>00595 }
<a name="l00596"></a>00596 
<a name="l00597"></a>00597 <span class="keywordtype">int</span>
<a name="l00598"></a><a class="code" href="ospf__zebra_8h.html#a7fce012a67bcc248e1c5ae21fd7c22c1">00598</a> <a class="code" href="ospf__zebra_8c.html#a8b96216df94c4c5b348d2ef747f93473">ospf_redistribute_default_set</a> (<span class="keyword">struct</span> <a class="code" href="structospf.html">ospf</a> *<a class="code" href="structospf.html">ospf</a>, <span class="keywordtype">int</span> originate,
<a name="l00599"></a>00599                                <span class="keywordtype">int</span> mtype, <span class="keywordtype">int</span> mvalue)
<a name="l00600"></a>00600 {
<a name="l00601"></a>00601   ospf-&gt;<a class="code" href="structospf.html#a1111f78d01dc9e8d522e639da7a2a36c">default_originate</a> = originate;
<a name="l00602"></a>00602   ospf-&gt;<a class="code" href="structospf.html#a469871fc51798a2de7e3b19ada21d8ce">dmetric</a>[<a class="code" href="ospf__zebra_8h.html#a353195a6a59d18a6807885cbefaf0d24">DEFAULT_ROUTE</a>].<a class="code" href="structospf.html#adcc2e8439120b1f4144a6be8d702f638">type</a> = mtype;
<a name="l00603"></a>00603   ospf-&gt;<a class="code" href="structospf.html#a469871fc51798a2de7e3b19ada21d8ce">dmetric</a>[<a class="code" href="ospf__zebra_8h.html#a353195a6a59d18a6807885cbefaf0d24">DEFAULT_ROUTE</a>].<a class="code" href="structospf.html#a2bd05e59ebe8b6b342e19562d55a8a10">value</a> = mvalue;
<a name="l00604"></a>00604 
<a name="l00605"></a>00605   <span class="keywordflow">if</span> (<a class="code" href="ospf__zebra_8c.html#a0b61d95e6baf19bdd9d8a7705788a226">ospf_is_type_redistributed</a> (<a class="code" href="ospf__zebra_8h.html#a353195a6a59d18a6807885cbefaf0d24">DEFAULT_ROUTE</a>))
<a name="l00606"></a>00606     {
<a name="l00607"></a>00607       <span class="comment">/* if ospf-&gt;default_originate changes value, is calling</span>
<a name="l00608"></a>00608 <span class="comment">     ospf_external_lsa_refresh_default sufficient to implement</span>
<a name="l00609"></a>00609 <span class="comment">     the change? */</span>
<a name="l00610"></a>00610       <a class="code" href="ospf__lsa_8c.html#a1be6376d9b23634a76f2a6a07833fe1e">ospf_external_lsa_refresh_default</a> (ospf);
<a name="l00611"></a>00611 
<a name="l00612"></a>00612       <span class="keywordflow">if</span> (<a class="code" href="ospf__dump_8h.html#a065e478fcd8bd7a409804fc9e9e67e70">IS_DEBUG_OSPF</a> (<a class="code" href="bgp__debug_8c.html#aacd09dfe4b60fac4ec1c5e2895066f07">zebra</a>, ZEBRA_REDISTRIBUTE))
<a name="l00613"></a>00613         <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;Redistribute[%s]: Refresh  Type[%d], Metric[%d]&quot;</span>,
<a name="l00614"></a>00614                    <a class="code" href="ospf__dump_8c.html#ac9f0bcaf160e328b6acb2c361dfa5002">ospf_redist_string</a>(<a class="code" href="ospf__zebra_8h.html#a353195a6a59d18a6807885cbefaf0d24">DEFAULT_ROUTE</a>),
<a name="l00615"></a>00615                    <a class="code" href="ospf__lsa_8c.html#a10781678cf0418caa60ce806cb18f7f1">metric_type</a> (ospf, <a class="code" href="ospf__zebra_8h.html#a353195a6a59d18a6807885cbefaf0d24">DEFAULT_ROUTE</a>),
<a name="l00616"></a>00616                    <a class="code" href="ospf__lsa_8c.html#aebf4067916a42ca176b32e7dbb15621d">metric_value</a> (ospf, <a class="code" href="ospf__zebra_8h.html#a353195a6a59d18a6807885cbefaf0d24">DEFAULT_ROUTE</a>));
<a name="l00617"></a>00617       <span class="keywordflow">return</span> <a class="code" href="command_8h.html#aa2008c1bc36d9ef42571a6ec52516d02">CMD_SUCCESS</a>;
<a name="l00618"></a>00618     }
<a name="l00619"></a>00619 
<a name="l00620"></a>00620   <a class="code" href="zclient_8c.html#a2d2c4a009144e592b06b55055ab9c38e">zclient_redistribute_default</a> (<a class="code" href="zebra_8h.html#a6a54e4c8e5f637b9edb208de808a2ac6">ZEBRA_REDISTRIBUTE_DEFAULT_ADD</a>, zclient);
<a name="l00621"></a>00621 
<a name="l00622"></a>00622   <span class="keywordflow">if</span> (<a class="code" href="ospf__dump_8h.html#a065e478fcd8bd7a409804fc9e9e67e70">IS_DEBUG_OSPF</a> (<a class="code" href="bgp__debug_8c.html#aacd09dfe4b60fac4ec1c5e2895066f07">zebra</a>, ZEBRA_REDISTRIBUTE))
<a name="l00623"></a>00623     <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;Redistribute[DEFAULT]: Start  Type[%d], Metric[%d]&quot;</span>,
<a name="l00624"></a>00624                <a class="code" href="ospf__lsa_8c.html#a10781678cf0418caa60ce806cb18f7f1">metric_type</a> (ospf, <a class="code" href="ospf__zebra_8h.html#a353195a6a59d18a6807885cbefaf0d24">DEFAULT_ROUTE</a>),
<a name="l00625"></a>00625                <a class="code" href="ospf__lsa_8c.html#aebf4067916a42ca176b32e7dbb15621d">metric_value</a> (ospf, <a class="code" href="ospf__zebra_8h.html#a353195a6a59d18a6807885cbefaf0d24">DEFAULT_ROUTE</a>));
<a name="l00626"></a>00626 
<a name="l00627"></a>00627   <span class="keywordflow">if</span> (ospf-&gt;<a class="code" href="structospf.html#acda9328f4f8627516f5c4942a45b4c25">router_id</a>.s_addr == 0)
<a name="l00628"></a>00628     ospf-&gt;<a class="code" href="structospf.html#a4e2d4fb95c750aeddee77669b7073e86">external_origin</a> |= (1 &lt;&lt; <a class="code" href="ospf__zebra_8h.html#a353195a6a59d18a6807885cbefaf0d24">DEFAULT_ROUTE</a>);
<a name="l00629"></a>00629   <span class="keywordflow">else</span>
<a name="l00630"></a>00630     <a class="code" href="thread_8h.html#aca77b3bbd166d3573de5ecd9756a590c">thread_add_timer</a> (master, <a class="code" href="ospf__lsa_8c.html#ab2bcb8bca8aa169076de0505e3ddad72">ospf_default_originate_timer</a>, ospf, 1);
<a name="l00631"></a>00631 
<a name="l00632"></a>00632   <a class="code" href="ospf__asbr_8c.html#a15ef7b9d7fd4f1120453e770c076160a">ospf_asbr_status_update</a> (ospf, ++ospf-&gt;<a class="code" href="structospf.html#a298631df5a443358670e6415175f2251">redistribute</a>);
<a name="l00633"></a>00633 
<a name="l00634"></a>00634   <span class="keywordflow">return</span> <a class="code" href="command_8h.html#aa2008c1bc36d9ef42571a6ec52516d02">CMD_SUCCESS</a>;
<a name="l00635"></a>00635 }
<a name="l00636"></a>00636 
<a name="l00637"></a>00637 <span class="keywordtype">int</span>
<a name="l00638"></a><a class="code" href="ospf__zebra_8h.html#a20ebb383b13958bdf4b9f86397efaa3d">00638</a> <a class="code" href="ospf__zebra_8c.html#aed80a1c3db7d07002fce735375188fb5">ospf_redistribute_default_unset</a> (<span class="keyword">struct</span> <a class="code" href="structospf.html">ospf</a> *<a class="code" href="structospf.html">ospf</a>)
<a name="l00639"></a>00639 {
<a name="l00640"></a>00640   <span class="keywordflow">if</span> (!<a class="code" href="ospf__zebra_8c.html#a0b61d95e6baf19bdd9d8a7705788a226">ospf_is_type_redistributed</a> (<a class="code" href="ospf__zebra_8h.html#a353195a6a59d18a6807885cbefaf0d24">DEFAULT_ROUTE</a>))
<a name="l00641"></a>00641     <span class="keywordflow">return</span> <a class="code" href="command_8h.html#aa2008c1bc36d9ef42571a6ec52516d02">CMD_SUCCESS</a>;
<a name="l00642"></a>00642 
<a name="l00643"></a>00643   ospf-&gt;<a class="code" href="structospf.html#a1111f78d01dc9e8d522e639da7a2a36c">default_originate</a> = <a class="code" href="ospfd_8h.html#a2cb5991aff286dfe8d5b67d9730e0c81">DEFAULT_ORIGINATE_NONE</a>;
<a name="l00644"></a>00644   ospf-&gt;<a class="code" href="structospf.html#a469871fc51798a2de7e3b19ada21d8ce">dmetric</a>[<a class="code" href="ospf__zebra_8h.html#a353195a6a59d18a6807885cbefaf0d24">DEFAULT_ROUTE</a>].<a class="code" href="structospf.html#adcc2e8439120b1f4144a6be8d702f638">type</a> = -1;
<a name="l00645"></a>00645   ospf-&gt;<a class="code" href="structospf.html#a469871fc51798a2de7e3b19ada21d8ce">dmetric</a>[<a class="code" href="ospf__zebra_8h.html#a353195a6a59d18a6807885cbefaf0d24">DEFAULT_ROUTE</a>].<a class="code" href="structospf.html#a2bd05e59ebe8b6b342e19562d55a8a10">value</a> = -1;
<a name="l00646"></a>00646 
<a name="l00647"></a>00647   <a class="code" href="zclient_8c.html#a2d2c4a009144e592b06b55055ab9c38e">zclient_redistribute_default</a> (<a class="code" href="zebra_8h.html#a2fd9f5c25e3e2e28a03047807f20e246">ZEBRA_REDISTRIBUTE_DEFAULT_DELETE</a>, zclient);
<a name="l00648"></a>00648 
<a name="l00649"></a>00649   <span class="keywordflow">if</span> (<a class="code" href="ospf__dump_8h.html#a065e478fcd8bd7a409804fc9e9e67e70">IS_DEBUG_OSPF</a> (<a class="code" href="bgp__debug_8c.html#aacd09dfe4b60fac4ec1c5e2895066f07">zebra</a>, ZEBRA_REDISTRIBUTE))
<a name="l00650"></a>00650     <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;Redistribute[DEFAULT]: Stop&quot;</span>);
<a name="l00651"></a>00651 
<a name="l00652"></a>00652   <a class="code" href="ospf__asbr_8c.html#a15ef7b9d7fd4f1120453e770c076160a">ospf_asbr_status_update</a> (ospf, --ospf-&gt;<a class="code" href="structospf.html#a298631df5a443358670e6415175f2251">redistribute</a>);
<a name="l00653"></a>00653 
<a name="l00654"></a>00654   <span class="keywordflow">return</span> <a class="code" href="command_8h.html#aa2008c1bc36d9ef42571a6ec52516d02">CMD_SUCCESS</a>;
<a name="l00655"></a>00655 }
<a name="l00656"></a>00656 
<a name="l00657"></a>00657 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00658"></a><a class="code" href="ospf__zebra_8c.html#a104b0443520d077cb0f1626f2bf6e735">00658</a> <a class="code" href="ospf__zebra_8c.html#a104b0443520d077cb0f1626f2bf6e735">ospf_external_lsa_originate_check</a> (<span class="keyword">struct</span> <a class="code" href="structospf.html">ospf</a> *<a class="code" href="structospf.html">ospf</a>,
<a name="l00659"></a>00659                                    <span class="keyword">struct</span> <a class="code" href="structexternal__info.html">external_info</a> *ei)
<a name="l00660"></a>00660 {
<a name="l00661"></a>00661   <span class="comment">/* If prefix is multicast, then do not originate LSA. */</span>
<a name="l00662"></a>00662   <span class="keywordflow">if</span> (IN_MULTICAST (htonl (ei-&gt;<a class="code" href="structexternal__info.html#a15eb7ea975a1090a107d7d54b798822c">p</a>.prefix.s_addr)))
<a name="l00663"></a>00663     {
<a name="l00664"></a>00664       <a class="code" href="log_8h.html#a383184727341e7ad985deb9e4f2156c7">zlog_info</a> (<span class="stringliteral">&quot;LSA[Type5:%s]: Not originate AS-external-LSA, &quot;</span>
<a name="l00665"></a>00665                  <span class="stringliteral">&quot;Prefix belongs multicast&quot;</span>, inet_ntoa (ei-&gt;<a class="code" href="structexternal__info.html#a15eb7ea975a1090a107d7d54b798822c">p</a>.prefix));
<a name="l00666"></a>00666       <span class="keywordflow">return</span> 0;
<a name="l00667"></a>00667     }
<a name="l00668"></a>00668 
<a name="l00669"></a>00669   <span class="comment">/* Take care of default-originate. */</span>
<a name="l00670"></a>00670   <span class="keywordflow">if</span> (<a class="code" href="ospf__lsa_8c.html#ab361b6fb4bed2a417afb49ae46bae391">is_prefix_default</a> (&amp;ei-&gt;<a class="code" href="structexternal__info.html#a15eb7ea975a1090a107d7d54b798822c">p</a>))
<a name="l00671"></a>00671     <span class="keywordflow">if</span> (ospf-&gt;<a class="code" href="structospf.html#a1111f78d01dc9e8d522e639da7a2a36c">default_originate</a> == <a class="code" href="ospfd_8h.html#a2cb5991aff286dfe8d5b67d9730e0c81">DEFAULT_ORIGINATE_NONE</a>)
<a name="l00672"></a>00672       {
<a name="l00673"></a>00673         <a class="code" href="log_8h.html#a383184727341e7ad985deb9e4f2156c7">zlog_info</a> (<span class="stringliteral">&quot;LSA[Type5:0.0.0.0]: Not originate AS-exntenal-LSA &quot;</span>
<a name="l00674"></a>00674                    <span class="stringliteral">&quot;for default&quot;</span>);
<a name="l00675"></a>00675         <span class="keywordflow">return</span> 0;
<a name="l00676"></a>00676       }
<a name="l00677"></a>00677 
<a name="l00678"></a>00678   <span class="keywordflow">return</span> 1;
<a name="l00679"></a>00679 }
<a name="l00680"></a>00680 
<a name="l00681"></a>00681 <span class="comment">/* If connected prefix is OSPF enable interface, then do not announce. */</span>
<a name="l00682"></a>00682 <span class="keywordtype">int</span>
<a name="l00683"></a><a class="code" href="ospf__zebra_8h.html#a71a523629f18d369ee982ef3ee27dede">00683</a> <a class="code" href="ospf__zebra_8c.html#a92dcc57e677b842ee7ce321d7cbae5e3">ospf_distribute_check_connected</a> (<span class="keyword">struct</span> <a class="code" href="structospf.html">ospf</a> *<a class="code" href="structospf.html">ospf</a>, <span class="keyword">struct</span> <a class="code" href="structexternal__info.html">external_info</a> *ei)
<a name="l00684"></a>00684 {
<a name="l00685"></a>00685   <span class="keyword">struct </span><a class="code" href="structlistnode.html">listnode</a> *node;
<a name="l00686"></a>00686   <span class="keyword">struct </span><a class="code" href="structospf__interface.html">ospf_interface</a> *oi;
<a name="l00687"></a>00687 
<a name="l00688"></a>00688 
<a name="l00689"></a>00689   <span class="keywordflow">for</span> (<a class="code" href="linklist_8h.html#a80a3f4035be83abbb709d17412993226">ALL_LIST_ELEMENTS_RO</a> (ospf-&gt;<a class="code" href="structospf.html#a977d3608343fe5db7900ec646880cb6a">oiflist</a>, node, oi))
<a name="l00690"></a>00690       <span class="keywordflow">if</span> (<a class="code" href="prefix_8c.html#a8c5d68665a4b036a361330bee254318e">prefix_match</a> (oi-&gt;<a class="code" href="structospf__interface.html#a43493bc2b5d951e3e38ace850332eca1">address</a>, (<span class="keyword">struct</span> <a class="code" href="structprefix.html">prefix</a> *) &amp;ei-&gt;<a class="code" href="structexternal__info.html#a15eb7ea975a1090a107d7d54b798822c">p</a>))
<a name="l00691"></a>00691           <span class="keywordflow">return</span> 0;
<a name="l00692"></a>00692   <span class="keywordflow">return</span> 1;
<a name="l00693"></a>00693 }
<a name="l00694"></a>00694 
<a name="l00695"></a>00695 <span class="comment">/* return 1 if external LSA must be originated, 0 otherwise */</span>
<a name="l00696"></a>00696 <span class="keywordtype">int</span>
<a name="l00697"></a><a class="code" href="ospf__zebra_8h.html#a73de8c9ab147f3c8b6f4537d83582a60">00697</a> <a class="code" href="ospf__zebra_8c.html#a7568b2d6ccc3687ad4a001cd142c4f6d">ospf_redistribute_check</a> (<span class="keyword">struct</span> <a class="code" href="structospf.html">ospf</a> *<a class="code" href="structospf.html">ospf</a>,
<a name="l00698"></a>00698                          <span class="keyword">struct</span> <a class="code" href="structexternal__info.html">external_info</a> *ei, <span class="keywordtype">int</span> *changed)
<a name="l00699"></a>00699 {
<a name="l00700"></a>00700   <span class="keyword">struct </span><a class="code" href="structroute__map__set__values.html">route_map_set_values</a> save_values;
<a name="l00701"></a>00701   <span class="keyword">struct </span><a class="code" href="structprefix__ipv4.html">prefix_ipv4</a> *<a class="code" href="spgrid_8c.html#a931bc2aa940ac2a4d1601cf842336926">p</a> = &amp;ei-&gt;<a class="code" href="structexternal__info.html#a15eb7ea975a1090a107d7d54b798822c">p</a>;
<a name="l00702"></a>00702   u_char <a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a> = <a class="code" href="ospf__lsa_8c.html#ab361b6fb4bed2a417afb49ae46bae391">is_prefix_default</a> (&amp;ei-&gt;<a class="code" href="structexternal__info.html#a15eb7ea975a1090a107d7d54b798822c">p</a>) ? <a class="code" href="ospf__zebra_8h.html#a353195a6a59d18a6807885cbefaf0d24">DEFAULT_ROUTE</a> : ei-&gt;<a class="code" href="structexternal__info.html#ad815e4322555ec84d18056c00745008f">type</a>;
<a name="l00703"></a>00703 
<a name="l00704"></a>00704   <span class="keywordflow">if</span> (changed)
<a name="l00705"></a>00705     *changed = 0;
<a name="l00706"></a>00706 
<a name="l00707"></a>00707   <span class="keywordflow">if</span> (!<a class="code" href="ospf__zebra_8c.html#a104b0443520d077cb0f1626f2bf6e735">ospf_external_lsa_originate_check</a> (ospf, ei))
<a name="l00708"></a>00708     <span class="keywordflow">return</span> 0;
<a name="l00709"></a>00709 
<a name="l00710"></a>00710   <span class="comment">/* Take care connected route. */</span>
<a name="l00711"></a>00711   <span class="keywordflow">if</span> (type == <a class="code" href="zebra_8h.html#aee45d53cdac2bd7fe4b2ce021c9d1b30">ZEBRA_ROUTE_CONNECT</a> &amp;&amp;
<a name="l00712"></a>00712       !<a class="code" href="ospf__zebra_8c.html#a92dcc57e677b842ee7ce321d7cbae5e3">ospf_distribute_check_connected</a> (ospf, ei))
<a name="l00713"></a>00713     <span class="keywordflow">return</span> 0;
<a name="l00714"></a>00714 
<a name="l00715"></a>00715   <span class="keywordflow">if</span> (!<a class="code" href="ospf__zebra_8h.html#a3ccd23195e60a2a4007fafb6a54e1a4e">DEFAULT_ROUTE_TYPE</a> (type) &amp;&amp; <a class="code" href="ospfd_8h.html#a21d66b4ea7498172da5521cf0445110e">DISTRIBUTE_NAME</a> (ospf, type))
<a name="l00716"></a>00716     <span class="comment">/* distirbute-list exists, but access-list may not? */</span>
<a name="l00717"></a>00717     <span class="keywordflow">if</span> (<a class="code" href="ospfd_8h.html#a96719238490e0edd9331bdeae79c190f">DISTRIBUTE_LIST</a> (ospf, type))
<a name="l00718"></a>00718       <span class="keywordflow">if</span> (<a class="code" href="filter_8c.html#a5565f487c65e2bf0308c7fd529f121a0">access_list_apply</a> (<a class="code" href="ospfd_8h.html#a96719238490e0edd9331bdeae79c190f">DISTRIBUTE_LIST</a> (ospf, type), p) == <a class="code" href="filter_8h.html#ab3b7281956317556f846daaebf75de72a898abadf6cc2f9d27780782f09d3a3e3">FILTER_DENY</a>)
<a name="l00719"></a>00719         {
<a name="l00720"></a>00720           <span class="keywordflow">if</span> (<a class="code" href="ospf__dump_8h.html#a065e478fcd8bd7a409804fc9e9e67e70">IS_DEBUG_OSPF</a> (<a class="code" href="bgp__debug_8c.html#aacd09dfe4b60fac4ec1c5e2895066f07">zebra</a>, ZEBRA_REDISTRIBUTE))
<a name="l00721"></a>00721             <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;Redistribute[%s]: %s/%d filtered by ditribute-list.&quot;</span>,
<a name="l00722"></a>00722                        <a class="code" href="ospf__dump_8c.html#ac9f0bcaf160e328b6acb2c361dfa5002">ospf_redist_string</a>(type),
<a name="l00723"></a>00723                        inet_ntoa (p-&gt;prefix), p-&gt;<a class="code" href="structprefix__ipv4.html#ab96da4bf1eb37195bd564bcf1126a16a">prefixlen</a>);
<a name="l00724"></a>00724           <span class="keywordflow">return</span> 0;
<a name="l00725"></a>00725         }
<a name="l00726"></a>00726 
<a name="l00727"></a>00727   save_values = ei-&gt;<a class="code" href="structexternal__info.html#ab1eb40ea0eff4aa76fc3e0c815bb9839">route_map_set</a>;
<a name="l00728"></a>00728   <a class="code" href="ospf__asbr_8c.html#aa4b664d1d2931e548f1e0803d00549ec">ospf_reset_route_map_set_values</a> (&amp;ei-&gt;<a class="code" href="structexternal__info.html#ab1eb40ea0eff4aa76fc3e0c815bb9839">route_map_set</a>);
<a name="l00729"></a>00729 
<a name="l00730"></a>00730   <span class="comment">/* apply route-map if needed */</span>
<a name="l00731"></a>00731   <span class="keywordflow">if</span> (<a class="code" href="ospfd_8h.html#a5c462a148a6cd728dcf50a1d7cc18804">ROUTEMAP_NAME</a> (ospf, type))
<a name="l00732"></a>00732     {
<a name="l00733"></a>00733       <span class="keywordtype">int</span> ret;
<a name="l00734"></a>00734 
<a name="l00735"></a>00735       ret = <a class="code" href="routemap_8c.html#a3372553a024332702cfd603e1f4c08d6">route_map_apply</a> (<a class="code" href="ospfd_8h.html#afdae06aa57f00f3f4e3fd12055ead548">ROUTEMAP</a> (ospf, type), (<span class="keyword">struct</span> <a class="code" href="structprefix.html">prefix</a> *) p,
<a name="l00736"></a>00736                              <a class="code" href="routemap_8h.html#ae21439463f873ce0ce1556c9d6fa7370a4284b205cb07374b45edb0fa25b8b064">RMAP_OSPF</a>, ei);
<a name="l00737"></a>00737 
<a name="l00738"></a>00738       <span class="keywordflow">if</span> (ret == <a class="code" href="routemap_8h.html#afd7345bfd662f1e7c77f0be351cd1516aa0f40f0a91e43bfe7131839fe179ac64">RMAP_DENYMATCH</a>)
<a name="l00739"></a>00739         {
<a name="l00740"></a>00740           ei-&gt;<a class="code" href="structexternal__info.html#ab1eb40ea0eff4aa76fc3e0c815bb9839">route_map_set</a> = save_values;
<a name="l00741"></a>00741           <span class="keywordflow">if</span> (<a class="code" href="ospf__dump_8h.html#a065e478fcd8bd7a409804fc9e9e67e70">IS_DEBUG_OSPF</a> (<a class="code" href="bgp__debug_8c.html#aacd09dfe4b60fac4ec1c5e2895066f07">zebra</a>, ZEBRA_REDISTRIBUTE))
<a name="l00742"></a>00742             <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;Redistribute[%s]: %s/%d filtered by route-map.&quot;</span>,
<a name="l00743"></a>00743                        <a class="code" href="ospf__dump_8c.html#ac9f0bcaf160e328b6acb2c361dfa5002">ospf_redist_string</a>(type),
<a name="l00744"></a>00744                        inet_ntoa (p-&gt;<a class="code" href="structprefix.html#af508982a05429729278c96708bd9e337">prefix</a>), p-&gt;<a class="code" href="structprefix.html#aae8dafba4797d25cf1d141780d87ff02">prefixlen</a>);
<a name="l00745"></a>00745           <span class="keywordflow">return</span> 0;
<a name="l00746"></a>00746         }
<a name="l00747"></a>00747 
<a name="l00748"></a>00748       <span class="comment">/* check if &#39;route-map set&#39; changed something */</span>
<a name="l00749"></a>00749       <span class="keywordflow">if</span> (changed)
<a name="l00750"></a>00750         *changed = !<a class="code" href="ospf__asbr_8c.html#a09c629a907b15a7997bda76039ec73cd">ospf_route_map_set_compare</a> (&amp;ei-&gt;<a class="code" href="structexternal__info.html#ab1eb40ea0eff4aa76fc3e0c815bb9839">route_map_set</a>,
<a name="l00751"></a>00751                                                 &amp;save_values);
<a name="l00752"></a>00752     }
<a name="l00753"></a>00753 
<a name="l00754"></a>00754   <span class="keywordflow">return</span> 1;
<a name="l00755"></a>00755 }
<a name="l00756"></a>00756 
<a name="l00757"></a>00757 <span class="comment">/* OSPF route-map set for redistribution */</span>
<a name="l00758"></a>00758 <span class="keywordtype">void</span>
<a name="l00759"></a><a class="code" href="ospf__zebra_8h.html#ac31d7000bbff95e3cc462e4880c4ef93">00759</a> <a class="code" href="ospf__zebra_8c.html#aeab30313d326fbb9a7bea8fbaaedc269">ospf_routemap_set</a> (<span class="keyword">struct</span> <a class="code" href="structospf.html">ospf</a> *<a class="code" href="structospf.html">ospf</a>, <span class="keywordtype">int</span> <a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="memory_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>)
<a name="l00760"></a>00760 {
<a name="l00761"></a>00761   <span class="keywordflow">if</span> (<a class="code" href="ospfd_8h.html#a5c462a148a6cd728dcf50a1d7cc18804">ROUTEMAP_NAME</a> (ospf, type))
<a name="l00762"></a>00762     free (<a class="code" href="ospfd_8h.html#a5c462a148a6cd728dcf50a1d7cc18804">ROUTEMAP_NAME</a> (ospf, type));
<a name="l00763"></a>00763 
<a name="l00764"></a>00764   <a class="code" href="ospfd_8h.html#a5c462a148a6cd728dcf50a1d7cc18804">ROUTEMAP_NAME</a> (ospf, type) = strdup (name);
<a name="l00765"></a>00765   <a class="code" href="ospfd_8h.html#afdae06aa57f00f3f4e3fd12055ead548">ROUTEMAP</a> (ospf, type) = <a class="code" href="routemap_8c.html#a52006340e589dda4244d35cafc9f6f10">route_map_lookup_by_name</a> (name);
<a name="l00766"></a>00766 }
<a name="l00767"></a>00767 
<a name="l00768"></a>00768 <span class="keywordtype">void</span>
<a name="l00769"></a><a class="code" href="ospf__zebra_8h.html#af309a974bddf58ee6ec7a3fdc0078769">00769</a> <a class="code" href="ospf__zebra_8c.html#a43f47b8284073d5a9b54b2f12c57c2dd">ospf_routemap_unset</a> (<span class="keyword">struct</span> <a class="code" href="structospf.html">ospf</a> *<a class="code" href="structospf.html">ospf</a>, <span class="keywordtype">int</span> <a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a>)
<a name="l00770"></a>00770 {
<a name="l00771"></a>00771   <span class="keywordflow">if</span> (<a class="code" href="ospfd_8h.html#a5c462a148a6cd728dcf50a1d7cc18804">ROUTEMAP_NAME</a> (ospf, type))
<a name="l00772"></a>00772     free (<a class="code" href="ospfd_8h.html#a5c462a148a6cd728dcf50a1d7cc18804">ROUTEMAP_NAME</a> (ospf, type));
<a name="l00773"></a>00773 
<a name="l00774"></a>00774   <a class="code" href="ospfd_8h.html#a5c462a148a6cd728dcf50a1d7cc18804">ROUTEMAP_NAME</a> (ospf, type) = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00775"></a>00775   <a class="code" href="ospfd_8h.html#afdae06aa57f00f3f4e3fd12055ead548">ROUTEMAP</a> (ospf, type) = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00776"></a>00776 }
<a name="l00777"></a>00777 
<a name="l00778"></a>00778 <span class="comment">/* Zebra route add and delete treatment. */</span>
<a name="l00779"></a>00779 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00780"></a><a class="code" href="ospf__zebra_8c.html#aa094f27792bcac11e8b637c65199e0fa">00780</a> <a class="code" href="ospf__zebra_8c.html#aa094f27792bcac11e8b637c65199e0fa">ospf_zebra_read_ipv4</a> (<span class="keywordtype">int</span> command, <span class="keyword">struct</span> zclient *zclient,
<a name="l00781"></a>00781                       <a class="code" href="zebra_8h.html#a6cbec281d30ae59db10d5b28b5d1cc03">zebra_size_t</a> <a class="code" href="isis__pdu_8h.html#a64ed70bbcb4536e2af22a1aaf5209d18">length</a>)
<a name="l00782"></a>00782 {
<a name="l00783"></a>00783   <span class="keyword">struct </span><a class="code" href="structstream.html">stream</a> *<a class="code" href="spgrid_8c.html#a5d97d3b42a0d6c9ec9a3e56f2616a6a5">s</a>;
<a name="l00784"></a>00784   <span class="keyword">struct </span><a class="code" href="structzapi__ipv4.html">zapi_ipv4</a> api;
<a name="l00785"></a>00785   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="structzapi__ipv4.html#a7043b2c08d10a58daa5e6e7800ff8a29">ifindex</a>;
<a name="l00786"></a>00786   <span class="keyword">struct </span>in_addr nexthop;
<a name="l00787"></a>00787   <span class="keyword">struct </span><a class="code" href="structprefix__ipv4.html">prefix_ipv4</a> p;
<a name="l00788"></a>00788   <span class="keyword">struct </span><a class="code" href="structexternal__info.html">external_info</a> *ei;
<a name="l00789"></a>00789   <span class="keyword">struct </span><a class="code" href="structospf.html">ospf</a> *<a class="code" href="structospf.html">ospf</a>;
<a name="l00790"></a>00790 
<a name="l00791"></a>00791   s = zclient-&gt;<a class="code" href="structzclient.html#a1b9d2a1e869c1008c2bc70d14ce2bf49">ibuf</a>;
<a name="l00792"></a>00792   ifindex = 0;
<a name="l00793"></a>00793   nexthop.s_addr = 0;
<a name="l00794"></a>00794 
<a name="l00795"></a>00795   <span class="comment">/* Type, flags, message. */</span>
<a name="l00796"></a>00796   api.<a class="code" href="structzapi__ipv4.html#ae4c29fc6652367a6546104010802ac2f">type</a> = <a class="code" href="stream_8c.html#a7902a86d9a749707c535840654ded3f6">stream_getc</a> (s);
<a name="l00797"></a>00797   api.<a class="code" href="structzapi__ipv4.html#af27235a3df3f1e86cdbd91bce4e0a2c9">flags</a> = <a class="code" href="stream_8c.html#a7902a86d9a749707c535840654ded3f6">stream_getc</a> (s);
<a name="l00798"></a>00798   api.<a class="code" href="structzapi__ipv4.html#a5d958982406b8e5c5792fa61d30dad2d">message</a> = <a class="code" href="stream_8c.html#a7902a86d9a749707c535840654ded3f6">stream_getc</a> (s);
<a name="l00799"></a>00799 
<a name="l00800"></a>00800   <span class="comment">/* IPv4 prefix. */</span>
<a name="l00801"></a>00801   memset (&amp;p, 0, <span class="keyword">sizeof</span> (<span class="keyword">struct</span> <a class="code" href="structprefix__ipv4.html">prefix_ipv4</a>));
<a name="l00802"></a>00802   p.<a class="code" href="structprefix__ipv4.html#a3a879ea08458c4807130156f5f23dbc7">family</a> = AF_INET;
<a name="l00803"></a>00803   p.<a class="code" href="structprefix__ipv4.html#ab96da4bf1eb37195bd564bcf1126a16a">prefixlen</a> = <a class="code" href="stream_8c.html#a7902a86d9a749707c535840654ded3f6">stream_getc</a> (s);
<a name="l00804"></a>00804   <a class="code" href="stream_8c.html#ab7101e57ef0d9dc1a33e7f7e30c91b9a">stream_get</a> (&amp;p.prefix, s, <a class="code" href="bgpd_8h.html#a472145011d944606a257487e80cc3ace">PSIZE</a> (p.<a class="code" href="structprefix__ipv4.html#ab96da4bf1eb37195bd564bcf1126a16a">prefixlen</a>));
<a name="l00805"></a>00805 
<a name="l00806"></a>00806   <span class="keywordflow">if</span> (<a class="code" href="prefix_8h.html#a255d6e4fa5cfaf4cd252266a0bd4dfda">IPV4_NET127</a>(ntohl(p.prefix.s_addr)))
<a name="l00807"></a>00807     <span class="keywordflow">return</span> 0;
<a name="l00808"></a>00808 
<a name="l00809"></a>00809   <span class="comment">/* Nexthop, ifindex, distance, metric. */</span>
<a name="l00810"></a>00810   <span class="keywordflow">if</span> (<a class="code" href="zebra_8h.html#a9310812ac92febfb7d1eb10127aea1a8">CHECK_FLAG</a> (api.<a class="code" href="structzapi__ipv4.html#a5d958982406b8e5c5792fa61d30dad2d">message</a>, <a class="code" href="zclient_8h.html#a321bbeaddad8bc9bffaf57f7ac6cf8fd">ZAPI_MESSAGE_NEXTHOP</a>))
<a name="l00811"></a>00811     {
<a name="l00812"></a>00812       api.<a class="code" href="structzapi__ipv4.html#a7af9e3fe513c80387289b433e33dfd7b">nexthop_num</a> = <a class="code" href="stream_8c.html#a7902a86d9a749707c535840654ded3f6">stream_getc</a> (s);
<a name="l00813"></a>00813       nexthop.s_addr = <a class="code" href="stream_8c.html#a0d93aa3e961894e5215d343625488576">stream_get_ipv4</a> (s);
<a name="l00814"></a>00814     }
<a name="l00815"></a>00815   <span class="keywordflow">if</span> (<a class="code" href="zebra_8h.html#a9310812ac92febfb7d1eb10127aea1a8">CHECK_FLAG</a> (api.<a class="code" href="structzapi__ipv4.html#a5d958982406b8e5c5792fa61d30dad2d">message</a>, <a class="code" href="zclient_8h.html#ae8d1e48f6c2858ecda1c3aee4219a0e6">ZAPI_MESSAGE_IFINDEX</a>))
<a name="l00816"></a>00816     {
<a name="l00817"></a>00817       api.<a class="code" href="structzapi__ipv4.html#ae831960c79c5bbf79345fe148c202641">ifindex_num</a> = <a class="code" href="stream_8c.html#a7902a86d9a749707c535840654ded3f6">stream_getc</a> (s);
<a name="l00818"></a>00818       <span class="comment">/* XXX assert(api.ifindex_num == 1); */</span>
<a name="l00819"></a>00819       ifindex = <a class="code" href="stream_8c.html#af857bfab0cbe7d5681e9108b58f939f2">stream_getl</a> (s);
<a name="l00820"></a>00820     }
<a name="l00821"></a>00821   <span class="keywordflow">if</span> (<a class="code" href="zebra_8h.html#a9310812ac92febfb7d1eb10127aea1a8">CHECK_FLAG</a> (api.<a class="code" href="structzapi__ipv4.html#a5d958982406b8e5c5792fa61d30dad2d">message</a>, <a class="code" href="zclient_8h.html#abe498bb81bfbda17757173ef23e25179">ZAPI_MESSAGE_DISTANCE</a>))
<a name="l00822"></a>00822     api.<a class="code" href="structzapi__ipv4.html#a78e8151136680e3bd6160864426f4ab3">distance</a> = <a class="code" href="stream_8c.html#a7902a86d9a749707c535840654ded3f6">stream_getc</a> (s);
<a name="l00823"></a>00823   <span class="keywordflow">if</span> (<a class="code" href="zebra_8h.html#a9310812ac92febfb7d1eb10127aea1a8">CHECK_FLAG</a> (api.<a class="code" href="structzapi__ipv4.html#a5d958982406b8e5c5792fa61d30dad2d">message</a>, <a class="code" href="zclient_8h.html#a4a5d60df1ef02f794476ea1daa6ba024">ZAPI_MESSAGE_METRIC</a>))
<a name="l00824"></a>00824     api.<a class="code" href="structzapi__ipv4.html#a4894d78fb0f8be44470318b265e5a487">metric</a> = <a class="code" href="stream_8c.html#af857bfab0cbe7d5681e9108b58f939f2">stream_getl</a> (s);
<a name="l00825"></a>00825 
<a name="l00826"></a>00826   ospf = <a class="code" href="ospfd_8c.html#a8ea0c935a4862c1469bc962e93fee74b">ospf_lookup</a> ();
<a name="l00827"></a>00827   <span class="keywordflow">if</span> (ospf == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00828"></a>00828     <span class="keywordflow">return</span> 0;
<a name="l00829"></a>00829 
<a name="l00830"></a>00830   <span class="keywordflow">if</span> (command == <a class="code" href="zebra_8h.html#aa2913a6b1e5fbc598479aa282343a5e1">ZEBRA_IPV4_ROUTE_ADD</a>)
<a name="l00831"></a>00831     {
<a name="l00832"></a>00832       <span class="comment">/* XXX|HACK|TODO|FIXME:</span>
<a name="l00833"></a>00833 <span class="comment">       * Maybe we should ignore reject/blackhole routes? Testing shows that</span>
<a name="l00834"></a>00834 <span class="comment">       * there is no problems though and this is only way to &quot;summarize&quot;</span>
<a name="l00835"></a>00835 <span class="comment">       * routes in ASBR at the moment. Maybe we need just a better generalised</span>
<a name="l00836"></a>00836 <span class="comment">       * solution for these types?</span>
<a name="l00837"></a>00837 <span class="comment">       *</span>
<a name="l00838"></a>00838 <span class="comment">       * if ( CHECK_FLAG (api.flags, ZEBRA_FLAG_BLACKHOLE)</span>
<a name="l00839"></a>00839 <span class="comment">       *     || CHECK_FLAG (api.flags, ZEBRA_FLAG_REJECT))</span>
<a name="l00840"></a>00840 <span class="comment">       * return 0;</span>
<a name="l00841"></a>00841 <span class="comment">       */</span>
<a name="l00842"></a>00842         
<a name="l00843"></a>00843       ei = <a class="code" href="ospf__asbr_8c.html#a6a90eaa85c3352db338f42b615933d9c">ospf_external_info_add</a> (api.<a class="code" href="structzapi__ipv4.html#ae4c29fc6652367a6546104010802ac2f">type</a>, p, ifindex, nexthop);
<a name="l00844"></a>00844 
<a name="l00845"></a>00845       <span class="keywordflow">if</span> (ospf-&gt;<a class="code" href="structospf.html#acda9328f4f8627516f5c4942a45b4c25">router_id</a>.s_addr == 0)
<a name="l00846"></a>00846         <span class="comment">/* Set flags to generate AS-external-LSA originate event</span>
<a name="l00847"></a>00847 <span class="comment">           for each redistributed protocols later. */</span>
<a name="l00848"></a>00848         ospf-&gt;<a class="code" href="structospf.html#a4e2d4fb95c750aeddee77669b7073e86">external_origin</a> |= (1 &lt;&lt; api.<a class="code" href="structzapi__ipv4.html#ae4c29fc6652367a6546104010802ac2f">type</a>);
<a name="l00849"></a>00849       <span class="keywordflow">else</span>
<a name="l00850"></a>00850         {
<a name="l00851"></a>00851           <span class="keywordflow">if</span> (ei)
<a name="l00852"></a>00852             {
<a name="l00853"></a>00853               <span class="keywordflow">if</span> (<a class="code" href="ospf__lsa_8c.html#ab361b6fb4bed2a417afb49ae46bae391">is_prefix_default</a> (&amp;p))
<a name="l00854"></a>00854                 <a class="code" href="ospf__lsa_8c.html#a1be6376d9b23634a76f2a6a07833fe1e">ospf_external_lsa_refresh_default</a> (ospf);
<a name="l00855"></a>00855               <span class="keywordflow">else</span>
<a name="l00856"></a>00856                 {
<a name="l00857"></a>00857                   <span class="keyword">struct </span><a class="code" href="structospf__lsa.html">ospf_lsa</a> *current;
<a name="l00858"></a>00858 
<a name="l00859"></a>00859                   current = <a class="code" href="ospf__asbr_8c.html#ad45c036a67747a7f65338b7ec6ff748d">ospf_external_info_find_lsa</a> (ospf, &amp;ei-&gt;<a class="code" href="structexternal__info.html#a15eb7ea975a1090a107d7d54b798822c">p</a>);
<a name="l00860"></a>00860                   <span class="keywordflow">if</span> (!current)
<a name="l00861"></a>00861                     <a class="code" href="ospf__lsa_8c.html#a96d24d54ba0ac3adc1ff557621ff2911">ospf_external_lsa_originate</a> (ospf, ei);
<a name="l00862"></a>00862                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="ospf__lsa_8h.html#a29c1c83c9c5e24d75e33d7efd0d12b88">IS_LSA_MAXAGE</a> (current))
<a name="l00863"></a>00863                     <a class="code" href="ospf__lsa_8c.html#a12f57ed226cea2cfd9499069dbde2f3c">ospf_external_lsa_refresh</a> (ospf, current,
<a name="l00864"></a>00864                                                ei, <a class="code" href="ospf__lsa_8h.html#a389234e05af4a29be76c63dc46576791">LSA_REFRESH_FORCE</a>);
<a name="l00865"></a>00865                   <span class="keywordflow">else</span>
<a name="l00866"></a>00866                     <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;ospf_zebra_read_ipv4() : %s already exists&quot;</span>,
<a name="l00867"></a>00867                                inet_ntoa (p.prefix));
<a name="l00868"></a>00868                 }
<a name="l00869"></a>00869             }
<a name="l00870"></a>00870         }
<a name="l00871"></a>00871     }
<a name="l00872"></a>00872   <span class="keywordflow">else</span>                          <span class="comment">/* if (command == ZEBRA_IPV4_ROUTE_DELETE) */</span>
<a name="l00873"></a>00873     {
<a name="l00874"></a>00874       <a class="code" href="ospf__asbr_8c.html#ae91dd932332bc12e89b6cc7f9358146f">ospf_external_info_delete</a> (api.<a class="code" href="structzapi__ipv4.html#ae4c29fc6652367a6546104010802ac2f">type</a>, p);
<a name="l00875"></a>00875       <span class="keywordflow">if</span> (<a class="code" href="ospf__lsa_8c.html#ab361b6fb4bed2a417afb49ae46bae391">is_prefix_default</a> (&amp;p))
<a name="l00876"></a>00876         <a class="code" href="ospf__lsa_8c.html#a1be6376d9b23634a76f2a6a07833fe1e">ospf_external_lsa_refresh_default</a> (ospf);
<a name="l00877"></a>00877       <span class="keywordflow">else</span>
<a name="l00878"></a>00878         <a class="code" href="ospf__lsa_8c.html#ae6fd27bc0a44fb71638c23c3ea829905">ospf_external_lsa_flush</a> (ospf, api.<a class="code" href="structzapi__ipv4.html#ae4c29fc6652367a6546104010802ac2f">type</a>, &amp;p, ifindex <span class="comment">/*, nexthop */</span>);
<a name="l00879"></a>00879     }
<a name="l00880"></a>00880 
<a name="l00881"></a>00881   <span class="keywordflow">return</span> 0;
<a name="l00882"></a>00882 }
<a name="l00883"></a>00883 
<a name="l00884"></a>00884 
<a name="l00885"></a>00885 <span class="keywordtype">int</span>
<a name="l00886"></a><a class="code" href="ospf__zebra_8h.html#a188e7add58035c375b35e4972eb5967e">00886</a> <a class="code" href="ospf__zebra_8c.html#a22ecb4de553f038a26adf0f2e20a2791">ospf_distribute_list_out_set</a> (<span class="keyword">struct</span> <a class="code" href="structospf.html">ospf</a> *<a class="code" href="structospf.html">ospf</a>, <span class="keywordtype">int</span> <a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="memory_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>)
<a name="l00887"></a>00887 {
<a name="l00888"></a>00888   <span class="comment">/* Lookup access-list for distribute-list. */</span>
<a name="l00889"></a>00889   <a class="code" href="ospfd_8h.html#a96719238490e0edd9331bdeae79c190f">DISTRIBUTE_LIST</a> (ospf, type) = <a class="code" href="filter_8c.html#a8cb65cd01015f6673c632cb5b8714b3e">access_list_lookup</a> (<a class="code" href="zebra_8h.html#a192fcc8cbfb7b9d03c6562c48941a4bd">AFI_IP</a>, name);
<a name="l00890"></a>00890 
<a name="l00891"></a>00891   <span class="comment">/* Clear previous distribute-name. */</span>
<a name="l00892"></a>00892   <span class="keywordflow">if</span> (<a class="code" href="ospfd_8h.html#a21d66b4ea7498172da5521cf0445110e">DISTRIBUTE_NAME</a> (ospf, type))
<a name="l00893"></a>00893     free (<a class="code" href="ospfd_8h.html#a21d66b4ea7498172da5521cf0445110e">DISTRIBUTE_NAME</a> (ospf, type));
<a name="l00894"></a>00894 
<a name="l00895"></a>00895   <span class="comment">/* Set distribute-name. */</span>
<a name="l00896"></a>00896   <a class="code" href="ospfd_8h.html#a21d66b4ea7498172da5521cf0445110e">DISTRIBUTE_NAME</a> (ospf, type) = strdup (name);
<a name="l00897"></a>00897 
<a name="l00898"></a>00898   <span class="comment">/* If access-list have been set, schedule update timer. */</span>
<a name="l00899"></a>00899   <span class="keywordflow">if</span> (<a class="code" href="ospfd_8h.html#a96719238490e0edd9331bdeae79c190f">DISTRIBUTE_LIST</a> (ospf, type))
<a name="l00900"></a>00900     <a class="code" href="ospf__zebra_8c.html#a52f98f2caaa07486833cfaad5888fdaa">ospf_distribute_list_update</a> (ospf, type);
<a name="l00901"></a>00901 
<a name="l00902"></a>00902   <span class="keywordflow">return</span> <a class="code" href="command_8h.html#aa2008c1bc36d9ef42571a6ec52516d02">CMD_SUCCESS</a>;
<a name="l00903"></a>00903 }
<a name="l00904"></a>00904 
<a name="l00905"></a>00905 <span class="keywordtype">int</span>
<a name="l00906"></a><a class="code" href="ospf__zebra_8h.html#aa38e1f4912ce27463789a93989f4582d">00906</a> <a class="code" href="ospf__zebra_8c.html#ad2fba700f6fbd0ba66cbb0b3969fefc2">ospf_distribute_list_out_unset</a> (<span class="keyword">struct</span> <a class="code" href="structospf.html">ospf</a> *<a class="code" href="structospf.html">ospf</a>, <span class="keywordtype">int</span> <a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="memory_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>)
<a name="l00907"></a>00907 {
<a name="l00908"></a>00908   <span class="comment">/* Schedule update timer. */</span>
<a name="l00909"></a>00909   <span class="keywordflow">if</span> (<a class="code" href="ospfd_8h.html#a96719238490e0edd9331bdeae79c190f">DISTRIBUTE_LIST</a> (ospf, type))
<a name="l00910"></a>00910     <a class="code" href="ospf__zebra_8c.html#a52f98f2caaa07486833cfaad5888fdaa">ospf_distribute_list_update</a> (ospf, type);
<a name="l00911"></a>00911 
<a name="l00912"></a>00912   <span class="comment">/* Unset distribute-list. */</span>
<a name="l00913"></a>00913   <a class="code" href="ospfd_8h.html#a96719238490e0edd9331bdeae79c190f">DISTRIBUTE_LIST</a> (ospf, type) = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00914"></a>00914 
<a name="l00915"></a>00915   <span class="comment">/* Clear distribute-name. */</span>
<a name="l00916"></a>00916   <span class="keywordflow">if</span> (<a class="code" href="ospfd_8h.html#a21d66b4ea7498172da5521cf0445110e">DISTRIBUTE_NAME</a> (ospf, type))
<a name="l00917"></a>00917     free (<a class="code" href="ospfd_8h.html#a21d66b4ea7498172da5521cf0445110e">DISTRIBUTE_NAME</a> (ospf, type));
<a name="l00918"></a>00918 
<a name="l00919"></a>00919   <a class="code" href="ospfd_8h.html#a21d66b4ea7498172da5521cf0445110e">DISTRIBUTE_NAME</a> (ospf, type) = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00920"></a>00920 
<a name="l00921"></a>00921   <span class="keywordflow">return</span> <a class="code" href="command_8h.html#aa2008c1bc36d9ef42571a6ec52516d02">CMD_SUCCESS</a>;
<a name="l00922"></a>00922 }
<a name="l00923"></a>00923 
<a name="l00924"></a>00924 <span class="comment">/* distribute-list update timer. */</span>
<a name="l00925"></a>00925 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00926"></a><a class="code" href="ospf__zebra_8c.html#a5c74ee744958cec76bc871c5beee7e00">00926</a> <a class="code" href="ospf__zebra_8c.html#a5c74ee744958cec76bc871c5beee7e00">ospf_distribute_list_update_timer</a> (<span class="keyword">struct</span> <a class="code" href="structthread.html">thread</a> *<a class="code" href="structthread.html">thread</a>)
<a name="l00927"></a>00927 {
<a name="l00928"></a>00928   <span class="keyword">struct </span><a class="code" href="structroute__node.html">route_node</a> *rn;
<a name="l00929"></a>00929   <span class="keyword">struct </span><a class="code" href="structexternal__info.html">external_info</a> *ei;
<a name="l00930"></a>00930   <span class="keyword">struct </span><a class="code" href="structroute__table.html">route_table</a> *rt;
<a name="l00931"></a>00931   <span class="keyword">struct </span><a class="code" href="structospf__lsa.html">ospf_lsa</a> *lsa;
<a name="l00932"></a>00932   <span class="keywordtype">int</span> <a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a>, default_refresh = 0;
<a name="l00933"></a>00933   <span class="keyword">struct </span><a class="code" href="structospf.html">ospf</a> *<a class="code" href="structospf.html">ospf</a>;
<a name="l00934"></a>00934 
<a name="l00935"></a>00935   ospf = <a class="code" href="ospfd_8c.html#a8ea0c935a4862c1469bc962e93fee74b">ospf_lookup</a> ();
<a name="l00936"></a>00936   <span class="keywordflow">if</span> (ospf == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00937"></a>00937     <span class="keywordflow">return</span> 0;
<a name="l00938"></a>00938 
<a name="l00939"></a>00939   ospf-&gt;<a class="code" href="structospf.html#abfa4d7a08ec475ecaa88449f363acd23">t_distribute_update</a> = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00940"></a>00940 
<a name="l00941"></a>00941   <a class="code" href="log_8h.html#a383184727341e7ad985deb9e4f2156c7">zlog_info</a> (<span class="stringliteral">&quot;Zebra[Redistribute]: distribute-list update timer fired!&quot;</span>);
<a name="l00942"></a>00942 
<a name="l00943"></a>00943   <span class="comment">/* foreach all external info. */</span>
<a name="l00944"></a>00944   <span class="keywordflow">for</span> (type = 0; type &lt;= <a class="code" href="zebra_8h.html#aec97442680d773fd62f9af5c9426b842">ZEBRA_ROUTE_MAX</a>; type++)
<a name="l00945"></a>00945     {
<a name="l00946"></a>00946       rt = <a class="code" href="ospfd_8h.html#a9fa5e60f9244cb3ea41a0a96d3c9b85c">EXTERNAL_INFO</a> (type);
<a name="l00947"></a>00947       <span class="keywordflow">if</span> (!rt)
<a name="l00948"></a>00948     <span class="keywordflow">continue</span>;
<a name="l00949"></a>00949       <span class="keywordflow">for</span> (rn = <a class="code" href="table_8c.html#aee1d06c531794df326d946bdac647fb2">route_top</a> (rt); rn; rn = <a class="code" href="table_8c.html#ad2addc694ecf6cd0cce57cb3a7d96902">route_next</a> (rn))
<a name="l00950"></a>00950     <span class="keywordflow">if</span> ((ei = rn-&gt;<a class="code" href="structroute__node.html#a20aabb1a6fbe9de363a1c57fe3124c87">info</a>) != <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00951"></a>00951       {
<a name="l00952"></a>00952         <span class="keywordflow">if</span> (<a class="code" href="ospf__lsa_8c.html#ab361b6fb4bed2a417afb49ae46bae391">is_prefix_default</a> (&amp;ei-&gt;<a class="code" href="structexternal__info.html#a15eb7ea975a1090a107d7d54b798822c">p</a>))
<a name="l00953"></a>00953           default_refresh = 1;
<a name="l00954"></a>00954         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((lsa = <a class="code" href="ospf__asbr_8c.html#ad45c036a67747a7f65338b7ec6ff748d">ospf_external_info_find_lsa</a> (ospf, &amp;ei-&gt;<a class="code" href="structexternal__info.html#a15eb7ea975a1090a107d7d54b798822c">p</a>)))
<a name="l00955"></a>00955           <a class="code" href="ospf__lsa_8c.html#a12f57ed226cea2cfd9499069dbde2f3c">ospf_external_lsa_refresh</a> (ospf, lsa, ei, <a class="code" href="ospf__lsa_8h.html#ac0488097cd4fde2b7a0c63001f958fda">LSA_REFRESH_IF_CHANGED</a>);
<a name="l00956"></a>00956         <span class="keywordflow">else</span>
<a name="l00957"></a>00957           <a class="code" href="ospf__lsa_8c.html#a96d24d54ba0ac3adc1ff557621ff2911">ospf_external_lsa_originate</a> (ospf, ei);
<a name="l00958"></a>00958       }
<a name="l00959"></a>00959     }
<a name="l00960"></a>00960   <span class="keywordflow">if</span> (default_refresh)
<a name="l00961"></a>00961     <a class="code" href="ospf__lsa_8c.html#a1be6376d9b23634a76f2a6a07833fe1e">ospf_external_lsa_refresh_default</a> (ospf);
<a name="l00962"></a>00962   <span class="keywordflow">return</span> 0;
<a name="l00963"></a>00963 }
<a name="l00964"></a>00964 
<a name="l00965"></a><a class="code" href="ospf__zebra_8c.html#a84eeafdde68ec75e1f387fed8d8032cc">00965</a> <span class="preprocessor">#define OSPF_DISTRIBUTE_UPDATE_DELAY 5</span>
<a name="l00966"></a>00966 <span class="preprocessor"></span>
<a name="l00967"></a>00967 <span class="comment">/* Update distribute-list and set timer to apply access-list. */</span>
<a name="l00968"></a>00968 <span class="keywordtype">void</span>
<a name="l00969"></a><a class="code" href="ospf__zebra_8h.html#abf2ac56768e377a285df120cd0deba82">00969</a> <a class="code" href="ospf__zebra_8c.html#a52f98f2caaa07486833cfaad5888fdaa">ospf_distribute_list_update</a> (<span class="keyword">struct</span> <a class="code" href="structospf.html">ospf</a> *<a class="code" href="structospf.html">ospf</a>, <span class="keywordtype">int</span> <a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a>)
<a name="l00970"></a>00970 {
<a name="l00971"></a>00971   <span class="keyword">struct </span><a class="code" href="structroute__table.html">route_table</a> *rt;
<a name="l00972"></a>00972 
<a name="l00973"></a>00973   <span class="comment">/* External info does not exist. */</span>
<a name="l00974"></a>00974   <span class="keywordflow">if</span> (!(rt = <a class="code" href="ospfd_8h.html#a9fa5e60f9244cb3ea41a0a96d3c9b85c">EXTERNAL_INFO</a> (type)))
<a name="l00975"></a>00975     <span class="keywordflow">return</span>;
<a name="l00976"></a>00976 
<a name="l00977"></a>00977   <span class="comment">/* If exists previously invoked thread, then let it continue. */</span>
<a name="l00978"></a>00978   <span class="keywordflow">if</span> (ospf-&gt;<a class="code" href="structospf.html#abfa4d7a08ec475ecaa88449f363acd23">t_distribute_update</a>)
<a name="l00979"></a>00979     <span class="keywordflow">return</span>;
<a name="l00980"></a>00980 
<a name="l00981"></a>00981   <span class="comment">/* Set timer. */</span>
<a name="l00982"></a>00982   ospf-&gt;<a class="code" href="structospf.html#abfa4d7a08ec475ecaa88449f363acd23">t_distribute_update</a> =
<a name="l00983"></a>00983     <a class="code" href="thread_8h.html#aca77b3bbd166d3573de5ecd9756a590c">thread_add_timer</a> (master, <a class="code" href="ospf__zebra_8c.html#a5c74ee744958cec76bc871c5beee7e00">ospf_distribute_list_update_timer</a>,
<a name="l00984"></a>00984                       (<span class="keywordtype">void</span> *) type, <a class="code" href="ospf__zebra_8c.html#a84eeafdde68ec75e1f387fed8d8032cc">OSPF_DISTRIBUTE_UPDATE_DELAY</a>);
<a name="l00985"></a>00985 }
<a name="l00986"></a>00986 
<a name="l00987"></a>00987 <span class="comment">/* If access-list is updated, apply some check. */</span>
<a name="l00988"></a>00988 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00989"></a><a class="code" href="ospf__zebra_8c.html#a4a532c457c6791580c8b595aa044db28">00989</a> <a class="code" href="ospf__zebra_8c.html#a4a532c457c6791580c8b595aa044db28">ospf_filter_update</a> (<span class="keyword">struct</span> <a class="code" href="structaccess__list.html">access_list</a> *access)
<a name="l00990"></a>00990 {
<a name="l00991"></a>00991   <span class="keyword">struct </span><a class="code" href="structospf.html">ospf</a> *<a class="code" href="structospf.html">ospf</a>;
<a name="l00992"></a>00992   <span class="keywordtype">int</span> <a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a>;
<a name="l00993"></a>00993   <span class="keywordtype">int</span> abr_inv = 0;
<a name="l00994"></a>00994   <span class="keyword">struct </span><a class="code" href="structospf__area.html">ospf_area</a> *<a class="code" href="ospf__vty_8c.html#a7030c85f46deeffac793079c664c14ce">area</a>;
<a name="l00995"></a>00995   <span class="keyword">struct </span><a class="code" href="structlistnode.html">listnode</a> *node;
<a name="l00996"></a>00996 
<a name="l00997"></a>00997   <span class="comment">/* If OSPF instatnce does not exist, return right now. */</span>
<a name="l00998"></a>00998   ospf = <a class="code" href="ospfd_8c.html#a8ea0c935a4862c1469bc962e93fee74b">ospf_lookup</a> ();
<a name="l00999"></a>00999   <span class="keywordflow">if</span> (ospf == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01000"></a>01000     <span class="keywordflow">return</span>;
<a name="l01001"></a>01001 
<a name="l01002"></a>01002   <span class="comment">/* Update distribute-list, and apply filter. */</span>
<a name="l01003"></a>01003   <span class="keywordflow">for</span> (type = 0; type &lt;= <a class="code" href="zebra_8h.html#aec97442680d773fd62f9af5c9426b842">ZEBRA_ROUTE_MAX</a>; type++)
<a name="l01004"></a>01004     {
<a name="l01005"></a>01005       <span class="keywordflow">if</span> (<a class="code" href="ospfd_8h.html#afdae06aa57f00f3f4e3fd12055ead548">ROUTEMAP</a> (ospf, type) != <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01006"></a>01006         {
<a name="l01007"></a>01007           <span class="comment">/* if route-map is not NULL it may be using this access list */</span>
<a name="l01008"></a>01008           <a class="code" href="ospf__zebra_8c.html#a52f98f2caaa07486833cfaad5888fdaa">ospf_distribute_list_update</a> (ospf, type);
<a name="l01009"></a>01009           <span class="keywordflow">continue</span>;
<a name="l01010"></a>01010         }
<a name="l01011"></a>01011 
<a name="l01012"></a>01012       <span class="comment">/* There is place for route-map for default-information (ZEBRA_ROUTE_MAX),</span>
<a name="l01013"></a>01013 <span class="comment">       * but no distribute list. */</span>
<a name="l01014"></a>01014       <span class="keywordflow">if</span> (type == <a class="code" href="zebra_8h.html#aec97442680d773fd62f9af5c9426b842">ZEBRA_ROUTE_MAX</a>)
<a name="l01015"></a>01015     <span class="keywordflow">break</span>;
<a name="l01016"></a>01016 
<a name="l01017"></a>01017       <span class="keywordflow">if</span> (<a class="code" href="ospfd_8h.html#a21d66b4ea7498172da5521cf0445110e">DISTRIBUTE_NAME</a> (ospf, type))
<a name="l01018"></a>01018         {
<a name="l01019"></a>01019           <span class="comment">/* Keep old access-list for distribute-list. */</span>
<a name="l01020"></a>01020           <span class="keyword">struct </span><a class="code" href="structaccess__list.html">access_list</a> *old = <a class="code" href="ospfd_8h.html#a96719238490e0edd9331bdeae79c190f">DISTRIBUTE_LIST</a> (ospf, type);
<a name="l01021"></a>01021 
<a name="l01022"></a>01022           <span class="comment">/* Update access-list for distribute-list. */</span>
<a name="l01023"></a>01023           <a class="code" href="ospfd_8h.html#a96719238490e0edd9331bdeae79c190f">DISTRIBUTE_LIST</a> (ospf, type) =
<a name="l01024"></a>01024             <a class="code" href="filter_8c.html#a8cb65cd01015f6673c632cb5b8714b3e">access_list_lookup</a> (<a class="code" href="zebra_8h.html#a192fcc8cbfb7b9d03c6562c48941a4bd">AFI_IP</a>, <a class="code" href="ospfd_8h.html#a21d66b4ea7498172da5521cf0445110e">DISTRIBUTE_NAME</a> (ospf, type));
<a name="l01025"></a>01025 
<a name="l01026"></a>01026           <span class="comment">/* No update for this distribute type. */</span>
<a name="l01027"></a>01027           <span class="keywordflow">if</span> (old == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; <a class="code" href="ospfd_8h.html#a96719238490e0edd9331bdeae79c190f">DISTRIBUTE_LIST</a> (ospf, type) == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01028"></a>01028             <span class="keywordflow">continue</span>;
<a name="l01029"></a>01029 
<a name="l01030"></a>01030           <span class="comment">/* Schedule distribute-list update timer. */</span>
<a name="l01031"></a>01031           <span class="keywordflow">if</span> (<a class="code" href="ospfd_8h.html#a96719238490e0edd9331bdeae79c190f">DISTRIBUTE_LIST</a> (ospf, type) == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ||
<a name="l01032"></a>01032               strcmp (<a class="code" href="ospfd_8h.html#a21d66b4ea7498172da5521cf0445110e">DISTRIBUTE_NAME</a> (ospf, type), access-&gt;<a class="code" href="structaccess__list.html#afdafa2fa941dc9afe1ad8471420c655a">name</a>) == 0)
<a name="l01033"></a>01033             <a class="code" href="ospf__zebra_8c.html#a52f98f2caaa07486833cfaad5888fdaa">ospf_distribute_list_update</a> (ospf, type);
<a name="l01034"></a>01034         }
<a name="l01035"></a>01035     }
<a name="l01036"></a>01036 
<a name="l01037"></a>01037   <span class="comment">/* Update Area access-list. */</span>
<a name="l01038"></a>01038   <span class="keywordflow">for</span> (<a class="code" href="linklist_8h.html#a80a3f4035be83abbb709d17412993226">ALL_LIST_ELEMENTS_RO</a> (ospf-&gt;<a class="code" href="structospf.html#a3f6f2d3b6f2ae9f0ad87223301d92bcc">areas</a>, node, area))
<a name="l01039"></a>01039     {
<a name="l01040"></a>01040       <span class="keywordflow">if</span> (<a class="code" href="ospf6__area_8h.html#a4b149526dcc0d9c5de7086d581336dcb">EXPORT_NAME</a> (area))
<a name="l01041"></a>01041         {
<a name="l01042"></a>01042           <a class="code" href="ospf6__area_8h.html#a3b1e86d59d3641da3b6b9281a97c7927">EXPORT_LIST</a> (area) = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01043"></a>01043           abr_inv++;
<a name="l01044"></a>01044         }
<a name="l01045"></a>01045 
<a name="l01046"></a>01046       <span class="keywordflow">if</span> (<a class="code" href="ospf6__area_8h.html#a8f03536971036c0537f7bda3fb525b14">IMPORT_NAME</a> (area))
<a name="l01047"></a>01047         {
<a name="l01048"></a>01048           <a class="code" href="ospf6__area_8h.html#a8bb9cd837b1e23c12864c27e469c9575">IMPORT_LIST</a> (area) = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01049"></a>01049           abr_inv++;
<a name="l01050"></a>01050         }
<a name="l01051"></a>01051     }
<a name="l01052"></a>01052 
<a name="l01053"></a>01053   <span class="comment">/* Schedule ABR tasks -- this will be changed -- takada. */</span>
<a name="l01054"></a>01054   <span class="keywordflow">if</span> (<a class="code" href="ospfd_8h.html#a66c6ce8df7e5b79426d9eca9f8ef6d27">IS_OSPF_ABR</a> (ospf) &amp;&amp; abr_inv)
<a name="l01055"></a>01055     <a class="code" href="ospf__abr_8c.html#a1ff6c727604d00c49b9c4a26131e5462">ospf_schedule_abr_task</a> (ospf);
<a name="l01056"></a>01056 }
<a name="l01057"></a>01057 
<a name="l01058"></a>01058 <span class="comment">/* If prefix-list is updated, do some updates. */</span>
<a name="l01059"></a>01059 <span class="keywordtype">void</span>
<a name="l01060"></a><a class="code" href="ospfd_8h.html#a0902d696caa40c45e1ebc3ba4d7de6f0">01060</a> <a class="code" href="ospf__zebra_8c.html#a490e15816e8166995cd3c9c4b7e0cc95">ospf_prefix_list_update</a> (<span class="keyword">struct</span> <a class="code" href="structprefix__list.html">prefix_list</a> *plist)
<a name="l01061"></a>01061 {
<a name="l01062"></a>01062   <span class="keyword">struct </span><a class="code" href="structospf.html">ospf</a> *<a class="code" href="structospf.html">ospf</a>;
<a name="l01063"></a>01063   <span class="keywordtype">int</span> <a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a>;
<a name="l01064"></a>01064   <span class="keywordtype">int</span> abr_inv = 0;
<a name="l01065"></a>01065   <span class="keyword">struct </span><a class="code" href="structospf__area.html">ospf_area</a> *<a class="code" href="ospf__vty_8c.html#a7030c85f46deeffac793079c664c14ce">area</a>;
<a name="l01066"></a>01066   <span class="keyword">struct </span><a class="code" href="structlistnode.html">listnode</a> *node;
<a name="l01067"></a>01067 
<a name="l01068"></a>01068   <span class="comment">/* If OSPF instatnce does not exist, return right now. */</span>
<a name="l01069"></a>01069   ospf = <a class="code" href="ospfd_8c.html#a8ea0c935a4862c1469bc962e93fee74b">ospf_lookup</a> ();
<a name="l01070"></a>01070   <span class="keywordflow">if</span> (ospf == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01071"></a>01071     <span class="keywordflow">return</span>;
<a name="l01072"></a>01072 
<a name="l01073"></a>01073   <span class="comment">/* Update all route-maps which are used as redistribution filters.</span>
<a name="l01074"></a>01074 <span class="comment">   * They might use prefix-list.</span>
<a name="l01075"></a>01075 <span class="comment">   */</span>
<a name="l01076"></a>01076   <span class="keywordflow">for</span> (type = 0; type &lt;= <a class="code" href="zebra_8h.html#aec97442680d773fd62f9af5c9426b842">ZEBRA_ROUTE_MAX</a>; type++)
<a name="l01077"></a>01077     {
<a name="l01078"></a>01078       <span class="keywordflow">if</span> (<a class="code" href="ospfd_8h.html#afdae06aa57f00f3f4e3fd12055ead548">ROUTEMAP</a> (ospf, type) != <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01079"></a>01079         {
<a name="l01080"></a>01080           <span class="comment">/* If route-map is not NULL it may be using this prefix list */</span>
<a name="l01081"></a>01081           <a class="code" href="ospf__zebra_8c.html#a52f98f2caaa07486833cfaad5888fdaa">ospf_distribute_list_update</a> (ospf, type);
<a name="l01082"></a>01082           <span class="keywordflow">continue</span>;
<a name="l01083"></a>01083         }
<a name="l01084"></a>01084     }
<a name="l01085"></a>01085 
<a name="l01086"></a>01086   <span class="comment">/* Update area filter-lists. */</span>
<a name="l01087"></a>01087   <span class="keywordflow">for</span> (<a class="code" href="linklist_8h.html#a80a3f4035be83abbb709d17412993226">ALL_LIST_ELEMENTS_RO</a> (ospf-&gt;<a class="code" href="structospf.html#a3f6f2d3b6f2ae9f0ad87223301d92bcc">areas</a>, node, area))
<a name="l01088"></a>01088     {
<a name="l01089"></a>01089       <span class="comment">/* Update filter-list in. */</span>
<a name="l01090"></a>01090       <span class="keywordflow">if</span> (<a class="code" href="ospf6__area_8h.html#abe51249890d05db475de4eed718656ea">PREFIX_NAME_IN</a> (area))
<a name="l01091"></a>01091         <span class="keywordflow">if</span> (strcmp (<a class="code" href="ospf6__area_8h.html#abe51249890d05db475de4eed718656ea">PREFIX_NAME_IN</a> (area), plist-&gt;<a class="code" href="structprefix__list.html#af18fa743ac0f45b51adc74e6e2828174">name</a>) == 0)
<a name="l01092"></a>01092           {
<a name="l01093"></a>01093             <a class="code" href="bgp__route_8h.html#ad143503066e23e446015fc61ba2e72ed">PREFIX_LIST_IN</a> (area) =
<a name="l01094"></a>01094               <a class="code" href="plist_8c.html#adfce5b38dccccdc141ffd3571b73a656">prefix_list_lookup</a> (<a class="code" href="zebra_8h.html#a192fcc8cbfb7b9d03c6562c48941a4bd">AFI_IP</a>, <a class="code" href="ospf6__area_8h.html#abe51249890d05db475de4eed718656ea">PREFIX_NAME_IN</a> (area));
<a name="l01095"></a>01095             abr_inv++;
<a name="l01096"></a>01096           }
<a name="l01097"></a>01097 
<a name="l01098"></a>01098       <span class="comment">/* Update filter-list out. */</span>
<a name="l01099"></a>01099       <span class="keywordflow">if</span> (<a class="code" href="ospf6__area_8h.html#a4ec3abaef7e217292ab5589e1b207957">PREFIX_NAME_OUT</a> (area))
<a name="l01100"></a>01100         <span class="keywordflow">if</span> (strcmp (<a class="code" href="ospf6__area_8h.html#a4ec3abaef7e217292ab5589e1b207957">PREFIX_NAME_OUT</a> (area), plist-&gt;<a class="code" href="structprefix__list.html#af18fa743ac0f45b51adc74e6e2828174">name</a>) == 0)
<a name="l01101"></a>01101           {
<a name="l01102"></a>01102             <a class="code" href="bgp__route_8h.html#ad143503066e23e446015fc61ba2e72ed">PREFIX_LIST_IN</a> (area) =
<a name="l01103"></a>01103               <a class="code" href="plist_8c.html#adfce5b38dccccdc141ffd3571b73a656">prefix_list_lookup</a> (<a class="code" href="zebra_8h.html#a192fcc8cbfb7b9d03c6562c48941a4bd">AFI_IP</a>, <a class="code" href="ospf6__area_8h.html#a4ec3abaef7e217292ab5589e1b207957">PREFIX_NAME_OUT</a> (area));
<a name="l01104"></a>01104             abr_inv++;
<a name="l01105"></a>01105           }
<a name="l01106"></a>01106     }
<a name="l01107"></a>01107 
<a name="l01108"></a>01108   <span class="comment">/* Schedule ABR task. */</span>
<a name="l01109"></a>01109   <span class="keywordflow">if</span> (<a class="code" href="ospfd_8h.html#a66c6ce8df7e5b79426d9eca9f8ef6d27">IS_OSPF_ABR</a> (ospf) &amp;&amp; abr_inv)
<a name="l01110"></a>01110     <a class="code" href="ospf__abr_8c.html#a1ff6c727604d00c49b9c4a26131e5462">ospf_schedule_abr_task</a> (ospf);
<a name="l01111"></a>01111 }
<a name="l01112"></a>01112 
<a name="l01113"></a>01113 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structospf__distance.html">ospf_distance</a> *
<a name="l01114"></a><a class="code" href="ospf__zebra_8c.html#a3cb2e7f39c68713a806a1d08643bb4b7">01114</a> <a class="code" href="ospf__zebra_8c.html#a3cb2e7f39c68713a806a1d08643bb4b7">ospf_distance_new</a> (<span class="keywordtype">void</span>)
<a name="l01115"></a>01115 {
<a name="l01116"></a>01116   <span class="keywordflow">return</span> <a class="code" href="memory_8h.html#a7826e4ed1d152cad0666dcf43f11f663">XCALLOC</a> (<a class="code" href="memtypes_8h.html#a7ff5f2dff38e7639981794c43dc9167bad6bee78f12efadf451900d73648ac5f6">MTYPE_OSPF_DISTANCE</a>, <span class="keyword">sizeof</span> (<span class="keyword">struct</span> <a class="code" href="structospf__distance.html">ospf_distance</a>));
<a name="l01117"></a>01117 }
<a name="l01118"></a>01118 
<a name="l01119"></a>01119 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01120"></a><a class="code" href="ospf__zebra_8c.html#ad7de1ef8610fe7846b43f26dd906c2d5">01120</a> <a class="code" href="ospf__zebra_8c.html#ad7de1ef8610fe7846b43f26dd906c2d5">ospf_distance_free</a> (<span class="keyword">struct</span> <a class="code" href="structospf__distance.html">ospf_distance</a> *odistance)
<a name="l01121"></a>01121 {
<a name="l01122"></a>01122   <a class="code" href="memory_8h.html#a29f1ce2c850a3163cd6b1b0bd460705d">XFREE</a> (<a class="code" href="memtypes_8h.html#a7ff5f2dff38e7639981794c43dc9167bad6bee78f12efadf451900d73648ac5f6">MTYPE_OSPF_DISTANCE</a>, odistance);
<a name="l01123"></a>01123 }
<a name="l01124"></a>01124 
<a name="l01125"></a>01125 <span class="keywordtype">int</span>
<a name="l01126"></a><a class="code" href="ospf__zebra_8h.html#ab7ee95d13b64a95a3d24d8cf674ef950">01126</a> <a class="code" href="ospf__zebra_8c.html#a23e0b3598c30c6bafaaa10fa441a969f">ospf_distance_set</a> (<span class="keyword">struct</span> <a class="code" href="structvty.html">vty</a> *<a class="code" href="structvty.html">vty</a>, <span class="keyword">struct</span> <a class="code" href="structospf.html">ospf</a> *<a class="code" href="structospf.html">ospf</a>, 
<a name="l01127"></a>01127                    <span class="keyword">const</span> <span class="keywordtype">char</span> *distance_str,
<a name="l01128"></a>01128                    <span class="keyword">const</span> <span class="keywordtype">char</span> *ip_str, 
<a name="l01129"></a>01129                    <span class="keyword">const</span> <span class="keywordtype">char</span> *access_list_str)
<a name="l01130"></a>01130 {
<a name="l01131"></a>01131   <span class="keywordtype">int</span> ret;
<a name="l01132"></a>01132   <span class="keyword">struct </span><a class="code" href="structprefix__ipv4.html">prefix_ipv4</a> p;
<a name="l01133"></a>01133   u_char <a class="code" href="zebra__rib_8c.html#afb9412686cd344ad61757c1c19ba8a87">distance</a>;
<a name="l01134"></a>01134   <span class="keyword">struct </span><a class="code" href="structroute__node.html">route_node</a> *rn;
<a name="l01135"></a>01135   <span class="keyword">struct </span><a class="code" href="structospf__distance.html">ospf_distance</a> *odistance;
<a name="l01136"></a>01136 
<a name="l01137"></a>01137   ret = <a class="code" href="prefix_8c.html#aae422250092661b36915d1769df957f7">str2prefix_ipv4</a> (ip_str, &amp;p);
<a name="l01138"></a>01138   <span class="keywordflow">if</span> (ret == 0)
<a name="l01139"></a>01139     {
<a name="l01140"></a>01140       <a class="code" href="vty_8c.html#a3725db0ec6ad3ffdd31f68abc807ee34">vty_out</a> (vty, <span class="stringliteral">&quot;Malformed prefix%s&quot;</span>, <a class="code" href="vty_8h.html#a3be8ca867e2953936a95c68dc64824b6">VTY_NEWLINE</a>);
<a name="l01141"></a>01141       <span class="keywordflow">return</span> <a class="code" href="command_8h.html#a92dc6dc30d8ef3651eb9d47a6083b025">CMD_WARNING</a>;
<a name="l01142"></a>01142     }
<a name="l01143"></a>01143 
<a name="l01144"></a>01144   distance = atoi (distance_str);
<a name="l01145"></a>01145 
<a name="l01146"></a>01146   <span class="comment">/* Get OSPF distance node. */</span>
<a name="l01147"></a>01147   rn = <a class="code" href="table_8c.html#ac91fdff1a0b8dc3d60ebaf152caa0f80">route_node_get</a> (ospf-&gt;<a class="code" href="structospf.html#aa0bcd2b2f2d571c795617a6ddcd0faa7">distance_table</a>, (<span class="keyword">struct</span> <a class="code" href="structprefix.html">prefix</a> *) &amp;p);
<a name="l01148"></a>01148   <span class="keywordflow">if</span> (rn-&gt;<a class="code" href="structroute__node.html#a20aabb1a6fbe9de363a1c57fe3124c87">info</a>)
<a name="l01149"></a>01149     {
<a name="l01150"></a>01150       odistance = rn-&gt;<a class="code" href="structroute__node.html#a20aabb1a6fbe9de363a1c57fe3124c87">info</a>;
<a name="l01151"></a>01151       <a class="code" href="table_8c.html#a849965644708e01ef49c203a2e00afd4">route_unlock_node</a> (rn);
<a name="l01152"></a>01152     }
<a name="l01153"></a>01153   <span class="keywordflow">else</span>
<a name="l01154"></a>01154     {
<a name="l01155"></a>01155       odistance = <a class="code" href="ospf__zebra_8c.html#a3cb2e7f39c68713a806a1d08643bb4b7">ospf_distance_new</a> ();
<a name="l01156"></a>01156       rn-&gt;<a class="code" href="structroute__node.html#a20aabb1a6fbe9de363a1c57fe3124c87">info</a> = odistance;
<a name="l01157"></a>01157     }
<a name="l01158"></a>01158 
<a name="l01159"></a>01159   <span class="comment">/* Set distance value. */</span>
<a name="l01160"></a>01160   odistance-&gt;<a class="code" href="structospf__distance.html#abfb569e1e6c80fda164304bf00250375">distance</a> = <a class="code" href="zebra__rib_8c.html#afb9412686cd344ad61757c1c19ba8a87">distance</a>;
<a name="l01161"></a>01161 
<a name="l01162"></a>01162   <span class="comment">/* Reset access-list configuration. */</span>
<a name="l01163"></a>01163   <span class="keywordflow">if</span> (odistance-&gt;<a class="code" href="structospf__distance.html#ab75a7f5e896a82a39cd9b3ee32e9a9a1">access_list</a>)
<a name="l01164"></a>01164     {
<a name="l01165"></a>01165       free (odistance-&gt;<a class="code" href="structospf__distance.html#ab75a7f5e896a82a39cd9b3ee32e9a9a1">access_list</a>);
<a name="l01166"></a>01166       odistance-&gt;<a class="code" href="structospf__distance.html#ab75a7f5e896a82a39cd9b3ee32e9a9a1">access_list</a> = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01167"></a>01167     }
<a name="l01168"></a>01168   <span class="keywordflow">if</span> (access_list_str)
<a name="l01169"></a>01169     odistance-&gt;<a class="code" href="structospf__distance.html#ab75a7f5e896a82a39cd9b3ee32e9a9a1">access_list</a> = strdup (access_list_str);
<a name="l01170"></a>01170 
<a name="l01171"></a>01171   <span class="keywordflow">return</span> <a class="code" href="command_8h.html#aa2008c1bc36d9ef42571a6ec52516d02">CMD_SUCCESS</a>;
<a name="l01172"></a>01172 }
<a name="l01173"></a>01173 
<a name="l01174"></a>01174 <span class="keywordtype">int</span>
<a name="l01175"></a><a class="code" href="ospf__zebra_8h.html#acf6d2c4c0ddedd11eca685895d2df9fd">01175</a> <a class="code" href="ospf__zebra_8c.html#a375a75203f161c2de60c77435b4b17c5">ospf_distance_unset</a> (<span class="keyword">struct</span> <a class="code" href="structvty.html">vty</a> *<a class="code" href="structvty.html">vty</a>, <span class="keyword">struct</span> <a class="code" href="structospf.html">ospf</a> *<a class="code" href="structospf.html">ospf</a>, 
<a name="l01176"></a>01176                      <span class="keyword">const</span> <span class="keywordtype">char</span> *distance_str,
<a name="l01177"></a>01177                      <span class="keyword">const</span> <span class="keywordtype">char</span> *ip_str, <span class="keywordtype">char</span> 
<a name="l01178"></a>01178                      <span class="keyword">const</span> *access_list_str)
<a name="l01179"></a>01179 {
<a name="l01180"></a>01180   <span class="keywordtype">int</span> ret;
<a name="l01181"></a>01181   <span class="keyword">struct </span><a class="code" href="structprefix__ipv4.html">prefix_ipv4</a> p;
<a name="l01182"></a>01182   u_char <a class="code" href="zebra__rib_8c.html#afb9412686cd344ad61757c1c19ba8a87">distance</a>;
<a name="l01183"></a>01183   <span class="keyword">struct </span><a class="code" href="structroute__node.html">route_node</a> *rn;
<a name="l01184"></a>01184   <span class="keyword">struct </span><a class="code" href="structospf__distance.html">ospf_distance</a> *odistance;
<a name="l01185"></a>01185 
<a name="l01186"></a>01186   ret = <a class="code" href="prefix_8c.html#aae422250092661b36915d1769df957f7">str2prefix_ipv4</a> (ip_str, &amp;p);
<a name="l01187"></a>01187   <span class="keywordflow">if</span> (ret == 0)
<a name="l01188"></a>01188     {
<a name="l01189"></a>01189       <a class="code" href="vty_8c.html#a3725db0ec6ad3ffdd31f68abc807ee34">vty_out</a> (vty, <span class="stringliteral">&quot;Malformed prefix%s&quot;</span>, <a class="code" href="vty_8h.html#a3be8ca867e2953936a95c68dc64824b6">VTY_NEWLINE</a>);
<a name="l01190"></a>01190       <span class="keywordflow">return</span> <a class="code" href="command_8h.html#a92dc6dc30d8ef3651eb9d47a6083b025">CMD_WARNING</a>;
<a name="l01191"></a>01191     }
<a name="l01192"></a>01192 
<a name="l01193"></a>01193   distance = atoi (distance_str);
<a name="l01194"></a>01194 
<a name="l01195"></a>01195   rn = <a class="code" href="table_8c.html#ab99d86b40440c8f18d4f2b31b5b8f1c7">route_node_lookup</a> (ospf-&gt;<a class="code" href="structospf.html#aa0bcd2b2f2d571c795617a6ddcd0faa7">distance_table</a>, (<span class="keyword">struct</span> <a class="code" href="structprefix.html">prefix</a> *) &amp;p);
<a name="l01196"></a>01196   <span class="keywordflow">if</span> (!rn)
<a name="l01197"></a>01197     {
<a name="l01198"></a>01198       <a class="code" href="vty_8c.html#a3725db0ec6ad3ffdd31f68abc807ee34">vty_out</a> (vty, <span class="stringliteral">&quot;Can&#39;t find specified prefix%s&quot;</span>, <a class="code" href="vty_8h.html#a3be8ca867e2953936a95c68dc64824b6">VTY_NEWLINE</a>);
<a name="l01199"></a>01199       <span class="keywordflow">return</span> <a class="code" href="command_8h.html#a92dc6dc30d8ef3651eb9d47a6083b025">CMD_WARNING</a>;
<a name="l01200"></a>01200     }
<a name="l01201"></a>01201 
<a name="l01202"></a>01202   odistance = rn-&gt;<a class="code" href="structroute__node.html#a20aabb1a6fbe9de363a1c57fe3124c87">info</a>;
<a name="l01203"></a>01203 
<a name="l01204"></a>01204   <span class="keywordflow">if</span> (odistance-&gt;<a class="code" href="structospf__distance.html#ab75a7f5e896a82a39cd9b3ee32e9a9a1">access_list</a>)
<a name="l01205"></a>01205     free (odistance-&gt;<a class="code" href="structospf__distance.html#ab75a7f5e896a82a39cd9b3ee32e9a9a1">access_list</a>);
<a name="l01206"></a>01206   <a class="code" href="ospf__zebra_8c.html#ad7de1ef8610fe7846b43f26dd906c2d5">ospf_distance_free</a> (odistance);
<a name="l01207"></a>01207 
<a name="l01208"></a>01208   rn-&gt;<a class="code" href="structroute__node.html#a20aabb1a6fbe9de363a1c57fe3124c87">info</a> = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01209"></a>01209   <a class="code" href="table_8c.html#a849965644708e01ef49c203a2e00afd4">route_unlock_node</a> (rn);
<a name="l01210"></a>01210   <a class="code" href="table_8c.html#a849965644708e01ef49c203a2e00afd4">route_unlock_node</a> (rn);
<a name="l01211"></a>01211 
<a name="l01212"></a>01212   <span class="keywordflow">return</span> <a class="code" href="command_8h.html#aa2008c1bc36d9ef42571a6ec52516d02">CMD_SUCCESS</a>;
<a name="l01213"></a>01213 }
<a name="l01214"></a>01214 
<a name="l01215"></a>01215 <span class="keywordtype">void</span>
<a name="l01216"></a><a class="code" href="ospf__zebra_8h.html#a8231cf4553f3d21064f755928618afd0">01216</a> <a class="code" href="ospf__zebra_8c.html#ae662051107e9412269a5868e5c1085d7">ospf_distance_reset</a> (<span class="keyword">struct</span> <a class="code" href="structospf.html">ospf</a> *<a class="code" href="structospf.html">ospf</a>)
<a name="l01217"></a>01217 {
<a name="l01218"></a>01218   <span class="keyword">struct </span><a class="code" href="structroute__node.html">route_node</a> *rn;
<a name="l01219"></a>01219   <span class="keyword">struct </span><a class="code" href="structospf__distance.html">ospf_distance</a> *odistance;
<a name="l01220"></a>01220 
<a name="l01221"></a>01221   <span class="keywordflow">for</span> (rn = <a class="code" href="table_8c.html#aee1d06c531794df326d946bdac647fb2">route_top</a> (ospf-&gt;<a class="code" href="structospf.html#aa0bcd2b2f2d571c795617a6ddcd0faa7">distance_table</a>); rn; rn = <a class="code" href="table_8c.html#ad2addc694ecf6cd0cce57cb3a7d96902">route_next</a> (rn))
<a name="l01222"></a>01222     <span class="keywordflow">if</span> ((odistance = rn-&gt;<a class="code" href="structroute__node.html#a20aabb1a6fbe9de363a1c57fe3124c87">info</a>) != <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01223"></a>01223       {
<a name="l01224"></a>01224         <span class="keywordflow">if</span> (odistance-&gt;<a class="code" href="structospf__distance.html#ab75a7f5e896a82a39cd9b3ee32e9a9a1">access_list</a>)
<a name="l01225"></a>01225           free (odistance-&gt;<a class="code" href="structospf__distance.html#ab75a7f5e896a82a39cd9b3ee32e9a9a1">access_list</a>);
<a name="l01226"></a>01226         <a class="code" href="ospf__zebra_8c.html#ad7de1ef8610fe7846b43f26dd906c2d5">ospf_distance_free</a> (odistance);
<a name="l01227"></a>01227         rn-&gt;<a class="code" href="structroute__node.html#a20aabb1a6fbe9de363a1c57fe3124c87">info</a> = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01228"></a>01228         <a class="code" href="table_8c.html#a849965644708e01ef49c203a2e00afd4">route_unlock_node</a> (rn);
<a name="l01229"></a>01229       }
<a name="l01230"></a>01230 }
<a name="l01231"></a>01231 
<a name="l01232"></a>01232 u_char
<a name="l01233"></a><a class="code" href="ospf__zebra_8h.html#a768ea1d8e5f6d7a410d9f799b23eb60e">01233</a> <a class="code" href="ospf__zebra_8c.html#a41cbdfc85156d98b745b25d652cb35a3">ospf_distance_apply</a> (<span class="keyword">struct</span> <a class="code" href="structprefix__ipv4.html">prefix_ipv4</a> *<a class="code" href="spgrid_8c.html#a931bc2aa940ac2a4d1601cf842336926">p</a>, <span class="keyword">struct</span> <a class="code" href="structospf__route.html">ospf_route</a> *or)
<a name="l01234"></a>01234 {
<a name="l01235"></a>01235   <span class="keyword">struct </span><a class="code" href="structospf.html">ospf</a> *<a class="code" href="structospf.html">ospf</a>;
<a name="l01236"></a>01236 
<a name="l01237"></a>01237   ospf = <a class="code" href="ospfd_8c.html#a8ea0c935a4862c1469bc962e93fee74b">ospf_lookup</a> ();
<a name="l01238"></a>01238   <span class="keywordflow">if</span> (ospf == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01239"></a>01239     <span class="keywordflow">return</span> 0;
<a name="l01240"></a>01240 
<a name="l01241"></a>01241   <span class="keywordflow">if</span> (ospf-&gt;<a class="code" href="structospf.html#ab87aa14246f5c62f4d866ad725c5f268">distance_intra</a>)
<a name="l01242"></a>01242     <span class="keywordflow">if</span> (or-&gt;<a class="code" href="structospf__route.html#a599273b0e8bc1a908cbedd22dcd78bbd">path_type</a> == <a class="code" href="ospf__route_8h.html#abc7a6177d1cdfac4e8a93ddd4235b08c">OSPF_PATH_INTRA_AREA</a>)
<a name="l01243"></a>01243       <span class="keywordflow">return</span> ospf-&gt;<a class="code" href="structospf.html#ab87aa14246f5c62f4d866ad725c5f268">distance_intra</a>;
<a name="l01244"></a>01244 
<a name="l01245"></a>01245   <span class="keywordflow">if</span> (ospf-&gt;<a class="code" href="structospf.html#aa35f81a36f5ec5e3cf7541303a9ef668">distance_inter</a>)
<a name="l01246"></a>01246     <span class="keywordflow">if</span> (or-&gt;<a class="code" href="structospf__route.html#a599273b0e8bc1a908cbedd22dcd78bbd">path_type</a> == <a class="code" href="ospf__route_8h.html#a1db558d26de4f9320c77c0d783d7b2b3">OSPF_PATH_INTER_AREA</a>)
<a name="l01247"></a>01247       <span class="keywordflow">return</span> ospf-&gt;<a class="code" href="structospf.html#aa35f81a36f5ec5e3cf7541303a9ef668">distance_inter</a>;
<a name="l01248"></a>01248 
<a name="l01249"></a>01249   <span class="keywordflow">if</span> (ospf-&gt;<a class="code" href="structospf.html#a293d2cb6ad232413308d29b40de93ad2">distance_external</a>)
<a name="l01250"></a>01250     <span class="keywordflow">if</span> (or-&gt;<a class="code" href="structospf__route.html#a599273b0e8bc1a908cbedd22dcd78bbd">path_type</a> == <a class="code" href="ospf__route_8h.html#a15dab014460164847059902ea4535834">OSPF_PATH_TYPE1_EXTERNAL</a>
<a name="l01251"></a>01251         || or-&gt;<a class="code" href="structospf__route.html#a599273b0e8bc1a908cbedd22dcd78bbd">path_type</a> == <a class="code" href="ospf__route_8h.html#aa9752c4570157da8a3258dc4cdf23ce5">OSPF_PATH_TYPE2_EXTERNAL</a>)
<a name="l01252"></a>01252       <span class="keywordflow">return</span> ospf-&gt;<a class="code" href="structospf.html#a293d2cb6ad232413308d29b40de93ad2">distance_external</a>;
<a name="l01253"></a>01253 
<a name="l01254"></a>01254   <span class="keywordflow">if</span> (ospf-&gt;<a class="code" href="structospf.html#a57b00cc3a2a5e6771e9b21ff5d7d3ff3">distance_all</a>)
<a name="l01255"></a>01255     <span class="keywordflow">return</span> ospf-&gt;<a class="code" href="structospf.html#a57b00cc3a2a5e6771e9b21ff5d7d3ff3">distance_all</a>;
<a name="l01256"></a>01256 
<a name="l01257"></a>01257   <span class="keywordflow">return</span> 0;
<a name="l01258"></a>01258 }
<a name="l01259"></a>01259 
<a name="l01260"></a>01260 <span class="keywordtype">void</span>
<a name="l01261"></a><a class="code" href="ospf__zebra_8h.html#a72fbdc912498a5746820b3bff6c6f0a8">01261</a> <a class="code" href="ospf__zebra_8c.html#ab1c4318a2b05df85bdda75f3355aa25c">ospf_zebra_init</a> ()
<a name="l01262"></a>01262 {
<a name="l01263"></a>01263   <span class="comment">/* Allocate zebra structure. */</span>
<a name="l01264"></a>01264   zclient = <a class="code" href="zclient_8c.html#aa521f2a71596b1dc50f76fcb57dff30b">zclient_new</a> ();
<a name="l01265"></a>01265   <a class="code" href="zclient_8c.html#ac649a246f405850a3ade72de002745e3">zclient_init</a> (zclient, <a class="code" href="zebra_8h.html#a35ba23125eb2c360943b1bad51673ab0">ZEBRA_ROUTE_OSPF</a>);
<a name="l01266"></a>01266   zclient-&gt;<a class="code" href="structzclient.html#a91ae88d0aa9ff087af5b7567334197f6">router_id_update</a> = <a class="code" href="ospf__zebra_8c.html#ac766e7564bdf5781398b1b1723b7d078">ospf_router_id_update_zebra</a>;
<a name="l01267"></a>01267   zclient-&gt;<a class="code" href="structzclient.html#a42e63c358fc87552ca16a1eea8b69c4f">interface_add</a> = <a class="code" href="ospf__zebra_8c.html#affcb29b33003244d9d1464bc907eda20">ospf_interface_add</a>;
<a name="l01268"></a>01268   zclient-&gt;<a class="code" href="structzclient.html#a59d608db28363c236285c6323d5697ab">interface_delete</a> = <a class="code" href="ospf__zebra_8c.html#afbcd5a399d377db72f8e11faa2b84b59">ospf_interface_delete</a>;
<a name="l01269"></a>01269   zclient-&gt;<a class="code" href="structzclient.html#a45465702e655472187e9efc3c1734daa">interface_up</a> = <a class="code" href="ospf__zebra_8c.html#ac5a236e0c7105013a377deda755a3a9f">ospf_interface_state_up</a>;
<a name="l01270"></a>01270   zclient-&gt;<a class="code" href="structzclient.html#a426b5e0ec3b5ad8843eb42deaa4fe335">interface_down</a> = <a class="code" href="ospf__zebra_8c.html#a8d0747b0991dedc055bf79a824a25834">ospf_interface_state_down</a>;
<a name="l01271"></a>01271   zclient-&gt;<a class="code" href="structzclient.html#a75ee908bb229653f271356b982fa76e7">interface_address_add</a> = <a class="code" href="ospf__zebra_8c.html#ab73bf4f6f734469a4d35cd112c74265a">ospf_interface_address_add</a>;
<a name="l01272"></a>01272   zclient-&gt;<a class="code" href="structzclient.html#a3494b722f85fe14ff8c99ddae54bad94">interface_address_delete</a> = <a class="code" href="ospf__zebra_8c.html#aef874b4b32cf37d7176a9f929de61d21">ospf_interface_address_delete</a>;
<a name="l01273"></a>01273   zclient-&gt;<a class="code" href="structzclient.html#ac2fe2ea5a7f820e1ac572f7629be997f">ipv4_route_add</a> = <a class="code" href="ospf__zebra_8c.html#aa094f27792bcac11e8b637c65199e0fa">ospf_zebra_read_ipv4</a>;
<a name="l01274"></a>01274   zclient-&gt;<a class="code" href="structzclient.html#a2fa1fdde8885665490f46edc8c102d4a">ipv4_route_delete</a> = <a class="code" href="ospf__zebra_8c.html#aa094f27792bcac11e8b637c65199e0fa">ospf_zebra_read_ipv4</a>;
<a name="l01275"></a>01275 
<a name="l01276"></a>01276   <a class="code" href="filter_8c.html#afc932e79e55881b9a1c1e700ec1e0cb4">access_list_add_hook</a> (<a class="code" href="ospf__zebra_8c.html#a4a532c457c6791580c8b595aa044db28">ospf_filter_update</a>);
<a name="l01277"></a>01277   <a class="code" href="filter_8c.html#a7696ba96f8b2cf3a96dbfb2e161d6752">access_list_delete_hook</a> (<a class="code" href="ospf__zebra_8c.html#a4a532c457c6791580c8b595aa044db28">ospf_filter_update</a>);
<a name="l01278"></a>01278   <a class="code" href="plist_8c.html#add7d0c6cd7985233eb409608b9bf248b">prefix_list_add_hook</a> (<a class="code" href="ospf__zebra_8c.html#a490e15816e8166995cd3c9c4b7e0cc95">ospf_prefix_list_update</a>);
<a name="l01279"></a>01279   <a class="code" href="plist_8c.html#a28384c5c606bb185263f9d8f7ad4fa98">prefix_list_delete_hook</a> (<a class="code" href="ospf__zebra_8c.html#a490e15816e8166995cd3c9c4b7e0cc95">ospf_prefix_list_update</a>);
<a name="l01280"></a>01280 }
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="ospf__zebra_8c.html">ospf_zebra.c</a>      </li>

    <li class="footer">Generated on Tue Apr 24 2012 10:41:08 for OSPFN by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.5.1 </li>
   </ul>
 </div>


</body>
</html>
