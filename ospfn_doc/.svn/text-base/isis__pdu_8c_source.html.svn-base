<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>OSPFN: isisd/isis_pdu.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>


</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">OSPFN
   &#160;<span id="projectnumber">1.1</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('isis__pdu_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">isisd/isis_pdu.c</div>  </div>
</div>
<div class="contents">
<a href="isis__pdu_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * IS-IS Rout(e)ing protocol - isis_pdu.c   </span>
<a name="l00003"></a>00003 <span class="comment"> *                             PDU processing</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * Copyright (C) 2001,2002   Sampo Saaristo</span>
<a name="l00006"></a>00006 <span class="comment"> *                           Tampere University of Technology      </span>
<a name="l00007"></a>00007 <span class="comment"> *                           Institute of Communications Engineering</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is free software; you can redistribute it and/or modify it </span>
<a name="l00010"></a>00010 <span class="comment"> * under the terms of the GNU General Public Licenseas published by the Free </span>
<a name="l00011"></a>00011 <span class="comment"> * Software Foundation; either version 2 of the License, or (at your option) </span>
<a name="l00012"></a>00012 <span class="comment"> * any later version.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is distributed in the hope that it will be useful,but WITHOUT </span>
<a name="l00015"></a>00015 <span class="comment"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or </span>
<a name="l00016"></a>00016 <span class="comment"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for </span>
<a name="l00017"></a>00017 <span class="comment"> * more details.</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment"> * You should have received a copy of the GNU General Public License along </span>
<a name="l00020"></a>00020 <span class="comment"> * with this program; if not, write to the Free Software Foundation, Inc., </span>
<a name="l00021"></a>00021 <span class="comment"> * 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
<a name="l00022"></a>00022 <span class="comment"> */</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;<a class="code" href="zebra_8h.html">zebra.h</a>&gt;</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="memory_8h.html">memory.h</a>&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="thread_8h.html">thread.h</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="linklist_8h.html">linklist.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="log_8h.html">log.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="stream_8h.html">stream.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="vty_8h.html">vty.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="hash_8c.html">hash.c</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="prefix_8h.html">prefix.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="if_8h.html">if.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="checksum_8h.html">checksum.h</a>&quot;</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="dict_8h.html">isisd/dict.h</a>&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="iso_8h.html">isisd/include-netbsd/iso.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="isis__constants_8h.html">isisd/isis_constants.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="isis__common_8h.html">isisd/isis_common.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="isis__adjacency_8h.html">isisd/isis_adjacency.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="isis__circuit_8h.html">isisd/isis_circuit.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="isis__network_8h.html">isisd/isis_network.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="isis__misc_8h.html">isisd/isis_misc.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="isis__dr_8h.html">isisd/isis_dr.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="isis__flags_8h.html">isisd/isis_flags.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="isis__tlv_8h.html">isisd/isis_tlv.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="isisd_8h.html">isisd/isisd.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="isis__dynhn_8h.html">isisd/isis_dynhn.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="isis__lsp_8h.html">isisd/isis_lsp.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="isis__pdu_8h.html">isisd/isis_pdu.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="iso__checksum_8h.html">isisd/iso_checksum.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="isis__csm_8h.html">isisd/isis_csm.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="isis__events_8h.html">isisd/isis_events.h</a>&quot;</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="keyword">extern</span> <span class="keyword">struct </span><a class="code" href="structthread__master.html">thread_master</a> *<a class="code" href="bgp__main_8c.html#af7f9077bc08df049beb65a1c09cde5fa">master</a>;
<a name="l00057"></a>00057 <span class="keyword">extern</span> <span class="keyword">struct </span><a class="code" href="structisis.html">isis</a> *<a class="code" href="isis__adjacency_8c.html#aa8cfdc8f7777fd242bd2c45f3a48b950">isis</a>;
<a name="l00058"></a>00058 
<a name="l00059"></a><a class="code" href="isis__pdu_8c.html#aca2aaedf29c85944f6063b91c0461b20">00059</a> <span class="preprocessor">#define ISIS_MINIMUM_FIXED_HDR_LEN 15</span>
<a name="l00060"></a><a class="code" href="isis__pdu_8c.html#ac2bed1172792ac0de1f61070ae90e647">00060</a> <span class="preprocessor"></span><span class="preprocessor">#define ISIS_MIN_PDU_LEN           13   </span><span class="comment">/* partial seqnum pdu with id_len=2 */</span>
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 <span class="preprocessor">#ifndef PNBBY</span>
<a name="l00063"></a><a class="code" href="isis__pdu_8c.html#a6f9a32b2fd315bf69360c883843e8699">00063</a> <span class="preprocessor"></span><span class="preprocessor">#define PNBBY 8</span>
<a name="l00064"></a>00064 <span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* PNBBY */</span>
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 <span class="comment">/* Utility mask array. */</span>
<a name="l00067"></a><a class="code" href="isis__pdu_8c.html#a675cc05c7391c1cd5e88ed25175ad5e1">00067</a> <span class="keyword">static</span> <span class="keyword">const</span> u_char <a class="code" href="isis__pdu_8c.html#a675cc05c7391c1cd5e88ed25175ad5e1">maskbit</a>[] = {
<a name="l00068"></a>00068   0x00, 0x80, 0xc0, 0xe0, 0xf0, 0xf8, 0xfc, 0xfe, 0xff
<a name="l00069"></a>00069 };
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 <span class="comment">/*</span>
<a name="l00072"></a>00072 <span class="comment"> * HELPER FUNCS</span>
<a name="l00073"></a>00073 <span class="comment"> */</span>
<a name="l00074"></a>00074 
<a name="l00075"></a>00075 <span class="comment">/*</span>
<a name="l00076"></a>00076 <span class="comment"> * Compares two sets of area addresses</span>
<a name="l00077"></a>00077 <span class="comment"> */</span>
<a name="l00078"></a>00078 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00079"></a><a class="code" href="isis__pdu_8c.html#ac44201d5d72450ec89f35a014c1e31c1">00079</a> <a class="code" href="isis__pdu_8c.html#ac44201d5d72450ec89f35a014c1e31c1">area_match</a> (<span class="keyword">struct</span> <a class="code" href="structlist.html">list</a> *<a class="code" href="dict_8c.html#a428f8207615465afdfcf1d31547ffef3">left</a>, <span class="keyword">struct</span> <a class="code" href="structlist.html">list</a> *<a class="code" href="dict_8c.html#ae545bf658b2c876abbbae55a7d12875f">right</a>)
<a name="l00080"></a>00080 {
<a name="l00081"></a>00081   <span class="keyword">struct </span><a class="code" href="structarea__addr.html">area_addr</a> *addr1, *addr2;
<a name="l00082"></a>00082   <span class="keyword">struct </span><a class="code" href="structlistnode.html">listnode</a> *node1, *node2;
<a name="l00083"></a>00083 
<a name="l00084"></a>00084   <span class="keywordflow">for</span> (<a class="code" href="linklist_8h.html#a80a3f4035be83abbb709d17412993226">ALL_LIST_ELEMENTS_RO</a> (left, node1, addr1))
<a name="l00085"></a>00085   {
<a name="l00086"></a>00086     <span class="keywordflow">for</span> (<a class="code" href="linklist_8h.html#a80a3f4035be83abbb709d17412993226">ALL_LIST_ELEMENTS_RO</a> (right, node2, addr2))
<a name="l00087"></a>00087     {
<a name="l00088"></a>00088       <span class="keywordflow">if</span> (addr1-&gt;<a class="code" href="structarea__addr.html#ae735a6ff10c8e48ebe4e98a06e194a82">addr_len</a> == addr2-&gt;<a class="code" href="structarea__addr.html#ae735a6ff10c8e48ebe4e98a06e194a82">addr_len</a> &amp;&amp;
<a name="l00089"></a>00089       !<a class="code" href="regex_8c.html#a98d0dff0c7366f08562d8e8583df9bb9">memcmp</a> (addr1-&gt;<a class="code" href="structarea__addr.html#ac84395fbe3f40a45edf1d7ab43a701da">area_addr</a>, addr2-&gt;<a class="code" href="structarea__addr.html#ac84395fbe3f40a45edf1d7ab43a701da">area_addr</a>, (<span class="keywordtype">int</span>) addr1-&gt;<a class="code" href="structarea__addr.html#ae735a6ff10c8e48ebe4e98a06e194a82">addr_len</a>))
<a name="l00090"></a>00090     <span class="keywordflow">return</span> 1;       <span class="comment">/* match */</span>
<a name="l00091"></a>00091     }
<a name="l00092"></a>00092   }
<a name="l00093"></a>00093 
<a name="l00094"></a>00094   <span class="keywordflow">return</span> 0;         <span class="comment">/* mismatch */</span>
<a name="l00095"></a>00095 }
<a name="l00096"></a>00096 
<a name="l00097"></a>00097 <span class="comment">/*</span>
<a name="l00098"></a>00098 <span class="comment"> * Check if ip2 is in the ip1&#39;s network (function like Prefix.h:prefix_match() )</span>
<a name="l00099"></a>00099 <span class="comment"> * param ip1            the IS interface ip address structure</span>
<a name="l00100"></a>00100 <span class="comment"> * param ip2            the IIH&#39;s ip address</span>
<a name="l00101"></a>00101 <span class="comment"> * return  0            the IIH&#39;s IP is not in the IS&#39;s subnetwork</span>
<a name="l00102"></a>00102 <span class="comment"> *         1            the IIH&#39;s IP is in the IS&#39;s subnetwork</span>
<a name="l00103"></a>00103 <span class="comment"> */</span>
<a name="l00104"></a>00104 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00105"></a><a class="code" href="isis__pdu_8c.html#ae727c7399fa6085b6d0ef021c52b887b">00105</a> <a class="code" href="isis__pdu_8c.html#ae727c7399fa6085b6d0ef021c52b887b">ip_same_subnet</a> (<span class="keyword">struct</span> <a class="code" href="structprefix__ipv4.html">prefix_ipv4</a> *ip1, <span class="keyword">struct</span> in_addr *ip2)
<a name="l00106"></a>00106 {
<a name="l00107"></a>00107   u_char *addr1, *addr2;
<a name="l00108"></a>00108   <span class="keywordtype">int</span> shift, offset, offsetloop;
<a name="l00109"></a>00109   <span class="keywordtype">int</span> len;
<a name="l00110"></a>00110 
<a name="l00111"></a>00111   addr1 = (u_char *) &amp; ip1-&gt;prefix.s_addr;
<a name="l00112"></a>00112   addr2 = (u_char *) &amp; ip2-&gt;s_addr;
<a name="l00113"></a>00113   len = ip1-&gt;<a class="code" href="structprefix__ipv4.html#ab96da4bf1eb37195bd564bcf1126a16a">prefixlen</a>;
<a name="l00114"></a>00114 
<a name="l00115"></a>00115   shift = len % <a class="code" href="isis__pdu_8c.html#a6f9a32b2fd315bf69360c883843e8699">PNBBY</a>;
<a name="l00116"></a>00116   offsetloop = offset = len / <a class="code" href="isis__pdu_8c.html#a6f9a32b2fd315bf69360c883843e8699">PNBBY</a>;
<a name="l00117"></a>00117 
<a name="l00118"></a>00118   <span class="keywordflow">while</span> (offsetloop--)
<a name="l00119"></a>00119     <span class="keywordflow">if</span> (addr1[offsetloop] != addr2[offsetloop])
<a name="l00120"></a>00120       <span class="keywordflow">return</span> 0;
<a name="l00121"></a>00121 
<a name="l00122"></a>00122   <span class="keywordflow">if</span> (shift)
<a name="l00123"></a>00123     <span class="keywordflow">if</span> (<a class="code" href="isis__pdu_8c.html#a675cc05c7391c1cd5e88ed25175ad5e1">maskbit</a>[shift] &amp; (addr1[offset] ^ addr2[offset]))
<a name="l00124"></a>00124       <span class="keywordflow">return</span> 0;
<a name="l00125"></a>00125 
<a name="l00126"></a>00126   <span class="keywordflow">return</span> 1;         <span class="comment">/* match  */</span>
<a name="l00127"></a>00127 }
<a name="l00128"></a>00128 
<a name="l00129"></a>00129 <span class="comment">/*</span>
<a name="l00130"></a>00130 <span class="comment"> * Compares two set of ip addresses</span>
<a name="l00131"></a>00131 <span class="comment"> * param left     the local interface&#39;s ip addresses</span>
<a name="l00132"></a>00132 <span class="comment"> * param right    the iih interface&#39;s ip address</span>
<a name="l00133"></a>00133 <span class="comment"> * return         0   no match;</span>
<a name="l00134"></a>00134 <span class="comment"> *                1   match;</span>
<a name="l00135"></a>00135 <span class="comment"> */</span>
<a name="l00136"></a>00136 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00137"></a><a class="code" href="isis__pdu_8c.html#a7df02c36d437547a772bc406fc9594fb">00137</a> <a class="code" href="isis__pdu_8c.html#a7df02c36d437547a772bc406fc9594fb">ip_match</a> (<span class="keyword">struct</span> <a class="code" href="structlist.html">list</a> *<a class="code" href="dict_8c.html#a428f8207615465afdfcf1d31547ffef3">left</a>, <span class="keyword">struct</span> <a class="code" href="structlist.html">list</a> *<a class="code" href="dict_8c.html#ae545bf658b2c876abbbae55a7d12875f">right</a>)
<a name="l00138"></a>00138 {
<a name="l00139"></a>00139   <span class="keyword">struct </span><a class="code" href="structprefix__ipv4.html">prefix_ipv4</a> *ip1;
<a name="l00140"></a>00140   <span class="keyword">struct </span>in_addr *ip2;
<a name="l00141"></a>00141   <span class="keyword">struct </span><a class="code" href="structlistnode.html">listnode</a> *node1, *node2;
<a name="l00142"></a>00142 
<a name="l00143"></a>00143   <span class="keywordflow">if</span> ((left == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || (right == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))
<a name="l00144"></a>00144     <span class="keywordflow">return</span> 0;
<a name="l00145"></a>00145   
<a name="l00146"></a>00146   <span class="keywordflow">for</span> (<a class="code" href="linklist_8h.html#a80a3f4035be83abbb709d17412993226">ALL_LIST_ELEMENTS_RO</a> (left, node1, ip1))
<a name="l00147"></a>00147   {
<a name="l00148"></a>00148     <span class="keywordflow">for</span> (<a class="code" href="linklist_8h.html#a80a3f4035be83abbb709d17412993226">ALL_LIST_ELEMENTS_RO</a> (right, node2, ip2))
<a name="l00149"></a>00149     {
<a name="l00150"></a>00150       <span class="keywordflow">if</span> (<a class="code" href="isis__pdu_8c.html#ae727c7399fa6085b6d0ef021c52b887b">ip_same_subnet</a> (ip1, ip2))
<a name="l00151"></a>00151     {
<a name="l00152"></a>00152       <span class="keywordflow">return</span> 1;     <span class="comment">/* match */</span>
<a name="l00153"></a>00153     }
<a name="l00154"></a>00154     }
<a name="l00155"></a>00155 
<a name="l00156"></a>00156   }
<a name="l00157"></a>00157   <span class="keywordflow">return</span> 0;
<a name="l00158"></a>00158 }
<a name="l00159"></a>00159 
<a name="l00160"></a>00160 <span class="comment">/*</span>
<a name="l00161"></a>00161 <span class="comment"> * Checks whether we should accept a PDU of given level </span>
<a name="l00162"></a>00162 <span class="comment"> */</span>
<a name="l00163"></a>00163 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00164"></a><a class="code" href="isis__pdu_8c.html#ad3be9b74a266fca7d08e91ad3e4b0d45">00164</a> <a class="code" href="isis__pdu_8c.html#ad3be9b74a266fca7d08e91ad3e4b0d45">accept_level</a> (<span class="keywordtype">int</span> level, <span class="keywordtype">int</span> <a class="code" href="isis__pdu_8h.html#a4237fb9b680bb5a92208b7e02eccb6a1">circuit_t</a>)
<a name="l00165"></a>00165 {
<a name="l00166"></a>00166   <span class="keywordtype">int</span> retval = ((circuit_t &amp; level) == level);  <span class="comment">/* simple approach */</span>
<a name="l00167"></a>00167 
<a name="l00168"></a>00168   <span class="keywordflow">return</span> retval;
<a name="l00169"></a>00169 }
<a name="l00170"></a>00170 
<a name="l00171"></a>00171 <span class="keywordtype">int</span>
<a name="l00172"></a><a class="code" href="isis__pdu_8h.html#aefd5a8caa169a427e30d599b51ab52e9">00172</a> <a class="code" href="isis__pdu_8c.html#aefd5a8caa169a427e30d599b51ab52e9">authentication_check</a> (<span class="keyword">struct</span> <a class="code" href="structisis__passwd.html">isis_passwd</a> *one, <span class="keyword">struct</span> <a class="code" href="structisis__passwd.html">isis_passwd</a> *theother)
<a name="l00173"></a>00173 {
<a name="l00174"></a>00174   <span class="keywordflow">if</span> (one-&gt;<a class="code" href="structisis__passwd.html#a874984e0745fbcb41df9f463d831be67">type</a> != theother-&gt;<a class="code" href="structisis__passwd.html#a874984e0745fbcb41df9f463d831be67">type</a>)
<a name="l00175"></a>00175     {
<a name="l00176"></a>00176       <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;Unsupported authentication type %d&quot;</span>, theother-&gt;<a class="code" href="structisis__passwd.html#a874984e0745fbcb41df9f463d831be67">type</a>);
<a name="l00177"></a>00177       <span class="keywordflow">return</span> 1;         <span class="comment">/* Auth fail (different authentication types) */</span>
<a name="l00178"></a>00178     }
<a name="l00179"></a>00179   <span class="keywordflow">switch</span> (one-&gt;<a class="code" href="structisis__passwd.html#a874984e0745fbcb41df9f463d831be67">type</a>)
<a name="l00180"></a>00180     {
<a name="l00181"></a>00181     <span class="keywordflow">case</span> <a class="code" href="isis__common_8h.html#a1883f8c30a26198657877c3860ae1160">ISIS_PASSWD_TYPE_CLEARTXT</a>:
<a name="l00182"></a>00182       <span class="keywordflow">if</span> (one-&gt;<a class="code" href="structisis__passwd.html#a3981443a6501783995b003ab8fd82f48">len</a> != theother-&gt;<a class="code" href="structisis__passwd.html#a3981443a6501783995b003ab8fd82f48">len</a>)
<a name="l00183"></a>00183     <span class="keywordflow">return</span> 1;       <span class="comment">/* Auth fail () - passwd len mismatch */</span>
<a name="l00184"></a>00184       <span class="keywordflow">return</span> <a class="code" href="regex_8c.html#a98d0dff0c7366f08562d8e8583df9bb9">memcmp</a> (one-&gt;<a class="code" href="structisis__passwd.html#a4af92e1126df2d7d2abeef451c082567">passwd</a>, theother-&gt;<a class="code" href="structisis__passwd.html#a4af92e1126df2d7d2abeef451c082567">passwd</a>, one-&gt;<a class="code" href="structisis__passwd.html#a3981443a6501783995b003ab8fd82f48">len</a>);
<a name="l00185"></a>00185       <span class="keywordflow">break</span>;
<a name="l00186"></a>00186     <span class="keywordflow">default</span>:
<a name="l00187"></a>00187       <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;Unsupported authentication type&quot;</span>);
<a name="l00188"></a>00188       <span class="keywordflow">break</span>;
<a name="l00189"></a>00189     }
<a name="l00190"></a>00190   <span class="keywordflow">return</span> 0;         <span class="comment">/* Auth pass */</span>
<a name="l00191"></a>00191 }
<a name="l00192"></a>00192 
<a name="l00193"></a>00193 <span class="comment">/*</span>
<a name="l00194"></a>00194 <span class="comment"> * Processing helper functions</span>
<a name="l00195"></a>00195 <span class="comment"> */</span>
<a name="l00196"></a>00196 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00197"></a><a class="code" href="isis__pdu_8c.html#afb3df247f88b4af648f1abf59f8a6044">00197</a> <a class="code" href="isis__pdu_8c.html#afb3df247f88b4af648f1abf59f8a6044">tlvs_to_adj_nlpids</a> (<span class="keyword">struct</span> <a class="code" href="structtlvs.html">tlvs</a> *<a class="code" href="structtlvs.html">tlvs</a>, <span class="keyword">struct</span> <a class="code" href="structisis__adjacency.html">isis_adjacency</a> *adj)
<a name="l00198"></a>00198 {
<a name="l00199"></a>00199   <span class="keywordtype">int</span> <a class="code" href="spgrid_8c.html#a139066bd9e344a8daae82c5ca919fffe">i</a>;
<a name="l00200"></a>00200   <span class="keyword">struct </span><a class="code" href="structnlpids.html">nlpids</a> *tlv_nlpids;
<a name="l00201"></a>00201 
<a name="l00202"></a>00202   <span class="keywordflow">if</span> (tlvs-&gt;<a class="code" href="structtlvs.html#a1e64fb03a35dacd896393c5a3fc06db1">nlpids</a>)
<a name="l00203"></a>00203     {
<a name="l00204"></a>00204 
<a name="l00205"></a>00205       tlv_nlpids = tlvs-&gt;<a class="code" href="structtlvs.html#a1e64fb03a35dacd896393c5a3fc06db1">nlpids</a>;
<a name="l00206"></a>00206 
<a name="l00207"></a>00207       adj-&gt;<a class="code" href="structisis__adjacency.html#a1c8f17ff6b70d8c457e8d2860909312c">nlpids</a>.<a class="code" href="structnlpids.html#a73f0f5f1e7aa64694d5802b91af6533b">count</a> = tlv_nlpids-&gt;<a class="code" href="structnlpids.html#a73f0f5f1e7aa64694d5802b91af6533b">count</a>;
<a name="l00208"></a>00208 
<a name="l00209"></a>00209       <span class="keywordflow">for</span> (i = 0; i &lt; tlv_nlpids-&gt;<a class="code" href="structnlpids.html#a73f0f5f1e7aa64694d5802b91af6533b">count</a>; i++)
<a name="l00210"></a>00210     {
<a name="l00211"></a>00211       adj-&gt;<a class="code" href="structisis__adjacency.html#a1c8f17ff6b70d8c457e8d2860909312c">nlpids</a>.<a class="code" href="structnlpids.html#a6dbd263750da21187880986a50fd5857">nlpids</a>[<a class="code" href="spgrid_8c.html#a139066bd9e344a8daae82c5ca919fffe">i</a>] = tlv_nlpids-&gt;<a class="code" href="structnlpids.html#a6dbd263750da21187880986a50fd5857">nlpids</a>[<a class="code" href="spgrid_8c.html#a139066bd9e344a8daae82c5ca919fffe">i</a>];
<a name="l00212"></a>00212     }
<a name="l00213"></a>00213     }
<a name="l00214"></a>00214 }
<a name="l00215"></a>00215 
<a name="l00216"></a>00216 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00217"></a><a class="code" href="isis__pdu_8c.html#a1eb77861c826ae12837e4245dee655ae">00217</a> <a class="code" href="isis__pdu_8c.html#a1eb77861c826ae12837e4245dee655ae">del_ip_addr</a> (<span class="keywordtype">void</span> *<a class="code" href="prefix_8h.html#a43e03366be2dd9176e91229d76541ce9">val</a>)
<a name="l00218"></a>00218 {
<a name="l00219"></a>00219   <a class="code" href="memory_8h.html#a29f1ce2c850a3163cd6b1b0bd460705d">XFREE</a> (<a class="code" href="memtypes_8h.html#a7ff5f2dff38e7639981794c43dc9167ba80b5687b76c7243b1ec8be38fb740b3f">MTYPE_ISIS_TMP</a>, val);
<a name="l00220"></a>00220 }
<a name="l00221"></a>00221 
<a name="l00222"></a>00222 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00223"></a><a class="code" href="isis__pdu_8c.html#af96726be5388512e070368d2438bbf99">00223</a> <a class="code" href="isis__pdu_8c.html#af96726be5388512e070368d2438bbf99">tlvs_to_adj_ipv4_addrs</a> (<span class="keyword">struct</span> <a class="code" href="structtlvs.html">tlvs</a> *<a class="code" href="structtlvs.html">tlvs</a>, <span class="keyword">struct</span> <a class="code" href="structisis__adjacency.html">isis_adjacency</a> *adj)
<a name="l00224"></a>00224 {
<a name="l00225"></a>00225   <span class="keyword">struct </span><a class="code" href="structlistnode.html">listnode</a> *node;
<a name="l00226"></a>00226   <span class="keyword">struct </span>in_addr *ipv4_addr, *malloced;
<a name="l00227"></a>00227 
<a name="l00228"></a>00228   <span class="keywordflow">if</span> (adj-&gt;<a class="code" href="structisis__adjacency.html#ad4c07af99270cae2fdc9f48120cbebcb">ipv4_addrs</a>)
<a name="l00229"></a>00229     {
<a name="l00230"></a>00230       adj-&gt;<a class="code" href="structisis__adjacency.html#ad4c07af99270cae2fdc9f48120cbebcb">ipv4_addrs</a>-&gt;<a class="code" href="structlist.html#ac4fd9a331fe65f4c0891aa35bf84a6f5">del</a> = <a class="code" href="isis__pdu_8c.html#a1eb77861c826ae12837e4245dee655ae">del_ip_addr</a>;
<a name="l00231"></a>00231       <a class="code" href="linklist_8c.html#ab5fdf1a904264be077ce19a432b1b119">list_delete</a> (adj-&gt;<a class="code" href="structisis__adjacency.html#ad4c07af99270cae2fdc9f48120cbebcb">ipv4_addrs</a>);
<a name="l00232"></a>00232     }
<a name="l00233"></a>00233   adj-&gt;<a class="code" href="structisis__adjacency.html#ad4c07af99270cae2fdc9f48120cbebcb">ipv4_addrs</a> = <a class="code" href="linklist_8c.html#af156f4ae343ef4a625f75b6c38845aef">list_new</a> ();
<a name="l00234"></a>00234   <span class="keywordflow">if</span> (tlvs-&gt;<a class="code" href="structtlvs.html#ae9ef317829a76d7a79d2789786a2ac1f">ipv4_addrs</a>)
<a name="l00235"></a>00235     {
<a name="l00236"></a>00236       <span class="keywordflow">for</span> (<a class="code" href="linklist_8h.html#a80a3f4035be83abbb709d17412993226">ALL_LIST_ELEMENTS_RO</a> (tlvs-&gt;<a class="code" href="structtlvs.html#ae9ef317829a76d7a79d2789786a2ac1f">ipv4_addrs</a>, node, ipv4_addr))
<a name="l00237"></a>00237       {
<a name="l00238"></a>00238     malloced = <a class="code" href="memory_8h.html#a6491adf46c1d769b529a8f2f7d75f2fe">XMALLOC</a> (<a class="code" href="memtypes_8h.html#a7ff5f2dff38e7639981794c43dc9167ba80b5687b76c7243b1ec8be38fb740b3f">MTYPE_ISIS_TMP</a>, <span class="keyword">sizeof</span> (<span class="keyword">struct</span> in_addr));
<a name="l00239"></a>00239     <a class="code" href="regex_8c.html#aed653b4838032a2c5ce8960421c8cfd7">memcpy</a> (malloced, ipv4_addr, <span class="keyword">sizeof</span> (<span class="keyword">struct</span> in_addr));
<a name="l00240"></a>00240     <a class="code" href="linklist_8c.html#adb2a0478aba995441aaf691d1f6fe5db">listnode_add</a> (adj-&gt;<a class="code" href="structisis__adjacency.html#ad4c07af99270cae2fdc9f48120cbebcb">ipv4_addrs</a>, malloced);
<a name="l00241"></a>00241       }
<a name="l00242"></a>00242     }
<a name="l00243"></a>00243 }
<a name="l00244"></a>00244 
<a name="l00245"></a>00245 <span class="preprocessor">#ifdef HAVE_IPV6</span>
<a name="l00246"></a>00246 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00247"></a>00247 tlvs_to_adj_ipv6_addrs (<span class="keyword">struct</span> <a class="code" href="structtlvs.html">tlvs</a> *<a class="code" href="structtlvs.html">tlvs</a>, <span class="keyword">struct</span> <a class="code" href="structisis__adjacency.html">isis_adjacency</a> *adj)
<a name="l00248"></a>00248 {
<a name="l00249"></a>00249   <span class="keyword">struct </span><a class="code" href="structlistnode.html">listnode</a> *node;
<a name="l00250"></a>00250   <span class="keyword">struct </span>in6_addr *ipv6_addr, *malloced;
<a name="l00251"></a>00251 
<a name="l00252"></a>00252   <span class="keywordflow">if</span> (adj-&gt;ipv6_addrs)
<a name="l00253"></a>00253     {
<a name="l00254"></a>00254       adj-&gt;ipv6_addrs-&gt;del = <a class="code" href="isis__pdu_8c.html#a1eb77861c826ae12837e4245dee655ae">del_ip_addr</a>;
<a name="l00255"></a>00255       <a class="code" href="linklist_8c.html#ab5fdf1a904264be077ce19a432b1b119">list_delete</a> (adj-&gt;ipv6_addrs);
<a name="l00256"></a>00256     }
<a name="l00257"></a>00257   adj-&gt;ipv6_addrs = <a class="code" href="linklist_8c.html#af156f4ae343ef4a625f75b6c38845aef">list_new</a> ();
<a name="l00258"></a>00258   <span class="keywordflow">if</span> (tlvs-&gt;ipv6_addrs)
<a name="l00259"></a>00259     {
<a name="l00260"></a>00260       <span class="keywordflow">for</span> (<a class="code" href="linklist_8h.html#a80a3f4035be83abbb709d17412993226">ALL_LIST_ELEMENTS_RO</a> (tlvs-&gt;ipv6_addrs, node, ipv6_addr))
<a name="l00261"></a>00261       {
<a name="l00262"></a>00262     malloced = <a class="code" href="memory_8h.html#a6491adf46c1d769b529a8f2f7d75f2fe">XMALLOC</a> (<a class="code" href="memtypes_8h.html#a7ff5f2dff38e7639981794c43dc9167ba80b5687b76c7243b1ec8be38fb740b3f">MTYPE_ISIS_TMP</a>, <span class="keyword">sizeof</span> (<span class="keyword">struct</span> in6_addr));
<a name="l00263"></a>00263     <a class="code" href="regex_8c.html#aed653b4838032a2c5ce8960421c8cfd7">memcpy</a> (malloced, ipv6_addr, <span class="keyword">sizeof</span> (<span class="keyword">struct</span> in6_addr));
<a name="l00264"></a>00264     <a class="code" href="linklist_8c.html#adb2a0478aba995441aaf691d1f6fe5db">listnode_add</a> (adj-&gt;ipv6_addrs, malloced);
<a name="l00265"></a>00265       }
<a name="l00266"></a>00266     }
<a name="l00267"></a>00267 
<a name="l00268"></a>00268 }
<a name="l00269"></a>00269 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_IPV6 */</span>
<a name="l00270"></a>00270 
<a name="l00271"></a>00271 <span class="comment">/*</span>
<a name="l00272"></a>00272 <span class="comment"> *  RECEIVE SIDE                           </span>
<a name="l00273"></a>00273 <span class="comment"> */</span>
<a name="l00274"></a>00274 
<a name="l00275"></a>00275 <span class="comment">/*</span>
<a name="l00276"></a>00276 <span class="comment"> * Process P2P IIH</span>
<a name="l00277"></a>00277 <span class="comment"> * ISO - 10589</span>
<a name="l00278"></a>00278 <span class="comment"> * Section 8.2.5 - Receiving point-to-point IIH PDUs</span>
<a name="l00279"></a>00279 <span class="comment"> *</span>
<a name="l00280"></a>00280 <span class="comment"> */</span>
<a name="l00281"></a>00281 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00282"></a><a class="code" href="isis__pdu_8c.html#ae1ed5a5e3ac93396b812ac8d35186073">00282</a> <a class="code" href="isis__pdu_8c.html#ae1ed5a5e3ac93396b812ac8d35186073">process_p2p_hello</a> (<span class="keyword">struct</span> <a class="code" href="structisis__circuit.html">isis_circuit</a> *circuit)
<a name="l00283"></a>00283 {
<a name="l00284"></a>00284   <span class="keywordtype">int</span> retval = <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;
<a name="l00285"></a>00285   <span class="keyword">struct </span><a class="code" href="structisis__p2p__hello__hdr.html">isis_p2p_hello_hdr</a> *hdr;
<a name="l00286"></a>00286   <span class="keyword">struct </span><a class="code" href="structisis__adjacency.html">isis_adjacency</a> *adj;
<a name="l00287"></a>00287   u_int32_t expected = 0, found;
<a name="l00288"></a>00288   <span class="keyword">struct </span>tlvs tlvs;
<a name="l00289"></a>00289 
<a name="l00290"></a>00290   <span class="keywordflow">if</span> ((<a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>) -
<a name="l00291"></a>00291        <a class="code" href="stream_8c.html#a717f15645000d42a15034f5ec83fc9a5">stream_get_getp</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>)) &lt; <a class="code" href="isis__pdu_8h.html#afc57a4bb656d257caa10f6a172006cd1">ISIS_P2PHELLO_HDRLEN</a>)
<a name="l00292"></a>00292     {
<a name="l00293"></a>00293       <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;Packet too short&quot;</span>);
<a name="l00294"></a>00294       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;
<a name="l00295"></a>00295     }
<a name="l00296"></a>00296 
<a name="l00297"></a>00297   <span class="comment">/* 8.2.5.1 PDU acceptance tests */</span>
<a name="l00298"></a>00298 
<a name="l00299"></a>00299   <span class="comment">/* 8.2.5.1 a) external domain untrue */</span>
<a name="l00300"></a>00300   <span class="comment">/* FIXME: not useful at all?         */</span>
<a name="l00301"></a>00301 
<a name="l00302"></a>00302   <span class="comment">/* 8.2.5.1 b) ID Length mismatch */</span>
<a name="l00303"></a>00303   <span class="comment">/* checked at the handle_pdu     */</span>
<a name="l00304"></a>00304 
<a name="l00305"></a>00305   <span class="comment">/* 8.2.5.2 IIH PDU Processing */</span>
<a name="l00306"></a>00306 
<a name="l00307"></a>00307   <span class="comment">/* 8.2.5.2 a) 1) Maximum Area Addresses */</span>
<a name="l00308"></a>00308   <span class="comment">/* Already checked, and can also be ommited */</span>
<a name="l00309"></a>00309 
<a name="l00310"></a>00310   <span class="comment">/*</span>
<a name="l00311"></a>00311 <span class="comment">   * Get the header</span>
<a name="l00312"></a>00312 <span class="comment">   */</span>
<a name="l00313"></a>00313   hdr = (<span class="keyword">struct </span><a class="code" href="structisis__p2p__hello__hdr.html">isis_p2p_hello_hdr</a> *) <a class="code" href="stream_8h.html#a4bb95ef1391c2b8b7b97678a5ad87cb7">STREAM_PNT</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>);
<a name="l00314"></a>00314   circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>-&gt;<a class="code" href="structstream.html#adb2dceb1b9e09edf611d9076a7a1a491">getp</a> += <a class="code" href="isis__pdu_8h.html#afc57a4bb656d257caa10f6a172006cd1">ISIS_P2PHELLO_HDRLEN</a>;
<a name="l00315"></a>00315 
<a name="l00316"></a>00316   <span class="comment">/*  hdr.circuit_t = stream_getc (stream);</span>
<a name="l00317"></a>00317 <span class="comment">     stream_get (hdr.source_id, stream, ISIS_SYS_ID_LEN);</span>
<a name="l00318"></a>00318 <span class="comment">     hdr.hold_time = stream_getw (stream);</span>
<a name="l00319"></a>00319 <span class="comment">     hdr.pdu_len   = stream_getw (stream);</span>
<a name="l00320"></a>00320 <span class="comment">     hdr.local_id  = stream_getc (stream); */</span>
<a name="l00321"></a>00321 
<a name="l00322"></a>00322   <span class="comment">/*</span>
<a name="l00323"></a>00323 <span class="comment">   * My interpertation of the ISO, if no adj exists we will create one for </span>
<a name="l00324"></a>00324 <span class="comment">   * the circuit</span>
<a name="l00325"></a>00325 <span class="comment">   */</span>
<a name="l00326"></a>00326 
<a name="l00327"></a>00327   <span class="keywordflow">if</span> (isis-&gt;<a class="code" href="structisis.html#a6e64127e274c1aa6a52cb0f4b541dfaa">debugs</a> &amp; <a class="code" href="isisd_8h.html#a4113d6aad857cfa148450dfc6ed85b5b">DEBUG_ADJ_PACKETS</a>)
<a name="l00328"></a>00328     {
<a name="l00329"></a>00329       <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;ISIS-Adj (%s): Rcvd P2P IIH from (%s), cir type %s,&quot;</span>
<a name="l00330"></a>00330           <span class="stringliteral">&quot; cir id %02d, length %d&quot;</span>,
<a name="l00331"></a>00331           circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>, circuit-&gt;<a class="code" href="structisis__circuit.html#ab03cac6463284a4ce8c1eb19e49f3b6d">interface</a>-&gt;<a class="code" href="structinterface.html#a98cadce768ec5aacb4c5fc4ca2c3eaa8">name</a>,
<a name="l00332"></a>00332           <a class="code" href="isis__misc_8c.html#a35b15c65a44088982fa8daca9fc7b022">circuit_t2string</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#ab222d6d0b054faa159d72bcb9768b3fb">circuit_is_type</a>),
<a name="l00333"></a>00333           circuit-&gt;<a class="code" href="structisis__circuit.html#a10453f6bcc1e8f1cb466240a81836ba9">circuit_id</a>, ntohs (hdr-&gt;<a class="code" href="structisis__p2p__hello__hdr.html#ab4e1e57d67bc848f55e96d85a9e840c5">pdu_len</a>));
<a name="l00334"></a>00334     }
<a name="l00335"></a>00335 
<a name="l00336"></a>00336   adj = circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a15852a59ea8be80680abac2070659440">p2p</a>.<a class="code" href="structisis__p2p__info.html#a17d32289e6648b9855b93482cd7c45a5">neighbor</a>;
<a name="l00337"></a>00337   <span class="keywordflow">if</span> (!adj)
<a name="l00338"></a>00338     {
<a name="l00339"></a>00339       adj = <a class="code" href="isis__adjacency_8c.html#a81fa83638827781e0f128c9c01551a95">isis_new_adj</a> (hdr-&gt;<a class="code" href="structisis__p2p__hello__hdr.html#af8de3d87d0e44db1853b72c60e11a983">source_id</a>, <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, circuit);
<a name="l00340"></a>00340       <span class="keywordflow">if</span> (adj == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00341"></a>00341     <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#ac694b0bd16857a3d50deea71f78e8b7f">ISIS_ERROR</a>;
<a name="l00342"></a>00342       circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a15852a59ea8be80680abac2070659440">p2p</a>.<a class="code" href="structisis__p2p__info.html#a17d32289e6648b9855b93482cd7c45a5">neighbor</a> = adj;
<a name="l00343"></a>00343       <a class="code" href="isis__adjacency_8c.html#a0f8f010e5bafa4fe5497e600c1ac12dd">isis_adj_state_change</a> (adj, <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a1973db8c983074b9c3e0cc74c23eab47">ISIS_ADJ_INITIALIZING</a>, <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00344"></a>00344       adj-&gt;<a class="code" href="structisis__adjacency.html#a187eb9cdad6881ecd2735b38a47e07e3">sys_type</a> = <a class="code" href="isis__adjacency_8h.html#ad310c3cfba255c6c6dda415939268b4da1d20bc4d429708dd9bc81735bd176618">ISIS_SYSTYPE_UNKNOWN</a>;
<a name="l00345"></a>00345     }
<a name="l00346"></a>00346 
<a name="l00347"></a>00347   <span class="comment">/* 8.2.6 Monitoring point-to-point adjacencies */</span>
<a name="l00348"></a>00348   adj-&gt;<a class="code" href="structisis__adjacency.html#a656446a9be5f9ebf466ffacc8741a909">hold_time</a> = ntohs (hdr-&gt;<a class="code" href="structisis__p2p__hello__hdr.html#a7bacc6278778ae3b6aeab9a68b5ed6fb">hold_time</a>);
<a name="l00349"></a>00349   adj-&gt;<a class="code" href="structisis__adjacency.html#afd570f7072dac8465cf207cd6df6c567">last_upd</a> = time (<a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00350"></a>00350 
<a name="l00351"></a>00351   <span class="comment">/*</span>
<a name="l00352"></a>00352 <span class="comment">   * Lets get the TLVS now</span>
<a name="l00353"></a>00353 <span class="comment">   */</span>
<a name="l00354"></a>00354   expected |= <a class="code" href="isis__tlv_8h.html#ae2a91163530ea4d9bfb3b00394a48316">TLVFLAG_AREA_ADDRS</a>;
<a name="l00355"></a>00355   expected |= <a class="code" href="isis__tlv_8h.html#a493ed26a4a2decc55275bd699df9a4a8">TLVFLAG_AUTH_INFO</a>;
<a name="l00356"></a>00356   expected |= <a class="code" href="isis__tlv_8h.html#ac9149da10b98f4211a51249c752b5fee">TLVFLAG_NLPID</a>;
<a name="l00357"></a>00357   expected |= <a class="code" href="isis__tlv_8h.html#ac1d5ea73aa3cc33a2c7e4190df6fab00">TLVFLAG_IPV4_ADDR</a>;
<a name="l00358"></a>00358   expected |= <a class="code" href="isis__tlv_8h.html#af63af1cfdbe427be867d8191c1ea5b5f">TLVFLAG_IPV6_ADDR</a>;
<a name="l00359"></a>00359 
<a name="l00360"></a>00360   retval = <a class="code" href="isis__tlv_8c.html#aad6fa3b6cc5e93707f75d8247f8787c8">parse_tlvs</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>,
<a name="l00361"></a>00361                <a class="code" href="stream_8h.html#a4bb95ef1391c2b8b7b97678a5ad87cb7">STREAM_PNT</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>),
<a name="l00362"></a>00362                ntohs (hdr-&gt;<a class="code" href="structisis__p2p__hello__hdr.html#ab4e1e57d67bc848f55e96d85a9e840c5">pdu_len</a>) - <a class="code" href="isis__pdu_8h.html#afc57a4bb656d257caa10f6a172006cd1">ISIS_P2PHELLO_HDRLEN</a>
<a name="l00363"></a>00363                - <a class="code" href="isis__pdu_8h.html#a61f100919f790014bded41907b477263">ISIS_FIXED_HDR_LEN</a>, &amp;expected, &amp;found, &amp;tlvs);
<a name="l00364"></a>00364 
<a name="l00365"></a>00365   <span class="keywordflow">if</span> (retval &gt; <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>)
<a name="l00366"></a>00366     {
<a name="l00367"></a>00367       <a class="code" href="isis__tlv_8c.html#a5f499235cf5a69697d280f5a1cd01612">free_tlvs</a> (&amp;tlvs);
<a name="l00368"></a>00368       <span class="keywordflow">return</span> retval;
<a name="l00369"></a>00369     };
<a name="l00370"></a>00370 
<a name="l00371"></a>00371   <span class="comment">/* 8.2.5.1 c) Authentication */</span>
<a name="l00372"></a>00372   <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a601d2b4b3220757f8f7212f2a1628ab2">passwd</a>.<a class="code" href="structisis__passwd.html#a874984e0745fbcb41df9f463d831be67">type</a>)
<a name="l00373"></a>00373     {
<a name="l00374"></a>00374       <span class="keywordflow">if</span> (!(found &amp; <a class="code" href="isis__tlv_8h.html#a493ed26a4a2decc55275bd699df9a4a8">TLVFLAG_AUTH_INFO</a>) ||
<a name="l00375"></a>00375       <a class="code" href="isis__pdu_8c.html#aefd5a8caa169a427e30d599b51ab52e9">authentication_check</a> (&amp;circuit-&gt;<a class="code" href="structisis__circuit.html#a601d2b4b3220757f8f7212f2a1628ab2">passwd</a>, &amp;tlvs.<a class="code" href="structtlvs.html#a53dc2cb65bc632c84b3d702ab1dc16ce">auth_info</a>))
<a name="l00376"></a>00376     {
<a name="l00377"></a>00377       <a class="code" href="isis__events_8c.html#a16a754e810bb7ba8e3b2a23c89d6d130">isis_event_auth_failure</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>,
<a name="l00378"></a>00378                    <span class="stringliteral">&quot;P2P hello authentication failure&quot;</span>,
<a name="l00379"></a>00379                    hdr-&gt;<a class="code" href="structisis__p2p__hello__hdr.html#af8de3d87d0e44db1853b72c60e11a983">source_id</a>);
<a name="l00380"></a>00380       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;
<a name="l00381"></a>00381     }
<a name="l00382"></a>00382     }
<a name="l00383"></a>00383 
<a name="l00384"></a>00384   <span class="comment">/* we do this now because the adj may not survive till the end... */</span>
<a name="l00385"></a>00385 
<a name="l00386"></a>00386   <span class="comment">/* we need to copy addresses to the adj */</span>
<a name="l00387"></a>00387   <a class="code" href="isis__pdu_8c.html#af96726be5388512e070368d2438bbf99">tlvs_to_adj_ipv4_addrs</a> (&amp;tlvs, adj);
<a name="l00388"></a>00388 
<a name="l00389"></a>00389 <span class="preprocessor">#ifdef HAVE_IPV6</span>
<a name="l00390"></a>00390 <span class="preprocessor"></span>  tlvs_to_adj_ipv6_addrs (&amp;tlvs, adj);
<a name="l00391"></a>00391 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_IPV6 */</span>
<a name="l00392"></a>00392 
<a name="l00393"></a>00393   <span class="comment">/* lets take care of the expiry */</span>
<a name="l00394"></a>00394   <a class="code" href="thread_8h.html#ae1dfd3f5f643212148d60a41d9f2192a">THREAD_TIMER_OFF</a> (adj-&gt;<a class="code" href="structisis__adjacency.html#a16900c0c5677510df0a115d145d5ce87">t_expire</a>);
<a name="l00395"></a>00395   <a class="code" href="thread_8h.html#a898ebeae19eb435889cbf53ea8b5120e">THREAD_TIMER_ON</a> (master, adj-&gt;<a class="code" href="structisis__adjacency.html#a16900c0c5677510df0a115d145d5ce87">t_expire</a>, <a class="code" href="isis__adjacency_8c.html#a089c767d62df53d044fc7ba923219879">isis_adj_expire</a>, adj,
<a name="l00396"></a>00396            (<span class="keywordtype">long</span>) adj-&gt;<a class="code" href="structisis__adjacency.html#a656446a9be5f9ebf466ffacc8741a909">hold_time</a>);
<a name="l00397"></a>00397 
<a name="l00398"></a>00398   <span class="comment">/* 8.2.5.2 a) a match was detected */</span>
<a name="l00399"></a>00399   <span class="keywordflow">if</span> (<a class="code" href="isis__pdu_8c.html#ac44201d5d72450ec89f35a014c1e31c1">area_match</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aca1436df894da89fb83d7924ef248397">area_addrs</a>, tlvs.<a class="code" href="structtlvs.html#a11d8deaa75c26e958cff5f74fee3ef10">area_addrs</a>))
<a name="l00400"></a>00400     {
<a name="l00401"></a>00401       <span class="comment">/* 8.2.5.2 a) 2) If the system is L1 - table 5 */</span>
<a name="l00402"></a>00402       <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#a81021eb6fb20d16db0d13c335baecdae">is_type</a> == <a class="code" href="isis__constants_8h.html#a4806dbcd4c094ef55cecd6aca29520d7">IS_LEVEL_1</a>)
<a name="l00403"></a>00403     {
<a name="l00404"></a>00404       <span class="keywordflow">switch</span> (hdr-&gt;<a class="code" href="structisis__p2p__hello__hdr.html#a0baabb9d6fe6845b3c63268586bf169a">circuit_t</a>)
<a name="l00405"></a>00405         {
<a name="l00406"></a>00406         <span class="keywordflow">case</span> <a class="code" href="isis__constants_8h.html#a4806dbcd4c094ef55cecd6aca29520d7">IS_LEVEL_1</a>:
<a name="l00407"></a>00407         <span class="keywordflow">case</span> <a class="code" href="isis__constants_8h.html#a9906fe43cc332e34827b3c233d509da6">IS_LEVEL_1_AND_2</a>:
<a name="l00408"></a>00408           <span class="keywordflow">if</span> (adj-&gt;<a class="code" href="structisis__adjacency.html#ade48f111121efb755bd2ea13a06a16ae">adj_state</a> != <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a1762b381ed451feffee948c5f5d0ed86">ISIS_ADJ_UP</a>)
<a name="l00409"></a>00409         {
<a name="l00410"></a>00410           <span class="comment">/* (4) adj state up */</span>
<a name="l00411"></a>00411           <a class="code" href="isis__adjacency_8c.html#a0f8f010e5bafa4fe5497e600c1ac12dd">isis_adj_state_change</a> (adj, <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a1762b381ed451feffee948c5f5d0ed86">ISIS_ADJ_UP</a>, <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00412"></a>00412           <span class="comment">/* (5) adj usage level 1 */</span>
<a name="l00413"></a>00413           adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> = <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434ac5e73d4da9efe1a383f26fd0c958c53c">ISIS_ADJ_LEVEL1</a>;
<a name="l00414"></a>00414         }
<a name="l00415"></a>00415           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> == <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434ac5e73d4da9efe1a383f26fd0c958c53c">ISIS_ADJ_LEVEL1</a>)
<a name="l00416"></a>00416         {
<a name="l00417"></a>00417           ;     <span class="comment">/* accept */</span>
<a name="l00418"></a>00418         }
<a name="l00419"></a>00419           <span class="keywordflow">break</span>;
<a name="l00420"></a>00420         <span class="keywordflow">case</span> <a class="code" href="isis__constants_8h.html#a9daa7fbf09b604c718f3bbe189aedd1a">IS_LEVEL_2</a>:
<a name="l00421"></a>00421           <span class="keywordflow">if</span> (adj-&gt;<a class="code" href="structisis__adjacency.html#ade48f111121efb755bd2ea13a06a16ae">adj_state</a> != <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a1762b381ed451feffee948c5f5d0ed86">ISIS_ADJ_UP</a>)
<a name="l00422"></a>00422         {
<a name="l00423"></a>00423           <span class="comment">/* (7) reject - wrong system type event */</span>
<a name="l00424"></a>00424           <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;wrongSystemType&quot;</span>);
<a name="l00425"></a>00425           <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;  <span class="comment">/* Reject */</span>
<a name="l00426"></a>00426         }
<a name="l00427"></a>00427           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> == <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434ac5e73d4da9efe1a383f26fd0c958c53c">ISIS_ADJ_LEVEL1</a>)
<a name="l00428"></a>00428         {
<a name="l00429"></a>00429           <span class="comment">/* (6) down - wrong system */</span>
<a name="l00430"></a>00430           <a class="code" href="isis__adjacency_8c.html#a0f8f010e5bafa4fe5497e600c1ac12dd">isis_adj_state_change</a> (adj, <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a74fdb396aae235e00736312b60c5d347">ISIS_ADJ_DOWN</a>, <span class="stringliteral">&quot;Wrong System&quot;</span>);
<a name="l00431"></a>00431         }
<a name="l00432"></a>00432           <span class="keywordflow">break</span>;
<a name="l00433"></a>00433         }
<a name="l00434"></a>00434     }
<a name="l00435"></a>00435 
<a name="l00436"></a>00436       <span class="comment">/* 8.2.5.2 a) 3) If the system is L1L2 - table 6 */</span>
<a name="l00437"></a>00437       <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#a81021eb6fb20d16db0d13c335baecdae">is_type</a> == <a class="code" href="isis__constants_8h.html#a9906fe43cc332e34827b3c233d509da6">IS_LEVEL_1_AND_2</a>)
<a name="l00438"></a>00438     {
<a name="l00439"></a>00439       <span class="keywordflow">switch</span> (hdr-&gt;<a class="code" href="structisis__p2p__hello__hdr.html#a0baabb9d6fe6845b3c63268586bf169a">circuit_t</a>)
<a name="l00440"></a>00440         {
<a name="l00441"></a>00441         <span class="keywordflow">case</span> <a class="code" href="isis__constants_8h.html#a4806dbcd4c094ef55cecd6aca29520d7">IS_LEVEL_1</a>:
<a name="l00442"></a>00442           <span class="keywordflow">if</span> (adj-&gt;<a class="code" href="structisis__adjacency.html#ade48f111121efb755bd2ea13a06a16ae">adj_state</a> != <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a1762b381ed451feffee948c5f5d0ed86">ISIS_ADJ_UP</a>)
<a name="l00443"></a>00443         {
<a name="l00444"></a>00444           <span class="comment">/* (6) adj state up */</span>
<a name="l00445"></a>00445           <a class="code" href="isis__adjacency_8c.html#a0f8f010e5bafa4fe5497e600c1ac12dd">isis_adj_state_change</a> (adj, <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a1762b381ed451feffee948c5f5d0ed86">ISIS_ADJ_UP</a>, <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00446"></a>00446           <span class="comment">/* (7) adj usage level 1 */</span>
<a name="l00447"></a>00447           adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> = <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434ac5e73d4da9efe1a383f26fd0c958c53c">ISIS_ADJ_LEVEL1</a>;
<a name="l00448"></a>00448         }
<a name="l00449"></a>00449           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> == <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434ac5e73d4da9efe1a383f26fd0c958c53c">ISIS_ADJ_LEVEL1</a>)
<a name="l00450"></a>00450         {
<a name="l00451"></a>00451           ;     <span class="comment">/* accept */</span>
<a name="l00452"></a>00452         }
<a name="l00453"></a>00453           <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> == <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434aae5d5e9d6b2655fbe76c0eaa011f9c58">ISIS_ADJ_LEVEL1AND2</a>) ||
<a name="l00454"></a>00454                (adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> == <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434a299a3b0ab58836ff30296ebbd291ac59">ISIS_ADJ_LEVEL2</a>))
<a name="l00455"></a>00455         {
<a name="l00456"></a>00456           <span class="comment">/* (8) down - wrong system */</span>
<a name="l00457"></a>00457           <a class="code" href="isis__adjacency_8c.html#a0f8f010e5bafa4fe5497e600c1ac12dd">isis_adj_state_change</a> (adj, <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a74fdb396aae235e00736312b60c5d347">ISIS_ADJ_DOWN</a>, <span class="stringliteral">&quot;Wrong System&quot;</span>);
<a name="l00458"></a>00458         }
<a name="l00459"></a>00459           <span class="keywordflow">break</span>;
<a name="l00460"></a>00460         <span class="keywordflow">case</span> <a class="code" href="isis__constants_8h.html#a9daa7fbf09b604c718f3bbe189aedd1a">IS_LEVEL_2</a>:
<a name="l00461"></a>00461           <span class="keywordflow">if</span> (adj-&gt;<a class="code" href="structisis__adjacency.html#ade48f111121efb755bd2ea13a06a16ae">adj_state</a> != <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a1762b381ed451feffee948c5f5d0ed86">ISIS_ADJ_UP</a>)
<a name="l00462"></a>00462         {
<a name="l00463"></a>00463           <span class="comment">/* (6) adj state up */</span>
<a name="l00464"></a>00464           <a class="code" href="isis__adjacency_8c.html#a0f8f010e5bafa4fe5497e600c1ac12dd">isis_adj_state_change</a> (adj, <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a1762b381ed451feffee948c5f5d0ed86">ISIS_ADJ_UP</a>, <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00465"></a>00465           <span class="comment">/* (9) adj usage level 2 */</span>
<a name="l00466"></a>00466           adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> = <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434a299a3b0ab58836ff30296ebbd291ac59">ISIS_ADJ_LEVEL2</a>;
<a name="l00467"></a>00467         }
<a name="l00468"></a>00468           <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> == <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434ac5e73d4da9efe1a383f26fd0c958c53c">ISIS_ADJ_LEVEL1</a>) ||
<a name="l00469"></a>00469                (adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> == <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434aae5d5e9d6b2655fbe76c0eaa011f9c58">ISIS_ADJ_LEVEL1AND2</a>))
<a name="l00470"></a>00470         {
<a name="l00471"></a>00471           <span class="comment">/* (8) down - wrong system */</span>
<a name="l00472"></a>00472           <a class="code" href="isis__adjacency_8c.html#a0f8f010e5bafa4fe5497e600c1ac12dd">isis_adj_state_change</a> (adj, <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a74fdb396aae235e00736312b60c5d347">ISIS_ADJ_DOWN</a>, <span class="stringliteral">&quot;Wrong System&quot;</span>);
<a name="l00473"></a>00473         }
<a name="l00474"></a>00474           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> == <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434a299a3b0ab58836ff30296ebbd291ac59">ISIS_ADJ_LEVEL2</a>)
<a name="l00475"></a>00475         {
<a name="l00476"></a>00476           ;     <span class="comment">/* Accept */</span>
<a name="l00477"></a>00477         }
<a name="l00478"></a>00478           <span class="keywordflow">break</span>;
<a name="l00479"></a>00479         <span class="keywordflow">case</span> <a class="code" href="isis__constants_8h.html#a9906fe43cc332e34827b3c233d509da6">IS_LEVEL_1_AND_2</a>:
<a name="l00480"></a>00480           <span class="keywordflow">if</span> (adj-&gt;<a class="code" href="structisis__adjacency.html#ade48f111121efb755bd2ea13a06a16ae">adj_state</a> != <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a1762b381ed451feffee948c5f5d0ed86">ISIS_ADJ_UP</a>)
<a name="l00481"></a>00481         {
<a name="l00482"></a>00482           <span class="comment">/* (6) adj state up */</span>
<a name="l00483"></a>00483           <a class="code" href="isis__adjacency_8c.html#a0f8f010e5bafa4fe5497e600c1ac12dd">isis_adj_state_change</a> (adj, <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a1762b381ed451feffee948c5f5d0ed86">ISIS_ADJ_UP</a>, <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00484"></a>00484           <span class="comment">/* (10) adj usage level 1 */</span>
<a name="l00485"></a>00485           adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> = <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434aae5d5e9d6b2655fbe76c0eaa011f9c58">ISIS_ADJ_LEVEL1AND2</a>;
<a name="l00486"></a>00486         }
<a name="l00487"></a>00487           <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> == <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434ac5e73d4da9efe1a383f26fd0c958c53c">ISIS_ADJ_LEVEL1</a>) ||
<a name="l00488"></a>00488                (adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> == <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434a299a3b0ab58836ff30296ebbd291ac59">ISIS_ADJ_LEVEL2</a>))
<a name="l00489"></a>00489         {
<a name="l00490"></a>00490           <span class="comment">/* (8) down - wrong system */</span>
<a name="l00491"></a>00491           <a class="code" href="isis__adjacency_8c.html#a0f8f010e5bafa4fe5497e600c1ac12dd">isis_adj_state_change</a> (adj, <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a74fdb396aae235e00736312b60c5d347">ISIS_ADJ_DOWN</a>, <span class="stringliteral">&quot;Wrong System&quot;</span>);
<a name="l00492"></a>00492         }
<a name="l00493"></a>00493           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> == <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434aae5d5e9d6b2655fbe76c0eaa011f9c58">ISIS_ADJ_LEVEL1AND2</a>)
<a name="l00494"></a>00494         {
<a name="l00495"></a>00495           ;     <span class="comment">/* Accept */</span>
<a name="l00496"></a>00496         }
<a name="l00497"></a>00497           <span class="keywordflow">break</span>;
<a name="l00498"></a>00498         }
<a name="l00499"></a>00499     }
<a name="l00500"></a>00500 
<a name="l00501"></a>00501       <span class="comment">/* 8.2.5.2 a) 4) If the system is L2 - table 7 */</span>
<a name="l00502"></a>00502       <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#a81021eb6fb20d16db0d13c335baecdae">is_type</a> == <a class="code" href="isis__constants_8h.html#a9daa7fbf09b604c718f3bbe189aedd1a">IS_LEVEL_2</a>)
<a name="l00503"></a>00503     {
<a name="l00504"></a>00504       <span class="keywordflow">switch</span> (hdr-&gt;<a class="code" href="structisis__p2p__hello__hdr.html#a0baabb9d6fe6845b3c63268586bf169a">circuit_t</a>)
<a name="l00505"></a>00505         {
<a name="l00506"></a>00506         <span class="keywordflow">case</span> <a class="code" href="isis__constants_8h.html#a4806dbcd4c094ef55cecd6aca29520d7">IS_LEVEL_1</a>:
<a name="l00507"></a>00507           <span class="keywordflow">if</span> (adj-&gt;<a class="code" href="structisis__adjacency.html#ade48f111121efb755bd2ea13a06a16ae">adj_state</a> != <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a1762b381ed451feffee948c5f5d0ed86">ISIS_ADJ_UP</a>)
<a name="l00508"></a>00508         {
<a name="l00509"></a>00509           <span class="comment">/* (5) reject - wrong system type event */</span>
<a name="l00510"></a>00510           <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;wrongSystemType&quot;</span>);
<a name="l00511"></a>00511           <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;  <span class="comment">/* Reject */</span>
<a name="l00512"></a>00512         }
<a name="l00513"></a>00513           <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> == <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434aae5d5e9d6b2655fbe76c0eaa011f9c58">ISIS_ADJ_LEVEL1AND2</a>) ||
<a name="l00514"></a>00514                (adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> == <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434a299a3b0ab58836ff30296ebbd291ac59">ISIS_ADJ_LEVEL2</a>))
<a name="l00515"></a>00515         {
<a name="l00516"></a>00516           <span class="comment">/* (6) down - wrong system */</span>
<a name="l00517"></a>00517           <a class="code" href="isis__adjacency_8c.html#a0f8f010e5bafa4fe5497e600c1ac12dd">isis_adj_state_change</a> (adj, <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a74fdb396aae235e00736312b60c5d347">ISIS_ADJ_DOWN</a>, <span class="stringliteral">&quot;Wrong System&quot;</span>);
<a name="l00518"></a>00518         }
<a name="l00519"></a>00519           <span class="keywordflow">break</span>;
<a name="l00520"></a>00520         <span class="keywordflow">case</span> <a class="code" href="isis__constants_8h.html#a9906fe43cc332e34827b3c233d509da6">IS_LEVEL_1_AND_2</a>:
<a name="l00521"></a>00521         <span class="keywordflow">case</span> <a class="code" href="isis__constants_8h.html#a9daa7fbf09b604c718f3bbe189aedd1a">IS_LEVEL_2</a>:
<a name="l00522"></a>00522           <span class="keywordflow">if</span> (adj-&gt;<a class="code" href="structisis__adjacency.html#ade48f111121efb755bd2ea13a06a16ae">adj_state</a> != <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a1762b381ed451feffee948c5f5d0ed86">ISIS_ADJ_UP</a>)
<a name="l00523"></a>00523         {
<a name="l00524"></a>00524           <span class="comment">/* (7) adj state up */</span>
<a name="l00525"></a>00525           <a class="code" href="isis__adjacency_8c.html#a0f8f010e5bafa4fe5497e600c1ac12dd">isis_adj_state_change</a> (adj, <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a1762b381ed451feffee948c5f5d0ed86">ISIS_ADJ_UP</a>, <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00526"></a>00526           <span class="comment">/* (8) adj usage level 2 */</span>
<a name="l00527"></a>00527           adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> = <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434a299a3b0ab58836ff30296ebbd291ac59">ISIS_ADJ_LEVEL2</a>;
<a name="l00528"></a>00528         }
<a name="l00529"></a>00529           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> == <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434aae5d5e9d6b2655fbe76c0eaa011f9c58">ISIS_ADJ_LEVEL1AND2</a>)
<a name="l00530"></a>00530         {
<a name="l00531"></a>00531           <span class="comment">/* (6) down - wrong system */</span>
<a name="l00532"></a>00532           <a class="code" href="isis__adjacency_8c.html#a0f8f010e5bafa4fe5497e600c1ac12dd">isis_adj_state_change</a> (adj, <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a74fdb396aae235e00736312b60c5d347">ISIS_ADJ_DOWN</a>, <span class="stringliteral">&quot;Wrong System&quot;</span>);
<a name="l00533"></a>00533         }
<a name="l00534"></a>00534           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> == <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434a299a3b0ab58836ff30296ebbd291ac59">ISIS_ADJ_LEVEL2</a>)
<a name="l00535"></a>00535         {
<a name="l00536"></a>00536           ;     <span class="comment">/* Accept */</span>
<a name="l00537"></a>00537         }
<a name="l00538"></a>00538           <span class="keywordflow">break</span>;
<a name="l00539"></a>00539         }
<a name="l00540"></a>00540     }
<a name="l00541"></a>00541     }
<a name="l00542"></a>00542   <span class="comment">/* 8.2.5.2 b) if no match was detected */</span>
<a name="l00543"></a>00543   <span class="keywordflow">else</span>
<a name="l00544"></a>00544     {
<a name="l00545"></a>00545       <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#a81021eb6fb20d16db0d13c335baecdae">is_type</a> == <a class="code" href="isis__constants_8h.html#a4806dbcd4c094ef55cecd6aca29520d7">IS_LEVEL_1</a>)
<a name="l00546"></a>00546     {
<a name="l00547"></a>00547       <span class="comment">/* 8.2.5.2 b) 1) is_type L1 and adj is not up */</span>
<a name="l00548"></a>00548       <span class="keywordflow">if</span> (adj-&gt;<a class="code" href="structisis__adjacency.html#ade48f111121efb755bd2ea13a06a16ae">adj_state</a> != <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a1762b381ed451feffee948c5f5d0ed86">ISIS_ADJ_UP</a>)
<a name="l00549"></a>00549         {
<a name="l00550"></a>00550           <a class="code" href="isis__adjacency_8c.html#a0f8f010e5bafa4fe5497e600c1ac12dd">isis_adj_state_change</a> (adj, <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a74fdb396aae235e00736312b60c5d347">ISIS_ADJ_DOWN</a>, <span class="stringliteral">&quot;Area Mismatch&quot;</span>);
<a name="l00551"></a>00551           <span class="comment">/* 8.2.5.2 b) 2)is_type L1 and adj is up */</span>
<a name="l00552"></a>00552         }
<a name="l00553"></a>00553       <span class="keywordflow">else</span>
<a name="l00554"></a>00554         {
<a name="l00555"></a>00555           <a class="code" href="isis__adjacency_8c.html#a0f8f010e5bafa4fe5497e600c1ac12dd">isis_adj_state_change</a> (adj, <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a74fdb396aae235e00736312b60c5d347">ISIS_ADJ_DOWN</a>,
<a name="l00556"></a>00556                      <span class="stringliteral">&quot;Down - Area Mismatch&quot;</span>);
<a name="l00557"></a>00557         }
<a name="l00558"></a>00558     }
<a name="l00559"></a>00559       <span class="comment">/* 8.2.5.2 b 3 If the system is L2 or L1L2 - table 8 */</span>
<a name="l00560"></a>00560       <span class="keywordflow">else</span>
<a name="l00561"></a>00561     {
<a name="l00562"></a>00562       <span class="keywordflow">switch</span> (hdr-&gt;<a class="code" href="structisis__p2p__hello__hdr.html#a0baabb9d6fe6845b3c63268586bf169a">circuit_t</a>)
<a name="l00563"></a>00563         {
<a name="l00564"></a>00564         <span class="keywordflow">case</span> <a class="code" href="isis__constants_8h.html#a4806dbcd4c094ef55cecd6aca29520d7">IS_LEVEL_1</a>:
<a name="l00565"></a>00565           <span class="keywordflow">if</span> (adj-&gt;<a class="code" href="structisis__adjacency.html#ade48f111121efb755bd2ea13a06a16ae">adj_state</a> != <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a1762b381ed451feffee948c5f5d0ed86">ISIS_ADJ_UP</a>)
<a name="l00566"></a>00566         {
<a name="l00567"></a>00567           <span class="comment">/* (6) reject - Area Mismatch event */</span>
<a name="l00568"></a>00568           <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;AreaMismatch&quot;</span>);
<a name="l00569"></a>00569           <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;  <span class="comment">/* Reject */</span>
<a name="l00570"></a>00570         }
<a name="l00571"></a>00571           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> == <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434ac5e73d4da9efe1a383f26fd0c958c53c">ISIS_ADJ_LEVEL1</a>)
<a name="l00572"></a>00572         {
<a name="l00573"></a>00573           <span class="comment">/* (7) down - area mismatch */</span>
<a name="l00574"></a>00574           <a class="code" href="isis__adjacency_8c.html#a0f8f010e5bafa4fe5497e600c1ac12dd">isis_adj_state_change</a> (adj, <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a74fdb396aae235e00736312b60c5d347">ISIS_ADJ_DOWN</a>, <span class="stringliteral">&quot;Area Mismatch&quot;</span>);
<a name="l00575"></a>00575 
<a name="l00576"></a>00576         }
<a name="l00577"></a>00577           <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> == <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434aae5d5e9d6b2655fbe76c0eaa011f9c58">ISIS_ADJ_LEVEL1AND2</a>) ||
<a name="l00578"></a>00578                (adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> == <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434a299a3b0ab58836ff30296ebbd291ac59">ISIS_ADJ_LEVEL2</a>))
<a name="l00579"></a>00579         {
<a name="l00580"></a>00580           <span class="comment">/* (7) down - wrong system */</span>
<a name="l00581"></a>00581           <a class="code" href="isis__adjacency_8c.html#a0f8f010e5bafa4fe5497e600c1ac12dd">isis_adj_state_change</a> (adj, <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a74fdb396aae235e00736312b60c5d347">ISIS_ADJ_DOWN</a>, <span class="stringliteral">&quot;Wrong System&quot;</span>);
<a name="l00582"></a>00582         }
<a name="l00583"></a>00583           <span class="keywordflow">break</span>;
<a name="l00584"></a>00584         <span class="keywordflow">case</span> <a class="code" href="isis__constants_8h.html#a9906fe43cc332e34827b3c233d509da6">IS_LEVEL_1_AND_2</a>:
<a name="l00585"></a>00585         <span class="keywordflow">case</span> <a class="code" href="isis__constants_8h.html#a9daa7fbf09b604c718f3bbe189aedd1a">IS_LEVEL_2</a>:
<a name="l00586"></a>00586           <span class="keywordflow">if</span> (adj-&gt;<a class="code" href="structisis__adjacency.html#ade48f111121efb755bd2ea13a06a16ae">adj_state</a> != <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a1762b381ed451feffee948c5f5d0ed86">ISIS_ADJ_UP</a>)
<a name="l00587"></a>00587         {
<a name="l00588"></a>00588           <span class="comment">/* (8) adj state up */</span>
<a name="l00589"></a>00589           <a class="code" href="isis__adjacency_8c.html#a0f8f010e5bafa4fe5497e600c1ac12dd">isis_adj_state_change</a> (adj, <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a1762b381ed451feffee948c5f5d0ed86">ISIS_ADJ_UP</a>, <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00590"></a>00590           <span class="comment">/* (9) adj usage level 2 */</span>
<a name="l00591"></a>00591           adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> = <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434a299a3b0ab58836ff30296ebbd291ac59">ISIS_ADJ_LEVEL2</a>;
<a name="l00592"></a>00592         }
<a name="l00593"></a>00593           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> == <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434ac5e73d4da9efe1a383f26fd0c958c53c">ISIS_ADJ_LEVEL1</a>)
<a name="l00594"></a>00594         {
<a name="l00595"></a>00595           <span class="comment">/* (7) down - wrong system */</span>
<a name="l00596"></a>00596           <a class="code" href="isis__adjacency_8c.html#a0f8f010e5bafa4fe5497e600c1ac12dd">isis_adj_state_change</a> (adj, <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a74fdb396aae235e00736312b60c5d347">ISIS_ADJ_DOWN</a>, <span class="stringliteral">&quot;Wrong System&quot;</span>);
<a name="l00597"></a>00597         }
<a name="l00598"></a>00598           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> == <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434aae5d5e9d6b2655fbe76c0eaa011f9c58">ISIS_ADJ_LEVEL1AND2</a>)
<a name="l00599"></a>00599         {
<a name="l00600"></a>00600           <span class="keywordflow">if</span> (hdr-&gt;<a class="code" href="structisis__p2p__hello__hdr.html#a0baabb9d6fe6845b3c63268586bf169a">circuit_t</a> == <a class="code" href="isis__constants_8h.html#a9daa7fbf09b604c718f3bbe189aedd1a">IS_LEVEL_2</a>)
<a name="l00601"></a>00601             {
<a name="l00602"></a>00602               <span class="comment">/* (7) down - wrong system */</span>
<a name="l00603"></a>00603               <a class="code" href="isis__adjacency_8c.html#a0f8f010e5bafa4fe5497e600c1ac12dd">isis_adj_state_change</a> (adj, <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a74fdb396aae235e00736312b60c5d347">ISIS_ADJ_DOWN</a>,
<a name="l00604"></a>00604                          <span class="stringliteral">&quot;Wrong System&quot;</span>);
<a name="l00605"></a>00605             }
<a name="l00606"></a>00606           <span class="keywordflow">else</span>
<a name="l00607"></a>00607             {
<a name="l00608"></a>00608               <span class="comment">/* (7) down - area mismatch */</span>
<a name="l00609"></a>00609               <a class="code" href="isis__adjacency_8c.html#a0f8f010e5bafa4fe5497e600c1ac12dd">isis_adj_state_change</a> (adj, <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a74fdb396aae235e00736312b60c5d347">ISIS_ADJ_DOWN</a>,
<a name="l00610"></a>00610                          <span class="stringliteral">&quot;Area Mismatch&quot;</span>);
<a name="l00611"></a>00611             }
<a name="l00612"></a>00612         }
<a name="l00613"></a>00613           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> == <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434a299a3b0ab58836ff30296ebbd291ac59">ISIS_ADJ_LEVEL2</a>)
<a name="l00614"></a>00614         {
<a name="l00615"></a>00615           ;     <span class="comment">/* Accept */</span>
<a name="l00616"></a>00616         }
<a name="l00617"></a>00617           <span class="keywordflow">break</span>;
<a name="l00618"></a>00618         }
<a name="l00619"></a>00619     }
<a name="l00620"></a>00620     }
<a name="l00621"></a>00621   <span class="comment">/* 8.2.5.2 c) if the action was up - comparing circuit IDs */</span>
<a name="l00622"></a>00622   <span class="comment">/* FIXME - Missing parts */</span>
<a name="l00623"></a>00623 
<a name="l00624"></a>00624   <span class="comment">/* some of my own understanding of the ISO, why the heck does</span>
<a name="l00625"></a>00625 <span class="comment">   * it not say what should I change the system_type to...</span>
<a name="l00626"></a>00626 <span class="comment">   */</span>
<a name="l00627"></a>00627   <span class="keywordflow">switch</span> (adj-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a>)
<a name="l00628"></a>00628     {
<a name="l00629"></a>00629     <span class="keywordflow">case</span> <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434ac5e73d4da9efe1a383f26fd0c958c53c">ISIS_ADJ_LEVEL1</a>:
<a name="l00630"></a>00630       adj-&gt;<a class="code" href="structisis__adjacency.html#a187eb9cdad6881ecd2735b38a47e07e3">sys_type</a> = <a class="code" href="isis__adjacency_8h.html#ad310c3cfba255c6c6dda415939268b4daddebdf6ea1f78c8503dd520854310078">ISIS_SYSTYPE_L1_IS</a>;
<a name="l00631"></a>00631       <span class="keywordflow">break</span>;
<a name="l00632"></a>00632     <span class="keywordflow">case</span> <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434a299a3b0ab58836ff30296ebbd291ac59">ISIS_ADJ_LEVEL2</a>:
<a name="l00633"></a>00633       adj-&gt;<a class="code" href="structisis__adjacency.html#a187eb9cdad6881ecd2735b38a47e07e3">sys_type</a> = <a class="code" href="isis__adjacency_8h.html#ad310c3cfba255c6c6dda415939268b4da615d7aa9f3d08cd8360e1b04a0b8806b">ISIS_SYSTYPE_L2_IS</a>;
<a name="l00634"></a>00634       <span class="keywordflow">break</span>;
<a name="l00635"></a>00635     <span class="keywordflow">case</span> <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434aae5d5e9d6b2655fbe76c0eaa011f9c58">ISIS_ADJ_LEVEL1AND2</a>:
<a name="l00636"></a>00636       adj-&gt;<a class="code" href="structisis__adjacency.html#a187eb9cdad6881ecd2735b38a47e07e3">sys_type</a> = <a class="code" href="isis__adjacency_8h.html#ad310c3cfba255c6c6dda415939268b4da615d7aa9f3d08cd8360e1b04a0b8806b">ISIS_SYSTYPE_L2_IS</a>;
<a name="l00637"></a>00637       <span class="keywordflow">break</span>;
<a name="l00638"></a>00638     <span class="keywordflow">case</span> <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434a501a122376669a6dd34f5db4c380d43a">ISIS_ADJ_NONE</a>:
<a name="l00639"></a>00639       adj-&gt;<a class="code" href="structisis__adjacency.html#a187eb9cdad6881ecd2735b38a47e07e3">sys_type</a> = <a class="code" href="isis__adjacency_8h.html#ad310c3cfba255c6c6dda415939268b4da1d20bc4d429708dd9bc81735bd176618">ISIS_SYSTYPE_UNKNOWN</a>;
<a name="l00640"></a>00640       <span class="keywordflow">break</span>;
<a name="l00641"></a>00641     }
<a name="l00642"></a>00642 
<a name="l00643"></a>00643   adj-&gt;<a class="code" href="structisis__adjacency.html#a94749cb53088c1898166a701f2a3931f">circuit_t</a> = hdr-&gt;<a class="code" href="structisis__p2p__hello__hdr.html#a0baabb9d6fe6845b3c63268586bf169a">circuit_t</a>;
<a name="l00644"></a>00644   adj-&gt;<a class="code" href="structisis__adjacency.html#abee45e3e4c2c3f246db1c8aa19186cc8">level</a> = hdr-&gt;<a class="code" href="structisis__p2p__hello__hdr.html#a0baabb9d6fe6845b3c63268586bf169a">circuit_t</a>;
<a name="l00645"></a>00645 
<a name="l00646"></a>00646   <a class="code" href="isis__tlv_8c.html#a5f499235cf5a69697d280f5a1cd01612">free_tlvs</a> (&amp;tlvs);
<a name="l00647"></a>00647 
<a name="l00648"></a>00648   <span class="keywordflow">return</span> retval;
<a name="l00649"></a>00649 }
<a name="l00650"></a>00650 
<a name="l00651"></a>00651 <span class="comment">/*</span>
<a name="l00652"></a>00652 <span class="comment"> * Process IS-IS LAN Level 1/2 Hello PDU</span>
<a name="l00653"></a>00653 <span class="comment"> */</span>
<a name="l00654"></a>00654 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00655"></a><a class="code" href="isis__pdu_8c.html#adb45f30316e2d1fed63fc164d31657c1">00655</a> <a class="code" href="isis__pdu_8c.html#adb45f30316e2d1fed63fc164d31657c1">process_lan_hello</a> (<span class="keywordtype">int</span> level, <span class="keyword">struct</span> <a class="code" href="structisis__circuit.html">isis_circuit</a> *circuit, u_char * ssnpa)
<a name="l00656"></a>00656 {
<a name="l00657"></a>00657   <span class="keywordtype">int</span> retval = <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;
<a name="l00658"></a>00658   <span class="keyword">struct </span><a class="code" href="structisis__lan__hello__hdr.html">isis_lan_hello_hdr</a> hdr;
<a name="l00659"></a>00659   <span class="keyword">struct </span><a class="code" href="structisis__adjacency.html">isis_adjacency</a> *adj;
<a name="l00660"></a>00660   u_int32_t expected = 0, found;
<a name="l00661"></a>00661   <span class="keyword">struct </span>tlvs tlvs;
<a name="l00662"></a>00662   u_char *<a class="code" href="isis__misc_8c.html#aa1751dc9ca6ba209edc0f7f8e51e1d11">snpa</a>;
<a name="l00663"></a>00663   <span class="keyword">struct </span><a class="code" href="structlistnode.html">listnode</a> *node;
<a name="l00664"></a>00664 
<a name="l00665"></a>00665   <span class="keywordflow">if</span> ((<a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>) -
<a name="l00666"></a>00666        <a class="code" href="stream_8c.html#a717f15645000d42a15034f5ec83fc9a5">stream_get_getp</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>)) &lt; <a class="code" href="isis__pdu_8h.html#ae252f7eb62c9ee4fd050d82558623d39">ISIS_LANHELLO_HDRLEN</a>)
<a name="l00667"></a>00667     {
<a name="l00668"></a>00668       <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;Packet too short&quot;</span>);
<a name="l00669"></a>00669       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;
<a name="l00670"></a>00670     }
<a name="l00671"></a>00671 
<a name="l00672"></a>00672   <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#aa21c1b770870b6ca7583a164435d1977">ext_domain</a>)
<a name="l00673"></a>00673     {
<a name="l00674"></a>00674       <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;level %d LAN Hello received over circuit with &quot;</span>
<a name="l00675"></a>00675           <span class="stringliteral">&quot;externalDomain = true&quot;</span>, level);
<a name="l00676"></a>00676       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;
<a name="l00677"></a>00677     }
<a name="l00678"></a>00678 
<a name="l00679"></a>00679   <span class="keywordflow">if</span> (!<a class="code" href="isis__pdu_8c.html#ad3be9b74a266fca7d08e91ad3e4b0d45">accept_level</a> (level, circuit-&gt;<a class="code" href="structisis__circuit.html#ab222d6d0b054faa159d72bcb9768b3fb">circuit_is_type</a>))
<a name="l00680"></a>00680     {
<a name="l00681"></a>00681       <span class="keywordflow">if</span> (isis-&gt;<a class="code" href="structisis.html#a6e64127e274c1aa6a52cb0f4b541dfaa">debugs</a> &amp; <a class="code" href="isisd_8h.html#a4113d6aad857cfa148450dfc6ed85b5b">DEBUG_ADJ_PACKETS</a>)
<a name="l00682"></a>00682     {
<a name="l00683"></a>00683       <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;ISIS-Adj (%s): Interface level mismatch, %s&quot;</span>,
<a name="l00684"></a>00684               circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>, circuit-&gt;<a class="code" href="structisis__circuit.html#ab03cac6463284a4ce8c1eb19e49f3b6d">interface</a>-&gt;<a class="code" href="structinterface.html#a98cadce768ec5aacb4c5fc4ca2c3eaa8">name</a>);
<a name="l00685"></a>00685     }
<a name="l00686"></a>00686       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;
<a name="l00687"></a>00687     }
<a name="l00688"></a>00688 
<a name="l00689"></a>00689 <span class="preprocessor">#if 0</span>
<a name="l00690"></a>00690 <span class="preprocessor"></span>  <span class="comment">/* Cisco&#39;s debug message compatability */</span>
<a name="l00691"></a>00691   <span class="keywordflow">if</span> (!<a class="code" href="isis__pdu_8c.html#ad3be9b74a266fca7d08e91ad3e4b0d45">accept_level</a> (level, circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#a81021eb6fb20d16db0d13c335baecdae">is_type</a>))
<a name="l00692"></a>00692     {
<a name="l00693"></a>00693       <span class="keywordflow">if</span> (isis-&gt;<a class="code" href="structisis.html#a6e64127e274c1aa6a52cb0f4b541dfaa">debugs</a> &amp; <a class="code" href="isisd_8h.html#a4113d6aad857cfa148450dfc6ed85b5b">DEBUG_ADJ_PACKETS</a>)
<a name="l00694"></a>00694     {
<a name="l00695"></a>00695       <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;ISIS-Adj (%s): is type mismatch&quot;</span>,
<a name="l00696"></a>00696               circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>);
<a name="l00697"></a>00697     }
<a name="l00698"></a>00698       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;
<a name="l00699"></a>00699     }
<a name="l00700"></a>00700 <span class="preprocessor">#endif</span>
<a name="l00701"></a>00701 <span class="preprocessor"></span>  <span class="comment">/*</span>
<a name="l00702"></a>00702 <span class="comment">   * Fill the header</span>
<a name="l00703"></a>00703 <span class="comment">   */</span>
<a name="l00704"></a>00704   hdr.<a class="code" href="structisis__lan__hello__hdr.html#adc05838604616cf54cd1a3da59d9fb54">circuit_t</a> = <a class="code" href="stream_8c.html#a7902a86d9a749707c535840654ded3f6">stream_getc</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>);
<a name="l00705"></a>00705   <a class="code" href="stream_8c.html#ab7101e57ef0d9dc1a33e7f7e30c91b9a">stream_get</a> (hdr.<a class="code" href="structisis__lan__hello__hdr.html#ace215b4fc901e21a973560b1a6562a69">source_id</a>, circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>, <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a>);
<a name="l00706"></a>00706   hdr.<a class="code" href="structisis__lan__hello__hdr.html#ab077a36b5a5430debe28b04bf25964a2">hold_time</a> = <a class="code" href="stream_8c.html#a66155fa63acd1f377a5b9e98aba7b888">stream_getw</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>);
<a name="l00707"></a>00707   hdr.<a class="code" href="structisis__lan__hello__hdr.html#aed1e2c349dadd95f0cc3211e0498ea81">pdu_len</a> = <a class="code" href="stream_8c.html#a66155fa63acd1f377a5b9e98aba7b888">stream_getw</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>);
<a name="l00708"></a>00708   hdr.<a class="code" href="structisis__lan__hello__hdr.html#a72f900765ed3b6306511055bee3582b2">prio</a> = <a class="code" href="stream_8c.html#a7902a86d9a749707c535840654ded3f6">stream_getc</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>);
<a name="l00709"></a>00709   <a class="code" href="stream_8c.html#ab7101e57ef0d9dc1a33e7f7e30c91b9a">stream_get</a> (hdr.<a class="code" href="structisis__lan__hello__hdr.html#a57b120a4bcafd36b80b2719061547349">lan_id</a>, circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>, <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a> + 1);
<a name="l00710"></a>00710 
<a name="l00711"></a>00711   <span class="keywordflow">if</span> (hdr.<a class="code" href="structisis__lan__hello__hdr.html#adc05838604616cf54cd1a3da59d9fb54">circuit_t</a> != <a class="code" href="isis__constants_8h.html#a4806dbcd4c094ef55cecd6aca29520d7">IS_LEVEL_1</a> &amp;&amp; hdr.<a class="code" href="structisis__lan__hello__hdr.html#adc05838604616cf54cd1a3da59d9fb54">circuit_t</a> != <a class="code" href="isis__constants_8h.html#a9daa7fbf09b604c718f3bbe189aedd1a">IS_LEVEL_2</a> &amp;&amp;
<a name="l00712"></a>00712       hdr.<a class="code" href="structisis__lan__hello__hdr.html#adc05838604616cf54cd1a3da59d9fb54">circuit_t</a> != <a class="code" href="isis__constants_8h.html#a9906fe43cc332e34827b3c233d509da6">IS_LEVEL_1_AND_2</a>)
<a name="l00713"></a>00713     {
<a name="l00714"></a>00714       <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;Level %d LAN Hello with Circuit Type %d&quot;</span>, level,
<a name="l00715"></a>00715          hdr.<a class="code" href="structisis__lan__hello__hdr.html#adc05838604616cf54cd1a3da59d9fb54">circuit_t</a>);
<a name="l00716"></a>00716       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#ac694b0bd16857a3d50deea71f78e8b7f">ISIS_ERROR</a>;
<a name="l00717"></a>00717     }
<a name="l00718"></a>00718   <span class="comment">/*</span>
<a name="l00719"></a>00719 <span class="comment">   * Then get the tlvs</span>
<a name="l00720"></a>00720 <span class="comment">   */</span>
<a name="l00721"></a>00721   expected |= <a class="code" href="isis__tlv_8h.html#a493ed26a4a2decc55275bd699df9a4a8">TLVFLAG_AUTH_INFO</a>;
<a name="l00722"></a>00722   expected |= <a class="code" href="isis__tlv_8h.html#ae2a91163530ea4d9bfb3b00394a48316">TLVFLAG_AREA_ADDRS</a>;
<a name="l00723"></a>00723   expected |= <a class="code" href="isis__tlv_8h.html#a73ebf94211143da42abc8c4a8c2deec3">TLVFLAG_LAN_NEIGHS</a>;
<a name="l00724"></a>00724   expected |= <a class="code" href="isis__tlv_8h.html#ac9149da10b98f4211a51249c752b5fee">TLVFLAG_NLPID</a>;
<a name="l00725"></a>00725   expected |= <a class="code" href="isis__tlv_8h.html#ac1d5ea73aa3cc33a2c7e4190df6fab00">TLVFLAG_IPV4_ADDR</a>;
<a name="l00726"></a>00726   expected |= <a class="code" href="isis__tlv_8h.html#af63af1cfdbe427be867d8191c1ea5b5f">TLVFLAG_IPV6_ADDR</a>;
<a name="l00727"></a>00727 
<a name="l00728"></a>00728   retval = <a class="code" href="isis__tlv_8c.html#aad6fa3b6cc5e93707f75d8247f8787c8">parse_tlvs</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>,
<a name="l00729"></a>00729                <a class="code" href="stream_8h.html#a4bb95ef1391c2b8b7b97678a5ad87cb7">STREAM_PNT</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>),
<a name="l00730"></a>00730                hdr.<a class="code" href="structisis__lan__hello__hdr.html#aed1e2c349dadd95f0cc3211e0498ea81">pdu_len</a> - <a class="code" href="isis__pdu_8h.html#ae252f7eb62c9ee4fd050d82558623d39">ISIS_LANHELLO_HDRLEN</a> -
<a name="l00731"></a>00731                <a class="code" href="isis__pdu_8h.html#a61f100919f790014bded41907b477263">ISIS_FIXED_HDR_LEN</a>, &amp;expected, &amp;found, &amp;tlvs);
<a name="l00732"></a>00732 
<a name="l00733"></a>00733   <span class="keywordflow">if</span> (retval &gt; <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>)
<a name="l00734"></a>00734     {
<a name="l00735"></a>00735       <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;parse_tlvs() failed&quot;</span>);
<a name="l00736"></a>00736       <span class="keywordflow">goto</span> out;
<a name="l00737"></a>00737     }
<a name="l00738"></a>00738 
<a name="l00739"></a>00739   <span class="keywordflow">if</span> (!(found &amp; <a class="code" href="isis__tlv_8h.html#ae2a91163530ea4d9bfb3b00394a48316">TLVFLAG_AREA_ADDRS</a>))
<a name="l00740"></a>00740     {
<a name="l00741"></a>00741       <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;No Area addresses TLV in Level %d LAN IS to IS hello&quot;</span>,
<a name="l00742"></a>00742          level);
<a name="l00743"></a>00743       retval = <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;
<a name="l00744"></a>00744       <span class="keywordflow">goto</span> out;
<a name="l00745"></a>00745     }
<a name="l00746"></a>00746 
<a name="l00747"></a>00747   <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a601d2b4b3220757f8f7212f2a1628ab2">passwd</a>.<a class="code" href="structisis__passwd.html#a874984e0745fbcb41df9f463d831be67">type</a>)
<a name="l00748"></a>00748     {
<a name="l00749"></a>00749       <span class="keywordflow">if</span> (!(found &amp; <a class="code" href="isis__tlv_8h.html#a493ed26a4a2decc55275bd699df9a4a8">TLVFLAG_AUTH_INFO</a>) ||
<a name="l00750"></a>00750       <a class="code" href="isis__pdu_8c.html#aefd5a8caa169a427e30d599b51ab52e9">authentication_check</a> (&amp;circuit-&gt;<a class="code" href="structisis__circuit.html#a601d2b4b3220757f8f7212f2a1628ab2">passwd</a>, &amp;tlvs.<a class="code" href="structtlvs.html#a53dc2cb65bc632c84b3d702ab1dc16ce">auth_info</a>))
<a name="l00751"></a>00751     {
<a name="l00752"></a>00752       <a class="code" href="isis__events_8c.html#a16a754e810bb7ba8e3b2a23c89d6d130">isis_event_auth_failure</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>,
<a name="l00753"></a>00753                    <span class="stringliteral">&quot;LAN hello authentication failure&quot;</span>,
<a name="l00754"></a>00754                    hdr.<a class="code" href="structisis__lan__hello__hdr.html#ace215b4fc901e21a973560b1a6562a69">source_id</a>);
<a name="l00755"></a>00755       retval = <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;
<a name="l00756"></a>00756       <span class="keywordflow">goto</span> out;
<a name="l00757"></a>00757     }
<a name="l00758"></a>00758     }
<a name="l00759"></a>00759 
<a name="l00760"></a>00760   <span class="comment">/*</span>
<a name="l00761"></a>00761 <span class="comment">   * Accept the level 1 adjacency only if a match between local and</span>
<a name="l00762"></a>00762 <span class="comment">   * remote area addresses is found</span>
<a name="l00763"></a>00763 <span class="comment">   */</span>
<a name="l00764"></a>00764   <span class="keywordflow">if</span> (level == 1 &amp;&amp; !<a class="code" href="isis__pdu_8c.html#ac44201d5d72450ec89f35a014c1e31c1">area_match</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aca1436df894da89fb83d7924ef248397">area_addrs</a>, tlvs.<a class="code" href="structtlvs.html#a11d8deaa75c26e958cff5f74fee3ef10">area_addrs</a>))
<a name="l00765"></a>00765     {
<a name="l00766"></a>00766       <span class="keywordflow">if</span> (isis-&gt;<a class="code" href="structisis.html#a6e64127e274c1aa6a52cb0f4b541dfaa">debugs</a> &amp; <a class="code" href="isisd_8h.html#a4113d6aad857cfa148450dfc6ed85b5b">DEBUG_ADJ_PACKETS</a>)
<a name="l00767"></a>00767     {
<a name="l00768"></a>00768       <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;ISIS-Adj (%s): Area mismatch, level %d IIH on %s&quot;</span>,
<a name="l00769"></a>00769               circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>, level,
<a name="l00770"></a>00770               circuit-&gt;<a class="code" href="structisis__circuit.html#ab03cac6463284a4ce8c1eb19e49f3b6d">interface</a>-&gt;<a class="code" href="structinterface.html#a98cadce768ec5aacb4c5fc4ca2c3eaa8">name</a>);
<a name="l00771"></a>00771     }
<a name="l00772"></a>00772       retval = <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;
<a name="l00773"></a>00773       <span class="keywordflow">goto</span> out;
<a name="l00774"></a>00774     }
<a name="l00775"></a>00775 
<a name="l00776"></a>00776   <span class="comment">/* </span>
<a name="l00777"></a>00777 <span class="comment">   * it&#39;s own IIH PDU - discard silently </span>
<a name="l00778"></a>00778 <span class="comment">   */</span>
<a name="l00779"></a>00779   <span class="keywordflow">if</span> (!<a class="code" href="regex_8c.html#a98d0dff0c7366f08562d8e8583df9bb9">memcmp</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#ac7adabf9b24b03c93e73bb9b03c2192b">snpa</a>, ssnpa, <a class="code" href="isis__constants_8h.html#a9822d89774e0d6ddaa06503950130423">ETH_ALEN</a>))
<a name="l00780"></a>00780     {
<a name="l00781"></a>00781       <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;ISIS-Adj (%s): it&#39;s own IIH PDU - discarded&quot;</span>,
<a name="l00782"></a>00782           circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>);
<a name="l00783"></a>00783 
<a name="l00784"></a>00784       retval = <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;
<a name="l00785"></a>00785       <span class="keywordflow">goto</span> out;
<a name="l00786"></a>00786     }
<a name="l00787"></a>00787 
<a name="l00788"></a>00788   <span class="comment">/*</span>
<a name="l00789"></a>00789 <span class="comment">   * check if it&#39;s own interface ip match iih ip addrs</span>
<a name="l00790"></a>00790 <span class="comment">   */</span>
<a name="l00791"></a>00791   <span class="keywordflow">if</span> (!(found &amp; <a class="code" href="isis__tlv_8h.html#ac1d5ea73aa3cc33a2c7e4190df6fab00">TLVFLAG_IPV4_ADDR</a>)
<a name="l00792"></a>00792       || !<a class="code" href="isis__pdu_8c.html#a7df02c36d437547a772bc406fc9594fb">ip_match</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#adcde796f44a1e725abe092f95a6cb075">ip_addrs</a>, tlvs.<a class="code" href="structtlvs.html#ae9ef317829a76d7a79d2789786a2ac1f">ipv4_addrs</a>))
<a name="l00793"></a>00793     {
<a name="l00794"></a>00794       <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a>
<a name="l00795"></a>00795     (<span class="stringliteral">&quot;ISIS-Adj: No usable IP interface addresses in LAN IIH from %s\n&quot;</span>,
<a name="l00796"></a>00796      circuit-&gt;<a class="code" href="structisis__circuit.html#ab03cac6463284a4ce8c1eb19e49f3b6d">interface</a>-&gt;<a class="code" href="structinterface.html#a98cadce768ec5aacb4c5fc4ca2c3eaa8">name</a>);
<a name="l00797"></a>00797       retval = <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;
<a name="l00798"></a>00798       <span class="keywordflow">goto</span> out;
<a name="l00799"></a>00799     }
<a name="l00800"></a>00800 
<a name="l00801"></a>00801   adj = <a class="code" href="isis__adjacency_8c.html#af928a678a2e0e3296d688be2a4d8e7ac">isis_adj_lookup</a> (hdr.<a class="code" href="structisis__lan__hello__hdr.html#ace215b4fc901e21a973560b1a6562a69">source_id</a>, circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#ada9bf2584373a37aed06b2e4c9e796f9">adjdb</a>[level - 1]);
<a name="l00802"></a>00802   <span class="keywordflow">if</span> (!adj)
<a name="l00803"></a>00803     {
<a name="l00804"></a>00804       <span class="comment">/*</span>
<a name="l00805"></a>00805 <span class="comment">       * Do as in 8.4.2.5</span>
<a name="l00806"></a>00806 <span class="comment">       */</span>
<a name="l00807"></a>00807       adj = <a class="code" href="isis__adjacency_8c.html#a81fa83638827781e0f128c9c01551a95">isis_new_adj</a> (hdr.<a class="code" href="structisis__lan__hello__hdr.html#ace215b4fc901e21a973560b1a6562a69">source_id</a>, ssnpa, level, circuit);
<a name="l00808"></a>00808       <span class="keywordflow">if</span> (adj == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00809"></a>00809     {
<a name="l00810"></a>00810       retval = <a class="code" href="isis__constants_8h.html#ac694b0bd16857a3d50deea71f78e8b7f">ISIS_ERROR</a>;
<a name="l00811"></a>00811       <span class="keywordflow">goto</span> out;
<a name="l00812"></a>00812     }
<a name="l00813"></a>00813 
<a name="l00814"></a>00814       adj-&gt;<a class="code" href="structisis__adjacency.html#abee45e3e4c2c3f246db1c8aa19186cc8">level</a> = level;
<a name="l00815"></a>00815       <a class="code" href="isis__adjacency_8c.html#a0f8f010e5bafa4fe5497e600c1ac12dd">isis_adj_state_change</a> (adj, <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a1973db8c983074b9c3e0cc74c23eab47">ISIS_ADJ_INITIALIZING</a>, <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00816"></a>00816 
<a name="l00817"></a>00817       <span class="keywordflow">if</span> (level == 1)
<a name="l00818"></a>00818     {
<a name="l00819"></a>00819       adj-&gt;<a class="code" href="structisis__adjacency.html#a187eb9cdad6881ecd2735b38a47e07e3">sys_type</a> = <a class="code" href="isis__adjacency_8h.html#ad310c3cfba255c6c6dda415939268b4daddebdf6ea1f78c8503dd520854310078">ISIS_SYSTYPE_L1_IS</a>;
<a name="l00820"></a>00820     }
<a name="l00821"></a>00821       <span class="keywordflow">else</span>
<a name="l00822"></a>00822     {
<a name="l00823"></a>00823       adj-&gt;<a class="code" href="structisis__adjacency.html#a187eb9cdad6881ecd2735b38a47e07e3">sys_type</a> = <a class="code" href="isis__adjacency_8h.html#ad310c3cfba255c6c6dda415939268b4da615d7aa9f3d08cd8360e1b04a0b8806b">ISIS_SYSTYPE_L2_IS</a>;
<a name="l00824"></a>00824     }
<a name="l00825"></a>00825       <a class="code" href="linklist_8c.html#acd6daa4be8ab3f175376e63c9d9c9500">list_delete_all_node</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#a1a8b5b8fcf6defb0b21b509d99953742">lan_neighs</a>[level - 1]);
<a name="l00826"></a>00826       <a class="code" href="isis__adjacency_8c.html#aa6290067148c07fb10f67b9e4237585f">isis_adj_build_neigh_list</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#ada9bf2584373a37aed06b2e4c9e796f9">adjdb</a>[level - 1],
<a name="l00827"></a>00827                  circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#a1a8b5b8fcf6defb0b21b509d99953742">lan_neighs</a>[level - 1]);
<a name="l00828"></a>00828     }
<a name="l00829"></a>00829 
<a name="l00830"></a>00830   <span class="keywordflow">if</span>(adj-&gt;<a class="code" href="structisis__adjacency.html#a76bf3ed808e66f1047d7a2a698683db2">dis_record</a>[level-1].<a class="code" href="structisis__dis__record.html#ae53530d9ceb39ce5604d82c3b5f0da1b">dis</a>==<a class="code" href="isis__dr_8h.html#a411da867a1e3279a6ff0d1624b9ab05fa971f7814bbbbb88e9186770d1ef77ae2">ISIS_IS_DIS</a>)
<a name="l00831"></a>00831     <span class="keywordflow">switch</span> (level)
<a name="l00832"></a>00832       {
<a name="l00833"></a>00833       <span class="keywordflow">case</span> 1:
<a name="l00834"></a>00834     <span class="keywordflow">if</span> (<a class="code" href="regex_8c.html#a98d0dff0c7366f08562d8e8583df9bb9">memcmp</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#a015b72bf5854d99b722f9f599b9eb158">l1_desig_is</a>, hdr.<a class="code" href="structisis__lan__hello__hdr.html#a57b120a4bcafd36b80b2719061547349">lan_id</a>, <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a> + 1))
<a name="l00835"></a>00835       {
<a name="l00836"></a>00836         <a class="code" href="thread_8h.html#a1067157ad59ad46f29bf87158dffc3de">thread_add_event</a> (master, <a class="code" href="isis__events_8c.html#aa449cea2358b48018e359f93e4909864">isis_event_dis_status_change</a>, circuit, 0);
<a name="l00837"></a>00837         <a class="code" href="regex_8c.html#aed653b4838032a2c5ce8960421c8cfd7">memcpy</a> (&amp;circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#a015b72bf5854d99b722f9f599b9eb158">l1_desig_is</a>, hdr.<a class="code" href="structisis__lan__hello__hdr.html#a57b120a4bcafd36b80b2719061547349">lan_id</a>,
<a name="l00838"></a>00838             <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a> + 1);
<a name="l00839"></a>00839       }
<a name="l00840"></a>00840     <span class="keywordflow">break</span>;
<a name="l00841"></a>00841       <span class="keywordflow">case</span> 2:
<a name="l00842"></a>00842     <span class="keywordflow">if</span> (<a class="code" href="regex_8c.html#a98d0dff0c7366f08562d8e8583df9bb9">memcmp</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#a2bde5462284eb2b294ed998fb5907de8">l2_desig_is</a>, hdr.<a class="code" href="structisis__lan__hello__hdr.html#a57b120a4bcafd36b80b2719061547349">lan_id</a>, <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a> + 1))
<a name="l00843"></a>00843       {
<a name="l00844"></a>00844         <a class="code" href="thread_8h.html#a1067157ad59ad46f29bf87158dffc3de">thread_add_event</a> (master, <a class="code" href="isis__events_8c.html#aa449cea2358b48018e359f93e4909864">isis_event_dis_status_change</a>, circuit, 0);
<a name="l00845"></a>00845         <a class="code" href="regex_8c.html#aed653b4838032a2c5ce8960421c8cfd7">memcpy</a> (&amp;circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#a2bde5462284eb2b294ed998fb5907de8">l2_desig_is</a>, hdr.<a class="code" href="structisis__lan__hello__hdr.html#a57b120a4bcafd36b80b2719061547349">lan_id</a>,
<a name="l00846"></a>00846             <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a> + 1);
<a name="l00847"></a>00847       }
<a name="l00848"></a>00848     <span class="keywordflow">break</span>;
<a name="l00849"></a>00849       }
<a name="l00850"></a>00850 
<a name="l00851"></a>00851   adj-&gt;<a class="code" href="structisis__adjacency.html#a656446a9be5f9ebf466ffacc8741a909">hold_time</a> = hdr.<a class="code" href="structisis__lan__hello__hdr.html#ab077a36b5a5430debe28b04bf25964a2">hold_time</a>;
<a name="l00852"></a>00852   adj-&gt;<a class="code" href="structisis__adjacency.html#afd570f7072dac8465cf207cd6df6c567">last_upd</a> = time (<a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00853"></a>00853   adj-&gt;<a class="code" href="structisis__adjacency.html#a4eca92e54cf0d683720479515d044d1c">prio</a>[level - 1] = hdr.<a class="code" href="structisis__lan__hello__hdr.html#a72f900765ed3b6306511055bee3582b2">prio</a>;
<a name="l00854"></a>00854 
<a name="l00855"></a>00855   <a class="code" href="regex_8c.html#aed653b4838032a2c5ce8960421c8cfd7">memcpy</a> (adj-&gt;<a class="code" href="structisis__adjacency.html#a7d3a80980b6870f382dc48f91035bd6b">lanid</a>, hdr.<a class="code" href="structisis__lan__hello__hdr.html#a57b120a4bcafd36b80b2719061547349">lan_id</a>, <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a> + 1);
<a name="l00856"></a>00856 
<a name="l00857"></a>00857   <span class="comment">/* which protocol are spoken ??? */</span>
<a name="l00858"></a>00858   <span class="keywordflow">if</span> (found &amp; <a class="code" href="isis__tlv_8h.html#ac9149da10b98f4211a51249c752b5fee">TLVFLAG_NLPID</a>)
<a name="l00859"></a>00859     <a class="code" href="isis__pdu_8c.html#afb3df247f88b4af648f1abf59f8a6044">tlvs_to_adj_nlpids</a> (&amp;tlvs, adj);
<a name="l00860"></a>00860 
<a name="l00861"></a>00861   <span class="comment">/* we need to copy addresses to the adj */</span>
<a name="l00862"></a>00862   <span class="keywordflow">if</span> (found &amp; TLVFLAG_IPV4_ADDR)
<a name="l00863"></a>00863     <a class="code" href="isis__pdu_8c.html#af96726be5388512e070368d2438bbf99">tlvs_to_adj_ipv4_addrs</a> (&amp;tlvs, adj);
<a name="l00864"></a>00864 
<a name="l00865"></a>00865 <span class="preprocessor">#ifdef HAVE_IPV6</span>
<a name="l00866"></a>00866 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (found &amp; <a class="code" href="isis__tlv_8h.html#af63af1cfdbe427be867d8191c1ea5b5f">TLVFLAG_IPV6_ADDR</a>)
<a name="l00867"></a>00867     tlvs_to_adj_ipv6_addrs (&amp;tlvs, adj);
<a name="l00868"></a>00868 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_IPV6 */</span>
<a name="l00869"></a>00869 
<a name="l00870"></a>00870   adj-&gt;<a class="code" href="structisis__adjacency.html#a94749cb53088c1898166a701f2a3931f">circuit_t</a> = hdr.<a class="code" href="structisis__lan__hello__hdr.html#adc05838604616cf54cd1a3da59d9fb54">circuit_t</a>;
<a name="l00871"></a>00871 
<a name="l00872"></a>00872   <span class="comment">/* lets take care of the expiry */</span>
<a name="l00873"></a>00873   <a class="code" href="thread_8h.html#ae1dfd3f5f643212148d60a41d9f2192a">THREAD_TIMER_OFF</a> (adj-&gt;<a class="code" href="structisis__adjacency.html#a16900c0c5677510df0a115d145d5ce87">t_expire</a>);
<a name="l00874"></a>00874   <a class="code" href="thread_8h.html#a898ebeae19eb435889cbf53ea8b5120e">THREAD_TIMER_ON</a> (master, adj-&gt;<a class="code" href="structisis__adjacency.html#a16900c0c5677510df0a115d145d5ce87">t_expire</a>, <a class="code" href="isis__adjacency_8c.html#a089c767d62df53d044fc7ba923219879">isis_adj_expire</a>, adj,
<a name="l00875"></a>00875            (<span class="keywordtype">long</span>) adj-&gt;<a class="code" href="structisis__adjacency.html#a656446a9be5f9ebf466ffacc8741a909">hold_time</a>);
<a name="l00876"></a>00876 
<a name="l00877"></a>00877   <span class="comment">/*</span>
<a name="l00878"></a>00878 <span class="comment">   * If the snpa for this circuit is found from LAN Neighbours TLV</span>
<a name="l00879"></a>00879 <span class="comment">   * we have two-way communication -&gt; adjacency can be put to state &quot;up&quot;</span>
<a name="l00880"></a>00880 <span class="comment">   */</span>
<a name="l00881"></a>00881 
<a name="l00882"></a>00882   <span class="keywordflow">if</span> (found &amp; <a class="code" href="isis__tlv_8h.html#a73ebf94211143da42abc8c4a8c2deec3">TLVFLAG_LAN_NEIGHS</a>)
<a name="l00883"></a>00883     {
<a name="l00884"></a>00884       <span class="keywordflow">if</span> (adj-&gt;<a class="code" href="structisis__adjacency.html#ade48f111121efb755bd2ea13a06a16ae">adj_state</a> != <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a1762b381ed451feffee948c5f5d0ed86">ISIS_ADJ_UP</a>)
<a name="l00885"></a>00885     {
<a name="l00886"></a>00886       <span class="keywordflow">for</span> (<a class="code" href="linklist_8h.html#a80a3f4035be83abbb709d17412993226">ALL_LIST_ELEMENTS_RO</a> (tlvs.<a class="code" href="structtlvs.html#ab00441be3a4bb1a610cf6b2746498568">lan_neighs</a>, node, snpa))
<a name="l00887"></a>00887         <span class="keywordflow">if</span> (!<a class="code" href="regex_8c.html#a98d0dff0c7366f08562d8e8583df9bb9">memcmp</a> (snpa, circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#ac7adabf9b24b03c93e73bb9b03c2192b">snpa</a>, <a class="code" href="isis__constants_8h.html#a9822d89774e0d6ddaa06503950130423">ETH_ALEN</a>))
<a name="l00888"></a>00888         {
<a name="l00889"></a>00889           <a class="code" href="isis__adjacency_8c.html#a0f8f010e5bafa4fe5497e600c1ac12dd">isis_adj_state_change</a> (adj, <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a1762b381ed451feffee948c5f5d0ed86">ISIS_ADJ_UP</a>,
<a name="l00890"></a>00890                      <span class="stringliteral">&quot;own SNPA found in LAN Neighbours TLV&quot;</span>);
<a name="l00891"></a>00891         }
<a name="l00892"></a>00892     }
<a name="l00893"></a>00893     }
<a name="l00894"></a>00894 
<a name="l00895"></a>00895 out:
<a name="l00896"></a>00896   <span class="comment">/* DEBUG_ADJ_PACKETS */</span>
<a name="l00897"></a>00897   <span class="keywordflow">if</span> (isis-&gt;<a class="code" href="structisis.html#a6e64127e274c1aa6a52cb0f4b541dfaa">debugs</a> &amp; <a class="code" href="isisd_8h.html#a4113d6aad857cfa148450dfc6ed85b5b">DEBUG_ADJ_PACKETS</a>)
<a name="l00898"></a>00898     {
<a name="l00899"></a>00899       <span class="comment">/* FIXME: is this place right? fix missing info */</span>
<a name="l00900"></a>00900       <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;ISIS-Adj (%s): Rcvd L%d LAN IIH from %s on %s, cirType %s, &quot;</span>
<a name="l00901"></a>00901           <span class="stringliteral">&quot;cirID %u, length %ld&quot;</span>,
<a name="l00902"></a>00902           circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>,
<a name="l00903"></a>00903           level, <a class="code" href="isis__misc_8c.html#a9ff6d4a3900eef27814548c4c5357090">snpa_print</a> (ssnpa), circuit-&gt;<a class="code" href="structisis__circuit.html#ab03cac6463284a4ce8c1eb19e49f3b6d">interface</a>-&gt;<a class="code" href="structinterface.html#a98cadce768ec5aacb4c5fc4ca2c3eaa8">name</a>,
<a name="l00904"></a>00904           <a class="code" href="isis__misc_8c.html#a35b15c65a44088982fa8daca9fc7b022">circuit_t2string</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#ab222d6d0b054faa159d72bcb9768b3fb">circuit_is_type</a>),
<a name="l00905"></a>00905           circuit-&gt;<a class="code" href="structisis__circuit.html#a10453f6bcc1e8f1cb466240a81836ba9">circuit_id</a>,
<a name="l00906"></a>00906           <span class="comment">/* FIXME: use %z when we stop supporting old compilers. */</span>
<a name="l00907"></a>00907           (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) <a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>));
<a name="l00908"></a>00908     }
<a name="l00909"></a>00909 
<a name="l00910"></a>00910   <a class="code" href="isis__tlv_8c.html#a5f499235cf5a69697d280f5a1cd01612">free_tlvs</a> (&amp;tlvs);
<a name="l00911"></a>00911 
<a name="l00912"></a>00912   <span class="keywordflow">return</span> retval;
<a name="l00913"></a>00913 }
<a name="l00914"></a>00914 
<a name="l00915"></a>00915 <span class="comment">/*</span>
<a name="l00916"></a>00916 <span class="comment"> * Process Level 1/2 Link State</span>
<a name="l00917"></a>00917 <span class="comment"> * ISO - 10589</span>
<a name="l00918"></a>00918 <span class="comment"> * Section 7.3.15.1 - Action on receipt of a link state PDU</span>
<a name="l00919"></a>00919 <span class="comment"> */</span>
<a name="l00920"></a>00920 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00921"></a><a class="code" href="isis__pdu_8c.html#aa15bc068c8e49090fcf9268028d4fb03">00921</a> <a class="code" href="isis__pdu_8c.html#aa15bc068c8e49090fcf9268028d4fb03">process_lsp</a> (<span class="keywordtype">int</span> level, <span class="keyword">struct</span> <a class="code" href="structisis__circuit.html">isis_circuit</a> *circuit, u_char * ssnpa)
<a name="l00922"></a>00922 {
<a name="l00923"></a>00923   <span class="keyword">struct </span><a class="code" href="structisis__link__state__hdr.html">isis_link_state_hdr</a> *hdr;
<a name="l00924"></a>00924   <span class="keyword">struct </span><a class="code" href="structisis__adjacency.html">isis_adjacency</a> *adj = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00925"></a>00925   <span class="keyword">struct </span><a class="code" href="structisis__lsp.html">isis_lsp</a> *lsp, *lsp0 = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00926"></a>00926   <span class="keywordtype">int</span> retval = <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>, comp = 0;
<a name="l00927"></a>00927   u_char <a class="code" href="isis__misc_8c.html#ac0016d3200b8885e05d151ca16ef4315">lspid</a>[<a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a> + 2];
<a name="l00928"></a>00928   <span class="keyword">struct </span><a class="code" href="structisis__passwd.html">isis_passwd</a> *<a class="code" href="structisis__passwd.html#a4af92e1126df2d7d2abeef451c082567">passwd</a>;
<a name="l00929"></a>00929 
<a name="l00930"></a>00930   <span class="comment">/* Sanity check - FIXME: move to correct place */</span>
<a name="l00931"></a>00931   <span class="keywordflow">if</span> ((<a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>) -
<a name="l00932"></a>00932        <a class="code" href="stream_8c.html#a717f15645000d42a15034f5ec83fc9a5">stream_get_getp</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>)) &lt; <a class="code" href="isis__pdu_8h.html#ac44728d163f3b54838fd7e03acf7c3f7">ISIS_LSP_HDR_LEN</a>)
<a name="l00933"></a>00933     {
<a name="l00934"></a>00934       <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;Packet too short&quot;</span>);
<a name="l00935"></a>00935       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;
<a name="l00936"></a>00936     }
<a name="l00937"></a>00937 
<a name="l00938"></a>00938   <span class="comment">/* Reference the header   */</span>
<a name="l00939"></a>00939   hdr = (<span class="keyword">struct </span><a class="code" href="structisis__link__state__hdr.html">isis_link_state_hdr</a> *) <a class="code" href="stream_8h.html#a4bb95ef1391c2b8b7b97678a5ad87cb7">STREAM_PNT</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>);
<a name="l00940"></a>00940 
<a name="l00941"></a>00941   <span class="keywordflow">if</span> (isis-&gt;<a class="code" href="structisis.html#a6e64127e274c1aa6a52cb0f4b541dfaa">debugs</a> &amp; <a class="code" href="isisd_8h.html#abd8d8358bf794de3d9fba9ef5de689b3">DEBUG_UPDATE_PACKETS</a>)
<a name="l00942"></a>00942     {
<a name="l00943"></a>00943       <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;ISIS-Upd (%s): Rcvd L%d LSP %s, seq 0x%08x, cksum 0x%04x, &quot;</span>
<a name="l00944"></a>00944           <span class="stringliteral">&quot;lifetime %us, len %lu, on %s&quot;</span>,
<a name="l00945"></a>00945           circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>,
<a name="l00946"></a>00946           level,
<a name="l00947"></a>00947           <a class="code" href="isis__misc_8c.html#a3a0e7f92008e3167e2c09b8761d06766">rawlspid_print</a> (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a6e6f2ce4d1b33c3280827272009a5af2">lsp_id</a>),
<a name="l00948"></a>00948           ntohl (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a10657aa355e049b928c9b1cea37bd9d9">seq_num</a>),
<a name="l00949"></a>00949           ntohs (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#afb16ee6cc606527cc2705773cc2b79c4">checksum</a>),
<a name="l00950"></a>00950           ntohs (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a21ef956c03ac1cb9f67cbef6faa12052">rem_lifetime</a>),
<a name="l00951"></a>00951           <span class="comment">/* FIXME: use %z when we stop supporting old compilers. */</span>
<a name="l00952"></a>00952           (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) <a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>), 
<a name="l00953"></a>00953           circuit-&gt;<a class="code" href="structisis__circuit.html#ab03cac6463284a4ce8c1eb19e49f3b6d">interface</a>-&gt;<a class="code" href="structinterface.html#a98cadce768ec5aacb4c5fc4ca2c3eaa8">name</a>);
<a name="l00954"></a>00954     }
<a name="l00955"></a>00955 
<a name="l00956"></a>00956   <a class="code" href="regex_8c.html#ad6d5aaa966ca7424f7cb9bd01f2c838b">assert</a> (ntohs (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a6f17d9f3a17625db25044ff0ff3da330">pdu_len</a>) &gt; <a class="code" href="isis__pdu_8h.html#ac44728d163f3b54838fd7e03acf7c3f7">ISIS_LSP_HDR_LEN</a>);
<a name="l00957"></a>00957 
<a name="l00958"></a>00958   <span class="comment">/* Checksum sanity check - FIXME: move to correct place */</span>
<a name="l00959"></a>00959   <span class="comment">/* 12 = sysid+pdu+remtime */</span>
<a name="l00960"></a>00960   <span class="keywordflow">if</span> (<a class="code" href="iso__checksum_8c.html#abf5d1536c8849c3b76e6fd4aa41785d6">iso_csum_verify</a> (<a class="code" href="stream_8h.html#a4bb95ef1391c2b8b7b97678a5ad87cb7">STREAM_PNT</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>) + 4,
<a name="l00961"></a>00961                ntohs (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a6f17d9f3a17625db25044ff0ff3da330">pdu_len</a>) - 12, &amp;hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#afb16ee6cc606527cc2705773cc2b79c4">checksum</a>))
<a name="l00962"></a>00962     {
<a name="l00963"></a>00963       <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;ISIS-Upd (%s): LSP %s invalid LSP checksum 0x%04x&quot;</span>,
<a name="l00964"></a>00964           circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>,
<a name="l00965"></a>00965           <a class="code" href="isis__misc_8c.html#a3a0e7f92008e3167e2c09b8761d06766">rawlspid_print</a> (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a6e6f2ce4d1b33c3280827272009a5af2">lsp_id</a>), ntohs (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#afb16ee6cc606527cc2705773cc2b79c4">checksum</a>));
<a name="l00966"></a>00966 
<a name="l00967"></a>00967       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;
<a name="l00968"></a>00968     }
<a name="l00969"></a>00969 
<a name="l00970"></a>00970   <span class="comment">/* 7.3.15.1 a) 1 - external domain circuit will discard lsps */</span>
<a name="l00971"></a>00971   <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#aa21c1b770870b6ca7583a164435d1977">ext_domain</a>)
<a name="l00972"></a>00972     {
<a name="l00973"></a>00973       <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a>
<a name="l00974"></a>00974     (<span class="stringliteral">&quot;ISIS-Upd (%s): LSP %s received at level %d over circuit with &quot;</span>
<a name="l00975"></a>00975      <span class="stringliteral">&quot;externalDomain = true&quot;</span>, circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>,
<a name="l00976"></a>00976      <a class="code" href="isis__misc_8c.html#a3a0e7f92008e3167e2c09b8761d06766">rawlspid_print</a> (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a6e6f2ce4d1b33c3280827272009a5af2">lsp_id</a>), level);
<a name="l00977"></a>00977 
<a name="l00978"></a>00978       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;
<a name="l00979"></a>00979     }
<a name="l00980"></a>00980 
<a name="l00981"></a>00981   <span class="comment">/* 7.3.15.1 a) 2,3 - manualL2OnlyMode not implemented */</span>
<a name="l00982"></a>00982   <span class="keywordflow">if</span> (!<a class="code" href="isis__pdu_8c.html#ad3be9b74a266fca7d08e91ad3e4b0d45">accept_level</a> (level, circuit-&gt;<a class="code" href="structisis__circuit.html#ab222d6d0b054faa159d72bcb9768b3fb">circuit_is_type</a>))
<a name="l00983"></a>00983     {
<a name="l00984"></a>00984       <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;ISIS-Upd (%s): LSP %s received at level %d over circuit of&quot;</span>
<a name="l00985"></a>00985           <span class="stringliteral">&quot; type %s&quot;</span>,
<a name="l00986"></a>00986           circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>,
<a name="l00987"></a>00987           <a class="code" href="isis__misc_8c.html#a3a0e7f92008e3167e2c09b8761d06766">rawlspid_print</a> (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a6e6f2ce4d1b33c3280827272009a5af2">lsp_id</a>),
<a name="l00988"></a>00988           level, <a class="code" href="isis__misc_8c.html#a35b15c65a44088982fa8daca9fc7b022">circuit_t2string</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#ab222d6d0b054faa159d72bcb9768b3fb">circuit_is_type</a>));
<a name="l00989"></a>00989 
<a name="l00990"></a>00990       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;
<a name="l00991"></a>00991     }
<a name="l00992"></a>00992 
<a name="l00993"></a>00993   <span class="comment">/* 7.3.15.1 a) 4 - need to make sure IDLength matches */</span>
<a name="l00994"></a>00994 
<a name="l00995"></a>00995   <span class="comment">/* 7.3.15.1 a) 5 - maximum area match, can be ommited since we only use 3 */</span>
<a name="l00996"></a>00996 
<a name="l00997"></a>00997   <span class="comment">/* 7.3.15.1 a) 7 - password check */</span>
<a name="l00998"></a>00998   (level == <a class="code" href="isis__constants_8h.html#a07d8effa4d110dfe9ed04bf051e6ebab">ISIS_LEVEL1</a>) ? (passwd = &amp;circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#afb66934e4bd3bda094550517a94de442">area_passwd</a>) :
<a name="l00999"></a>00999     (passwd = &amp;circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#a60cd44a3a31b36dc808ad3fd9efc97a0">domain_passwd</a>);
<a name="l01000"></a>01000   <span class="keywordflow">if</span> (passwd-&gt;<a class="code" href="structisis__passwd.html#a874984e0745fbcb41df9f463d831be67">type</a>)
<a name="l01001"></a>01001     {
<a name="l01002"></a>01002       <span class="keywordflow">if</span> (<a class="code" href="isis__lsp_8c.html#ae815308b33a56b78b9a65809bc344ac4">isis_lsp_authinfo_check</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>, circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>,
<a name="l01003"></a>01003                    ntohs (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a6f17d9f3a17625db25044ff0ff3da330">pdu_len</a>), passwd))
<a name="l01004"></a>01004     {
<a name="l01005"></a>01005       <a class="code" href="isis__events_8c.html#a16a754e810bb7ba8e3b2a23c89d6d130">isis_event_auth_failure</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>,
<a name="l01006"></a>01006                    <span class="stringliteral">&quot;LSP authentication failure&quot;</span>, hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a6e6f2ce4d1b33c3280827272009a5af2">lsp_id</a>);
<a name="l01007"></a>01007       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;
<a name="l01008"></a>01008     }
<a name="l01009"></a>01009     }
<a name="l01010"></a>01010   <span class="comment">/* Find the LSP in our database and compare it to this Link State header */</span>
<a name="l01011"></a>01011   lsp = <a class="code" href="isis__lsp_8c.html#a3859237ab43b147f4520d060439ca002">lsp_search</a> (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a6e6f2ce4d1b33c3280827272009a5af2">lsp_id</a>, circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#a2e85d570b957a6f8fc47dc4db6fa8f4e">lspdb</a>[level - 1]);
<a name="l01012"></a>01012   <span class="keywordflow">if</span> (lsp)
<a name="l01013"></a>01013     comp = <a class="code" href="isis__lsp_8c.html#a299d8a18662f432a07979c177e2723f0">lsp_compare</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>, lsp, hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a10657aa355e049b928c9b1cea37bd9d9">seq_num</a>,
<a name="l01014"></a>01014             hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#afb16ee6cc606527cc2705773cc2b79c4">checksum</a>, hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a21ef956c03ac1cb9f67cbef6faa12052">rem_lifetime</a>);
<a name="l01015"></a>01015   <span class="keywordflow">if</span> (lsp &amp;&amp; (lsp-&gt;<a class="code" href="structisis__lsp.html#a92fb19d67740e3bfde012e19af97b7d3">own_lsp</a>
<a name="l01016"></a>01016 #ifdef TOPOLOGY_GENERATE
<a name="l01017"></a>01017           || lsp-&gt;from_topology
<a name="l01018"></a>01018 #endif <span class="comment">/* TOPOLOGY_GENERATE */</span>
<a name="l01019"></a>01019       ))
<a name="l01020"></a>01020     <span class="keywordflow">goto</span> dontcheckadj;
<a name="l01021"></a>01021 
<a name="l01022"></a>01022   <span class="comment">/* 7.3.15.1 a) 6 - Must check that we have an adjacency of the same level  */</span>
<a name="l01023"></a>01023   <span class="comment">/* for broadcast circuits, snpa should be compared */</span>
<a name="l01024"></a>01024   <span class="comment">/* FIXME : Point To Point */</span>
<a name="l01025"></a>01025 
<a name="l01026"></a>01026   <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a569e39bbf7fafd533eae2eeafa671b8c">circ_type</a> == <a class="code" href="isis__circuit_8h.html#a01a94c5f24c88efb64f791a749ae8f95">CIRCUIT_T_BROADCAST</a>)
<a name="l01027"></a>01027     {
<a name="l01028"></a>01028       adj = <a class="code" href="isis__adjacency_8c.html#ae2500faa623c2fe78fef559c347dc2c7">isis_adj_lookup_snpa</a> (ssnpa, circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#ada9bf2584373a37aed06b2e4c9e796f9">adjdb</a>[level - 1]);
<a name="l01029"></a>01029       <span class="keywordflow">if</span> (!adj)
<a name="l01030"></a>01030     {
<a name="l01031"></a>01031       <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;(%s): DS ======= LSP %s, seq 0x%08x, cksum 0x%04x, &quot;</span>
<a name="l01032"></a>01032               <span class="stringliteral">&quot;lifetime %us on %s&quot;</span>,
<a name="l01033"></a>01033               circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>,
<a name="l01034"></a>01034               <a class="code" href="isis__misc_8c.html#a3a0e7f92008e3167e2c09b8761d06766">rawlspid_print</a> (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a6e6f2ce4d1b33c3280827272009a5af2">lsp_id</a>),
<a name="l01035"></a>01035               ntohl (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a10657aa355e049b928c9b1cea37bd9d9">seq_num</a>),
<a name="l01036"></a>01036               ntohs (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#afb16ee6cc606527cc2705773cc2b79c4">checksum</a>),
<a name="l01037"></a>01037               ntohs (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a21ef956c03ac1cb9f67cbef6faa12052">rem_lifetime</a>), circuit-&gt;<a class="code" href="structisis__circuit.html#ab03cac6463284a4ce8c1eb19e49f3b6d">interface</a>-&gt;<a class="code" href="structinterface.html#a98cadce768ec5aacb4c5fc4ca2c3eaa8">name</a>);
<a name="l01038"></a>01038       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;  <span class="comment">/* Silently discard */</span>
<a name="l01039"></a>01039     }
<a name="l01040"></a>01040     }
<a name="l01041"></a>01041 
<a name="l01042"></a>01042   <span class="comment">/* for non broadcast, we just need to find same level adj */</span>
<a name="l01043"></a>01043   <span class="keywordflow">else</span>
<a name="l01044"></a>01044     {
<a name="l01045"></a>01045       <span class="comment">/* If no adj, or no sharing of level */</span>
<a name="l01046"></a>01046       <span class="keywordflow">if</span> (!circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a15852a59ea8be80680abac2070659440">p2p</a>.<a class="code" href="structisis__p2p__info.html#a17d32289e6648b9855b93482cd7c45a5">neighbor</a>)
<a name="l01047"></a>01047     {
<a name="l01048"></a>01048       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;   <span class="comment">/* Silently discard */</span>
<a name="l01049"></a>01049     }
<a name="l01050"></a>01050       <span class="keywordflow">else</span>
<a name="l01051"></a>01051     {
<a name="l01052"></a>01052       <span class="keywordflow">if</span> (((level == 1) &amp;&amp;
<a name="l01053"></a>01053            (circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a15852a59ea8be80680abac2070659440">p2p</a>.<a class="code" href="structisis__p2p__info.html#a17d32289e6648b9855b93482cd7c45a5">neighbor</a>-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> == <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434a299a3b0ab58836ff30296ebbd291ac59">ISIS_ADJ_LEVEL2</a>)) ||
<a name="l01054"></a>01054           ((level == 2) &amp;&amp;
<a name="l01055"></a>01055            (circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a15852a59ea8be80680abac2070659440">p2p</a>.<a class="code" href="structisis__p2p__info.html#a17d32289e6648b9855b93482cd7c45a5">neighbor</a>-&gt;<a class="code" href="structisis__adjacency.html#a3cb53910a1050483efa04d144bd57ffc">adj_usage</a> == <a class="code" href="isis__adjacency_8h.html#abbe0dae7a957cc6c9f9ae6a33739b434ac5e73d4da9efe1a383f26fd0c958c53c">ISIS_ADJ_LEVEL1</a>)))
<a name="l01056"></a>01056         <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;    <span class="comment">/* Silently discard */</span>
<a name="l01057"></a>01057     }
<a name="l01058"></a>01058     }
<a name="l01059"></a>01059 dontcheckadj:
<a name="l01060"></a>01060   <span class="comment">/* 7.3.15.1 a) 7 - Passwords for level 1 - not implemented  */</span>
<a name="l01061"></a>01061 
<a name="l01062"></a>01062   <span class="comment">/* 7.3.15.1 a) 8 - Passwords for level 2 - not implemented  */</span>
<a name="l01063"></a>01063 
<a name="l01064"></a>01064   <span class="comment">/* 7.3.15.1 a) 9 - OriginatingLSPBufferSize - not implemented  FIXME: do it */</span>
<a name="l01065"></a>01065 
<a name="l01066"></a>01066   <span class="comment">/* 7.3.15.1 b) - If the remaining life time is 0, we perform 7.3.16.4 */</span>
<a name="l01067"></a>01067   <span class="keywordflow">if</span> (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a21ef956c03ac1cb9f67cbef6faa12052">rem_lifetime</a> == 0)
<a name="l01068"></a>01068     {
<a name="l01069"></a>01069       <span class="keywordflow">if</span> (!lsp)
<a name="l01070"></a>01070     {
<a name="l01071"></a>01071       <span class="comment">/* 7.3.16.4 a) 1) No LSP in db -&gt; send an ack, but don&#39;t save */</span>
<a name="l01072"></a>01072       <span class="comment">/* only needed on explicit update, eg - p2p */</span>
<a name="l01073"></a>01073       <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a569e39bbf7fafd533eae2eeafa671b8c">circ_type</a> == <a class="code" href="isis__circuit_8h.html#aa2113a49e7c75a5d4997d59df0530726">CIRCUIT_T_P2P</a>)
<a name="l01074"></a>01074         <a class="code" href="isis__pdu_8c.html#a92677d57850d42c168f35387f9bcaeb8">ack_lsp</a> (hdr, circuit, level);
<a name="l01075"></a>01075       <span class="keywordflow">return</span> retval;    <span class="comment">/* FIXME: do we need a purge? */</span>
<a name="l01076"></a>01076     }
<a name="l01077"></a>01077       <span class="keywordflow">else</span>
<a name="l01078"></a>01078     {
<a name="l01079"></a>01079       <span class="keywordflow">if</span> (<a class="code" href="regex_8c.html#a98d0dff0c7366f08562d8e8583df9bb9">memcmp</a> (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a6e6f2ce4d1b33c3280827272009a5af2">lsp_id</a>, isis-&gt;<a class="code" href="structisis.html#a769d4d051a0f424e8c0568b4eeef748e">sysid</a>, <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a>))
<a name="l01080"></a>01080         {
<a name="l01081"></a>01081           <span class="comment">/* LSP by some other system -&gt; do 7.3.16.4 b) */</span>
<a name="l01082"></a>01082           <span class="comment">/* 7.3.16.4 b) 1)  */</span>
<a name="l01083"></a>01083           <span class="keywordflow">if</span> (comp == <a class="code" href="isis__lsp_8h.html#a2b334f17cd54fd535379deac75b7e8f0">LSP_NEWER</a>)
<a name="l01084"></a>01084         {
<a name="l01085"></a>01085           <a class="code" href="isis__lsp_8c.html#ad5c26e2f2f08b4a76183ca91ff454ff9">lsp_update</a> (lsp, hdr, circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>, circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>,
<a name="l01086"></a>01086                   level);
<a name="l01087"></a>01087           <span class="comment">/* ii */</span>
<a name="l01088"></a>01088           <a class="code" href="isis__flags_8h.html#a57f45d9b4a8c70c53f796d96e5555fac">ISIS_FLAGS_SET_ALL</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a96d155dbf3bbd20256cf7a68c8d9fd20">SRMflags</a>);
<a name="l01089"></a>01089           <span class="comment">/* iii */</span>
<a name="l01090"></a>01090           <a class="code" href="isis__flags_8h.html#ac67a62e2e71ff606be09d8e74865aac8">ISIS_CLEAR_FLAG</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a96d155dbf3bbd20256cf7a68c8d9fd20">SRMflags</a>, circuit);
<a name="l01091"></a>01091           <span class="comment">/* v */</span>
<a name="l01092"></a>01092           <a class="code" href="isis__flags_8h.html#a4de3e70a95a71772672a6188573dba45">ISIS_FLAGS_CLEAR_ALL</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a03d0dd350cd760986f4907c5df08363a">SSNflags</a>); <span class="comment">/* FIXME: OTHER than c */</span>
<a name="l01093"></a>01093           <span class="comment">/* iv */</span>
<a name="l01094"></a>01094           <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a569e39bbf7fafd533eae2eeafa671b8c">circ_type</a> != <a class="code" href="isis__circuit_8h.html#a01a94c5f24c88efb64f791a749ae8f95">CIRCUIT_T_BROADCAST</a>)
<a name="l01095"></a>01095             <a class="code" href="isis__flags_8h.html#a1f7b5b2baa94ebc0450ccb5839a682e7">ISIS_SET_FLAG</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a03d0dd350cd760986f4907c5df08363a">SSNflags</a>, circuit);
<a name="l01096"></a>01096 
<a name="l01097"></a>01097         }       <span class="comment">/* 7.3.16.4 b) 2) */</span>
<a name="l01098"></a>01098           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (comp == <a class="code" href="isis__lsp_8h.html#a99cb1e872b18fd541d954846ec30aa7f">LSP_EQUAL</a>)
<a name="l01099"></a>01099         {
<a name="l01100"></a>01100           <span class="comment">/* i */</span>
<a name="l01101"></a>01101           <a class="code" href="isis__flags_8h.html#ac67a62e2e71ff606be09d8e74865aac8">ISIS_CLEAR_FLAG</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a96d155dbf3bbd20256cf7a68c8d9fd20">SRMflags</a>, circuit);
<a name="l01102"></a>01102           <span class="comment">/* ii */</span>
<a name="l01103"></a>01103           <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a569e39bbf7fafd533eae2eeafa671b8c">circ_type</a> != <a class="code" href="isis__circuit_8h.html#a01a94c5f24c88efb64f791a749ae8f95">CIRCUIT_T_BROADCAST</a>)
<a name="l01104"></a>01104             <a class="code" href="isis__flags_8h.html#a1f7b5b2baa94ebc0450ccb5839a682e7">ISIS_SET_FLAG</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a03d0dd350cd760986f4907c5df08363a">SSNflags</a>, circuit);
<a name="l01105"></a>01105         }       <span class="comment">/* 7.3.16.4 b) 3) */</span>
<a name="l01106"></a>01106           <span class="keywordflow">else</span>
<a name="l01107"></a>01107         {
<a name="l01108"></a>01108           <a class="code" href="isis__flags_8h.html#a1f7b5b2baa94ebc0450ccb5839a682e7">ISIS_SET_FLAG</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a96d155dbf3bbd20256cf7a68c8d9fd20">SRMflags</a>, circuit);
<a name="l01109"></a>01109           <a class="code" href="isis__flags_8h.html#ac67a62e2e71ff606be09d8e74865aac8">ISIS_CLEAR_FLAG</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a03d0dd350cd760986f4907c5df08363a">SSNflags</a>, circuit);
<a name="l01110"></a>01110         }
<a name="l01111"></a>01111         }
<a name="l01112"></a>01112       <span class="keywordflow">else</span>
<a name="l01113"></a>01113         {
<a name="l01114"></a>01114           <span class="comment">/* our own LSP -&gt; 7.3.16.4 c) */</span>
<a name="l01115"></a>01115           <span class="keywordflow">if</span> (<a class="code" href="isis__lsp_8h.html#a15ad7ce72dee875930a28bec035f7b71">LSP_PSEUDO_ID</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a3e4328d15b43f9023fee75d60f08aca0">lsp_header</a>-&gt;<a class="code" href="structisis__link__state__hdr.html#a6e6f2ce4d1b33c3280827272009a5af2">lsp_id</a>) !=
<a name="l01116"></a>01116           circuit-&gt;<a class="code" href="structisis__circuit.html#a10453f6bcc1e8f1cb466240a81836ba9">circuit_id</a>
<a name="l01117"></a>01117           || (<a class="code" href="isis__lsp_8h.html#a15ad7ce72dee875930a28bec035f7b71">LSP_PSEUDO_ID</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a3e4328d15b43f9023fee75d60f08aca0">lsp_header</a>-&gt;<a class="code" href="structisis__link__state__hdr.html#a6e6f2ce4d1b33c3280827272009a5af2">lsp_id</a>) ==
<a name="l01118"></a>01118               circuit-&gt;<a class="code" href="structisis__circuit.html#a10453f6bcc1e8f1cb466240a81836ba9">circuit_id</a>
<a name="l01119"></a>01119               &amp;&amp; circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#adb24376d01beb41cab0ed0c49c3a214c">is_dr</a>[level - 1] == 1))
<a name="l01120"></a>01120         {
<a name="l01121"></a>01121           lsp-&gt;<a class="code" href="structisis__lsp.html#a3e4328d15b43f9023fee75d60f08aca0">lsp_header</a>-&gt;<a class="code" href="structisis__link__state__hdr.html#a10657aa355e049b928c9b1cea37bd9d9">seq_num</a> = htonl (ntohl (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a10657aa355e049b928c9b1cea37bd9d9">seq_num</a>) + 1);
<a name="l01122"></a>01122           <span class="keywordflow">if</span> (isis-&gt;<a class="code" href="structisis.html#a6e64127e274c1aa6a52cb0f4b541dfaa">debugs</a> &amp; <a class="code" href="isisd_8h.html#abd8d8358bf794de3d9fba9ef5de689b3">DEBUG_UPDATE_PACKETS</a>)
<a name="l01123"></a>01123             <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;LSP LEN: %d&quot;</span>,
<a name="l01124"></a>01124                 ntohs (lsp-&gt;<a class="code" href="structisis__lsp.html#a3e4328d15b43f9023fee75d60f08aca0">lsp_header</a>-&gt;<a class="code" href="structisis__link__state__hdr.html#a6f17d9f3a17625db25044ff0ff3da330">pdu_len</a>));
<a name="l01125"></a>01125           <a class="code" href="checksum_8c.html#a097fa5404eb654e8e112bb954bf4ef15">fletcher_checksum</a> (<a class="code" href="stream_8h.html#afde5f5db208a43da6faf7b830f26d7fc">STREAM_DATA</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a944fd7d5abffb3968b729b4fc1a9e631">pdu</a>) + 12,
<a name="l01126"></a>01126                    ntohs (lsp-&gt;<a class="code" href="structisis__lsp.html#a3e4328d15b43f9023fee75d60f08aca0">lsp_header</a>-&gt;<a class="code" href="structisis__link__state__hdr.html#a6f17d9f3a17625db25044ff0ff3da330">pdu_len</a>) - 12, 12);
<a name="l01127"></a>01127           <a class="code" href="isis__flags_8h.html#a57f45d9b4a8c70c53f796d96e5555fac">ISIS_FLAGS_SET_ALL</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a96d155dbf3bbd20256cf7a68c8d9fd20">SRMflags</a>);
<a name="l01128"></a>01128           <span class="keywordflow">if</span> (isis-&gt;<a class="code" href="structisis.html#a6e64127e274c1aa6a52cb0f4b541dfaa">debugs</a> &amp; <a class="code" href="isisd_8h.html#abd8d8358bf794de3d9fba9ef5de689b3">DEBUG_UPDATE_PACKETS</a>)
<a name="l01129"></a>01129             <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;ISIS-Upd (%s): (1) re-originating LSP %s new &quot;</span>
<a name="l01130"></a>01130                 <span class="stringliteral">&quot;seq 0x%08x&quot;</span>, circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>,
<a name="l01131"></a>01131                 <a class="code" href="isis__misc_8c.html#a3a0e7f92008e3167e2c09b8761d06766">rawlspid_print</a> (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a6e6f2ce4d1b33c3280827272009a5af2">lsp_id</a>),
<a name="l01132"></a>01132                 ntohl (lsp-&gt;<a class="code" href="structisis__lsp.html#a3e4328d15b43f9023fee75d60f08aca0">lsp_header</a>-&gt;<a class="code" href="structisis__link__state__hdr.html#a10657aa355e049b928c9b1cea37bd9d9">seq_num</a>));
<a name="l01133"></a>01133           lsp-&gt;<a class="code" href="structisis__lsp.html#a3e4328d15b43f9023fee75d60f08aca0">lsp_header</a>-&gt;<a class="code" href="structisis__link__state__hdr.html#a21ef956c03ac1cb9f67cbef6faa12052">rem_lifetime</a> =
<a name="l01134"></a>01134             htons (<a class="code" href="isis__misc_8c.html#a177a75676b1916fefb4eb7275911fb6e">isis_jitter</a>
<a name="l01135"></a>01135                (circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#af0e5e6cfa7b7536e0700dd3645025d9b">max_lsp_lifetime</a>[level - 1],
<a name="l01136"></a>01136                 <a class="code" href="isis__constants_8h.html#adfaaf0b4e69adf9ae9c8dc47e3e00918">MAX_AGE_JITTER</a>));
<a name="l01137"></a>01137         }
<a name="l01138"></a>01138           <span class="keywordflow">else</span>
<a name="l01139"></a>01139         {
<a name="l01140"></a>01140           <span class="comment">/* Got purge for own pseudo-lsp, and we are not DR  */</span>
<a name="l01141"></a>01141           <a class="code" href="isis__lsp_8c.html#a326bd66d63f17cf92421e5df0d29fe32">lsp_purge_dr</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a3e4328d15b43f9023fee75d60f08aca0">lsp_header</a>-&gt;<a class="code" href="structisis__link__state__hdr.html#a6e6f2ce4d1b33c3280827272009a5af2">lsp_id</a>, circuit, level);
<a name="l01142"></a>01142         }
<a name="l01143"></a>01143         }
<a name="l01144"></a>01144     }
<a name="l01145"></a>01145       <span class="keywordflow">return</span> retval;
<a name="l01146"></a>01146     }
<a name="l01147"></a>01147   <span class="comment">/* 7.3.15.1 c) - If this is our own lsp and we don&#39;t have it initiate a </span>
<a name="l01148"></a>01148 <span class="comment">   * purge */</span>
<a name="l01149"></a>01149   <span class="keywordflow">if</span> (<a class="code" href="regex_8c.html#a98d0dff0c7366f08562d8e8583df9bb9">memcmp</a> (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a6e6f2ce4d1b33c3280827272009a5af2">lsp_id</a>, isis-&gt;<a class="code" href="structisis.html#a769d4d051a0f424e8c0568b4eeef748e">sysid</a>, <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a>) == 0)
<a name="l01150"></a>01150     {
<a name="l01151"></a>01151       <span class="keywordflow">if</span> (!lsp)
<a name="l01152"></a>01152     {
<a name="l01153"></a>01153       <span class="comment">/* 7.3.16.4: initiate a purge */</span>
<a name="l01154"></a>01154       <a class="code" href="isis__lsp_8c.html#a3b934844c90f614a6f5f4a2734a23e77">lsp_purge_non_exist</a> (hdr, circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>);
<a name="l01155"></a>01155       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;
<a name="l01156"></a>01156     }
<a name="l01157"></a>01157       <span class="comment">/* 7.3.15.1 d) - If this is our own lsp and we have it */</span>
<a name="l01158"></a>01158 
<a name="l01159"></a>01159       <span class="comment">/* In 7.3.16.1, If an Intermediate system R somewhere in the domain</span>
<a name="l01160"></a>01160 <span class="comment">       * has information that the current sequence number for source S is</span>
<a name="l01161"></a>01161 <span class="comment">       * &quot;greater&quot; than that held by S, ... */</span>
<a name="l01162"></a>01162 
<a name="l01163"></a>01163       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ntohl (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a10657aa355e049b928c9b1cea37bd9d9">seq_num</a>) &gt; ntohl (lsp-&gt;<a class="code" href="structisis__lsp.html#a3e4328d15b43f9023fee75d60f08aca0">lsp_header</a>-&gt;<a class="code" href="structisis__link__state__hdr.html#a10657aa355e049b928c9b1cea37bd9d9">seq_num</a>))
<a name="l01164"></a>01164     {
<a name="l01165"></a>01165       <span class="comment">/* 7.3.16.1  */</span>
<a name="l01166"></a>01166       lsp-&gt;<a class="code" href="structisis__lsp.html#a3e4328d15b43f9023fee75d60f08aca0">lsp_header</a>-&gt;<a class="code" href="structisis__link__state__hdr.html#a10657aa355e049b928c9b1cea37bd9d9">seq_num</a> = htonl (ntohl (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a10657aa355e049b928c9b1cea37bd9d9">seq_num</a>) + 1);
<a name="l01167"></a>01167 
<a name="l01168"></a>01168       <a class="code" href="checksum_8c.html#a097fa5404eb654e8e112bb954bf4ef15">fletcher_checksum</a> (<a class="code" href="stream_8h.html#afde5f5db208a43da6faf7b830f26d7fc">STREAM_DATA</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a944fd7d5abffb3968b729b4fc1a9e631">pdu</a>) + 12,
<a name="l01169"></a>01169                ntohs (lsp-&gt;<a class="code" href="structisis__lsp.html#a3e4328d15b43f9023fee75d60f08aca0">lsp_header</a>-&gt;<a class="code" href="structisis__link__state__hdr.html#a6f17d9f3a17625db25044ff0ff3da330">pdu_len</a>) - 12, 12);
<a name="l01170"></a>01170 
<a name="l01171"></a>01171       <a class="code" href="isis__flags_8h.html#a57f45d9b4a8c70c53f796d96e5555fac">ISIS_FLAGS_SET_ALL</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a96d155dbf3bbd20256cf7a68c8d9fd20">SRMflags</a>);
<a name="l01172"></a>01172       <span class="keywordflow">if</span> (isis-&gt;<a class="code" href="structisis.html#a6e64127e274c1aa6a52cb0f4b541dfaa">debugs</a> &amp; <a class="code" href="isisd_8h.html#abd8d8358bf794de3d9fba9ef5de689b3">DEBUG_UPDATE_PACKETS</a>)
<a name="l01173"></a>01173         <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;ISIS-Upd (%s): (2) re-originating LSP %s new seq &quot;</span>
<a name="l01174"></a>01174             <span class="stringliteral">&quot;0x%08x&quot;</span>, circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>,
<a name="l01175"></a>01175             <a class="code" href="isis__misc_8c.html#a3a0e7f92008e3167e2c09b8761d06766">rawlspid_print</a> (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a6e6f2ce4d1b33c3280827272009a5af2">lsp_id</a>),
<a name="l01176"></a>01176             ntohl (lsp-&gt;<a class="code" href="structisis__lsp.html#a3e4328d15b43f9023fee75d60f08aca0">lsp_header</a>-&gt;<a class="code" href="structisis__link__state__hdr.html#a10657aa355e049b928c9b1cea37bd9d9">seq_num</a>));
<a name="l01177"></a>01177       lsp-&gt;<a class="code" href="structisis__lsp.html#a3e4328d15b43f9023fee75d60f08aca0">lsp_header</a>-&gt;<a class="code" href="structisis__link__state__hdr.html#a21ef956c03ac1cb9f67cbef6faa12052">rem_lifetime</a> =
<a name="l01178"></a>01178         htons (<a class="code" href="isis__misc_8c.html#a177a75676b1916fefb4eb7275911fb6e">isis_jitter</a>
<a name="l01179"></a>01179            (circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#af0e5e6cfa7b7536e0700dd3645025d9b">max_lsp_lifetime</a>[level - 1],
<a name="l01180"></a>01180             <a class="code" href="isis__constants_8h.html#adfaaf0b4e69adf9ae9c8dc47e3e00918">MAX_AGE_JITTER</a>));
<a name="l01181"></a>01181     }
<a name="l01182"></a>01182     }
<a name="l01183"></a>01183   <span class="keywordflow">else</span>
<a name="l01184"></a>01184     {
<a name="l01185"></a>01185       <span class="comment">/* 7.3.15.1 e) - This lsp originated on another system */</span>
<a name="l01186"></a>01186 
<a name="l01187"></a>01187       <span class="comment">/* 7.3.15.1 e) 1) LSP newer than the one in db or no LSP in db */</span>
<a name="l01188"></a>01188       <span class="keywordflow">if</span> ((!lsp || comp == <a class="code" href="isis__lsp_8h.html#a2b334f17cd54fd535379deac75b7e8f0">LSP_NEWER</a>))
<a name="l01189"></a>01189     {
<a name="l01190"></a>01190       <span class="comment">/* i */</span>
<a name="l01191"></a>01191       <span class="keywordflow">if</span> (lsp)
<a name="l01192"></a>01192         {
<a name="l01193"></a>01193 <span class="preprocessor">#ifdef EXTREME_DEBUG</span>
<a name="l01194"></a>01194 <span class="preprocessor"></span>          <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;level %d number is - %ld&quot;</span>, level,
<a name="l01195"></a>01195               circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#a2e85d570b957a6f8fc47dc4db6fa8f4e">lspdb</a>[level - 1]-&gt;<a class="code" href="structdict__t.html#a488591945754dac1b010461dfc4ff75b">dict_nodecount</a>);
<a name="l01196"></a>01196 <span class="preprocessor">#endif </span><span class="comment">/* EXTREME DEBUG */</span>
<a name="l01197"></a>01197           <a class="code" href="isis__lsp_8c.html#ac9198965904e0c9a57ade0011b114d3f">lsp_search_and_destroy</a> (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a6e6f2ce4d1b33c3280827272009a5af2">lsp_id</a>,
<a name="l01198"></a>01198                       circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#a2e85d570b957a6f8fc47dc4db6fa8f4e">lspdb</a>[level - 1]);
<a name="l01199"></a>01199           <span class="comment">/* exists, so we overwrite */</span>
<a name="l01200"></a>01200 <span class="preprocessor">#ifdef EXTREME_DEBUG</span>
<a name="l01201"></a>01201 <span class="preprocessor"></span>          <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;level %d number is - %ld&quot;</span>, level,
<a name="l01202"></a>01202               circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#a2e85d570b957a6f8fc47dc4db6fa8f4e">lspdb</a>[level - 1]-&gt;<a class="code" href="structdict__t.html#a488591945754dac1b010461dfc4ff75b">dict_nodecount</a>);
<a name="l01203"></a>01203 <span class="preprocessor">#endif </span><span class="comment">/* EXTREME DEBUG */</span>
<a name="l01204"></a>01204         }
<a name="l01205"></a>01205       <span class="comment">/*</span>
<a name="l01206"></a>01206 <span class="comment">       * If this lsp is a frag, need to see if we have zero lsp present</span>
<a name="l01207"></a>01207 <span class="comment">       */</span>
<a name="l01208"></a>01208       <span class="keywordflow">if</span> (<a class="code" href="isis__lsp_8h.html#a3d17e3f51a6b45aa8a777ec4b9ec3100">LSP_FRAGMENT</a> (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a6e6f2ce4d1b33c3280827272009a5af2">lsp_id</a>) != 0)
<a name="l01209"></a>01209         {
<a name="l01210"></a>01210           <a class="code" href="regex_8c.html#aed653b4838032a2c5ce8960421c8cfd7">memcpy</a> (lspid, hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a6e6f2ce4d1b33c3280827272009a5af2">lsp_id</a>, <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a> + 1);
<a name="l01211"></a>01211           <a class="code" href="isis__lsp_8h.html#a3d17e3f51a6b45aa8a777ec4b9ec3100">LSP_FRAGMENT</a> (lspid) = 0;
<a name="l01212"></a>01212           lsp0 = <a class="code" href="isis__lsp_8c.html#a3859237ab43b147f4520d060439ca002">lsp_search</a> (lspid, circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#a2e85d570b957a6f8fc47dc4db6fa8f4e">lspdb</a>[level - 1]);
<a name="l01213"></a>01213           <span class="keywordflow">if</span> (!lsp0)
<a name="l01214"></a>01214         {
<a name="l01215"></a>01215           <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;Got lsp frag, while zero lsp not database&quot;</span>);
<a name="l01216"></a>01216           <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;
<a name="l01217"></a>01217         }
<a name="l01218"></a>01218         }
<a name="l01219"></a>01219       lsp =
<a name="l01220"></a>01220         <a class="code" href="isis__lsp_8c.html#af11fc334a37a7a089a4c5e2d44496110">lsp_new_from_stream_ptr</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>,
<a name="l01221"></a>01221                      ntohs (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a6f17d9f3a17625db25044ff0ff3da330">pdu_len</a>), lsp0,
<a name="l01222"></a>01222                      circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>);
<a name="l01223"></a>01223       lsp-&gt;<a class="code" href="structisis__lsp.html#ab719e4479e4fc861c4cfa7a3c9d403c6">level</a> = level;
<a name="l01224"></a>01224       lsp-&gt;<a class="code" href="structisis__lsp.html#a4481c48a70a19d351802ee561729fce3">adj</a> = adj;
<a name="l01225"></a>01225       <a class="code" href="isis__lsp_8c.html#a09d8f3bcc073c87f01c32b2f0994fb04">lsp_insert</a> (lsp, circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#a2e85d570b957a6f8fc47dc4db6fa8f4e">lspdb</a>[level - 1]);
<a name="l01226"></a>01226       <span class="comment">/* ii */</span>
<a name="l01227"></a>01227       <a class="code" href="isis__flags_8h.html#a57f45d9b4a8c70c53f796d96e5555fac">ISIS_FLAGS_SET_ALL</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a96d155dbf3bbd20256cf7a68c8d9fd20">SRMflags</a>);
<a name="l01228"></a>01228       <span class="comment">/* iii */</span>
<a name="l01229"></a>01229       <a class="code" href="isis__flags_8h.html#ac67a62e2e71ff606be09d8e74865aac8">ISIS_CLEAR_FLAG</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a96d155dbf3bbd20256cf7a68c8d9fd20">SRMflags</a>, circuit);
<a name="l01230"></a>01230 
<a name="l01231"></a>01231       <span class="comment">/* iv */</span>
<a name="l01232"></a>01232       <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a569e39bbf7fafd533eae2eeafa671b8c">circ_type</a> != <a class="code" href="isis__circuit_8h.html#a01a94c5f24c88efb64f791a749ae8f95">CIRCUIT_T_BROADCAST</a>)
<a name="l01233"></a>01233         <a class="code" href="isis__flags_8h.html#a1f7b5b2baa94ebc0450ccb5839a682e7">ISIS_SET_FLAG</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a03d0dd350cd760986f4907c5df08363a">SSNflags</a>, circuit);
<a name="l01234"></a>01234       <span class="comment">/* FIXME: v) */</span>
<a name="l01235"></a>01235     }
<a name="l01236"></a>01236       <span class="comment">/* 7.3.15.1 e) 2) LSP equal to the one in db */</span>
<a name="l01237"></a>01237       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (comp == <a class="code" href="isis__lsp_8h.html#a99cb1e872b18fd541d954846ec30aa7f">LSP_EQUAL</a>)
<a name="l01238"></a>01238     {
<a name="l01239"></a>01239       <a class="code" href="isis__flags_8h.html#ac67a62e2e71ff606be09d8e74865aac8">ISIS_CLEAR_FLAG</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a96d155dbf3bbd20256cf7a68c8d9fd20">SRMflags</a>, circuit);
<a name="l01240"></a>01240       <a class="code" href="isis__lsp_8c.html#ad5c26e2f2f08b4a76183ca91ff454ff9">lsp_update</a> (lsp, hdr, circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>, circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>, level);
<a name="l01241"></a>01241       <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a569e39bbf7fafd533eae2eeafa671b8c">circ_type</a> != <a class="code" href="isis__circuit_8h.html#a01a94c5f24c88efb64f791a749ae8f95">CIRCUIT_T_BROADCAST</a>)
<a name="l01242"></a>01242         {
<a name="l01243"></a>01243           <a class="code" href="isis__flags_8h.html#a1f7b5b2baa94ebc0450ccb5839a682e7">ISIS_SET_FLAG</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a03d0dd350cd760986f4907c5df08363a">SSNflags</a>, circuit);
<a name="l01244"></a>01244         }
<a name="l01245"></a>01245     }
<a name="l01246"></a>01246       <span class="comment">/* 7.3.15.1 e) 3) LSP older than the one in db */</span>
<a name="l01247"></a>01247       <span class="keywordflow">else</span>
<a name="l01248"></a>01248     {
<a name="l01249"></a>01249       <a class="code" href="isis__flags_8h.html#a1f7b5b2baa94ebc0450ccb5839a682e7">ISIS_SET_FLAG</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a96d155dbf3bbd20256cf7a68c8d9fd20">SRMflags</a>, circuit);
<a name="l01250"></a>01250       <a class="code" href="isis__flags_8h.html#ac67a62e2e71ff606be09d8e74865aac8">ISIS_CLEAR_FLAG</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a03d0dd350cd760986f4907c5df08363a">SSNflags</a>, circuit);
<a name="l01251"></a>01251     }
<a name="l01252"></a>01252     }
<a name="l01253"></a>01253   <span class="keywordflow">if</span> (lsp)
<a name="l01254"></a>01254     lsp-&gt;<a class="code" href="structisis__lsp.html#a4481c48a70a19d351802ee561729fce3">adj</a> = adj;
<a name="l01255"></a>01255   <span class="keywordflow">return</span> retval;
<a name="l01256"></a>01256 }
<a name="l01257"></a>01257 
<a name="l01258"></a>01258 <span class="comment">/*</span>
<a name="l01259"></a>01259 <span class="comment"> * Process Sequence Numbers</span>
<a name="l01260"></a>01260 <span class="comment"> * ISO - 10589</span>
<a name="l01261"></a>01261 <span class="comment"> * Section 7.3.15.2 - Action on receipt of a sequence numbers PDU</span>
<a name="l01262"></a>01262 <span class="comment"> */</span>
<a name="l01263"></a>01263 
<a name="l01264"></a>01264 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01265"></a><a class="code" href="isis__pdu_8c.html#a4e16ec0d4416a973611faf1d57beac3a">01265</a> <a class="code" href="isis__pdu_8c.html#a4e16ec0d4416a973611faf1d57beac3a">process_snp</a> (<span class="keywordtype">int</span> snp_type, <span class="keywordtype">int</span> level, <span class="keyword">struct</span> <a class="code" href="structisis__circuit.html">isis_circuit</a> *circuit,
<a name="l01266"></a>01266          u_char * ssnpa)
<a name="l01267"></a>01267 {
<a name="l01268"></a>01268   <span class="keywordtype">int</span> retval = <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;
<a name="l01269"></a>01269   <span class="keywordtype">int</span> <a class="code" href="ospf__spf_8c.html#aea544039058f177b3d5698fbaa84cfb0">cmp</a>, own_lsp;
<a name="l01270"></a>01270   <span class="keywordtype">char</span> typechar = <span class="charliteral">&#39; &#39;</span>;
<a name="l01271"></a>01271   <span class="keywordtype">int</span> len;
<a name="l01272"></a>01272   <span class="keyword">struct </span><a class="code" href="structisis__adjacency.html">isis_adjacency</a> *adj;
<a name="l01273"></a>01273   <span class="keyword">struct </span><a class="code" href="structisis__complete__seqnum__hdr.html">isis_complete_seqnum_hdr</a> *chdr = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01274"></a>01274   <span class="keyword">struct </span><a class="code" href="structisis__partial__seqnum__hdr.html">isis_partial_seqnum_hdr</a> *phdr = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01275"></a>01275   uint32_t found = 0, expected = 0;
<a name="l01276"></a>01276   <span class="keyword">struct </span><a class="code" href="structisis__lsp.html">isis_lsp</a> *lsp;
<a name="l01277"></a>01277   <span class="keyword">struct </span><a class="code" href="structlsp__entry.html">lsp_entry</a> *entry;
<a name="l01278"></a>01278   <span class="keyword">struct </span><a class="code" href="structlistnode.html">listnode</a> *node, *nnode;
<a name="l01279"></a>01279   <span class="keyword">struct </span><a class="code" href="structlistnode.html">listnode</a> *node2, *nnode2;
<a name="l01280"></a>01280   <span class="keyword">struct </span>tlvs tlvs;
<a name="l01281"></a>01281   <span class="keyword">struct </span><a class="code" href="structlist.html">list</a> *lsp_list = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01282"></a>01282   <span class="keyword">struct </span><a class="code" href="structisis__passwd.html">isis_passwd</a> *<a class="code" href="structisis__passwd.html#a4af92e1126df2d7d2abeef451c082567">passwd</a>;
<a name="l01283"></a>01283 
<a name="l01284"></a>01284   <span class="keywordflow">if</span> (snp_type == <a class="code" href="isis__pdu_8h.html#ab9d39eb77423805c1c9e40824167b90d">ISIS_SNP_CSNP_FLAG</a>)
<a name="l01285"></a>01285     {
<a name="l01286"></a>01286       <span class="comment">/* getting the header info */</span>
<a name="l01287"></a>01287       typechar = <span class="charliteral">&#39;C&#39;</span>;
<a name="l01288"></a>01288       chdr =
<a name="l01289"></a>01289     (<span class="keyword">struct </span><a class="code" href="structisis__complete__seqnum__hdr.html">isis_complete_seqnum_hdr</a> *) <a class="code" href="stream_8h.html#a4bb95ef1391c2b8b7b97678a5ad87cb7">STREAM_PNT</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>);
<a name="l01290"></a>01290       circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>-&gt;<a class="code" href="structstream.html#adb2dceb1b9e09edf611d9076a7a1a491">getp</a> += <a class="code" href="isis__pdu_8h.html#ad643847e4f6bb080e2e6359abcad1c15">ISIS_CSNP_HDRLEN</a>;
<a name="l01291"></a>01291       len = ntohs (chdr-&gt;<a class="code" href="structisis__complete__seqnum__hdr.html#aac677c5f7229ab1b4a718e5e4dc5705d">pdu_len</a>);
<a name="l01292"></a>01292       <span class="keywordflow">if</span> (len &lt; <a class="code" href="isis__pdu_8h.html#ad643847e4f6bb080e2e6359abcad1c15">ISIS_CSNP_HDRLEN</a>)
<a name="l01293"></a>01293     {
<a name="l01294"></a>01294       <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;Received a CSNP with bogus length!&quot;</span>);
<a name="l01295"></a>01295       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;
<a name="l01296"></a>01296     }
<a name="l01297"></a>01297     }
<a name="l01298"></a>01298   <span class="keywordflow">else</span>
<a name="l01299"></a>01299     {
<a name="l01300"></a>01300       typechar = <span class="charliteral">&#39;P&#39;</span>;
<a name="l01301"></a>01301       phdr =
<a name="l01302"></a>01302     (<span class="keyword">struct </span><a class="code" href="structisis__partial__seqnum__hdr.html">isis_partial_seqnum_hdr</a> *) <a class="code" href="stream_8h.html#a4bb95ef1391c2b8b7b97678a5ad87cb7">STREAM_PNT</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>);
<a name="l01303"></a>01303       circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>-&gt;<a class="code" href="structstream.html#adb2dceb1b9e09edf611d9076a7a1a491">getp</a> += <a class="code" href="isis__pdu_8h.html#aceab21fb8507148277e0980a0cd31a1e">ISIS_PSNP_HDRLEN</a>;
<a name="l01304"></a>01304       len = ntohs (phdr-&gt;<a class="code" href="structisis__partial__seqnum__hdr.html#a410986989ab5574f82baaaa8c26c9efa">pdu_len</a>);
<a name="l01305"></a>01305       <span class="keywordflow">if</span> (len &lt; <a class="code" href="isis__pdu_8h.html#aceab21fb8507148277e0980a0cd31a1e">ISIS_PSNP_HDRLEN</a>)
<a name="l01306"></a>01306     {
<a name="l01307"></a>01307       <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;Received a CSNP with bogus length!&quot;</span>);
<a name="l01308"></a>01308       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;
<a name="l01309"></a>01309     }
<a name="l01310"></a>01310     }
<a name="l01311"></a>01311 
<a name="l01312"></a>01312   <span class="comment">/* 7.3.15.2 a) 1 - external domain circuit will discard snp pdu */</span>
<a name="l01313"></a>01313   <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#aa21c1b770870b6ca7583a164435d1977">ext_domain</a>)
<a name="l01314"></a>01314     {
<a name="l01315"></a>01315 
<a name="l01316"></a>01316       <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;ISIS-Snp (%s): Rcvd L%d %cSNP on %s, &quot;</span>
<a name="l01317"></a>01317           <span class="stringliteral">&quot;skipping: circuit externalDomain = true&quot;</span>,
<a name="l01318"></a>01318           circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>,
<a name="l01319"></a>01319           level, typechar, circuit-&gt;<a class="code" href="structisis__circuit.html#ab03cac6463284a4ce8c1eb19e49f3b6d">interface</a>-&gt;<a class="code" href="structinterface.html#a98cadce768ec5aacb4c5fc4ca2c3eaa8">name</a>);
<a name="l01320"></a>01320 
<a name="l01321"></a>01321       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;
<a name="l01322"></a>01322     }
<a name="l01323"></a>01323 
<a name="l01324"></a>01324   <span class="comment">/* 7.3.15.2 a) 2,3 - manualL2OnlyMode not implemented */</span>
<a name="l01325"></a>01325   <span class="keywordflow">if</span> (!<a class="code" href="isis__pdu_8c.html#ad3be9b74a266fca7d08e91ad3e4b0d45">accept_level</a> (level, circuit-&gt;<a class="code" href="structisis__circuit.html#ab222d6d0b054faa159d72bcb9768b3fb">circuit_is_type</a>))
<a name="l01326"></a>01326     {
<a name="l01327"></a>01327 
<a name="l01328"></a>01328       <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;ISIS-Snp (%s): Rcvd L%d %cSNP on %s, &quot;</span>
<a name="l01329"></a>01329           <span class="stringliteral">&quot;skipping: circuit type %s does not match level %d&quot;</span>,
<a name="l01330"></a>01330           circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>,
<a name="l01331"></a>01331           level,
<a name="l01332"></a>01332           typechar,
<a name="l01333"></a>01333           circuit-&gt;<a class="code" href="structisis__circuit.html#ab03cac6463284a4ce8c1eb19e49f3b6d">interface</a>-&gt;<a class="code" href="structinterface.html#a98cadce768ec5aacb4c5fc4ca2c3eaa8">name</a>,
<a name="l01334"></a>01334           <a class="code" href="isis__misc_8c.html#a35b15c65a44088982fa8daca9fc7b022">circuit_t2string</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#ab222d6d0b054faa159d72bcb9768b3fb">circuit_is_type</a>), level);
<a name="l01335"></a>01335 
<a name="l01336"></a>01336       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;
<a name="l01337"></a>01337     }
<a name="l01338"></a>01338 
<a name="l01339"></a>01339   <span class="comment">/* 7.3.15.2 a) 4 - not applicable for CSNP  only PSNPs on broadcast */</span>
<a name="l01340"></a>01340   <span class="keywordflow">if</span> ((snp_type == <a class="code" href="isis__pdu_8h.html#aa027c4cc52b1c87015b46641ced54839">ISIS_SNP_PSNP_FLAG</a>) &amp;&amp;
<a name="l01341"></a>01341       (circuit-&gt;<a class="code" href="structisis__circuit.html#a569e39bbf7fafd533eae2eeafa671b8c">circ_type</a> == <a class="code" href="isis__circuit_8h.html#a01a94c5f24c88efb64f791a749ae8f95">CIRCUIT_T_BROADCAST</a>))
<a name="l01342"></a>01342     {
<a name="l01343"></a>01343       <span class="keywordflow">if</span> (!circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#adb24376d01beb41cab0ed0c49c3a214c">is_dr</a>[level - 1])
<a name="l01344"></a>01344     {
<a name="l01345"></a>01345 
<a name="l01346"></a>01346       <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;ISIS-Snp (%s): Rcvd L%d %cSNP from %s on %s, &quot;</span>
<a name="l01347"></a>01347               <span class="stringliteral">&quot;skipping: we are not the DIS&quot;</span>,
<a name="l01348"></a>01348               circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>,
<a name="l01349"></a>01349               level,
<a name="l01350"></a>01350               typechar, <a class="code" href="isis__misc_8c.html#a9ff6d4a3900eef27814548c4c5357090">snpa_print</a> (ssnpa), circuit-&gt;<a class="code" href="structisis__circuit.html#ab03cac6463284a4ce8c1eb19e49f3b6d">interface</a>-&gt;<a class="code" href="structinterface.html#a98cadce768ec5aacb4c5fc4ca2c3eaa8">name</a>);
<a name="l01351"></a>01351 
<a name="l01352"></a>01352       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;
<a name="l01353"></a>01353     }
<a name="l01354"></a>01354     }
<a name="l01355"></a>01355 
<a name="l01356"></a>01356   <span class="comment">/* 7.3.15.2 a) 5 - need to make sure IDLength matches - already checked */</span>
<a name="l01357"></a>01357 
<a name="l01358"></a>01358   <span class="comment">/* 7.3.15.2 a) 6 - maximum area match, can be ommited since we only use 3</span>
<a name="l01359"></a>01359 <span class="comment">   * - already checked */</span>
<a name="l01360"></a>01360 
<a name="l01361"></a>01361   <span class="comment">/* 7.3.15.2 a) 7 - Must check that we have an adjacency of the same level  */</span>
<a name="l01362"></a>01362   <span class="comment">/* for broadcast circuits, snpa should be compared */</span>
<a name="l01363"></a>01363   <span class="comment">/* FIXME : Do we need to check SNPA? */</span>
<a name="l01364"></a>01364   <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a569e39bbf7fafd533eae2eeafa671b8c">circ_type</a> == <a class="code" href="isis__circuit_8h.html#a01a94c5f24c88efb64f791a749ae8f95">CIRCUIT_T_BROADCAST</a>)
<a name="l01365"></a>01365     {
<a name="l01366"></a>01366       <span class="keywordflow">if</span> (snp_type == <a class="code" href="isis__pdu_8h.html#ab9d39eb77423805c1c9e40824167b90d">ISIS_SNP_CSNP_FLAG</a>)
<a name="l01367"></a>01367     {
<a name="l01368"></a>01368       adj =
<a name="l01369"></a>01369         <a class="code" href="isis__adjacency_8c.html#af928a678a2e0e3296d688be2a4d8e7ac">isis_adj_lookup</a> (chdr-&gt;<a class="code" href="structisis__complete__seqnum__hdr.html#af1752370bddd40a0438065042268ff34">source_id</a>, circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#ada9bf2584373a37aed06b2e4c9e796f9">adjdb</a>[level - 1]);
<a name="l01370"></a>01370     }
<a name="l01371"></a>01371       <span class="keywordflow">else</span>
<a name="l01372"></a>01372     {
<a name="l01373"></a>01373       <span class="comment">/* a psnp on a broadcast, how lovely of Juniper :) */</span>
<a name="l01374"></a>01374       adj =
<a name="l01375"></a>01375         <a class="code" href="isis__adjacency_8c.html#af928a678a2e0e3296d688be2a4d8e7ac">isis_adj_lookup</a> (phdr-&gt;<a class="code" href="structisis__partial__seqnum__hdr.html#af7a4f90cdd7c994d35d3bac0b367e9b1">source_id</a>, circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#ada9bf2584373a37aed06b2e4c9e796f9">adjdb</a>[level - 1]);
<a name="l01376"></a>01376     }
<a name="l01377"></a>01377       <span class="keywordflow">if</span> (!adj)
<a name="l01378"></a>01378     <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;     <span class="comment">/* Silently discard */</span>
<a name="l01379"></a>01379     }
<a name="l01380"></a>01380   <span class="keywordflow">else</span>
<a name="l01381"></a>01381     {
<a name="l01382"></a>01382       <span class="keywordflow">if</span> (!circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a15852a59ea8be80680abac2070659440">p2p</a>.<a class="code" href="structisis__p2p__info.html#a17d32289e6648b9855b93482cd7c45a5">neighbor</a>)
<a name="l01383"></a>01383     <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;     <span class="comment">/* Silently discard */</span>
<a name="l01384"></a>01384     }
<a name="l01385"></a>01385 
<a name="l01386"></a>01386   <span class="comment">/* 7.3.15.2 a) 8 - Passwords for level 1 - not implemented  */</span>
<a name="l01387"></a>01387 
<a name="l01388"></a>01388   <span class="comment">/* 7.3.15.2 a) 9 - Passwords for level 2 - not implemented  */</span>
<a name="l01389"></a>01389 
<a name="l01390"></a>01390   memset (&amp;tlvs, 0, <span class="keyword">sizeof</span> (<span class="keyword">struct</span> tlvs));
<a name="l01391"></a>01391 
<a name="l01392"></a>01392   <span class="comment">/* parse the SNP */</span>
<a name="l01393"></a>01393   expected |= <a class="code" href="isis__tlv_8h.html#a42ad62b910ab7635f552812763aeac12">TLVFLAG_LSP_ENTRIES</a>;
<a name="l01394"></a>01394   expected |= <a class="code" href="isis__tlv_8h.html#a493ed26a4a2decc55275bd699df9a4a8">TLVFLAG_AUTH_INFO</a>;
<a name="l01395"></a>01395   retval = <a class="code" href="isis__tlv_8c.html#aad6fa3b6cc5e93707f75d8247f8787c8">parse_tlvs</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>,
<a name="l01396"></a>01396                <a class="code" href="stream_8h.html#a4bb95ef1391c2b8b7b97678a5ad87cb7">STREAM_PNT</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>),
<a name="l01397"></a>01397                len - circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>-&gt;<a class="code" href="structstream.html#adb2dceb1b9e09edf611d9076a7a1a491">getp</a>,
<a name="l01398"></a>01398                &amp;expected, &amp;found, &amp;tlvs);
<a name="l01399"></a>01399 
<a name="l01400"></a>01400   <span class="keywordflow">if</span> (retval &gt; <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>)
<a name="l01401"></a>01401     {
<a name="l01402"></a>01402       <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;something went very wrong processing SNP&quot;</span>);
<a name="l01403"></a>01403       <a class="code" href="isis__tlv_8c.html#a5f499235cf5a69697d280f5a1cd01612">free_tlvs</a> (&amp;tlvs);
<a name="l01404"></a>01404       <span class="keywordflow">return</span> retval;
<a name="l01405"></a>01405     }
<a name="l01406"></a>01406 
<a name="l01407"></a>01407   <span class="keywordflow">if</span> (level == 1)
<a name="l01408"></a>01408     passwd = &amp;circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#afb66934e4bd3bda094550517a94de442">area_passwd</a>;
<a name="l01409"></a>01409   <span class="keywordflow">else</span>
<a name="l01410"></a>01410     passwd = &amp;circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#a60cd44a3a31b36dc808ad3fd9efc97a0">domain_passwd</a>;
<a name="l01411"></a>01411 
<a name="l01412"></a>01412   <span class="keywordflow">if</span> (<a class="code" href="zebra_8h.html#a9310812ac92febfb7d1eb10127aea1a8">CHECK_FLAG</a>(passwd-&gt;<a class="code" href="structisis__passwd.html#ae05e8ad6fc2b30cdbb8c29196f120bdf">snp_auth</a>, <a class="code" href="isis__common_8h.html#ae1c1a601a5f1496d080ddd19881916a3">SNP_AUTH_RECV</a>))
<a name="l01413"></a>01413     {
<a name="l01414"></a>01414       <span class="keywordflow">if</span> (passwd-&gt;<a class="code" href="structisis__passwd.html#a874984e0745fbcb41df9f463d831be67">type</a>)
<a name="l01415"></a>01415     {
<a name="l01416"></a>01416       <span class="keywordflow">if</span> (!(found &amp; <a class="code" href="isis__tlv_8h.html#a493ed26a4a2decc55275bd699df9a4a8">TLVFLAG_AUTH_INFO</a>) ||
<a name="l01417"></a>01417           <a class="code" href="isis__pdu_8c.html#aefd5a8caa169a427e30d599b51ab52e9">authentication_check</a> (passwd, &amp;tlvs.<a class="code" href="structtlvs.html#a53dc2cb65bc632c84b3d702ab1dc16ce">auth_info</a>))
<a name="l01418"></a>01418         {
<a name="l01419"></a>01419           <a class="code" href="isis__events_8c.html#a16a754e810bb7ba8e3b2a23c89d6d130">isis_event_auth_failure</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>,
<a name="l01420"></a>01420                        <span class="stringliteral">&quot;SNP authentication&quot;</span> <span class="stringliteral">&quot; failure&quot;</span>,
<a name="l01421"></a>01421                        phdr ? phdr-&gt;<a class="code" href="structisis__partial__seqnum__hdr.html#af7a4f90cdd7c994d35d3bac0b367e9b1">source_id</a> : chdr-&gt;<a class="code" href="structisis__complete__seqnum__hdr.html#af1752370bddd40a0438065042268ff34">source_id</a>);
<a name="l01422"></a>01422           <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;
<a name="l01423"></a>01423         }
<a name="l01424"></a>01424     }
<a name="l01425"></a>01425     }
<a name="l01426"></a>01426 
<a name="l01427"></a>01427   <span class="comment">/* debug isis snp-packets */</span>
<a name="l01428"></a>01428   <span class="keywordflow">if</span> (isis-&gt;<a class="code" href="structisis.html#a6e64127e274c1aa6a52cb0f4b541dfaa">debugs</a> &amp; <a class="code" href="isisd_8h.html#ab16b82eb25717295303c7099035d9dc9">DEBUG_SNP_PACKETS</a>)
<a name="l01429"></a>01429     {
<a name="l01430"></a>01430       <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;ISIS-Snp (%s): Rcvd L%d %cSNP from %s on %s&quot;</span>,
<a name="l01431"></a>01431           circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>,
<a name="l01432"></a>01432           level,
<a name="l01433"></a>01433           typechar, <a class="code" href="isis__misc_8c.html#a9ff6d4a3900eef27814548c4c5357090">snpa_print</a> (ssnpa), circuit-&gt;<a class="code" href="structisis__circuit.html#ab03cac6463284a4ce8c1eb19e49f3b6d">interface</a>-&gt;<a class="code" href="structinterface.html#a98cadce768ec5aacb4c5fc4ca2c3eaa8">name</a>);
<a name="l01434"></a>01434       <span class="keywordflow">if</span> (tlvs.<a class="code" href="structtlvs.html#a5819e536c61399ab0dea624041495a35">lsp_entries</a>)
<a name="l01435"></a>01435     {
<a name="l01436"></a>01436       <span class="keywordflow">for</span> (<a class="code" href="linklist_8h.html#a80a3f4035be83abbb709d17412993226">ALL_LIST_ELEMENTS_RO</a> (tlvs.<a class="code" href="structtlvs.html#a5819e536c61399ab0dea624041495a35">lsp_entries</a>, node, entry))
<a name="l01437"></a>01437       {
<a name="l01438"></a>01438         <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;ISIS-Snp (%s):         %cSNP entry %s, seq 0x%08x,&quot;</span>
<a name="l01439"></a>01439             <span class="stringliteral">&quot; cksum 0x%04x, lifetime %us&quot;</span>,
<a name="l01440"></a>01440             circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>,
<a name="l01441"></a>01441             typechar,
<a name="l01442"></a>01442             <a class="code" href="isis__misc_8c.html#a3a0e7f92008e3167e2c09b8761d06766">rawlspid_print</a> (entry-&gt;<a class="code" href="structlsp__entry.html#a7343aec4f3fe479341c7a46e78593115">lsp_id</a>),
<a name="l01443"></a>01443             ntohl (entry-&gt;<a class="code" href="structlsp__entry.html#a1c2972b33699b2a8e93f42dcc2519a1a">seq_num</a>),
<a name="l01444"></a>01444             ntohs (entry-&gt;<a class="code" href="structlsp__entry.html#afb608ebc17ca3af33a74f25ae2f1e7d8">checksum</a>), ntohs (entry-&gt;<a class="code" href="structlsp__entry.html#ad216f5b8048448d789ea75d5958de3e1">rem_lifetime</a>));
<a name="l01445"></a>01445       }
<a name="l01446"></a>01446     }
<a name="l01447"></a>01447     }
<a name="l01448"></a>01448 
<a name="l01449"></a>01449   <span class="comment">/* 7.3.15.2 b) Actions on LSP_ENTRIES reported */</span>
<a name="l01450"></a>01450   <span class="keywordflow">if</span> (tlvs.<a class="code" href="structtlvs.html#a5819e536c61399ab0dea624041495a35">lsp_entries</a>)
<a name="l01451"></a>01451     {
<a name="l01452"></a>01452       <span class="keywordflow">for</span> (<a class="code" href="linklist_8h.html#a80a3f4035be83abbb709d17412993226">ALL_LIST_ELEMENTS_RO</a> (tlvs.<a class="code" href="structtlvs.html#a5819e536c61399ab0dea624041495a35">lsp_entries</a>, node, entry))
<a name="l01453"></a>01453       {
<a name="l01454"></a>01454     lsp = <a class="code" href="isis__lsp_8c.html#a3859237ab43b147f4520d060439ca002">lsp_search</a> (entry-&gt;<a class="code" href="structlsp__entry.html#a7343aec4f3fe479341c7a46e78593115">lsp_id</a>, circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#a2e85d570b957a6f8fc47dc4db6fa8f4e">lspdb</a>[level - 1]);
<a name="l01455"></a>01455     own_lsp = !<a class="code" href="regex_8c.html#a98d0dff0c7366f08562d8e8583df9bb9">memcmp</a> (entry-&gt;<a class="code" href="structlsp__entry.html#a7343aec4f3fe479341c7a46e78593115">lsp_id</a>, isis-&gt;<a class="code" href="structisis.html#a769d4d051a0f424e8c0568b4eeef748e">sysid</a>, <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a>);
<a name="l01456"></a>01456     <span class="keywordflow">if</span> (lsp)
<a name="l01457"></a>01457       {
<a name="l01458"></a>01458         <span class="comment">/* 7.3.15.2 b) 1) is this LSP newer */</span>
<a name="l01459"></a>01459         cmp = <a class="code" href="isis__lsp_8c.html#a299d8a18662f432a07979c177e2723f0">lsp_compare</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>, lsp, entry-&gt;<a class="code" href="structlsp__entry.html#a1c2972b33699b2a8e93f42dcc2519a1a">seq_num</a>,
<a name="l01460"></a>01460                    entry-&gt;<a class="code" href="structlsp__entry.html#afb608ebc17ca3af33a74f25ae2f1e7d8">checksum</a>, entry-&gt;<a class="code" href="structlsp__entry.html#ad216f5b8048448d789ea75d5958de3e1">rem_lifetime</a>);
<a name="l01461"></a>01461         <span class="comment">/* 7.3.15.2 b) 2) if it equals, clear SRM on p2p */</span>
<a name="l01462"></a>01462         <span class="keywordflow">if</span> (cmp == <a class="code" href="isis__lsp_8h.html#a99cb1e872b18fd541d954846ec30aa7f">LSP_EQUAL</a>)
<a name="l01463"></a>01463           {
<a name="l01464"></a>01464         <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a569e39bbf7fafd533eae2eeafa671b8c">circ_type</a> != <a class="code" href="isis__circuit_8h.html#a01a94c5f24c88efb64f791a749ae8f95">CIRCUIT_T_BROADCAST</a>)
<a name="l01465"></a>01465           <a class="code" href="isis__flags_8h.html#ac67a62e2e71ff606be09d8e74865aac8">ISIS_CLEAR_FLAG</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a96d155dbf3bbd20256cf7a68c8d9fd20">SRMflags</a>, circuit);
<a name="l01466"></a>01466         <span class="comment">/* 7.3.15.2 b) 3) if it is older, clear SSN and set SRM */</span>
<a name="l01467"></a>01467           }
<a name="l01468"></a>01468         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmp == <a class="code" href="isis__lsp_8h.html#a3902417a88de806e8b32c2a5930eb9bc">LSP_OLDER</a>)
<a name="l01469"></a>01469           {
<a name="l01470"></a>01470         <a class="code" href="isis__flags_8h.html#ac67a62e2e71ff606be09d8e74865aac8">ISIS_CLEAR_FLAG</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a03d0dd350cd760986f4907c5df08363a">SSNflags</a>, circuit);
<a name="l01471"></a>01471         <a class="code" href="isis__flags_8h.html#a1f7b5b2baa94ebc0450ccb5839a682e7">ISIS_SET_FLAG</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a96d155dbf3bbd20256cf7a68c8d9fd20">SRMflags</a>, circuit);
<a name="l01472"></a>01472           }
<a name="l01473"></a>01473         <span class="keywordflow">else</span>
<a name="l01474"></a>01474           {
<a name="l01475"></a>01475         <span class="comment">/* 7.3.15.2 b) 4) if it is newer, set SSN and clear SRM</span>
<a name="l01476"></a>01476 <span class="comment">         * on p2p */</span>
<a name="l01477"></a>01477         <span class="keywordflow">if</span> (own_lsp)
<a name="l01478"></a>01478           {
<a name="l01479"></a>01479             <a class="code" href="isis__lsp_8c.html#a95c7b93c607b9aba6b6697b136d9ad98">lsp_inc_seqnum</a> (lsp, ntohl (entry-&gt;<a class="code" href="structlsp__entry.html#a1c2972b33699b2a8e93f42dcc2519a1a">seq_num</a>));
<a name="l01480"></a>01480             <a class="code" href="isis__flags_8h.html#a1f7b5b2baa94ebc0450ccb5839a682e7">ISIS_SET_FLAG</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a96d155dbf3bbd20256cf7a68c8d9fd20">SRMflags</a>, circuit);
<a name="l01481"></a>01481           }
<a name="l01482"></a>01482         <span class="keywordflow">else</span>
<a name="l01483"></a>01483           {
<a name="l01484"></a>01484             <a class="code" href="isis__flags_8h.html#a1f7b5b2baa94ebc0450ccb5839a682e7">ISIS_SET_FLAG</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a03d0dd350cd760986f4907c5df08363a">SSNflags</a>, circuit);
<a name="l01485"></a>01485             <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a569e39bbf7fafd533eae2eeafa671b8c">circ_type</a> != <a class="code" href="isis__circuit_8h.html#a01a94c5f24c88efb64f791a749ae8f95">CIRCUIT_T_BROADCAST</a>)
<a name="l01486"></a>01486               <a class="code" href="isis__flags_8h.html#ac67a62e2e71ff606be09d8e74865aac8">ISIS_CLEAR_FLAG</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a96d155dbf3bbd20256cf7a68c8d9fd20">SRMflags</a>, circuit);
<a name="l01487"></a>01487           }
<a name="l01488"></a>01488           }
<a name="l01489"></a>01489       }
<a name="l01490"></a>01490     <span class="keywordflow">else</span>
<a name="l01491"></a>01491       {
<a name="l01492"></a>01492         <span class="comment">/* 7.3.15.2 b) 5) if it was not found, and all of those are not 0, </span>
<a name="l01493"></a>01493 <span class="comment">         * insert it and set SSN on it */</span>
<a name="l01494"></a>01494         <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="structlsp__entry.html#ad216f5b8048448d789ea75d5958de3e1">rem_lifetime</a> &amp;&amp; entry-&gt;<a class="code" href="structlsp__entry.html#afb608ebc17ca3af33a74f25ae2f1e7d8">checksum</a> &amp;&amp; entry-&gt;<a class="code" href="structlsp__entry.html#a1c2972b33699b2a8e93f42dcc2519a1a">seq_num</a> &amp;&amp;
<a name="l01495"></a>01495         <a class="code" href="regex_8c.html#a98d0dff0c7366f08562d8e8583df9bb9">memcmp</a> (entry-&gt;<a class="code" href="structlsp__entry.html#a7343aec4f3fe479341c7a46e78593115">lsp_id</a>, isis-&gt;<a class="code" href="structisis.html#a769d4d051a0f424e8c0568b4eeef748e">sysid</a>, <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a>))
<a name="l01496"></a>01496           {
<a name="l01497"></a>01497         lsp = <a class="code" href="isis__lsp_8c.html#af43ff22a21554145c239b6c37556ce1a">lsp_new</a> (entry-&gt;<a class="code" href="structlsp__entry.html#a7343aec4f3fe479341c7a46e78593115">lsp_id</a>, ntohs (entry-&gt;<a class="code" href="structlsp__entry.html#ad216f5b8048448d789ea75d5958de3e1">rem_lifetime</a>),
<a name="l01498"></a>01498                    0, 0, entry-&gt;<a class="code" href="structlsp__entry.html#afb608ebc17ca3af33a74f25ae2f1e7d8">checksum</a>, level);
<a name="l01499"></a>01499         <a class="code" href="isis__lsp_8c.html#a09d8f3bcc073c87f01c32b2f0994fb04">lsp_insert</a> (lsp, circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#a2e85d570b957a6f8fc47dc4db6fa8f4e">lspdb</a>[level - 1]);
<a name="l01500"></a>01500         <a class="code" href="isis__flags_8h.html#a1f7b5b2baa94ebc0450ccb5839a682e7">ISIS_SET_FLAG</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a03d0dd350cd760986f4907c5df08363a">SSNflags</a>, circuit);
<a name="l01501"></a>01501           }
<a name="l01502"></a>01502       }
<a name="l01503"></a>01503       }
<a name="l01504"></a>01504     }
<a name="l01505"></a>01505 
<a name="l01506"></a>01506   <span class="comment">/* 7.3.15.2 c) on CSNP set SRM for all in range which were not reported */</span>
<a name="l01507"></a>01507   <span class="keywordflow">if</span> (snp_type == <a class="code" href="isis__pdu_8h.html#ab9d39eb77423805c1c9e40824167b90d">ISIS_SNP_CSNP_FLAG</a>)
<a name="l01508"></a>01508     {
<a name="l01509"></a>01509       <span class="comment">/*</span>
<a name="l01510"></a>01510 <span class="comment">       * Build a list from our own LSP db bounded with start_ and stop_lsp_id</span>
<a name="l01511"></a>01511 <span class="comment">       */</span>
<a name="l01512"></a>01512       lsp_list = <a class="code" href="linklist_8c.html#af156f4ae343ef4a625f75b6c38845aef">list_new</a> ();
<a name="l01513"></a>01513       <a class="code" href="isis__lsp_8c.html#a66fb0f7dfcff76c23f14eaaf816b11f9">lsp_build_list_nonzero_ht</a> (chdr-&gt;<a class="code" href="structisis__complete__seqnum__hdr.html#a0b2c464f9ef4210d2ed04dbff13b5c75">start_lsp_id</a>, chdr-&gt;<a class="code" href="structisis__complete__seqnum__hdr.html#ac714a51c6fabe095eadf5f093764ca76">stop_lsp_id</a>,
<a name="l01514"></a>01514                  lsp_list, circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#a2e85d570b957a6f8fc47dc4db6fa8f4e">lspdb</a>[level - 1]);
<a name="l01515"></a>01515 
<a name="l01516"></a>01516       <span class="comment">/* Fixme: Find a better solution */</span>
<a name="l01517"></a>01517       <span class="keywordflow">if</span> (tlvs.<a class="code" href="structtlvs.html#a5819e536c61399ab0dea624041495a35">lsp_entries</a>)
<a name="l01518"></a>01518     {
<a name="l01519"></a>01519       <span class="keywordflow">for</span> (<a class="code" href="linklist_8h.html#a71512a873b8f0e2b4c84d3c949a9bbaf">ALL_LIST_ELEMENTS</a> (tlvs.<a class="code" href="structtlvs.html#a5819e536c61399ab0dea624041495a35">lsp_entries</a>, node, nnode, entry))
<a name="l01520"></a>01520       {
<a name="l01521"></a>01521         <span class="keywordflow">for</span> (<a class="code" href="linklist_8h.html#a71512a873b8f0e2b4c84d3c949a9bbaf">ALL_LIST_ELEMENTS</a> (lsp_list, node2, nnode2, lsp))
<a name="l01522"></a>01522         {
<a name="l01523"></a>01523           <span class="keywordflow">if</span> (<a class="code" href="isis__lsp_8c.html#a04ba9b8f0efece8345a3f6e90be19da1">lsp_id_cmp</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a3e4328d15b43f9023fee75d60f08aca0">lsp_header</a>-&gt;<a class="code" href="structisis__link__state__hdr.html#a6e6f2ce4d1b33c3280827272009a5af2">lsp_id</a>, entry-&gt;<a class="code" href="structlsp__entry.html#a7343aec4f3fe479341c7a46e78593115">lsp_id</a>) == 0)
<a name="l01524"></a>01524         {
<a name="l01525"></a>01525           <a class="code" href="linklist_8c.html#a44569d4d868c60e29b21409612a5df05">list_delete_node</a> (lsp_list, node2);
<a name="l01526"></a>01526           <span class="keywordflow">break</span>;
<a name="l01527"></a>01527         }
<a name="l01528"></a>01528         }
<a name="l01529"></a>01529       }
<a name="l01530"></a>01530     }
<a name="l01531"></a>01531       <span class="comment">/* on remaining LSPs we set SRM (neighbor knew not of) */</span>
<a name="l01532"></a>01532       <span class="keywordflow">for</span> (<a class="code" href="linklist_8h.html#a80a3f4035be83abbb709d17412993226">ALL_LIST_ELEMENTS_RO</a> (lsp_list, node, lsp))
<a name="l01533"></a>01533       {
<a name="l01534"></a>01534     <a class="code" href="isis__flags_8h.html#a1f7b5b2baa94ebc0450ccb5839a682e7">ISIS_SET_FLAG</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a96d155dbf3bbd20256cf7a68c8d9fd20">SRMflags</a>, circuit);
<a name="l01535"></a>01535       }
<a name="l01536"></a>01536       <span class="comment">/* lets free it */</span>
<a name="l01537"></a>01537       <a class="code" href="linklist_8c.html#a15aa9f8cf8424489adf1efd4d075aac6">list_free</a> (lsp_list);
<a name="l01538"></a>01538     }
<a name="l01539"></a>01539 
<a name="l01540"></a>01540   <a class="code" href="isis__tlv_8c.html#a5f499235cf5a69697d280f5a1cd01612">free_tlvs</a> (&amp;tlvs);
<a name="l01541"></a>01541   <span class="keywordflow">return</span> retval;
<a name="l01542"></a>01542 }
<a name="l01543"></a>01543 
<a name="l01544"></a>01544 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01545"></a><a class="code" href="isis__pdu_8c.html#aae34abef6549bb3917ee120cb846bb41">01545</a> <a class="code" href="isis__pdu_8c.html#aae34abef6549bb3917ee120cb846bb41">process_csnp</a> (<span class="keywordtype">int</span> level, <span class="keyword">struct</span> <a class="code" href="structisis__circuit.html">isis_circuit</a> *circuit, u_char * ssnpa)
<a name="l01546"></a>01546 {
<a name="l01547"></a>01547   <span class="comment">/* Sanity check - FIXME: move to correct place */</span>
<a name="l01548"></a>01548   <span class="keywordflow">if</span> ((<a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>) -
<a name="l01549"></a>01549        <a class="code" href="stream_8c.html#a717f15645000d42a15034f5ec83fc9a5">stream_get_getp</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>)) &lt; <a class="code" href="isis__pdu_8h.html#ad643847e4f6bb080e2e6359abcad1c15">ISIS_CSNP_HDRLEN</a>)
<a name="l01550"></a>01550     {
<a name="l01551"></a>01551       <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;Packet too short ( &lt; %d)&quot;</span>, <a class="code" href="isis__pdu_8h.html#ad643847e4f6bb080e2e6359abcad1c15">ISIS_CSNP_HDRLEN</a>);
<a name="l01552"></a>01552       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;
<a name="l01553"></a>01553     }
<a name="l01554"></a>01554 
<a name="l01555"></a>01555   <span class="keywordflow">return</span> <a class="code" href="isis__pdu_8c.html#a4e16ec0d4416a973611faf1d57beac3a">process_snp</a> (<a class="code" href="isis__pdu_8h.html#ab9d39eb77423805c1c9e40824167b90d">ISIS_SNP_CSNP_FLAG</a>, level, circuit, ssnpa);
<a name="l01556"></a>01556 }
<a name="l01557"></a>01557 
<a name="l01558"></a>01558 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01559"></a><a class="code" href="isis__pdu_8c.html#a4341127ac99b45c32f8f35aa8bc277df">01559</a> <a class="code" href="isis__pdu_8c.html#a4341127ac99b45c32f8f35aa8bc277df">process_psnp</a> (<span class="keywordtype">int</span> level, <span class="keyword">struct</span> <a class="code" href="structisis__circuit.html">isis_circuit</a> *circuit, u_char * ssnpa)
<a name="l01560"></a>01560 {
<a name="l01561"></a>01561   <span class="keywordflow">if</span> ((<a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>) -
<a name="l01562"></a>01562        <a class="code" href="stream_8c.html#a717f15645000d42a15034f5ec83fc9a5">stream_get_getp</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>)) &lt; <a class="code" href="isis__pdu_8h.html#aceab21fb8507148277e0980a0cd31a1e">ISIS_PSNP_HDRLEN</a>)
<a name="l01563"></a>01563     {
<a name="l01564"></a>01564       <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;Packet too short&quot;</span>);
<a name="l01565"></a>01565       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;
<a name="l01566"></a>01566     }
<a name="l01567"></a>01567 
<a name="l01568"></a>01568   <span class="keywordflow">return</span> <a class="code" href="isis__pdu_8c.html#a4e16ec0d4416a973611faf1d57beac3a">process_snp</a> (<a class="code" href="isis__pdu_8h.html#aa027c4cc52b1c87015b46641ced54839">ISIS_SNP_PSNP_FLAG</a>, level, circuit, ssnpa);
<a name="l01569"></a>01569 }
<a name="l01570"></a>01570 
<a name="l01571"></a>01571 <span class="comment">/*</span>
<a name="l01572"></a>01572 <span class="comment"> * Process ISH</span>
<a name="l01573"></a>01573 <span class="comment"> * ISO - 10589</span>
<a name="l01574"></a>01574 <span class="comment"> * Section 8.2.2 - Receiving ISH PDUs by an intermediate system</span>
<a name="l01575"></a>01575 <span class="comment"> * FIXME: sample packet dump, need to figure 0x81 - looks like NLPid</span>
<a name="l01576"></a>01576 <span class="comment"> *           0x82   0x15    0x01    0x00    0x04    0x01    0x2c    0x59</span>
<a name="l01577"></a>01577 <span class="comment"> *           0x38   0x08    0x47    0x00    0x01    0x00    0x02    0x00</span>
<a name="l01578"></a>01578 <span class="comment"> *           0x03   0x00    0x81    0x01    0xcc</span>
<a name="l01579"></a>01579 <span class="comment"> */</span>
<a name="l01580"></a>01580 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01581"></a><a class="code" href="isis__pdu_8c.html#a91fbea5cc0d8560ca8d150743f5da79d">01581</a> <a class="code" href="isis__pdu_8c.html#a91fbea5cc0d8560ca8d150743f5da79d">process_is_hello</a> (<span class="keyword">struct</span> <a class="code" href="structisis__circuit.html">isis_circuit</a> *circuit)
<a name="l01582"></a>01582 {
<a name="l01583"></a>01583   <span class="keyword">struct </span><a class="code" href="structisis__adjacency.html">isis_adjacency</a> *adj;
<a name="l01584"></a>01584   <span class="keywordtype">int</span> retval = <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;
<a name="l01585"></a>01585   u_char neigh_len;
<a name="l01586"></a>01586   u_char *<a class="code" href="isis__misc_8c.html#aba11fdf75896b0a0b94c02619b945c97">sysid</a>;
<a name="l01587"></a>01587 
<a name="l01588"></a>01588   <span class="comment">/* In this point in time we are not yet able to handle is_hellos</span>
<a name="l01589"></a>01589 <span class="comment">   * on lan - Sorry juniper...</span>
<a name="l01590"></a>01590 <span class="comment">   */</span>
<a name="l01591"></a>01591   <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a569e39bbf7fafd533eae2eeafa671b8c">circ_type</a> == <a class="code" href="isis__circuit_8h.html#a01a94c5f24c88efb64f791a749ae8f95">CIRCUIT_T_BROADCAST</a>)
<a name="l01592"></a>01592     <span class="keywordflow">return</span> retval;
<a name="l01593"></a>01593 
<a name="l01594"></a>01594   neigh_len = <a class="code" href="stream_8c.html#a7902a86d9a749707c535840654ded3f6">stream_getc</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>);
<a name="l01595"></a>01595   sysid = <a class="code" href="stream_8h.html#a4bb95ef1391c2b8b7b97678a5ad87cb7">STREAM_PNT</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>) + neigh_len - 1 - <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a>;
<a name="l01596"></a>01596   adj = circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a15852a59ea8be80680abac2070659440">p2p</a>.<a class="code" href="structisis__p2p__info.html#a17d32289e6648b9855b93482cd7c45a5">neighbor</a>;
<a name="l01597"></a>01597   <span class="keywordflow">if</span> (!adj)
<a name="l01598"></a>01598     {
<a name="l01599"></a>01599       <span class="comment">/* 8.2.2 */</span>
<a name="l01600"></a>01600       adj = <a class="code" href="isis__adjacency_8c.html#a81fa83638827781e0f128c9c01551a95">isis_new_adj</a> (sysid, <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, circuit);
<a name="l01601"></a>01601       <span class="keywordflow">if</span> (adj == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01602"></a>01602     <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#ac694b0bd16857a3d50deea71f78e8b7f">ISIS_ERROR</a>;
<a name="l01603"></a>01603 
<a name="l01604"></a>01604       <a class="code" href="isis__adjacency_8c.html#a0f8f010e5bafa4fe5497e600c1ac12dd">isis_adj_state_change</a> (adj, <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a1973db8c983074b9c3e0cc74c23eab47">ISIS_ADJ_INITIALIZING</a>, <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01605"></a>01605       adj-&gt;<a class="code" href="structisis__adjacency.html#a187eb9cdad6881ecd2735b38a47e07e3">sys_type</a> = <a class="code" href="isis__adjacency_8h.html#ad310c3cfba255c6c6dda415939268b4da1d20bc4d429708dd9bc81735bd176618">ISIS_SYSTYPE_UNKNOWN</a>;
<a name="l01606"></a>01606       circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a15852a59ea8be80680abac2070659440">p2p</a>.<a class="code" href="structisis__p2p__info.html#a17d32289e6648b9855b93482cd7c45a5">neighbor</a> = adj;
<a name="l01607"></a>01607     }
<a name="l01608"></a>01608   <span class="comment">/* 8.2.2 a) */</span>
<a name="l01609"></a>01609   <span class="keywordflow">if</span> ((adj-&gt;<a class="code" href="structisis__adjacency.html#ade48f111121efb755bd2ea13a06a16ae">adj_state</a> == <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a1762b381ed451feffee948c5f5d0ed86">ISIS_ADJ_UP</a>) &amp;&amp; <a class="code" href="regex_8c.html#a98d0dff0c7366f08562d8e8583df9bb9">memcmp</a> (adj-&gt;<a class="code" href="structisis__adjacency.html#a7b23942ae5652d5cf59b263f131c2038">sysid</a>, sysid,
<a name="l01610"></a>01610                          ISIS_SYS_ID_LEN))
<a name="l01611"></a>01611     {
<a name="l01612"></a>01612       <span class="comment">/* 8.2.2 a) 1) FIXME: adjStateChange(down) event */</span>
<a name="l01613"></a>01613       <span class="comment">/* 8.2.2 a) 2) delete the adj */</span>
<a name="l01614"></a>01614       <a class="code" href="memory_8h.html#a29f1ce2c850a3163cd6b1b0bd460705d">XFREE</a> (<a class="code" href="memtypes_8h.html#a7ff5f2dff38e7639981794c43dc9167ba573c15a700e70c8a655319a64727f856">MTYPE_ISIS_ADJACENCY</a>, adj);
<a name="l01615"></a>01615       <span class="comment">/* 8.2.2 a) 3) create a new adj */</span>
<a name="l01616"></a>01616       adj = <a class="code" href="isis__adjacency_8c.html#a81fa83638827781e0f128c9c01551a95">isis_new_adj</a> (sysid, <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, circuit);
<a name="l01617"></a>01617       <span class="keywordflow">if</span> (adj == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01618"></a>01618     <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#ac694b0bd16857a3d50deea71f78e8b7f">ISIS_ERROR</a>;
<a name="l01619"></a>01619 
<a name="l01620"></a>01620       <span class="comment">/* 8.2.2 a) 3) i */</span>
<a name="l01621"></a>01621       <a class="code" href="isis__adjacency_8c.html#a0f8f010e5bafa4fe5497e600c1ac12dd">isis_adj_state_change</a> (adj, <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a1973db8c983074b9c3e0cc74c23eab47">ISIS_ADJ_INITIALIZING</a>, <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01622"></a>01622       <span class="comment">/* 8.2.2 a) 3) ii */</span>
<a name="l01623"></a>01623       adj-&gt;<a class="code" href="structisis__adjacency.html#a187eb9cdad6881ecd2735b38a47e07e3">sys_type</a> = <a class="code" href="isis__adjacency_8h.html#ad310c3cfba255c6c6dda415939268b4da1d20bc4d429708dd9bc81735bd176618">ISIS_SYSTYPE_UNKNOWN</a>;
<a name="l01624"></a>01624       <span class="comment">/* 8.2.2 a) 4) quite meaningless */</span>
<a name="l01625"></a>01625     }
<a name="l01626"></a>01626   <span class="comment">/* 8.2.2 b) ignore on condition */</span>
<a name="l01627"></a>01627   <span class="keywordflow">if</span> ((adj-&gt;<a class="code" href="structisis__adjacency.html#ade48f111121efb755bd2ea13a06a16ae">adj_state</a> == <a class="code" href="isis__adjacency_8h.html#ad407b8d5b86106c7891c353d06af5576a1973db8c983074b9c3e0cc74c23eab47">ISIS_ADJ_INITIALIZING</a>) &amp;&amp;
<a name="l01628"></a>01628       (adj-&gt;<a class="code" href="structisis__adjacency.html#a187eb9cdad6881ecd2735b38a47e07e3">sys_type</a> == <a class="code" href="isis__adjacency_8h.html#ad310c3cfba255c6c6dda415939268b4da200778581ea795c59c48b27748eae10e">ISIS_SYSTYPE_IS</a>))
<a name="l01629"></a>01629     {
<a name="l01630"></a>01630       <span class="comment">/* do nothing */</span>
<a name="l01631"></a>01631     }
<a name="l01632"></a>01632   <span class="keywordflow">else</span>
<a name="l01633"></a>01633     {
<a name="l01634"></a>01634       <span class="comment">/* 8.2.2 c) respond with a p2p IIH */</span>
<a name="l01635"></a>01635       <a class="code" href="isis__pdu_8c.html#ada46fc1940683eac5a47249f80f865b5">send_hello</a> (circuit, 1);
<a name="l01636"></a>01636     }
<a name="l01637"></a>01637   <span class="comment">/* 8.2.2 d) type is IS */</span>
<a name="l01638"></a>01638   adj-&gt;<a class="code" href="structisis__adjacency.html#a187eb9cdad6881ecd2735b38a47e07e3">sys_type</a> = <a class="code" href="isis__adjacency_8h.html#ad310c3cfba255c6c6dda415939268b4da200778581ea795c59c48b27748eae10e">ISIS_SYSTYPE_IS</a>;
<a name="l01639"></a>01639   <span class="comment">/* 8.2.2 e) FIXME: Circuit type of? */</span>
<a name="l01640"></a>01640 
<a name="l01641"></a>01641   <span class="keywordflow">return</span> retval;
<a name="l01642"></a>01642 }
<a name="l01643"></a>01643 
<a name="l01644"></a>01644 <span class="comment">/*</span>
<a name="l01645"></a>01645 <span class="comment"> * PDU Dispatcher</span>
<a name="l01646"></a>01646 <span class="comment"> */</span>
<a name="l01647"></a>01647 
<a name="l01648"></a>01648 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01649"></a><a class="code" href="isis__pdu_8c.html#acb5f4492a8f9bb27a780ebfe97934e85">01649</a> <a class="code" href="isis__pdu_8c.html#acb5f4492a8f9bb27a780ebfe97934e85">isis_handle_pdu</a> (<span class="keyword">struct</span> <a class="code" href="structisis__circuit.html">isis_circuit</a> *<a class="code" href="structisis__adjacency.html#a29d8beb7bedcecb2c6c2f7112ba5d072">circuit</a>, u_char * ssnpa)
<a name="l01650"></a>01650 {
<a name="l01651"></a>01651   <span class="keyword">struct </span><a class="code" href="structisis__fixed__hdr.html">isis_fixed_hdr</a> *hdr;
<a name="l01652"></a>01652   <span class="keyword">struct </span><a class="code" href="structesis__fixed__hdr.html">esis_fixed_hdr</a> *esis_hdr;
<a name="l01653"></a>01653 
<a name="l01654"></a>01654   <span class="keywordtype">int</span> retval = <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;
<a name="l01655"></a>01655 
<a name="l01656"></a>01656   <span class="comment">/*</span>
<a name="l01657"></a>01657 <span class="comment">   * Let&#39;s first read data from stream to the header</span>
<a name="l01658"></a>01658 <span class="comment">   */</span>
<a name="l01659"></a>01659   hdr = (<span class="keyword">struct </span><a class="code" href="structisis__fixed__hdr.html">isis_fixed_hdr</a> *) <a class="code" href="stream_8h.html#afde5f5db208a43da6faf7b830f26d7fc">STREAM_DATA</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>);
<a name="l01660"></a>01660 
<a name="l01661"></a>01661   <span class="keywordflow">if</span> ((hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#ab7d3a92cb745fd25d033e0daefca7f74">idrp</a> != <a class="code" href="iso_8h.html#a5246f338b99d70bb67f26fdbf2c25c8b">ISO10589_ISIS</a>) &amp;&amp; (hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#ab7d3a92cb745fd25d033e0daefca7f74">idrp</a> != <a class="code" href="iso_8h.html#ac46252393a469e6335e3689dd8a9c45b">ISO9542_ESIS</a>))
<a name="l01662"></a>01662     {
<a name="l01663"></a>01663       <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;Not an IS-IS or ES-IS packet IDRP=%02x&quot;</span>, hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#ab7d3a92cb745fd25d033e0daefca7f74">idrp</a>);
<a name="l01664"></a>01664       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#ac694b0bd16857a3d50deea71f78e8b7f">ISIS_ERROR</a>;
<a name="l01665"></a>01665     }
<a name="l01666"></a>01666 
<a name="l01667"></a>01667   <span class="comment">/* now we need to know if this is an ISO 9542 packet and</span>
<a name="l01668"></a>01668 <span class="comment">   * take real good care of it, waaa!</span>
<a name="l01669"></a>01669 <span class="comment">   */</span>
<a name="l01670"></a>01670   <span class="keywordflow">if</span> (hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#ab7d3a92cb745fd25d033e0daefca7f74">idrp</a> == <a class="code" href="iso_8h.html#ac46252393a469e6335e3689dd8a9c45b">ISO9542_ESIS</a>)
<a name="l01671"></a>01671     {
<a name="l01672"></a>01672       esis_hdr = (<span class="keyword">struct </span><a class="code" href="structesis__fixed__hdr.html">esis_fixed_hdr</a> *) <a class="code" href="stream_8h.html#afde5f5db208a43da6faf7b830f26d7fc">STREAM_DATA</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>);
<a name="l01673"></a>01673       <a class="code" href="stream_8c.html#a5506a87bd79df66accb6ad8fbbd5857c">stream_set_getp</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>, <a class="code" href="isis__pdu_8h.html#aa6a1330be2a7f7ca02ccd7d7cefeb6de">ESIS_FIXED_HDR_LEN</a>);
<a name="l01674"></a>01674       <span class="comment">/* FIXME: Need to do some acceptence tests */</span>
<a name="l01675"></a>01675       <span class="comment">/* example length... */</span>
<a name="l01676"></a>01676       <span class="keywordflow">switch</span> (esis_hdr-&gt;<a class="code" href="structesis__fixed__hdr.html#ac2151754f7d0212d4a1be3e1f1512aad">pdu_type</a>)
<a name="l01677"></a>01677     {
<a name="l01678"></a>01678     <span class="keywordflow">case</span> <a class="code" href="isis__pdu_8h.html#a7d8d38ce35472f05aa4a7e74e68576c8">ESH_PDU</a>:
<a name="l01679"></a>01679       <span class="comment">/* FIXME */</span>
<a name="l01680"></a>01680       <span class="keywordflow">break</span>;
<a name="l01681"></a>01681     <span class="keywordflow">case</span> <a class="code" href="isis__pdu_8h.html#adf31bc2976b78796a60f4d978dcbc518">ISH_PDU</a>:
<a name="l01682"></a>01682       <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;AN ISH PDU!!&quot;</span>);
<a name="l01683"></a>01683       retval = <a class="code" href="isis__pdu_8c.html#a91fbea5cc0d8560ca8d150743f5da79d">process_is_hello</a> (circuit);
<a name="l01684"></a>01684       <span class="keywordflow">break</span>;
<a name="l01685"></a>01685     <span class="keywordflow">default</span>:
<a name="l01686"></a>01686       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#ac694b0bd16857a3d50deea71f78e8b7f">ISIS_ERROR</a>;
<a name="l01687"></a>01687     }
<a name="l01688"></a>01688       <span class="keywordflow">return</span> retval;
<a name="l01689"></a>01689     }
<a name="l01690"></a>01690   <span class="keywordflow">else</span>
<a name="l01691"></a>01691     {
<a name="l01692"></a>01692       <a class="code" href="stream_8c.html#a5506a87bd79df66accb6ad8fbbd5857c">stream_set_getp</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>, <a class="code" href="isis__pdu_8h.html#a61f100919f790014bded41907b477263">ISIS_FIXED_HDR_LEN</a>);
<a name="l01693"></a>01693     }
<a name="l01694"></a>01694   <span class="comment">/*</span>
<a name="l01695"></a>01695 <span class="comment">   * and then process it</span>
<a name="l01696"></a>01696 <span class="comment">   */</span>
<a name="l01697"></a>01697 
<a name="l01698"></a>01698   <span class="keywordflow">if</span> (hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#acde2c4eefcd9af9aef447b106383b03e">length</a> &lt; <a class="code" href="isis__pdu_8c.html#aca2aaedf29c85944f6063b91c0461b20">ISIS_MINIMUM_FIXED_HDR_LEN</a>)
<a name="l01699"></a>01699     {
<a name="l01700"></a>01700       <a class="code" href="log_8h.html#aaf50b52a949696adb9e77153b08545ad">zlog_err</a> (<span class="stringliteral">&quot;Fixed header length = %d&quot;</span>, hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#acde2c4eefcd9af9aef447b106383b03e">length</a>);
<a name="l01701"></a>01701       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#ac694b0bd16857a3d50deea71f78e8b7f">ISIS_ERROR</a>;
<a name="l01702"></a>01702     }
<a name="l01703"></a>01703 
<a name="l01704"></a>01704   <span class="keywordflow">if</span> (hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#aae65a4fef2c1f3f7f5601da9fe5491c3">version1</a> != 1)
<a name="l01705"></a>01705     {
<a name="l01706"></a>01706       <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;Unsupported ISIS version %u&quot;</span>, hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#aae65a4fef2c1f3f7f5601da9fe5491c3">version1</a>);
<a name="l01707"></a>01707       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;
<a name="l01708"></a>01708     }
<a name="l01709"></a>01709   <span class="comment">/* either 6 or 0 */</span>
<a name="l01710"></a>01710   <span class="keywordflow">if</span> ((hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#adbac4c42a022759367d1fd9a1fdb40f7">id_len</a> != 0) &amp;&amp; (hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#adbac4c42a022759367d1fd9a1fdb40f7">id_len</a> != <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a>))
<a name="l01711"></a>01711     {
<a name="l01712"></a>01712       <a class="code" href="log_8h.html#aaf50b52a949696adb9e77153b08545ad">zlog_err</a>
<a name="l01713"></a>01713     (<span class="stringliteral">&quot;IDFieldLengthMismatch: ID Length field in a received PDU  %u, &quot;</span>
<a name="l01714"></a>01714      <span class="stringliteral">&quot;while the parameter for this IS is %u&quot;</span>, hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#adbac4c42a022759367d1fd9a1fdb40f7">id_len</a>,
<a name="l01715"></a>01715      <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a>);
<a name="l01716"></a>01716       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#ac694b0bd16857a3d50deea71f78e8b7f">ISIS_ERROR</a>;
<a name="l01717"></a>01717     }
<a name="l01718"></a>01718 
<a name="l01719"></a>01719   <span class="keywordflow">if</span> (hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#ab0240202f6415d4ad641b692615ed1eb">version2</a> != 1)
<a name="l01720"></a>01720     {
<a name="l01721"></a>01721       <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;Unsupported ISIS version %u&quot;</span>, hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#ab0240202f6415d4ad641b692615ed1eb">version2</a>);
<a name="l01722"></a>01722       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;
<a name="l01723"></a>01723     }
<a name="l01724"></a>01724   <span class="comment">/* either 3 or 0 */</span>
<a name="l01725"></a>01725   <span class="keywordflow">if</span> ((hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#abf027a2ccc2b29a6b36cae277894f7c3">max_area_addrs</a> != 0)
<a name="l01726"></a>01726       &amp;&amp; (hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#abf027a2ccc2b29a6b36cae277894f7c3">max_area_addrs</a> != isis-&gt;<a class="code" href="structisis.html#aece17be3ce01b59ac1e2c1b443cb4a19">max_area_addrs</a>))
<a name="l01727"></a>01727     {
<a name="l01728"></a>01728       <a class="code" href="log_8h.html#aaf50b52a949696adb9e77153b08545ad">zlog_err</a> (<span class="stringliteral">&quot;maximumAreaAddressesMismatch: maximumAreaAdresses in a &quot;</span>
<a name="l01729"></a>01729         <span class="stringliteral">&quot;received PDU %u while the parameter for this IS is %u&quot;</span>,
<a name="l01730"></a>01730         hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#abf027a2ccc2b29a6b36cae277894f7c3">max_area_addrs</a>, isis-&gt;<a class="code" href="structisis.html#aece17be3ce01b59ac1e2c1b443cb4a19">max_area_addrs</a>);
<a name="l01731"></a>01731       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#ac694b0bd16857a3d50deea71f78e8b7f">ISIS_ERROR</a>;
<a name="l01732"></a>01732     }
<a name="l01733"></a>01733 
<a name="l01734"></a>01734   <span class="keywordflow">switch</span> (hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#a6e0886d9e411e4f4ab9de644af8ee034">pdu_type</a>)
<a name="l01735"></a>01735     {
<a name="l01736"></a>01736     <span class="keywordflow">case</span> <a class="code" href="isis__pdu_8h.html#aaecfaf101078595ebfeed0bd1740932b">L1_LAN_HELLO</a>:
<a name="l01737"></a>01737       retval = <a class="code" href="isis__pdu_8c.html#adb45f30316e2d1fed63fc164d31657c1">process_lan_hello</a> (<a class="code" href="isis__constants_8h.html#a07d8effa4d110dfe9ed04bf051e6ebab">ISIS_LEVEL1</a>, circuit, ssnpa);
<a name="l01738"></a>01738       <span class="keywordflow">break</span>;
<a name="l01739"></a>01739     <span class="keywordflow">case</span> <a class="code" href="isis__pdu_8h.html#af62a8d7593e2fabd396e8dce9124d09d">L2_LAN_HELLO</a>:
<a name="l01740"></a>01740       retval = <a class="code" href="isis__pdu_8c.html#adb45f30316e2d1fed63fc164d31657c1">process_lan_hello</a> (<a class="code" href="isis__constants_8h.html#ad8502b655a001bf61391e956a316ffc2">ISIS_LEVEL2</a>, circuit, ssnpa);
<a name="l01741"></a>01741       <span class="keywordflow">break</span>;
<a name="l01742"></a>01742     <span class="keywordflow">case</span> <a class="code" href="isis__pdu_8h.html#ac01a71c9cb0d66d483f5022d9812b4db">P2P_HELLO</a>:
<a name="l01743"></a>01743       retval = <a class="code" href="isis__pdu_8c.html#ae1ed5a5e3ac93396b812ac8d35186073">process_p2p_hello</a> (circuit);
<a name="l01744"></a>01744       <span class="keywordflow">break</span>;
<a name="l01745"></a>01745     <span class="keywordflow">case</span> <a class="code" href="isis__pdu_8h.html#a37bd70be235d213245350209287f9d69">L1_LINK_STATE</a>:
<a name="l01746"></a>01746       retval = <a class="code" href="isis__pdu_8c.html#aa15bc068c8e49090fcf9268028d4fb03">process_lsp</a> (<a class="code" href="isis__constants_8h.html#a07d8effa4d110dfe9ed04bf051e6ebab">ISIS_LEVEL1</a>, circuit, ssnpa);
<a name="l01747"></a>01747       <span class="keywordflow">break</span>;
<a name="l01748"></a>01748     <span class="keywordflow">case</span> <a class="code" href="isis__pdu_8h.html#a0078daf40d7e45a7bdbd26a016dde2da">L2_LINK_STATE</a>:
<a name="l01749"></a>01749       retval = <a class="code" href="isis__pdu_8c.html#aa15bc068c8e49090fcf9268028d4fb03">process_lsp</a> (<a class="code" href="isis__constants_8h.html#ad8502b655a001bf61391e956a316ffc2">ISIS_LEVEL2</a>, circuit, ssnpa);
<a name="l01750"></a>01750       <span class="keywordflow">break</span>;
<a name="l01751"></a>01751     <span class="keywordflow">case</span> <a class="code" href="isis__pdu_8h.html#acd69d37ac6c82a2f79d1790b258f35b4">L1_COMPLETE_SEQ_NUM</a>:
<a name="l01752"></a>01752       retval = <a class="code" href="isis__pdu_8c.html#aae34abef6549bb3917ee120cb846bb41">process_csnp</a> (<a class="code" href="isis__constants_8h.html#a07d8effa4d110dfe9ed04bf051e6ebab">ISIS_LEVEL1</a>, circuit, ssnpa);
<a name="l01753"></a>01753       <span class="keywordflow">break</span>;
<a name="l01754"></a>01754     <span class="keywordflow">case</span> <a class="code" href="isis__pdu_8h.html#a56e28262496597ee720d611b16040847">L2_COMPLETE_SEQ_NUM</a>:
<a name="l01755"></a>01755       retval = <a class="code" href="isis__pdu_8c.html#aae34abef6549bb3917ee120cb846bb41">process_csnp</a> (<a class="code" href="isis__constants_8h.html#ad8502b655a001bf61391e956a316ffc2">ISIS_LEVEL2</a>, circuit, ssnpa);
<a name="l01756"></a>01756       <span class="keywordflow">break</span>;
<a name="l01757"></a>01757     <span class="keywordflow">case</span> <a class="code" href="isis__pdu_8h.html#acb5235709fbb83fee17285736e47f228">L1_PARTIAL_SEQ_NUM</a>:
<a name="l01758"></a>01758       retval = <a class="code" href="isis__pdu_8c.html#a4341127ac99b45c32f8f35aa8bc277df">process_psnp</a> (<a class="code" href="isis__constants_8h.html#a07d8effa4d110dfe9ed04bf051e6ebab">ISIS_LEVEL1</a>, circuit, ssnpa);
<a name="l01759"></a>01759       <span class="keywordflow">break</span>;
<a name="l01760"></a>01760     <span class="keywordflow">case</span> <a class="code" href="isis__pdu_8h.html#a711a885da413c85c2add3efefec3a69f">L2_PARTIAL_SEQ_NUM</a>:
<a name="l01761"></a>01761       retval = <a class="code" href="isis__pdu_8c.html#a4341127ac99b45c32f8f35aa8bc277df">process_psnp</a> (<a class="code" href="isis__constants_8h.html#ad8502b655a001bf61391e956a316ffc2">ISIS_LEVEL2</a>, circuit, ssnpa);
<a name="l01762"></a>01762       <span class="keywordflow">break</span>;
<a name="l01763"></a>01763     <span class="keywordflow">default</span>:
<a name="l01764"></a>01764       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#ac694b0bd16857a3d50deea71f78e8b7f">ISIS_ERROR</a>;
<a name="l01765"></a>01765     }
<a name="l01766"></a>01766 
<a name="l01767"></a>01767   <span class="keywordflow">return</span> retval;
<a name="l01768"></a>01768 }
<a name="l01769"></a>01769 
<a name="l01770"></a>01770 <span class="preprocessor">#ifdef GNU_LINUX</span>
<a name="l01771"></a>01771 <span class="preprocessor"></span><span class="keywordtype">int</span>
<a name="l01772"></a>01772 <a class="code" href="isis__pdu_8c.html#a75016a6ce480bc69cba2753bce7c52e1">isis_receive</a> (<span class="keyword">struct</span> <a class="code" href="structthread.html">thread</a> *<a class="code" href="structthread.html">thread</a>)
<a name="l01773"></a>01773 {
<a name="l01774"></a>01774   <span class="keyword">struct </span><a class="code" href="structisis__circuit.html">isis_circuit</a> *circuit;
<a name="l01775"></a>01775   u_char ssnpa[<a class="code" href="isis__constants_8h.html#a9822d89774e0d6ddaa06503950130423">ETH_ALEN</a>];
<a name="l01776"></a>01776   <span class="keywordtype">int</span> retval;
<a name="l01777"></a>01777 
<a name="l01778"></a>01778   <span class="comment">/*</span>
<a name="l01779"></a>01779 <span class="comment">   * Get the circuit </span>
<a name="l01780"></a>01780 <span class="comment">   */</span>
<a name="l01781"></a>01781   circuit = <a class="code" href="thread_8h.html#a78f2ae47a7a334f7f74bfed7fda48e5a">THREAD_ARG</a> (thread);
<a name="l01782"></a>01782   <a class="code" href="regex_8c.html#ad6d5aaa966ca7424f7cb9bd01f2c838b">assert</a> (circuit);
<a name="l01783"></a>01783 
<a name="l01784"></a>01784   <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a> == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01785"></a>01785     circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a> = <a class="code" href="stream_8c.html#a7117cdad9fa5e5ae633e0cf08d047459">stream_new</a> (<a class="code" href="isis__constants_8h.html#aa507eb18af6ca6d6db6e3db750ab0737">ISO_MTU</a> (circuit));
<a name="l01786"></a>01786   <span class="keywordflow">else</span>
<a name="l01787"></a>01787     <a class="code" href="stream_8c.html#aee8fd31485ebc2f0a556a6a5d5c2d1e6">stream_reset</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>);
<a name="l01788"></a>01788 
<a name="l01789"></a>01789   retval = circuit-&gt;<a class="code" href="structisis__circuit.html#ae53bfd73cd6f9a69f392c645c4ccce7c">rx</a> (circuit, ssnpa);
<a name="l01790"></a>01790   circuit-&gt;<a class="code" href="structisis__circuit.html#afa7165030b312ae2ce406ec15a4624df">t_read</a> = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01791"></a>01791 
<a name="l01792"></a>01792   <span class="keywordflow">if</span> (retval == <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>)
<a name="l01793"></a>01793     retval = <a class="code" href="isis__pdu_8c.html#acb5f4492a8f9bb27a780ebfe97934e85">isis_handle_pdu</a> (circuit, ssnpa);
<a name="l01794"></a>01794 
<a name="l01795"></a>01795   <span class="comment">/* </span>
<a name="l01796"></a>01796 <span class="comment">   * prepare for next packet. </span>
<a name="l01797"></a>01797 <span class="comment">   */</span>
<a name="l01798"></a>01798   <a class="code" href="thread_8h.html#aa1c80a0def008e6c3439baa8b49a1dab">THREAD_READ_ON</a> (master, circuit-&gt;<a class="code" href="structisis__circuit.html#afa7165030b312ae2ce406ec15a4624df">t_read</a>, <a class="code" href="isis__pdu_8c.html#a75016a6ce480bc69cba2753bce7c52e1">isis_receive</a>, circuit,
<a name="l01799"></a>01799           circuit-&gt;<a class="code" href="structisis__circuit.html#a2fa1849a71a356f206776c2329f27dbc">fd</a>);
<a name="l01800"></a>01800 
<a name="l01801"></a>01801   <span class="keywordflow">return</span> retval;
<a name="l01802"></a>01802 }
<a name="l01803"></a>01803 
<a name="l01804"></a>01804 <span class="preprocessor">#else</span>
<a name="l01805"></a>01805 <span class="preprocessor"></span><span class="keywordtype">int</span>
<a name="l01806"></a><a class="code" href="isis__pdu_8h.html#a75016a6ce480bc69cba2753bce7c52e1">01806</a> <a class="code" href="isis__pdu_8c.html#a75016a6ce480bc69cba2753bce7c52e1">isis_receive</a> (<span class="keyword">struct</span> thread *thread)
<a name="l01807"></a>01807 {
<a name="l01808"></a>01808   <span class="keyword">struct </span><a class="code" href="structisis__circuit.html">isis_circuit</a> *circuit;
<a name="l01809"></a>01809   u_char ssnpa[<a class="code" href="isis__constants_8h.html#a9822d89774e0d6ddaa06503950130423">ETH_ALEN</a>];
<a name="l01810"></a>01810   <span class="keywordtype">int</span> retval;
<a name="l01811"></a>01811 
<a name="l01812"></a>01812   <span class="comment">/*</span>
<a name="l01813"></a>01813 <span class="comment">   * Get the circuit </span>
<a name="l01814"></a>01814 <span class="comment">   */</span>
<a name="l01815"></a>01815   circuit = <a class="code" href="thread_8h.html#a78f2ae47a7a334f7f74bfed7fda48e5a">THREAD_ARG</a> (thread);
<a name="l01816"></a>01816   <a class="code" href="regex_8c.html#ad6d5aaa966ca7424f7cb9bd01f2c838b">assert</a> (circuit);
<a name="l01817"></a>01817 
<a name="l01818"></a>01818   circuit-&gt;<a class="code" href="structisis__circuit.html#afa7165030b312ae2ce406ec15a4624df">t_read</a> = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01819"></a>01819 
<a name="l01820"></a>01820   <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a> == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01821"></a>01821     circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a> = <a class="code" href="stream_8c.html#a7117cdad9fa5e5ae633e0cf08d047459">stream_new</a> (<a class="code" href="isis__constants_8h.html#aa507eb18af6ca6d6db6e3db750ab0737">ISO_MTU</a> (circuit));
<a name="l01822"></a>01822   <span class="keywordflow">else</span>
<a name="l01823"></a>01823     <a class="code" href="stream_8c.html#aee8fd31485ebc2f0a556a6a5d5c2d1e6">stream_reset</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#abc0c4c6484b34715228b6811f442f9aa">rcv_stream</a>);
<a name="l01824"></a>01824 
<a name="l01825"></a>01825   retval = circuit-&gt;<a class="code" href="structisis__circuit.html#ae53bfd73cd6f9a69f392c645c4ccce7c">rx</a> (circuit, ssnpa);
<a name="l01826"></a>01826 
<a name="l01827"></a>01827   <span class="keywordflow">if</span> (retval == <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>)
<a name="l01828"></a>01828     retval = <a class="code" href="isis__pdu_8c.html#acb5f4492a8f9bb27a780ebfe97934e85">isis_handle_pdu</a> (circuit, ssnpa);
<a name="l01829"></a>01829 
<a name="l01830"></a>01830   <span class="comment">/* </span>
<a name="l01831"></a>01831 <span class="comment">   * prepare for next packet. </span>
<a name="l01832"></a>01832 <span class="comment">   */</span>
<a name="l01833"></a>01833   circuit-&gt;<a class="code" href="structisis__circuit.html#afa7165030b312ae2ce406ec15a4624df">t_read</a> = <a class="code" href="thread_8h.html#a9231be4b08f04f6ebc1bea080443ba74">thread_add_timer_msec</a> (master, <a class="code" href="isis__pdu_8c.html#a75016a6ce480bc69cba2753bce7c52e1">isis_receive</a>, circuit,
<a name="l01834"></a>01834                        <a class="code" href="linklist_8h.html#a0429e6385b31a314cc64432a906201e5">listcount</a>
<a name="l01835"></a>01835                        (circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#a1ef8753b22245b7d8fff0331deef3b21">circuit_list</a>) *
<a name="l01836"></a>01836                        100);
<a name="l01837"></a>01837 
<a name="l01838"></a>01838   <span class="keywordflow">return</span> retval;
<a name="l01839"></a>01839 }
<a name="l01840"></a>01840 
<a name="l01841"></a>01841 <span class="preprocessor">#endif</span>
<a name="l01842"></a>01842 <span class="preprocessor"></span>
<a name="l01843"></a>01843  <span class="comment">/* filling of the fixed isis header */</span>
<a name="l01844"></a>01844 <span class="keywordtype">void</span>
<a name="l01845"></a><a class="code" href="isis__pdu_8h.html#a5bb1429f6b41964f060f6abbfb50b5bf">01845</a> <a class="code" href="isis__pdu_8c.html#a5bb1429f6b41964f060f6abbfb50b5bf">fill_fixed_hdr</a> (<span class="keyword">struct</span> <a class="code" href="structisis__fixed__hdr.html">isis_fixed_hdr</a> *hdr, u_char <a class="code" href="isis__pdu_8h.html#a171cfddbd6dabd8e34fb43da9912c3ca">pdu_type</a>)
<a name="l01846"></a>01846 {
<a name="l01847"></a>01847   memset (hdr, 0, <span class="keyword">sizeof</span> (<span class="keyword">struct</span> <a class="code" href="structisis__fixed__hdr.html">isis_fixed_hdr</a>));
<a name="l01848"></a>01848 
<a name="l01849"></a>01849   hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#ab7d3a92cb745fd25d033e0daefca7f74">idrp</a> = <a class="code" href="iso_8h.html#a5246f338b99d70bb67f26fdbf2c25c8b">ISO10589_ISIS</a>;
<a name="l01850"></a>01850 
<a name="l01851"></a>01851   <span class="keywordflow">switch</span> (pdu_type)
<a name="l01852"></a>01852     {
<a name="l01853"></a>01853     <span class="keywordflow">case</span> <a class="code" href="isis__pdu_8h.html#aaecfaf101078595ebfeed0bd1740932b">L1_LAN_HELLO</a>:
<a name="l01854"></a>01854     <span class="keywordflow">case</span> <a class="code" href="isis__pdu_8h.html#af62a8d7593e2fabd396e8dce9124d09d">L2_LAN_HELLO</a>:
<a name="l01855"></a>01855       hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#acde2c4eefcd9af9aef447b106383b03e">length</a> = <a class="code" href="isis__pdu_8h.html#ae252f7eb62c9ee4fd050d82558623d39">ISIS_LANHELLO_HDRLEN</a>;
<a name="l01856"></a>01856       <span class="keywordflow">break</span>;
<a name="l01857"></a>01857     <span class="keywordflow">case</span> <a class="code" href="isis__pdu_8h.html#ac01a71c9cb0d66d483f5022d9812b4db">P2P_HELLO</a>:
<a name="l01858"></a>01858       hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#acde2c4eefcd9af9aef447b106383b03e">length</a> = <a class="code" href="isis__pdu_8h.html#afc57a4bb656d257caa10f6a172006cd1">ISIS_P2PHELLO_HDRLEN</a>;
<a name="l01859"></a>01859       <span class="keywordflow">break</span>;
<a name="l01860"></a>01860     <span class="keywordflow">case</span> <a class="code" href="isis__pdu_8h.html#a37bd70be235d213245350209287f9d69">L1_LINK_STATE</a>:
<a name="l01861"></a>01861     <span class="keywordflow">case</span> <a class="code" href="isis__pdu_8h.html#a0078daf40d7e45a7bdbd26a016dde2da">L2_LINK_STATE</a>:
<a name="l01862"></a>01862       hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#acde2c4eefcd9af9aef447b106383b03e">length</a> = <a class="code" href="isis__pdu_8h.html#ac44728d163f3b54838fd7e03acf7c3f7">ISIS_LSP_HDR_LEN</a>;
<a name="l01863"></a>01863       <span class="keywordflow">break</span>;
<a name="l01864"></a>01864     <span class="keywordflow">case</span> <a class="code" href="isis__pdu_8h.html#acd69d37ac6c82a2f79d1790b258f35b4">L1_COMPLETE_SEQ_NUM</a>:
<a name="l01865"></a>01865     <span class="keywordflow">case</span> <a class="code" href="isis__pdu_8h.html#a56e28262496597ee720d611b16040847">L2_COMPLETE_SEQ_NUM</a>:
<a name="l01866"></a>01866       hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#acde2c4eefcd9af9aef447b106383b03e">length</a> = <a class="code" href="isis__pdu_8h.html#ad643847e4f6bb080e2e6359abcad1c15">ISIS_CSNP_HDRLEN</a>;
<a name="l01867"></a>01867       <span class="keywordflow">break</span>;
<a name="l01868"></a>01868     <span class="keywordflow">case</span> <a class="code" href="isis__pdu_8h.html#acb5235709fbb83fee17285736e47f228">L1_PARTIAL_SEQ_NUM</a>:
<a name="l01869"></a>01869     <span class="keywordflow">case</span> <a class="code" href="isis__pdu_8h.html#a711a885da413c85c2add3efefec3a69f">L2_PARTIAL_SEQ_NUM</a>:
<a name="l01870"></a>01870       hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#acde2c4eefcd9af9aef447b106383b03e">length</a> = <a class="code" href="isis__pdu_8h.html#aceab21fb8507148277e0980a0cd31a1e">ISIS_PSNP_HDRLEN</a>;
<a name="l01871"></a>01871       <span class="keywordflow">break</span>;
<a name="l01872"></a>01872     <span class="keywordflow">default</span>:
<a name="l01873"></a>01873       <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;fill_fixed_hdr(): unknown pdu type %d&quot;</span>, pdu_type);
<a name="l01874"></a>01874       <span class="keywordflow">return</span>;
<a name="l01875"></a>01875     }
<a name="l01876"></a>01876   hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#acde2c4eefcd9af9aef447b106383b03e">length</a> += <a class="code" href="isis__pdu_8h.html#a61f100919f790014bded41907b477263">ISIS_FIXED_HDR_LEN</a>;
<a name="l01877"></a>01877   hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#a6e0886d9e411e4f4ab9de644af8ee034">pdu_type</a> = <a class="code" href="isis__pdu_8h.html#a171cfddbd6dabd8e34fb43da9912c3ca">pdu_type</a>;
<a name="l01878"></a>01878   hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#aae65a4fef2c1f3f7f5601da9fe5491c3">version1</a> = 1;
<a name="l01879"></a>01879   hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#adbac4c42a022759367d1fd9a1fdb40f7">id_len</a> = 0;      <span class="comment">/* ISIS_SYS_ID_LEN -  0==6 */</span>
<a name="l01880"></a>01880   hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#ab0240202f6415d4ad641b692615ed1eb">version2</a> = 1;
<a name="l01881"></a>01881   hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#abf027a2ccc2b29a6b36cae277894f7c3">max_area_addrs</a> = 0;  <span class="comment">/* isis-&gt;max_area_addrs -  0==3 */</span>
<a name="l01882"></a>01882 }
<a name="l01883"></a>01883 
<a name="l01884"></a>01884 <span class="comment">/*</span>
<a name="l01885"></a>01885 <span class="comment"> * SEND SIDE                             </span>
<a name="l01886"></a>01886 <span class="comment"> */</span>
<a name="l01887"></a>01887 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01888"></a><a class="code" href="isis__pdu_8c.html#adec6ead19bda8ae8f106249935b71552">01888</a> <a class="code" href="isis__pdu_8c.html#adec6ead19bda8ae8f106249935b71552">fill_fixed_hdr_andstream</a> (<span class="keyword">struct</span> <a class="code" href="structisis__fixed__hdr.html">isis_fixed_hdr</a> *hdr, u_char <a class="code" href="isis__pdu_8h.html#a171cfddbd6dabd8e34fb43da9912c3ca">pdu_type</a>,
<a name="l01889"></a>01889               <span class="keyword">struct</span> <a class="code" href="structstream.html">stream</a> *<a class="code" href="structstream.html">stream</a>)
<a name="l01890"></a>01890 {
<a name="l01891"></a>01891   <a class="code" href="isis__pdu_8c.html#a5bb1429f6b41964f060f6abbfb50b5bf">fill_fixed_hdr</a> (hdr, pdu_type);
<a name="l01892"></a>01892 
<a name="l01893"></a>01893   <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (stream, hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#ab7d3a92cb745fd25d033e0daefca7f74">idrp</a>);
<a name="l01894"></a>01894   <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (stream, hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#acde2c4eefcd9af9aef447b106383b03e">length</a>);
<a name="l01895"></a>01895   <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (stream, hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#aae65a4fef2c1f3f7f5601da9fe5491c3">version1</a>);
<a name="l01896"></a>01896   <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (stream, hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#adbac4c42a022759367d1fd9a1fdb40f7">id_len</a>);
<a name="l01897"></a>01897   <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (stream, hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#a6e0886d9e411e4f4ab9de644af8ee034">pdu_type</a>);
<a name="l01898"></a>01898   <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (stream, hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#ab0240202f6415d4ad641b692615ed1eb">version2</a>);
<a name="l01899"></a>01899   <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (stream, hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#a4291f7b81ea45e9f30bf6c05f3190ed7">reserved</a>);
<a name="l01900"></a>01900   <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (stream, hdr-&gt;<a class="code" href="structisis__fixed__hdr.html#abf027a2ccc2b29a6b36cae277894f7c3">max_area_addrs</a>);
<a name="l01901"></a>01901 
<a name="l01902"></a>01902   <span class="keywordflow">return</span>;
<a name="l01903"></a>01903 }
<a name="l01904"></a>01904 
<a name="l01905"></a>01905 <span class="keywordtype">int</span>
<a name="l01906"></a><a class="code" href="isis__pdu_8h.html#ada46fc1940683eac5a47249f80f865b5">01906</a> <a class="code" href="isis__pdu_8c.html#ada46fc1940683eac5a47249f80f865b5">send_hello</a> (<span class="keyword">struct</span> <a class="code" href="structisis__circuit.html">isis_circuit</a> *circuit, <span class="keywordtype">int</span> level)
<a name="l01907"></a>01907 {
<a name="l01908"></a>01908   <span class="keyword">struct </span><a class="code" href="structisis__fixed__hdr.html">isis_fixed_hdr</a> fixed_hdr;
<a name="l01909"></a>01909   <span class="keyword">struct </span><a class="code" href="structisis__lan__hello__hdr.html">isis_lan_hello_hdr</a> hello_hdr;
<a name="l01910"></a>01910   <span class="keyword">struct </span><a class="code" href="structisis__p2p__hello__hdr.html">isis_p2p_hello_hdr</a> p2p_hello_hdr;
<a name="l01911"></a>01911 
<a name="l01912"></a>01912   u_int32_t <a class="code" href="isis__circuit_8c.html#a900b5f9651c07bafd5d81cc876b93885">interval</a>;
<a name="l01913"></a>01913   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> len_pointer, <a class="code" href="isis__pdu_8h.html#a64ed70bbcb4536e2af22a1aaf5209d18">length</a>;
<a name="l01914"></a>01914   <span class="keywordtype">int</span> retval;
<a name="l01915"></a>01915 
<a name="l01916"></a>01916   <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#ab03cac6463284a4ce8c1eb19e49f3b6d">interface</a>-&gt;<a class="code" href="structinterface.html#aadd24df2d261a3bfcbdfe4797e639afb">mtu</a> == 0)
<a name="l01917"></a>01917     {
<a name="l01918"></a>01918       <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;circuit has zero MTU&quot;</span>);
<a name="l01919"></a>01919       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;
<a name="l01920"></a>01920     }
<a name="l01921"></a>01921 
<a name="l01922"></a>01922   <span class="keywordflow">if</span> (!circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>)
<a name="l01923"></a>01923     circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a> = <a class="code" href="stream_8c.html#a7117cdad9fa5e5ae633e0cf08d047459">stream_new</a> (<a class="code" href="isis__constants_8h.html#aa507eb18af6ca6d6db6e3db750ab0737">ISO_MTU</a> (circuit));
<a name="l01924"></a>01924   <span class="keywordflow">else</span>
<a name="l01925"></a>01925     <a class="code" href="stream_8c.html#aee8fd31485ebc2f0a556a6a5d5c2d1e6">stream_reset</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>);
<a name="l01926"></a>01926 
<a name="l01927"></a>01927   <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a569e39bbf7fafd533eae2eeafa671b8c">circ_type</a> == <a class="code" href="isis__circuit_8h.html#a01a94c5f24c88efb64f791a749ae8f95">CIRCUIT_T_BROADCAST</a>)
<a name="l01928"></a>01928     <span class="keywordflow">if</span> (level == 1)
<a name="l01929"></a>01929       <a class="code" href="isis__pdu_8c.html#adec6ead19bda8ae8f106249935b71552">fill_fixed_hdr_andstream</a> (&amp;fixed_hdr, <a class="code" href="isis__pdu_8h.html#aaecfaf101078595ebfeed0bd1740932b">L1_LAN_HELLO</a>,
<a name="l01930"></a>01930                 circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>);
<a name="l01931"></a>01931     <span class="keywordflow">else</span>
<a name="l01932"></a>01932       <a class="code" href="isis__pdu_8c.html#adec6ead19bda8ae8f106249935b71552">fill_fixed_hdr_andstream</a> (&amp;fixed_hdr, <a class="code" href="isis__pdu_8h.html#af62a8d7593e2fabd396e8dce9124d09d">L2_LAN_HELLO</a>,
<a name="l01933"></a>01933                 circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>);
<a name="l01934"></a>01934   <span class="keywordflow">else</span>
<a name="l01935"></a>01935     <a class="code" href="isis__pdu_8c.html#adec6ead19bda8ae8f106249935b71552">fill_fixed_hdr_andstream</a> (&amp;fixed_hdr, <a class="code" href="isis__pdu_8h.html#ac01a71c9cb0d66d483f5022d9812b4db">P2P_HELLO</a>, circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>);
<a name="l01936"></a>01936 
<a name="l01937"></a>01937   <span class="comment">/*</span>
<a name="l01938"></a>01938 <span class="comment">   * Fill LAN Level 1 or 2 Hello PDU header</span>
<a name="l01939"></a>01939 <span class="comment">   */</span>
<a name="l01940"></a>01940   memset (&amp;hello_hdr, 0, <span class="keyword">sizeof</span> (<span class="keyword">struct</span> <a class="code" href="structisis__lan__hello__hdr.html">isis_lan_hello_hdr</a>));
<a name="l01941"></a>01941   interval = circuit-&gt;<a class="code" href="structisis__circuit.html#a9af263fd35717a7f759e4a0cf2fd1a2b">hello_multiplier</a>[level - 1] *
<a name="l01942"></a>01942     circuit-&gt;<a class="code" href="structisis__circuit.html#a7edd39f2abe11ecbbd758dc1a0d3f8c0">hello_interval</a>[level - 1];
<a name="l01943"></a>01943   <span class="keywordflow">if</span> (interval &gt; USHRT_MAX)
<a name="l01944"></a>01944     interval = USHRT_MAX;
<a name="l01945"></a>01945   hello_hdr.<a class="code" href="structisis__lan__hello__hdr.html#adc05838604616cf54cd1a3da59d9fb54">circuit_t</a> = circuit-&gt;<a class="code" href="structisis__circuit.html#ab222d6d0b054faa159d72bcb9768b3fb">circuit_is_type</a>;
<a name="l01946"></a>01946   <a class="code" href="regex_8c.html#aed653b4838032a2c5ce8960421c8cfd7">memcpy</a> (hello_hdr.<a class="code" href="structisis__lan__hello__hdr.html#ace215b4fc901e21a973560b1a6562a69">source_id</a>, isis-&gt;<a class="code" href="structisis.html#a769d4d051a0f424e8c0568b4eeef748e">sysid</a>, <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a>);
<a name="l01947"></a>01947   hello_hdr.<a class="code" href="structisis__lan__hello__hdr.html#ab077a36b5a5430debe28b04bf25964a2">hold_time</a> = htons ((u_int16_t) interval);
<a name="l01948"></a>01948 
<a name="l01949"></a>01949   hello_hdr.<a class="code" href="structisis__lan__hello__hdr.html#aed1e2c349dadd95f0cc3211e0498ea81">pdu_len</a> = 0;    <span class="comment">/* Update the PDU Length later */</span>
<a name="l01950"></a>01950   len_pointer = <a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>) + 3 + <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a>;
<a name="l01951"></a>01951 
<a name="l01952"></a>01952   <span class="comment">/* copy the shared part of the hello to the p2p hello if needed */</span>
<a name="l01953"></a>01953   <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a569e39bbf7fafd533eae2eeafa671b8c">circ_type</a> == <a class="code" href="isis__circuit_8h.html#aa2113a49e7c75a5d4997d59df0530726">CIRCUIT_T_P2P</a>)
<a name="l01954"></a>01954     {
<a name="l01955"></a>01955       <a class="code" href="regex_8c.html#aed653b4838032a2c5ce8960421c8cfd7">memcpy</a> (&amp;p2p_hello_hdr, &amp;hello_hdr, 5 + <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a>);
<a name="l01956"></a>01956       p2p_hello_hdr.<a class="code" href="structisis__p2p__hello__hdr.html#a48c0804078fc1ef85b0b3f64a9c939db">local_id</a> = circuit-&gt;<a class="code" href="structisis__circuit.html#a10453f6bcc1e8f1cb466240a81836ba9">circuit_id</a>;
<a name="l01957"></a>01957       <span class="comment">/* FIXME: need better understanding */</span>
<a name="l01958"></a>01958       <a class="code" href="stream_8c.html#a2f540a71efdf46e8c3a923f73e9f3b73">stream_put</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>, &amp;p2p_hello_hdr, <a class="code" href="isis__pdu_8h.html#afc57a4bb656d257caa10f6a172006cd1">ISIS_P2PHELLO_HDRLEN</a>);
<a name="l01959"></a>01959     }
<a name="l01960"></a>01960   <span class="keywordflow">else</span>
<a name="l01961"></a>01961     {
<a name="l01962"></a>01962       hello_hdr.<a class="code" href="structisis__lan__hello__hdr.html#a72f900765ed3b6306511055bee3582b2">prio</a> = circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#a9087f16298d7bbf26ac8b480c932ab8d">priority</a>[level - 1];
<a name="l01963"></a>01963       <span class="keywordflow">if</span> (level == 1 &amp;&amp; circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#a015b72bf5854d99b722f9f599b9eb158">l1_desig_is</a>)
<a name="l01964"></a>01964     {
<a name="l01965"></a>01965       <a class="code" href="regex_8c.html#aed653b4838032a2c5ce8960421c8cfd7">memcpy</a> (hello_hdr.<a class="code" href="structisis__lan__hello__hdr.html#a57b120a4bcafd36b80b2719061547349">lan_id</a>, circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#a015b72bf5854d99b722f9f599b9eb158">l1_desig_is</a>,
<a name="l01966"></a>01966           <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a> + 1);
<a name="l01967"></a>01967     }
<a name="l01968"></a>01968       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (level == 2 &amp;&amp; circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#a2bde5462284eb2b294ed998fb5907de8">l2_desig_is</a>)
<a name="l01969"></a>01969     {
<a name="l01970"></a>01970       <a class="code" href="regex_8c.html#aed653b4838032a2c5ce8960421c8cfd7">memcpy</a> (hello_hdr.<a class="code" href="structisis__lan__hello__hdr.html#a57b120a4bcafd36b80b2719061547349">lan_id</a>, circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#a2bde5462284eb2b294ed998fb5907de8">l2_desig_is</a>,
<a name="l01971"></a>01971           <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a> + 1);
<a name="l01972"></a>01972     }
<a name="l01973"></a>01973       <a class="code" href="stream_8c.html#a2f540a71efdf46e8c3a923f73e9f3b73">stream_put</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>, &amp;hello_hdr, <a class="code" href="isis__pdu_8h.html#ae252f7eb62c9ee4fd050d82558623d39">ISIS_LANHELLO_HDRLEN</a>);
<a name="l01974"></a>01974     }
<a name="l01975"></a>01975 
<a name="l01976"></a>01976   <span class="comment">/*</span>
<a name="l01977"></a>01977 <span class="comment">   * Then the variable length part </span>
<a name="l01978"></a>01978 <span class="comment">   */</span>
<a name="l01979"></a>01979   <span class="comment">/* add circuit password */</span>
<a name="l01980"></a>01980   <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a601d2b4b3220757f8f7212f2a1628ab2">passwd</a>.<a class="code" href="structisis__passwd.html#a874984e0745fbcb41df9f463d831be67">type</a>)
<a name="l01981"></a>01981     <span class="keywordflow">if</span> (<a class="code" href="isis__tlv_8c.html#a02f053566530986751054dcf500af3a9">tlv_add_authinfo</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a601d2b4b3220757f8f7212f2a1628ab2">passwd</a>.<a class="code" href="structisis__passwd.html#a874984e0745fbcb41df9f463d831be67">type</a>, circuit-&gt;<a class="code" href="structisis__circuit.html#a601d2b4b3220757f8f7212f2a1628ab2">passwd</a>.<a class="code" href="structisis__passwd.html#a3981443a6501783995b003ab8fd82f48">len</a>,
<a name="l01982"></a>01982               circuit-&gt;<a class="code" href="structisis__circuit.html#a601d2b4b3220757f8f7212f2a1628ab2">passwd</a>.<a class="code" href="structisis__passwd.html#a4af92e1126df2d7d2abeef451c082567">passwd</a>, circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>))
<a name="l01983"></a>01983       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;
<a name="l01984"></a>01984   <span class="comment">/*  Area Addresses TLV */</span>
<a name="l01985"></a>01985   <a class="code" href="regex_8c.html#ad6d5aaa966ca7424f7cb9bd01f2c838b">assert</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>);
<a name="l01986"></a>01986   <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aca1436df894da89fb83d7924ef248397">area_addrs</a> &amp;&amp; circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aca1436df894da89fb83d7924ef248397">area_addrs</a>-&gt;<a class="code" href="structlist.html#ac9c4d4d7c65e726bd9ee0c8884b6349b">count</a> &gt; 0)
<a name="l01987"></a>01987     <span class="keywordflow">if</span> (<a class="code" href="isis__tlv_8c.html#abd5c4be878c3cab41e46d107480f433e">tlv_add_area_addrs</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aca1436df894da89fb83d7924ef248397">area_addrs</a>, circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>))
<a name="l01988"></a>01988       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;
<a name="l01989"></a>01989 
<a name="l01990"></a>01990   <span class="comment">/*  LAN Neighbors TLV */</span>
<a name="l01991"></a>01991   <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a569e39bbf7fafd533eae2eeafa671b8c">circ_type</a> == <a class="code" href="isis__circuit_8h.html#a01a94c5f24c88efb64f791a749ae8f95">CIRCUIT_T_BROADCAST</a>)
<a name="l01992"></a>01992     {
<a name="l01993"></a>01993       <span class="keywordflow">if</span> (level == 1 &amp;&amp; circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#a1a8b5b8fcf6defb0b21b509d99953742">lan_neighs</a>[0]-&gt;<a class="code" href="structlist.html#ac9c4d4d7c65e726bd9ee0c8884b6349b">count</a> &gt; 0)
<a name="l01994"></a>01994     <span class="keywordflow">if</span> (<a class="code" href="isis__tlv_8c.html#af413f4244b14abcd0bd1a9f01784b979">tlv_add_lan_neighs</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#a1a8b5b8fcf6defb0b21b509d99953742">lan_neighs</a>[0],
<a name="l01995"></a>01995                 circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>))
<a name="l01996"></a>01996       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;
<a name="l01997"></a>01997       <span class="keywordflow">if</span> (level == 2 &amp;&amp; circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#a1a8b5b8fcf6defb0b21b509d99953742">lan_neighs</a>[1]-&gt;<a class="code" href="structlist.html#ac9c4d4d7c65e726bd9ee0c8884b6349b">count</a> &gt; 0)
<a name="l01998"></a>01998     <span class="keywordflow">if</span> (<a class="code" href="isis__tlv_8c.html#af413f4244b14abcd0bd1a9f01784b979">tlv_add_lan_neighs</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#a1a8b5b8fcf6defb0b21b509d99953742">lan_neighs</a>[1],
<a name="l01999"></a>01999                 circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>))
<a name="l02000"></a>02000       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;
<a name="l02001"></a>02001     }
<a name="l02002"></a>02002 
<a name="l02003"></a>02003   <span class="comment">/* Protocols Supported TLV */</span>
<a name="l02004"></a>02004   <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#aa9672d51825e67d22c772575a9d8624a">nlpids</a>.<a class="code" href="structnlpids.html#a73f0f5f1e7aa64694d5802b91af6533b">count</a> &gt; 0)
<a name="l02005"></a>02005     <span class="keywordflow">if</span> (<a class="code" href="isis__tlv_8c.html#ab4ebf52852b3eeb88bc641ce88d2657b">tlv_add_nlpid</a> (&amp;circuit-&gt;<a class="code" href="structisis__circuit.html#aa9672d51825e67d22c772575a9d8624a">nlpids</a>, circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>))
<a name="l02006"></a>02006       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;
<a name="l02007"></a>02007   <span class="comment">/* IP interface Address TLV */</span>
<a name="l02008"></a>02008   <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a9dbb2266ee5b76604a27fd0855e910f5">ip_router</a> &amp;&amp; circuit-&gt;<a class="code" href="structisis__circuit.html#adcde796f44a1e725abe092f95a6cb075">ip_addrs</a> &amp;&amp; circuit-&gt;<a class="code" href="structisis__circuit.html#adcde796f44a1e725abe092f95a6cb075">ip_addrs</a>-&gt;<a class="code" href="structlist.html#ac9c4d4d7c65e726bd9ee0c8884b6349b">count</a> &gt; 0)
<a name="l02009"></a>02009     <span class="keywordflow">if</span> (<a class="code" href="isis__tlv_8c.html#a53f64fb8ba8bcd845f37594d4132bb89">tlv_add_ip_addrs</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#adcde796f44a1e725abe092f95a6cb075">ip_addrs</a>, circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>))
<a name="l02010"></a>02010       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;
<a name="l02011"></a>02011 
<a name="l02012"></a>02012 <span class="preprocessor">#ifdef HAVE_IPV6</span>
<a name="l02013"></a>02013 <span class="preprocessor"></span>  <span class="comment">/* IPv6 Interface Address TLV */</span>
<a name="l02014"></a>02014   <span class="keywordflow">if</span> (circuit-&gt;ipv6_router &amp;&amp; circuit-&gt;ipv6_link &amp;&amp;
<a name="l02015"></a>02015       circuit-&gt;ipv6_link-&gt;count &gt; 0)
<a name="l02016"></a>02016     <span class="keywordflow">if</span> (tlv_add_ipv6_addrs (circuit-&gt;ipv6_link, circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>))
<a name="l02017"></a>02017       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;
<a name="l02018"></a>02018 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_IPV6 */</span>
<a name="l02019"></a>02019 
<a name="l02020"></a>02020   <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#a83676730231d3a5aad5d5914957a2b68">pad_hellos</a>)
<a name="l02021"></a>02021     <span class="keywordflow">if</span> (<a class="code" href="isis__tlv_8c.html#a182acd86508a8e8113496b2fe82501a6">tlv_add_padding</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>))
<a name="l02022"></a>02022       <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#a58479855936d63f1609867e2732ccb09">ISIS_WARNING</a>;
<a name="l02023"></a>02023 
<a name="l02024"></a>02024   length = <a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>);
<a name="l02025"></a>02025   <span class="comment">/* Update PDU length */</span>
<a name="l02026"></a>02026   <a class="code" href="stream_8c.html#a41de70a7383bac6220b787d740c0b261">stream_putw_at</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>, len_pointer, (u_int16_t) length);
<a name="l02027"></a>02027 
<a name="l02028"></a>02028   retval = circuit-&gt;<a class="code" href="structisis__circuit.html#af17faf994f21d75da89129ed100cb71d">tx</a> (circuit, level);
<a name="l02029"></a>02029   <span class="keywordflow">if</span> (retval)
<a name="l02030"></a>02030     <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;sending of LAN Level %d Hello failed&quot;</span>, level);
<a name="l02031"></a>02031 
<a name="l02032"></a>02032   <span class="comment">/* DEBUG_ADJ_PACKETS */</span>
<a name="l02033"></a>02033   <span class="keywordflow">if</span> (isis-&gt;<a class="code" href="structisis.html#a6e64127e274c1aa6a52cb0f4b541dfaa">debugs</a> &amp; <a class="code" href="isisd_8h.html#a4113d6aad857cfa148450dfc6ed85b5b">DEBUG_ADJ_PACKETS</a>)
<a name="l02034"></a>02034     {
<a name="l02035"></a>02035       <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a569e39bbf7fafd533eae2eeafa671b8c">circ_type</a> == <a class="code" href="isis__circuit_8h.html#a01a94c5f24c88efb64f791a749ae8f95">CIRCUIT_T_BROADCAST</a>)
<a name="l02036"></a>02036     {
<a name="l02037"></a>02037       <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;ISIS-Adj (%s): Sent L%d LAN IIH on %s, length %ld&quot;</span>,
<a name="l02038"></a>02038               circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>, level, circuit-&gt;<a class="code" href="structisis__circuit.html#ab03cac6463284a4ce8c1eb19e49f3b6d">interface</a>-&gt;<a class="code" href="structinterface.html#a98cadce768ec5aacb4c5fc4ca2c3eaa8">name</a>,
<a name="l02039"></a>02039               <span class="comment">/* FIXME: use %z when we stop supporting old compilers. */</span>
<a name="l02040"></a>02040               (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) <a class="code" href="stream_8h.html#a6e3b6e25ed5cfa2faea8485414a0c1a4">STREAM_SIZE</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>));
<a name="l02041"></a>02041     }
<a name="l02042"></a>02042       <span class="keywordflow">else</span>
<a name="l02043"></a>02043     {
<a name="l02044"></a>02044       <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;ISIS-Adj (%s): Sent P2P IIH on %s, length %ld&quot;</span>,
<a name="l02045"></a>02045               circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>, circuit-&gt;<a class="code" href="structisis__circuit.html#ab03cac6463284a4ce8c1eb19e49f3b6d">interface</a>-&gt;<a class="code" href="structinterface.html#a98cadce768ec5aacb4c5fc4ca2c3eaa8">name</a>,
<a name="l02046"></a>02046               <span class="comment">/* FIXME: use %z when we stop supporting old compilers. */</span>
<a name="l02047"></a>02047               (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) <a class="code" href="stream_8h.html#a6e3b6e25ed5cfa2faea8485414a0c1a4">STREAM_SIZE</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>));
<a name="l02048"></a>02048     }
<a name="l02049"></a>02049     }
<a name="l02050"></a>02050 
<a name="l02051"></a>02051   <span class="keywordflow">return</span> retval;
<a name="l02052"></a>02052 }
<a name="l02053"></a>02053 
<a name="l02054"></a>02054 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02055"></a><a class="code" href="isis__pdu_8c.html#ad38fe669ff232d9720882e210d46781d">02055</a> <a class="code" href="isis__pdu_8c.html#ad38fe669ff232d9720882e210d46781d">send_lan_hello</a> (<span class="keyword">struct</span> <a class="code" href="structisis__circuit.html">isis_circuit</a> *circuit, <span class="keywordtype">int</span> level)
<a name="l02056"></a>02056 {
<a name="l02057"></a>02057   <span class="keywordflow">return</span> <a class="code" href="isis__pdu_8c.html#ada46fc1940683eac5a47249f80f865b5">send_hello</a> (circuit, level);
<a name="l02058"></a>02058 }
<a name="l02059"></a>02059 
<a name="l02060"></a>02060 <span class="keywordtype">int</span>
<a name="l02061"></a><a class="code" href="isis__pdu_8h.html#ac3719e0f27b001ab4b863944a14d2727">02061</a> <a class="code" href="isis__pdu_8c.html#ac3719e0f27b001ab4b863944a14d2727">send_lan_l1_hello</a> (<span class="keyword">struct</span> thread *thread)
<a name="l02062"></a>02062 {
<a name="l02063"></a>02063   <span class="keyword">struct </span><a class="code" href="structisis__circuit.html">isis_circuit</a> *circuit;
<a name="l02064"></a>02064   <span class="keywordtype">int</span> retval;
<a name="l02065"></a>02065 
<a name="l02066"></a>02066   circuit = <a class="code" href="thread_8h.html#a78f2ae47a7a334f7f74bfed7fda48e5a">THREAD_ARG</a> (thread);
<a name="l02067"></a>02067   <a class="code" href="regex_8c.html#ad6d5aaa966ca7424f7cb9bd01f2c838b">assert</a> (circuit);
<a name="l02068"></a>02068   circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#ae47a7d7fa924f3848bff4793fc250826">t_send_lan_hello</a>[0] = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02069"></a>02069 
<a name="l02070"></a>02070   <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#a0766cf32585b89b427a69cd8ad1c22fb">run_dr_elect</a>[0])
<a name="l02071"></a>02071     retval = <a class="code" href="isis__dr_8c.html#a35798a245595794b3cb07a6561e0499a">isis_dr_elect</a> (circuit, 1);
<a name="l02072"></a>02072 
<a name="l02073"></a>02073   retval = <a class="code" href="isis__pdu_8c.html#ad38fe669ff232d9720882e210d46781d">send_lan_hello</a> (circuit, 1);
<a name="l02074"></a>02074 
<a name="l02075"></a>02075   <span class="comment">/* set next timer thread */</span>
<a name="l02076"></a>02076   <a class="code" href="thread_8h.html#a898ebeae19eb435889cbf53ea8b5120e">THREAD_TIMER_ON</a> (master, circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#ae47a7d7fa924f3848bff4793fc250826">t_send_lan_hello</a>[0],
<a name="l02077"></a>02077            <a class="code" href="isis__pdu_8c.html#ac3719e0f27b001ab4b863944a14d2727">send_lan_l1_hello</a>, circuit,
<a name="l02078"></a>02078            <a class="code" href="isis__misc_8c.html#a177a75676b1916fefb4eb7275911fb6e">isis_jitter</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a7edd39f2abe11ecbbd758dc1a0d3f8c0">hello_interval</a>[0], <a class="code" href="isis__constants_8h.html#a05b53aafec81f1ae7ca52ad0aac5255c">IIH_JITTER</a>));
<a name="l02079"></a>02079 
<a name="l02080"></a>02080   <span class="keywordflow">return</span> retval;
<a name="l02081"></a>02081 }
<a name="l02082"></a>02082 
<a name="l02083"></a>02083 <span class="keywordtype">int</span>
<a name="l02084"></a><a class="code" href="isis__pdu_8h.html#a395c19db187c485c02eb41b63fc024ac">02084</a> <a class="code" href="isis__pdu_8c.html#a395c19db187c485c02eb41b63fc024ac">send_lan_l2_hello</a> (<span class="keyword">struct</span> thread *thread)
<a name="l02085"></a>02085 {
<a name="l02086"></a>02086   <span class="keyword">struct </span><a class="code" href="structisis__circuit.html">isis_circuit</a> *circuit;
<a name="l02087"></a>02087   <span class="keywordtype">int</span> retval;
<a name="l02088"></a>02088 
<a name="l02089"></a>02089   circuit = <a class="code" href="thread_8h.html#a78f2ae47a7a334f7f74bfed7fda48e5a">THREAD_ARG</a> (thread);
<a name="l02090"></a>02090   <a class="code" href="regex_8c.html#ad6d5aaa966ca7424f7cb9bd01f2c838b">assert</a> (circuit);
<a name="l02091"></a>02091   circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#ae47a7d7fa924f3848bff4793fc250826">t_send_lan_hello</a>[1] = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02092"></a>02092 
<a name="l02093"></a>02093   <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#a0766cf32585b89b427a69cd8ad1c22fb">run_dr_elect</a>[1])
<a name="l02094"></a>02094     retval = <a class="code" href="isis__dr_8c.html#a35798a245595794b3cb07a6561e0499a">isis_dr_elect</a> (circuit, 2);
<a name="l02095"></a>02095 
<a name="l02096"></a>02096   retval = <a class="code" href="isis__pdu_8c.html#ad38fe669ff232d9720882e210d46781d">send_lan_hello</a> (circuit, 2);
<a name="l02097"></a>02097 
<a name="l02098"></a>02098   <span class="comment">/* set next timer thread */</span>
<a name="l02099"></a>02099   <a class="code" href="thread_8h.html#a898ebeae19eb435889cbf53ea8b5120e">THREAD_TIMER_ON</a> (master, circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#ae47a7d7fa924f3848bff4793fc250826">t_send_lan_hello</a>[1],
<a name="l02100"></a>02100            <a class="code" href="isis__pdu_8c.html#a395c19db187c485c02eb41b63fc024ac">send_lan_l2_hello</a>, circuit,
<a name="l02101"></a>02101            <a class="code" href="isis__misc_8c.html#a177a75676b1916fefb4eb7275911fb6e">isis_jitter</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a7edd39f2abe11ecbbd758dc1a0d3f8c0">hello_interval</a>[1], <a class="code" href="isis__constants_8h.html#a05b53aafec81f1ae7ca52ad0aac5255c">IIH_JITTER</a>));
<a name="l02102"></a>02102 
<a name="l02103"></a>02103   <span class="keywordflow">return</span> retval;
<a name="l02104"></a>02104 }
<a name="l02105"></a>02105 
<a name="l02106"></a>02106 <span class="keywordtype">int</span>
<a name="l02107"></a><a class="code" href="isis__pdu_8h.html#add55c6255271cf958880489585619db9">02107</a> <a class="code" href="isis__pdu_8c.html#add55c6255271cf958880489585619db9">send_p2p_hello</a> (<span class="keyword">struct</span> thread *thread)
<a name="l02108"></a>02108 {
<a name="l02109"></a>02109   <span class="keyword">struct </span><a class="code" href="structisis__circuit.html">isis_circuit</a> *circuit;
<a name="l02110"></a>02110 
<a name="l02111"></a>02111   circuit = <a class="code" href="thread_8h.html#a78f2ae47a7a334f7f74bfed7fda48e5a">THREAD_ARG</a> (thread);
<a name="l02112"></a>02112   <a class="code" href="regex_8c.html#ad6d5aaa966ca7424f7cb9bd01f2c838b">assert</a> (circuit);
<a name="l02113"></a>02113   circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a15852a59ea8be80680abac2070659440">p2p</a>.<a class="code" href="structisis__p2p__info.html#adaa34f30db7fc536f5aec39d08fcbf64">t_send_p2p_hello</a> = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02114"></a>02114 
<a name="l02115"></a>02115   <a class="code" href="isis__pdu_8c.html#ada46fc1940683eac5a47249f80f865b5">send_hello</a> (circuit, 1);
<a name="l02116"></a>02116 
<a name="l02117"></a>02117   <span class="comment">/* set next timer thread */</span>
<a name="l02118"></a>02118   <a class="code" href="thread_8h.html#a898ebeae19eb435889cbf53ea8b5120e">THREAD_TIMER_ON</a> (master, circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a15852a59ea8be80680abac2070659440">p2p</a>.<a class="code" href="structisis__p2p__info.html#adaa34f30db7fc536f5aec39d08fcbf64">t_send_p2p_hello</a>, <a class="code" href="isis__pdu_8c.html#add55c6255271cf958880489585619db9">send_p2p_hello</a>,
<a name="l02119"></a>02119            circuit, <a class="code" href="isis__misc_8c.html#a177a75676b1916fefb4eb7275911fb6e">isis_jitter</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a7edd39f2abe11ecbbd758dc1a0d3f8c0">hello_interval</a>[1],
<a name="l02120"></a>02120                      <a class="code" href="isis__constants_8h.html#a05b53aafec81f1ae7ca52ad0aac5255c">IIH_JITTER</a>));
<a name="l02121"></a>02121 
<a name="l02122"></a>02122   <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;
<a name="l02123"></a>02123 }
<a name="l02124"></a>02124 
<a name="l02125"></a>02125 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02126"></a><a class="code" href="isis__pdu_8c.html#a713bfb71ca33fedd6b66ea5e8ab8f21c">02126</a> <a class="code" href="isis__pdu_8c.html#a713bfb71ca33fedd6b66ea5e8ab8f21c">build_csnp</a> (<span class="keywordtype">int</span> level, u_char * start, u_char * stop, <span class="keyword">struct</span> <a class="code" href="structlist.html">list</a> *lsps,
<a name="l02127"></a>02127         <span class="keyword">struct</span> <a class="code" href="structisis__circuit.html">isis_circuit</a> *circuit)
<a name="l02128"></a>02128 {
<a name="l02129"></a>02129   <span class="keyword">struct </span><a class="code" href="structisis__fixed__hdr.html">isis_fixed_hdr</a> fixed_hdr;
<a name="l02130"></a>02130   <span class="keyword">struct </span><a class="code" href="structisis__passwd.html">isis_passwd</a> *<a class="code" href="structisis__passwd.html#a4af92e1126df2d7d2abeef451c082567">passwd</a>;
<a name="l02131"></a>02131   <span class="keywordtype">int</span> retval = <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;
<a name="l02132"></a>02132   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> lenp;
<a name="l02133"></a>02133   u_int16_t <a class="code" href="isis__pdu_8h.html#a64ed70bbcb4536e2af22a1aaf5209d18">length</a>;
<a name="l02134"></a>02134 
<a name="l02135"></a>02135   <span class="keywordflow">if</span> (level == 1)
<a name="l02136"></a>02136     <a class="code" href="isis__pdu_8c.html#adec6ead19bda8ae8f106249935b71552">fill_fixed_hdr_andstream</a> (&amp;fixed_hdr, <a class="code" href="isis__pdu_8h.html#acd69d37ac6c82a2f79d1790b258f35b4">L1_COMPLETE_SEQ_NUM</a>,
<a name="l02137"></a>02137                   circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>);
<a name="l02138"></a>02138   <span class="keywordflow">else</span>
<a name="l02139"></a>02139     <a class="code" href="isis__pdu_8c.html#adec6ead19bda8ae8f106249935b71552">fill_fixed_hdr_andstream</a> (&amp;fixed_hdr, <a class="code" href="isis__pdu_8h.html#a56e28262496597ee720d611b16040847">L2_COMPLETE_SEQ_NUM</a>,
<a name="l02140"></a>02140                   circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>);
<a name="l02141"></a>02141 
<a name="l02142"></a>02142   <span class="comment">/*</span>
<a name="l02143"></a>02143 <span class="comment">   * Fill Level 1 or 2 Complete Sequence Numbers header</span>
<a name="l02144"></a>02144 <span class="comment">   */</span>
<a name="l02145"></a>02145 
<a name="l02146"></a>02146   lenp = <a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>);
<a name="l02147"></a>02147   <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>, 0); <span class="comment">/* PDU length - when we know it */</span>
<a name="l02148"></a>02148   <span class="comment">/* no need to send the source here, it is always us if we csnp */</span>
<a name="l02149"></a>02149   <a class="code" href="stream_8c.html#a2f540a71efdf46e8c3a923f73e9f3b73">stream_put</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>, isis-&gt;<a class="code" href="structisis.html#a769d4d051a0f424e8c0568b4eeef748e">sysid</a>, <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a>);
<a name="l02150"></a>02150   <span class="comment">/* with zero circuit id - ref 9.10, 9.11 */</span>
<a name="l02151"></a>02151   <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>, 0x00);
<a name="l02152"></a>02152 
<a name="l02153"></a>02153   <a class="code" href="stream_8c.html#a2f540a71efdf46e8c3a923f73e9f3b73">stream_put</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>, start, <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a> + 2);
<a name="l02154"></a>02154   <a class="code" href="stream_8c.html#a2f540a71efdf46e8c3a923f73e9f3b73">stream_put</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>, stop, <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a> + 2);
<a name="l02155"></a>02155 
<a name="l02156"></a>02156   <span class="comment">/*</span>
<a name="l02157"></a>02157 <span class="comment">   * And TLVs</span>
<a name="l02158"></a>02158 <span class="comment">   */</span>
<a name="l02159"></a>02159   <span class="keywordflow">if</span> (level == 1)
<a name="l02160"></a>02160     passwd = &amp;circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#afb66934e4bd3bda094550517a94de442">area_passwd</a>;
<a name="l02161"></a>02161   <span class="keywordflow">else</span>
<a name="l02162"></a>02162     passwd = &amp;circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#a60cd44a3a31b36dc808ad3fd9efc97a0">domain_passwd</a>;
<a name="l02163"></a>02163 
<a name="l02164"></a>02164   <span class="keywordflow">if</span> (<a class="code" href="zebra_8h.html#a9310812ac92febfb7d1eb10127aea1a8">CHECK_FLAG</a>(passwd-&gt;<a class="code" href="structisis__passwd.html#ae05e8ad6fc2b30cdbb8c29196f120bdf">snp_auth</a>, <a class="code" href="isis__common_8h.html#a7f46c0cc8c90fa42f9d6c82abb532b74">SNP_AUTH_SEND</a>))
<a name="l02165"></a>02165     <span class="keywordflow">if</span> (passwd-&gt;<a class="code" href="structisis__passwd.html#a874984e0745fbcb41df9f463d831be67">type</a>)
<a name="l02166"></a>02166       retval = <a class="code" href="isis__tlv_8c.html#a02f053566530986751054dcf500af3a9">tlv_add_authinfo</a> (passwd-&gt;<a class="code" href="structisis__passwd.html#a874984e0745fbcb41df9f463d831be67">type</a>, passwd-&gt;<a class="code" href="structisis__passwd.html#a3981443a6501783995b003ab8fd82f48">len</a>,
<a name="l02167"></a>02167                  passwd-&gt;<a class="code" href="structisis__passwd.html#a4af92e1126df2d7d2abeef451c082567">passwd</a>, circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>);
<a name="l02168"></a>02168 
<a name="l02169"></a>02169   <span class="keywordflow">if</span> (!retval &amp;&amp; lsps)
<a name="l02170"></a>02170     {
<a name="l02171"></a>02171       retval = <a class="code" href="isis__tlv_8c.html#a1f29437b2c7ce6a210cee6cc9f9f920d">tlv_add_lsp_entries</a> (lsps, circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>);
<a name="l02172"></a>02172     }
<a name="l02173"></a>02173   length = (u_int16_t) <a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>);
<a name="l02174"></a>02174   <a class="code" href="regex_8c.html#ad6d5aaa966ca7424f7cb9bd01f2c838b">assert</a> (length &gt;= <a class="code" href="isis__pdu_8h.html#ad643847e4f6bb080e2e6359abcad1c15">ISIS_CSNP_HDRLEN</a>);
<a name="l02175"></a>02175   <span class="comment">/* Update PU length */</span>
<a name="l02176"></a>02176   <a class="code" href="stream_8c.html#a41de70a7383bac6220b787d740c0b261">stream_putw_at</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>, lenp, length);
<a name="l02177"></a>02177 
<a name="l02178"></a>02178   <span class="keywordflow">return</span> retval;
<a name="l02179"></a>02179 }
<a name="l02180"></a>02180 
<a name="l02181"></a>02181 <span class="comment">/*</span>
<a name="l02182"></a>02182 <span class="comment"> * FIXME: support multiple CSNPs</span>
<a name="l02183"></a>02183 <span class="comment"> */</span>
<a name="l02184"></a>02184 
<a name="l02185"></a>02185 <span class="keywordtype">int</span>
<a name="l02186"></a><a class="code" href="isis__pdu_8h.html#ab75f3f062607df2c29d3ba4f4c2341dc">02186</a> <a class="code" href="isis__pdu_8c.html#ab75f3f062607df2c29d3ba4f4c2341dc">send_csnp</a> (<span class="keyword">struct</span> <a class="code" href="structisis__circuit.html">isis_circuit</a> *circuit, <span class="keywordtype">int</span> level)
<a name="l02187"></a>02187 {
<a name="l02188"></a>02188   <span class="keywordtype">int</span> retval = <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;
<a name="l02189"></a>02189   u_char start[<a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a> + 2];
<a name="l02190"></a>02190   u_char stop[<a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a> + 2];
<a name="l02191"></a>02191   <span class="keyword">struct </span><a class="code" href="structlist.html">list</a> *<a class="code" href="structlist.html">list</a> = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02192"></a>02192   <span class="keyword">struct </span><a class="code" href="structlistnode.html">listnode</a> *node;
<a name="l02193"></a>02193   <span class="keyword">struct </span><a class="code" href="structisis__lsp.html">isis_lsp</a> *lsp;
<a name="l02194"></a>02194 
<a name="l02195"></a>02195   memset (start, 0x00, <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a> + 2);
<a name="l02196"></a>02196   memset (stop, 0xff, <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a> + 2);
<a name="l02197"></a>02197 
<a name="l02198"></a>02198   <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#a2e85d570b957a6f8fc47dc4db6fa8f4e">lspdb</a>[level - 1] &amp;&amp;
<a name="l02199"></a>02199       <a class="code" href="dict_8h.html#a392c768130a1c7ed5a6c2f299cd0d2e8">dict_count</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#a2e85d570b957a6f8fc47dc4db6fa8f4e">lspdb</a>[level - 1]) &gt; 0)
<a name="l02200"></a>02200     {
<a name="l02201"></a>02201       list = <a class="code" href="linklist_8c.html#af156f4ae343ef4a625f75b6c38845aef">list_new</a> ();
<a name="l02202"></a>02202       <a class="code" href="isis__lsp_8c.html#ac59fd5f8a4d5e146a7d36dd6525e43ae">lsp_build_list</a> (start, stop, list, circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#a2e85d570b957a6f8fc47dc4db6fa8f4e">lspdb</a>[level - 1]);
<a name="l02203"></a>02203 
<a name="l02204"></a>02204       <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a> == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02205"></a>02205     circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a> = <a class="code" href="stream_8c.html#a7117cdad9fa5e5ae633e0cf08d047459">stream_new</a> (<a class="code" href="isis__constants_8h.html#aa507eb18af6ca6d6db6e3db750ab0737">ISO_MTU</a> (circuit));
<a name="l02206"></a>02206       <span class="keywordflow">else</span>
<a name="l02207"></a>02207     <a class="code" href="stream_8c.html#aee8fd31485ebc2f0a556a6a5d5c2d1e6">stream_reset</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>);
<a name="l02208"></a>02208 
<a name="l02209"></a>02209       retval = <a class="code" href="isis__pdu_8c.html#a713bfb71ca33fedd6b66ea5e8ab8f21c">build_csnp</a> (level, start, stop, list, circuit);
<a name="l02210"></a>02210 
<a name="l02211"></a>02211       <span class="keywordflow">if</span> (isis-&gt;<a class="code" href="structisis.html#a6e64127e274c1aa6a52cb0f4b541dfaa">debugs</a> &amp; <a class="code" href="isisd_8h.html#ab16b82eb25717295303c7099035d9dc9">DEBUG_SNP_PACKETS</a>)
<a name="l02212"></a>02212     {
<a name="l02213"></a>02213       <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;ISIS-Snp (%s): Sent L%d CSNP on %s, length %ld&quot;</span>,
<a name="l02214"></a>02214              circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>, level, circuit-&gt;<a class="code" href="structisis__circuit.html#ab03cac6463284a4ce8c1eb19e49f3b6d">interface</a>-&gt;<a class="code" href="structinterface.html#a98cadce768ec5aacb4c5fc4ca2c3eaa8">name</a>,
<a name="l02215"></a>02215              <span class="comment">/* FIXME: use %z when we stop supporting old compilers. */</span>
<a name="l02216"></a>02216              (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) <a class="code" href="stream_8h.html#a6e3b6e25ed5cfa2faea8485414a0c1a4">STREAM_SIZE</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>));
<a name="l02217"></a>02217       <span class="keywordflow">for</span> (<a class="code" href="linklist_8h.html#a80a3f4035be83abbb709d17412993226">ALL_LIST_ELEMENTS_RO</a> (list, node, lsp))
<a name="l02218"></a>02218       {
<a name="l02219"></a>02219         <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;ISIS-Snp (%s):         CSNP entry %s, seq 0x%08x,&quot;</span>
<a name="l02220"></a>02220             <span class="stringliteral">&quot; cksum 0x%04x, lifetime %us&quot;</span>,
<a name="l02221"></a>02221             circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>,
<a name="l02222"></a>02222             <a class="code" href="isis__misc_8c.html#a3a0e7f92008e3167e2c09b8761d06766">rawlspid_print</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a3e4328d15b43f9023fee75d60f08aca0">lsp_header</a>-&gt;<a class="code" href="structisis__link__state__hdr.html#a6e6f2ce4d1b33c3280827272009a5af2">lsp_id</a>),
<a name="l02223"></a>02223             ntohl (lsp-&gt;<a class="code" href="structisis__lsp.html#a3e4328d15b43f9023fee75d60f08aca0">lsp_header</a>-&gt;<a class="code" href="structisis__link__state__hdr.html#a10657aa355e049b928c9b1cea37bd9d9">seq_num</a>),
<a name="l02224"></a>02224             ntohs (lsp-&gt;<a class="code" href="structisis__lsp.html#a3e4328d15b43f9023fee75d60f08aca0">lsp_header</a>-&gt;<a class="code" href="structisis__link__state__hdr.html#afb16ee6cc606527cc2705773cc2b79c4">checksum</a>),
<a name="l02225"></a>02225             ntohs (lsp-&gt;<a class="code" href="structisis__lsp.html#a3e4328d15b43f9023fee75d60f08aca0">lsp_header</a>-&gt;<a class="code" href="structisis__link__state__hdr.html#a21ef956c03ac1cb9f67cbef6faa12052">rem_lifetime</a>));
<a name="l02226"></a>02226       }
<a name="l02227"></a>02227     }
<a name="l02228"></a>02228 
<a name="l02229"></a>02229       <a class="code" href="linklist_8c.html#ab5fdf1a904264be077ce19a432b1b119">list_delete</a> (list);
<a name="l02230"></a>02230 
<a name="l02231"></a>02231       <span class="keywordflow">if</span> (retval == <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>)
<a name="l02232"></a>02232     retval = circuit-&gt;<a class="code" href="structisis__circuit.html#af17faf994f21d75da89129ed100cb71d">tx</a> (circuit, level);
<a name="l02233"></a>02233     }
<a name="l02234"></a>02234   <span class="keywordflow">return</span> retval;
<a name="l02235"></a>02235 }
<a name="l02236"></a>02236 
<a name="l02237"></a>02237 <span class="keywordtype">int</span>
<a name="l02238"></a><a class="code" href="isis__pdu_8h.html#ab5830fef07f627c56ba857e36b108bac">02238</a> <a class="code" href="isis__pdu_8c.html#ab5830fef07f627c56ba857e36b108bac">send_l1_csnp</a> (<span class="keyword">struct</span> thread *thread)
<a name="l02239"></a>02239 {
<a name="l02240"></a>02240   <span class="keyword">struct </span><a class="code" href="structisis__circuit.html">isis_circuit</a> *circuit;
<a name="l02241"></a>02241   <span class="keywordtype">int</span> retval = <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;
<a name="l02242"></a>02242 
<a name="l02243"></a>02243   circuit = <a class="code" href="thread_8h.html#a78f2ae47a7a334f7f74bfed7fda48e5a">THREAD_ARG</a> (thread);
<a name="l02244"></a>02244   <a class="code" href="regex_8c.html#ad6d5aaa966ca7424f7cb9bd01f2c838b">assert</a> (circuit);
<a name="l02245"></a>02245 
<a name="l02246"></a>02246   circuit-&gt;<a class="code" href="structisis__circuit.html#afb1b17f21dd3115002016a0b3d9116cb">t_send_csnp</a>[0] = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02247"></a>02247 
<a name="l02248"></a>02248   <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a569e39bbf7fafd533eae2eeafa671b8c">circ_type</a> == <a class="code" href="isis__circuit_8h.html#a01a94c5f24c88efb64f791a749ae8f95">CIRCUIT_T_BROADCAST</a> &amp;&amp; circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#adb24376d01beb41cab0ed0c49c3a214c">is_dr</a>[0])
<a name="l02249"></a>02249     {
<a name="l02250"></a>02250       <a class="code" href="isis__pdu_8c.html#ab75f3f062607df2c29d3ba4f4c2341dc">send_csnp</a> (circuit, 1);
<a name="l02251"></a>02251     }
<a name="l02252"></a>02252   <span class="comment">/* set next timer thread */</span>
<a name="l02253"></a>02253   <a class="code" href="thread_8h.html#a898ebeae19eb435889cbf53ea8b5120e">THREAD_TIMER_ON</a> (master, circuit-&gt;<a class="code" href="structisis__circuit.html#afb1b17f21dd3115002016a0b3d9116cb">t_send_csnp</a>[0], <a class="code" href="isis__pdu_8c.html#ab5830fef07f627c56ba857e36b108bac">send_l1_csnp</a>, circuit,
<a name="l02254"></a>02254            <a class="code" href="isis__misc_8c.html#a177a75676b1916fefb4eb7275911fb6e">isis_jitter</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a1b3a587132c475f3b90b5f8b03ec182d">csnp_interval</a>[0], <a class="code" href="isis__constants_8h.html#a5bd43220bafd834e4710deaea471541b">CSNP_JITTER</a>));
<a name="l02255"></a>02255 
<a name="l02256"></a>02256   <span class="keywordflow">return</span> retval;
<a name="l02257"></a>02257 }
<a name="l02258"></a>02258 
<a name="l02259"></a>02259 <span class="keywordtype">int</span>
<a name="l02260"></a><a class="code" href="isis__pdu_8h.html#a2a1bbd2f0b090ddcd6d6e87a7c352ca3">02260</a> <a class="code" href="isis__pdu_8c.html#a2a1bbd2f0b090ddcd6d6e87a7c352ca3">send_l2_csnp</a> (<span class="keyword">struct</span> thread *thread)
<a name="l02261"></a>02261 {
<a name="l02262"></a>02262   <span class="keyword">struct </span><a class="code" href="structisis__circuit.html">isis_circuit</a> *circuit;
<a name="l02263"></a>02263   <span class="keywordtype">int</span> retval = <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;
<a name="l02264"></a>02264 
<a name="l02265"></a>02265   circuit = <a class="code" href="thread_8h.html#a78f2ae47a7a334f7f74bfed7fda48e5a">THREAD_ARG</a> (thread);
<a name="l02266"></a>02266   <a class="code" href="regex_8c.html#ad6d5aaa966ca7424f7cb9bd01f2c838b">assert</a> (circuit);
<a name="l02267"></a>02267 
<a name="l02268"></a>02268   circuit-&gt;<a class="code" href="structisis__circuit.html#afb1b17f21dd3115002016a0b3d9116cb">t_send_csnp</a>[1] = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02269"></a>02269 
<a name="l02270"></a>02270   <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a569e39bbf7fafd533eae2eeafa671b8c">circ_type</a> == <a class="code" href="isis__circuit_8h.html#a01a94c5f24c88efb64f791a749ae8f95">CIRCUIT_T_BROADCAST</a> &amp;&amp; circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#adb24376d01beb41cab0ed0c49c3a214c">is_dr</a>[1])
<a name="l02271"></a>02271     {
<a name="l02272"></a>02272       <a class="code" href="isis__pdu_8c.html#ab75f3f062607df2c29d3ba4f4c2341dc">send_csnp</a> (circuit, 2);
<a name="l02273"></a>02273     }
<a name="l02274"></a>02274   <span class="comment">/* set next timer thread */</span>
<a name="l02275"></a>02275   <a class="code" href="thread_8h.html#a898ebeae19eb435889cbf53ea8b5120e">THREAD_TIMER_ON</a> (master, circuit-&gt;<a class="code" href="structisis__circuit.html#afb1b17f21dd3115002016a0b3d9116cb">t_send_csnp</a>[1], <a class="code" href="isis__pdu_8c.html#a2a1bbd2f0b090ddcd6d6e87a7c352ca3">send_l2_csnp</a>, circuit,
<a name="l02276"></a>02276            <a class="code" href="isis__misc_8c.html#a177a75676b1916fefb4eb7275911fb6e">isis_jitter</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a1b3a587132c475f3b90b5f8b03ec182d">csnp_interval</a>[1], <a class="code" href="isis__constants_8h.html#a5bd43220bafd834e4710deaea471541b">CSNP_JITTER</a>));
<a name="l02277"></a>02277 
<a name="l02278"></a>02278   <span class="keywordflow">return</span> retval;
<a name="l02279"></a>02279 }
<a name="l02280"></a>02280 
<a name="l02281"></a>02281 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02282"></a><a class="code" href="isis__pdu_8c.html#acea9f4e378ed2d9b0e535fbd57172a42">02282</a> <a class="code" href="isis__pdu_8c.html#acea9f4e378ed2d9b0e535fbd57172a42">build_psnp</a> (<span class="keywordtype">int</span> level, <span class="keyword">struct</span> <a class="code" href="structisis__circuit.html">isis_circuit</a> *circuit, <span class="keyword">struct</span> <a class="code" href="structlist.html">list</a> *lsps)
<a name="l02283"></a>02283 {
<a name="l02284"></a>02284   <span class="keyword">struct </span><a class="code" href="structisis__fixed__hdr.html">isis_fixed_hdr</a> fixed_hdr;
<a name="l02285"></a>02285   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> lenp;
<a name="l02286"></a>02286   u_int16_t <a class="code" href="isis__pdu_8h.html#a64ed70bbcb4536e2af22a1aaf5209d18">length</a>;
<a name="l02287"></a>02287   <span class="keywordtype">int</span> retval = 0;
<a name="l02288"></a>02288   <span class="keyword">struct </span><a class="code" href="structisis__lsp.html">isis_lsp</a> *lsp;
<a name="l02289"></a>02289   <span class="keyword">struct </span><a class="code" href="structisis__passwd.html">isis_passwd</a> *<a class="code" href="structisis__passwd.html#a4af92e1126df2d7d2abeef451c082567">passwd</a>;
<a name="l02290"></a>02290   <span class="keyword">struct </span><a class="code" href="structlistnode.html">listnode</a> *node;
<a name="l02291"></a>02291 
<a name="l02292"></a>02292   <span class="keywordflow">if</span> (level == 1)
<a name="l02293"></a>02293     <a class="code" href="isis__pdu_8c.html#adec6ead19bda8ae8f106249935b71552">fill_fixed_hdr_andstream</a> (&amp;fixed_hdr, <a class="code" href="isis__pdu_8h.html#acb5235709fbb83fee17285736e47f228">L1_PARTIAL_SEQ_NUM</a>,
<a name="l02294"></a>02294                   circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>);
<a name="l02295"></a>02295   <span class="keywordflow">else</span>
<a name="l02296"></a>02296     <a class="code" href="isis__pdu_8c.html#adec6ead19bda8ae8f106249935b71552">fill_fixed_hdr_andstream</a> (&amp;fixed_hdr, <a class="code" href="isis__pdu_8h.html#a711a885da413c85c2add3efefec3a69f">L2_PARTIAL_SEQ_NUM</a>,
<a name="l02297"></a>02297                   circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>);
<a name="l02298"></a>02298 
<a name="l02299"></a>02299   <span class="comment">/*</span>
<a name="l02300"></a>02300 <span class="comment">   * Fill Level 1 or 2 Partial Sequence Numbers header</span>
<a name="l02301"></a>02301 <span class="comment">   */</span>
<a name="l02302"></a>02302   lenp = <a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>);
<a name="l02303"></a>02303   <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>, 0); <span class="comment">/* PDU length - when we know it */</span>
<a name="l02304"></a>02304   <a class="code" href="stream_8c.html#a2f540a71efdf46e8c3a923f73e9f3b73">stream_put</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>, isis-&gt;<a class="code" href="structisis.html#a769d4d051a0f424e8c0568b4eeef748e">sysid</a>, <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a>);
<a name="l02305"></a>02305   <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>, circuit-&gt;<a class="code" href="structisis__circuit.html#abac1ddd5e6459cc84fe32064f6643471">idx</a>);
<a name="l02306"></a>02306 
<a name="l02307"></a>02307   <span class="comment">/*</span>
<a name="l02308"></a>02308 <span class="comment">   * And TLVs</span>
<a name="l02309"></a>02309 <span class="comment">   */</span>
<a name="l02310"></a>02310 
<a name="l02311"></a>02311   <span class="keywordflow">if</span> (level == 1)
<a name="l02312"></a>02312     passwd = &amp;circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#afb66934e4bd3bda094550517a94de442">area_passwd</a>;
<a name="l02313"></a>02313   <span class="keywordflow">else</span>
<a name="l02314"></a>02314     passwd = &amp;circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#a60cd44a3a31b36dc808ad3fd9efc97a0">domain_passwd</a>;
<a name="l02315"></a>02315 
<a name="l02316"></a>02316   <span class="keywordflow">if</span> (<a class="code" href="zebra_8h.html#a9310812ac92febfb7d1eb10127aea1a8">CHECK_FLAG</a>(passwd-&gt;<a class="code" href="structisis__passwd.html#ae05e8ad6fc2b30cdbb8c29196f120bdf">snp_auth</a>, <a class="code" href="isis__common_8h.html#a7f46c0cc8c90fa42f9d6c82abb532b74">SNP_AUTH_SEND</a>))
<a name="l02317"></a>02317     <span class="keywordflow">if</span> (passwd-&gt;<a class="code" href="structisis__passwd.html#a874984e0745fbcb41df9f463d831be67">type</a>)
<a name="l02318"></a>02318       retval = <a class="code" href="isis__tlv_8c.html#a02f053566530986751054dcf500af3a9">tlv_add_authinfo</a> (passwd-&gt;<a class="code" href="structisis__passwd.html#a874984e0745fbcb41df9f463d831be67">type</a>, passwd-&gt;<a class="code" href="structisis__passwd.html#a3981443a6501783995b003ab8fd82f48">len</a>,
<a name="l02319"></a>02319                  passwd-&gt;<a class="code" href="structisis__passwd.html#a4af92e1126df2d7d2abeef451c082567">passwd</a>, circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>);
<a name="l02320"></a>02320 
<a name="l02321"></a>02321   <span class="keywordflow">if</span> (!retval &amp;&amp; lsps)
<a name="l02322"></a>02322     {
<a name="l02323"></a>02323       retval = <a class="code" href="isis__tlv_8c.html#a1f29437b2c7ce6a210cee6cc9f9f920d">tlv_add_lsp_entries</a> (lsps, circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>);
<a name="l02324"></a>02324     }
<a name="l02325"></a>02325 
<a name="l02326"></a>02326   <span class="keywordflow">if</span> (isis-&gt;<a class="code" href="structisis.html#a6e64127e274c1aa6a52cb0f4b541dfaa">debugs</a> &amp; <a class="code" href="isisd_8h.html#ab16b82eb25717295303c7099035d9dc9">DEBUG_SNP_PACKETS</a>)
<a name="l02327"></a>02327     {
<a name="l02328"></a>02328       <span class="keywordflow">for</span> (<a class="code" href="linklist_8h.html#a80a3f4035be83abbb709d17412993226">ALL_LIST_ELEMENTS_RO</a> (lsps, node, lsp))
<a name="l02329"></a>02329       {
<a name="l02330"></a>02330     <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;ISIS-Snp (%s):         PSNP entry %s, seq 0x%08x,&quot;</span>
<a name="l02331"></a>02331             <span class="stringliteral">&quot; cksum 0x%04x, lifetime %us&quot;</span>,
<a name="l02332"></a>02332             circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>,
<a name="l02333"></a>02333             <a class="code" href="isis__misc_8c.html#a3a0e7f92008e3167e2c09b8761d06766">rawlspid_print</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a3e4328d15b43f9023fee75d60f08aca0">lsp_header</a>-&gt;<a class="code" href="structisis__link__state__hdr.html#a6e6f2ce4d1b33c3280827272009a5af2">lsp_id</a>),
<a name="l02334"></a>02334             ntohl (lsp-&gt;<a class="code" href="structisis__lsp.html#a3e4328d15b43f9023fee75d60f08aca0">lsp_header</a>-&gt;<a class="code" href="structisis__link__state__hdr.html#a10657aa355e049b928c9b1cea37bd9d9">seq_num</a>),
<a name="l02335"></a>02335             ntohs (lsp-&gt;<a class="code" href="structisis__lsp.html#a3e4328d15b43f9023fee75d60f08aca0">lsp_header</a>-&gt;<a class="code" href="structisis__link__state__hdr.html#afb16ee6cc606527cc2705773cc2b79c4">checksum</a>),
<a name="l02336"></a>02336             ntohs (lsp-&gt;<a class="code" href="structisis__lsp.html#a3e4328d15b43f9023fee75d60f08aca0">lsp_header</a>-&gt;<a class="code" href="structisis__link__state__hdr.html#a21ef956c03ac1cb9f67cbef6faa12052">rem_lifetime</a>));
<a name="l02337"></a>02337       }
<a name="l02338"></a>02338     }
<a name="l02339"></a>02339 
<a name="l02340"></a>02340   length = (u_int16_t) <a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>);
<a name="l02341"></a>02341   <a class="code" href="regex_8c.html#ad6d5aaa966ca7424f7cb9bd01f2c838b">assert</a> (length &gt;= <a class="code" href="isis__pdu_8h.html#aceab21fb8507148277e0980a0cd31a1e">ISIS_PSNP_HDRLEN</a>);
<a name="l02342"></a>02342   <span class="comment">/* Update PDU length */</span>
<a name="l02343"></a>02343   <a class="code" href="stream_8c.html#a41de70a7383bac6220b787d740c0b261">stream_putw_at</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>, lenp, length);
<a name="l02344"></a>02344 
<a name="l02345"></a>02345   <span class="keywordflow">return</span> <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;
<a name="l02346"></a>02346 }
<a name="l02347"></a>02347 
<a name="l02348"></a>02348 <span class="comment">/*</span>
<a name="l02349"></a>02349 <span class="comment"> *  7.3.15.4 action on expiration of partial SNP interval</span>
<a name="l02350"></a>02350 <span class="comment"> *  level 1</span>
<a name="l02351"></a>02351 <span class="comment"> */</span>
<a name="l02352"></a>02352 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02353"></a><a class="code" href="isis__pdu_8c.html#ac55cfde4697927e6b91ef2296a57493c">02353</a> <a class="code" href="isis__pdu_8c.html#ac55cfde4697927e6b91ef2296a57493c">send_psnp</a> (<span class="keywordtype">int</span> level, <span class="keyword">struct</span> <a class="code" href="structisis__circuit.html">isis_circuit</a> *circuit)
<a name="l02354"></a>02354 {
<a name="l02355"></a>02355   <span class="keywordtype">int</span> retval = <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;
<a name="l02356"></a>02356   <span class="keyword">struct </span><a class="code" href="structisis__lsp.html">isis_lsp</a> *lsp;
<a name="l02357"></a>02357   <span class="keyword">struct </span><a class="code" href="structlist.html">list</a> *<a class="code" href="structlist.html">list</a> = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02358"></a>02358   <span class="keyword">struct </span><a class="code" href="structlistnode.html">listnode</a> *node;
<a name="l02359"></a>02359 
<a name="l02360"></a>02360   <span class="keywordflow">if</span> ((circuit-&gt;<a class="code" href="structisis__circuit.html#a569e39bbf7fafd533eae2eeafa671b8c">circ_type</a> == <a class="code" href="isis__circuit_8h.html#a01a94c5f24c88efb64f791a749ae8f95">CIRCUIT_T_BROADCAST</a> &amp;&amp;
<a name="l02361"></a>02361        !circuit-&gt;<a class="code" href="structisis__circuit.html#a054734bc8d5a177c375cd28ab313dfc4">u</a>.<a class="code" href="structisis__circuit.html#a921ef29acc454e98615e0269f3bc926e">bc</a>.<a class="code" href="structisis__bcast__info.html#adb24376d01beb41cab0ed0c49c3a214c">is_dr</a>[level - 1]) ||
<a name="l02362"></a>02362       circuit-&gt;<a class="code" href="structisis__circuit.html#a569e39bbf7fafd533eae2eeafa671b8c">circ_type</a> != <a class="code" href="isis__circuit_8h.html#a01a94c5f24c88efb64f791a749ae8f95">CIRCUIT_T_BROADCAST</a>)
<a name="l02363"></a>02363     {
<a name="l02364"></a>02364 
<a name="l02365"></a>02365       <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#a2e85d570b957a6f8fc47dc4db6fa8f4e">lspdb</a>[level - 1] &amp;&amp;
<a name="l02366"></a>02366       <a class="code" href="dict_8h.html#a392c768130a1c7ed5a6c2f299cd0d2e8">dict_count</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#a2e85d570b957a6f8fc47dc4db6fa8f4e">lspdb</a>[level - 1]) &gt; 0)
<a name="l02367"></a>02367     {
<a name="l02368"></a>02368       list = <a class="code" href="linklist_8c.html#af156f4ae343ef4a625f75b6c38845aef">list_new</a> ();
<a name="l02369"></a>02369       <a class="code" href="isis__lsp_8c.html#ac59c6231af3791411278d2b5f3be2188">lsp_build_list_ssn</a> (circuit, list, circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#a2e85d570b957a6f8fc47dc4db6fa8f4e">lspdb</a>[level - 1]);
<a name="l02370"></a>02370 
<a name="l02371"></a>02371       <span class="keywordflow">if</span> (<a class="code" href="linklist_8h.html#a0429e6385b31a314cc64432a906201e5">listcount</a> (list) &gt; 0)
<a name="l02372"></a>02372         {
<a name="l02373"></a>02373           <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a> == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02374"></a>02374         circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a> = <a class="code" href="stream_8c.html#a7117cdad9fa5e5ae633e0cf08d047459">stream_new</a> (<a class="code" href="isis__constants_8h.html#aa507eb18af6ca6d6db6e3db750ab0737">ISO_MTU</a> (circuit));
<a name="l02375"></a>02375           <span class="keywordflow">else</span>
<a name="l02376"></a>02376         <a class="code" href="stream_8c.html#aee8fd31485ebc2f0a556a6a5d5c2d1e6">stream_reset</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>);
<a name="l02377"></a>02377 
<a name="l02378"></a>02378 
<a name="l02379"></a>02379           <span class="keywordflow">if</span> (isis-&gt;<a class="code" href="structisis.html#a6e64127e274c1aa6a52cb0f4b541dfaa">debugs</a> &amp; <a class="code" href="isisd_8h.html#ab16b82eb25717295303c7099035d9dc9">DEBUG_SNP_PACKETS</a>)
<a name="l02380"></a>02380         <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;ISIS-Snp (%s): Sent L%d PSNP on %s, length %ld&quot;</span>,
<a name="l02381"></a>02381                 circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>, level,
<a name="l02382"></a>02382                 circuit-&gt;<a class="code" href="structisis__circuit.html#ab03cac6463284a4ce8c1eb19e49f3b6d">interface</a>-&gt;<a class="code" href="structinterface.html#a98cadce768ec5aacb4c5fc4ca2c3eaa8">name</a>,
<a name="l02383"></a>02383                 <span class="comment">/* FIXME: use %z when we stop supporting old</span>
<a name="l02384"></a>02384 <span class="comment">                 * compilers. */</span>
<a name="l02385"></a>02385                 (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) <a class="code" href="stream_8h.html#a6e3b6e25ed5cfa2faea8485414a0c1a4">STREAM_SIZE</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>));
<a name="l02386"></a>02386 
<a name="l02387"></a>02387           retval = <a class="code" href="isis__pdu_8c.html#acea9f4e378ed2d9b0e535fbd57172a42">build_psnp</a> (level, circuit, list);
<a name="l02388"></a>02388           <span class="keywordflow">if</span> (retval == <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>)
<a name="l02389"></a>02389         retval = circuit-&gt;<a class="code" href="structisis__circuit.html#af17faf994f21d75da89129ed100cb71d">tx</a> (circuit, level);
<a name="l02390"></a>02390 
<a name="l02391"></a>02391           <span class="keywordflow">if</span> (retval == <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>)
<a name="l02392"></a>02392         {
<a name="l02393"></a>02393           <span class="comment">/*</span>
<a name="l02394"></a>02394 <span class="comment">           * sending succeeded, we can clear SSN flags of this circuit</span>
<a name="l02395"></a>02395 <span class="comment">           * for the LSPs in list</span>
<a name="l02396"></a>02396 <span class="comment">           */</span>
<a name="l02397"></a>02397           <span class="keywordflow">for</span> (<a class="code" href="linklist_8h.html#a80a3f4035be83abbb709d17412993226">ALL_LIST_ELEMENTS_RO</a> (list, node, lsp))
<a name="l02398"></a>02398                     <a class="code" href="isis__flags_8h.html#ac67a62e2e71ff606be09d8e74865aac8">ISIS_CLEAR_FLAG</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a03d0dd350cd760986f4907c5df08363a">SSNflags</a>, circuit);
<a name="l02399"></a>02399         }
<a name="l02400"></a>02400         }
<a name="l02401"></a>02401       <a class="code" href="linklist_8c.html#ab5fdf1a904264be077ce19a432b1b119">list_delete</a> (list);
<a name="l02402"></a>02402     }
<a name="l02403"></a>02403     }
<a name="l02404"></a>02404 
<a name="l02405"></a>02405   <span class="keywordflow">return</span> retval;
<a name="l02406"></a>02406 }
<a name="l02407"></a>02407 
<a name="l02408"></a>02408 <span class="keywordtype">int</span>
<a name="l02409"></a><a class="code" href="isis__pdu_8h.html#a001cd2fbdf45b46870187e20b3cc7efc">02409</a> <a class="code" href="isis__pdu_8c.html#a001cd2fbdf45b46870187e20b3cc7efc">send_l1_psnp</a> (<span class="keyword">struct</span> thread *thread)
<a name="l02410"></a>02410 {
<a name="l02411"></a>02411 
<a name="l02412"></a>02412   <span class="keyword">struct </span><a class="code" href="structisis__circuit.html">isis_circuit</a> *circuit;
<a name="l02413"></a>02413   <span class="keywordtype">int</span> retval = <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;
<a name="l02414"></a>02414 
<a name="l02415"></a>02415   circuit = <a class="code" href="thread_8h.html#a78f2ae47a7a334f7f74bfed7fda48e5a">THREAD_ARG</a> (thread);
<a name="l02416"></a>02416   <a class="code" href="regex_8c.html#ad6d5aaa966ca7424f7cb9bd01f2c838b">assert</a> (circuit);
<a name="l02417"></a>02417 
<a name="l02418"></a>02418   circuit-&gt;<a class="code" href="structisis__circuit.html#a3ad206840c48b3ff93d5160f5a402e2e">t_send_psnp</a>[0] = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02419"></a>02419 
<a name="l02420"></a>02420   <a class="code" href="isis__pdu_8c.html#ac55cfde4697927e6b91ef2296a57493c">send_psnp</a> (1, circuit);
<a name="l02421"></a>02421   <span class="comment">/* set next timer thread */</span>
<a name="l02422"></a>02422   <a class="code" href="thread_8h.html#a898ebeae19eb435889cbf53ea8b5120e">THREAD_TIMER_ON</a> (master, circuit-&gt;<a class="code" href="structisis__circuit.html#a3ad206840c48b3ff93d5160f5a402e2e">t_send_psnp</a>[0], <a class="code" href="isis__pdu_8c.html#a001cd2fbdf45b46870187e20b3cc7efc">send_l1_psnp</a>, circuit,
<a name="l02423"></a>02423            <a class="code" href="isis__misc_8c.html#a177a75676b1916fefb4eb7275911fb6e">isis_jitter</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#ab73d895f1c1588eb68e5b467f7f1b479">psnp_interval</a>[0], <a class="code" href="isis__constants_8h.html#a8ebe0205326ccb2592f752237c21729b">PSNP_JITTER</a>));
<a name="l02424"></a>02424 
<a name="l02425"></a>02425   <span class="keywordflow">return</span> retval;
<a name="l02426"></a>02426 }
<a name="l02427"></a>02427 
<a name="l02428"></a>02428 <span class="comment">/*</span>
<a name="l02429"></a>02429 <span class="comment"> *  7.3.15.4 action on expiration of partial SNP interval</span>
<a name="l02430"></a>02430 <span class="comment"> *  level 2</span>
<a name="l02431"></a>02431 <span class="comment"> */</span>
<a name="l02432"></a>02432 <span class="keywordtype">int</span>
<a name="l02433"></a><a class="code" href="isis__pdu_8h.html#ada5c84113d20d6c83fce25bfea104e93">02433</a> <a class="code" href="isis__pdu_8c.html#ada5c84113d20d6c83fce25bfea104e93">send_l2_psnp</a> (<span class="keyword">struct</span> thread *thread)
<a name="l02434"></a>02434 {
<a name="l02435"></a>02435   <span class="keyword">struct </span><a class="code" href="structisis__circuit.html">isis_circuit</a> *circuit;
<a name="l02436"></a>02436   <span class="keywordtype">int</span> retval = <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>;
<a name="l02437"></a>02437 
<a name="l02438"></a>02438   circuit = <a class="code" href="thread_8h.html#a78f2ae47a7a334f7f74bfed7fda48e5a">THREAD_ARG</a> (thread);
<a name="l02439"></a>02439   <a class="code" href="regex_8c.html#ad6d5aaa966ca7424f7cb9bd01f2c838b">assert</a> (circuit);
<a name="l02440"></a>02440 
<a name="l02441"></a>02441   circuit-&gt;<a class="code" href="structisis__circuit.html#a3ad206840c48b3ff93d5160f5a402e2e">t_send_psnp</a>[1] = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02442"></a>02442 
<a name="l02443"></a>02443   <a class="code" href="isis__pdu_8c.html#ac55cfde4697927e6b91ef2296a57493c">send_psnp</a> (2, circuit);
<a name="l02444"></a>02444 
<a name="l02445"></a>02445   <span class="comment">/* set next timer thread */</span>
<a name="l02446"></a>02446   <a class="code" href="thread_8h.html#a898ebeae19eb435889cbf53ea8b5120e">THREAD_TIMER_ON</a> (master, circuit-&gt;<a class="code" href="structisis__circuit.html#a3ad206840c48b3ff93d5160f5a402e2e">t_send_psnp</a>[1], <a class="code" href="isis__pdu_8c.html#ada5c84113d20d6c83fce25bfea104e93">send_l2_psnp</a>, circuit,
<a name="l02447"></a>02447            <a class="code" href="isis__misc_8c.html#a177a75676b1916fefb4eb7275911fb6e">isis_jitter</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#ab73d895f1c1588eb68e5b467f7f1b479">psnp_interval</a>[1], <a class="code" href="isis__constants_8h.html#a8ebe0205326ccb2592f752237c21729b">PSNP_JITTER</a>));
<a name="l02448"></a>02448 
<a name="l02449"></a>02449   <span class="keywordflow">return</span> retval;
<a name="l02450"></a>02450 }
<a name="l02451"></a>02451 
<a name="l02452"></a>02452 <span class="comment">/*</span>
<a name="l02453"></a>02453 <span class="comment"> * ISO 10589 - 7.3.14.3</span>
<a name="l02454"></a>02454 <span class="comment"> */</span>
<a name="l02455"></a>02455 <span class="keywordtype">int</span>
<a name="l02456"></a><a class="code" href="isis__pdu_8h.html#a23b42a7925a367125e6e0fa3db33f597">02456</a> <a class="code" href="isis__pdu_8c.html#a23b42a7925a367125e6e0fa3db33f597">send_lsp</a> (<span class="keyword">struct</span> thread *thread)
<a name="l02457"></a>02457 {
<a name="l02458"></a>02458   <span class="keyword">struct </span><a class="code" href="structisis__circuit.html">isis_circuit</a> *circuit;
<a name="l02459"></a>02459   <span class="keyword">struct </span><a class="code" href="structisis__lsp.html">isis_lsp</a> *lsp;
<a name="l02460"></a>02460   <span class="keyword">struct </span><a class="code" href="structlistnode.html">listnode</a> *node;
<a name="l02461"></a>02461   <span class="keywordtype">int</span> retval = 0;
<a name="l02462"></a>02462 
<a name="l02463"></a>02463   circuit = <a class="code" href="thread_8h.html#a78f2ae47a7a334f7f74bfed7fda48e5a">THREAD_ARG</a> (thread);
<a name="l02464"></a>02464   <a class="code" href="regex_8c.html#ad6d5aaa966ca7424f7cb9bd01f2c838b">assert</a> (circuit);
<a name="l02465"></a>02465 
<a name="l02466"></a>02466   <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a7491f48eafb46ce87d7041bd7959633b">state</a> == <a class="code" href="isis__csm_8h.html#a65d367a002446ae64678b4586f5e2cc5">C_STATE_UP</a>)
<a name="l02467"></a>02467     {
<a name="l02468"></a>02468       lsp = <a class="code" href="linklist_8h.html#a574f1b7acbcea848771bd5ddc61e430a">listgetdata</a> ((node = <a class="code" href="linklist_8h.html#a3d4492ca03b023aeecd4d6b0cdaa16fb">listhead</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a3540c30e2a6967daf9f9e1b76b00e2be">lsp_queue</a>)));
<a name="l02469"></a>02469 
<a name="l02470"></a>02470       <span class="comment">/*</span>
<a name="l02471"></a>02471 <span class="comment">       * Do not send if levels do not match</span>
<a name="l02472"></a>02472 <span class="comment">       */</span>
<a name="l02473"></a>02473       <span class="keywordflow">if</span> (!(lsp-&gt;<a class="code" href="structisis__lsp.html#ab719e4479e4fc861c4cfa7a3c9d403c6">level</a> &amp; circuit-&gt;<a class="code" href="structisis__circuit.html#ab222d6d0b054faa159d72bcb9768b3fb">circuit_is_type</a>))
<a name="l02474"></a>02474     <span class="keywordflow">goto</span> dontsend;
<a name="l02475"></a>02475 
<a name="l02476"></a>02476       <span class="comment">/*</span>
<a name="l02477"></a>02477 <span class="comment">       * Do not send if we do not have adjacencies in state up on the circuit</span>
<a name="l02478"></a>02478 <span class="comment">       */</span>
<a name="l02479"></a>02479       <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#ad3b84de111be4155660a1ed94e380e2b">upadjcount</a>[lsp-&gt;<a class="code" href="structisis__lsp.html#ab719e4479e4fc861c4cfa7a3c9d403c6">level</a> - 1] == 0)
<a name="l02480"></a>02480     <span class="keywordflow">goto</span> dontsend;
<a name="l02481"></a>02481       <span class="comment">/* only send if it needs sending */</span>
<a name="l02482"></a>02482       <span class="keywordflow">if</span> ((time (<a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) - lsp-&gt;<a class="code" href="structisis__lsp.html#af7c4e460bdbf8301b65213ca256581e0">last_sent</a>) &gt;=
<a name="l02483"></a>02483       circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#a5806de66c9aa420f4b2a5774df0959cf">lsp_gen_interval</a>[lsp-&gt;<a class="code" href="structisis__lsp.html#ab719e4479e4fc861c4cfa7a3c9d403c6">level</a> - 1])
<a name="l02484"></a>02484     {
<a name="l02485"></a>02485 
<a name="l02486"></a>02486       <span class="keywordflow">if</span> (isis-&gt;<a class="code" href="structisis.html#a6e64127e274c1aa6a52cb0f4b541dfaa">debugs</a> &amp; <a class="code" href="isisd_8h.html#abd8d8358bf794de3d9fba9ef5de689b3">DEBUG_UPDATE_PACKETS</a>)
<a name="l02487"></a>02487         {
<a name="l02488"></a>02488           <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a>
<a name="l02489"></a>02489         (<span class="stringliteral">&quot;ISIS-Upd (%s): Sent L%d LSP %s, seq 0x%08x, cksum 0x%04x,&quot;</span>
<a name="l02490"></a>02490          <span class="stringliteral">&quot; lifetime %us on %s&quot;</span>, circuit-&gt;<a class="code" href="structisis__circuit.html#a4284617c89806a77b3c2314e15ac508b">area</a>-&gt;<a class="code" href="structisis__area.html#aef5ef529e28214a477a6a7c2fe03c350">area_tag</a>, lsp-&gt;<a class="code" href="structisis__lsp.html#ab719e4479e4fc861c4cfa7a3c9d403c6">level</a>,
<a name="l02491"></a>02491          <a class="code" href="isis__misc_8c.html#a3a0e7f92008e3167e2c09b8761d06766">rawlspid_print</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a3e4328d15b43f9023fee75d60f08aca0">lsp_header</a>-&gt;<a class="code" href="structisis__link__state__hdr.html#a6e6f2ce4d1b33c3280827272009a5af2">lsp_id</a>),
<a name="l02492"></a>02492          ntohl (lsp-&gt;<a class="code" href="structisis__lsp.html#a3e4328d15b43f9023fee75d60f08aca0">lsp_header</a>-&gt;<a class="code" href="structisis__link__state__hdr.html#a10657aa355e049b928c9b1cea37bd9d9">seq_num</a>),
<a name="l02493"></a>02493          ntohs (lsp-&gt;<a class="code" href="structisis__lsp.html#a3e4328d15b43f9023fee75d60f08aca0">lsp_header</a>-&gt;<a class="code" href="structisis__link__state__hdr.html#afb16ee6cc606527cc2705773cc2b79c4">checksum</a>),
<a name="l02494"></a>02494          ntohs (lsp-&gt;<a class="code" href="structisis__lsp.html#a3e4328d15b43f9023fee75d60f08aca0">lsp_header</a>-&gt;<a class="code" href="structisis__link__state__hdr.html#a21ef956c03ac1cb9f67cbef6faa12052">rem_lifetime</a>),
<a name="l02495"></a>02495          circuit-&gt;<a class="code" href="structisis__circuit.html#ab03cac6463284a4ce8c1eb19e49f3b6d">interface</a>-&gt;<a class="code" href="structinterface.html#a98cadce768ec5aacb4c5fc4ca2c3eaa8">name</a>);
<a name="l02496"></a>02496         }
<a name="l02497"></a>02497       <span class="comment">/* copy our lsp to the send buffer */</span>
<a name="l02498"></a>02498       <a class="code" href="stream_8c.html#a53dd7429b44228c374706fdc5e35c6ae">stream_copy</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>, lsp-&gt;<a class="code" href="structisis__lsp.html#a944fd7d5abffb3968b729b4fc1a9e631">pdu</a>);
<a name="l02499"></a>02499 
<a name="l02500"></a>02500       retval = circuit-&gt;<a class="code" href="structisis__circuit.html#af17faf994f21d75da89129ed100cb71d">tx</a> (circuit, lsp-&gt;<a class="code" href="structisis__lsp.html#ab719e4479e4fc861c4cfa7a3c9d403c6">level</a>);
<a name="l02501"></a>02501 
<a name="l02502"></a>02502       <span class="comment">/*</span>
<a name="l02503"></a>02503 <span class="comment">       * If the sending succeeded, we can del the lsp from circuits</span>
<a name="l02504"></a>02504 <span class="comment">       * lsp_queue</span>
<a name="l02505"></a>02505 <span class="comment">       */</span>
<a name="l02506"></a>02506       <span class="keywordflow">if</span> (retval == <a class="code" href="isis__constants_8h.html#aeece0df48a5b652b227aeaeab5eef2f7">ISIS_OK</a>)
<a name="l02507"></a>02507         {
<a name="l02508"></a>02508           <a class="code" href="linklist_8c.html#a44569d4d868c60e29b21409612a5df05">list_delete_node</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a3540c30e2a6967daf9f9e1b76b00e2be">lsp_queue</a>, node);
<a name="l02509"></a>02509 
<a name="l02510"></a>02510           <span class="comment">/*</span>
<a name="l02511"></a>02511 <span class="comment">           * On broadcast circuits also the SRMflag can be cleared</span>
<a name="l02512"></a>02512 <span class="comment">           */</span>
<a name="l02513"></a>02513           <span class="keywordflow">if</span> (circuit-&gt;<a class="code" href="structisis__circuit.html#a569e39bbf7fafd533eae2eeafa671b8c">circ_type</a> == <a class="code" href="isis__circuit_8h.html#a01a94c5f24c88efb64f791a749ae8f95">CIRCUIT_T_BROADCAST</a>)
<a name="l02514"></a>02514         <a class="code" href="isis__flags_8h.html#ac67a62e2e71ff606be09d8e74865aac8">ISIS_CLEAR_FLAG</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a96d155dbf3bbd20256cf7a68c8d9fd20">SRMflags</a>, circuit);
<a name="l02515"></a>02515 
<a name="l02516"></a>02516           <span class="keywordflow">if</span> (<a class="code" href="isis__flags_8c.html#aa104abd02ef1ceeb11c8cea01a058796">flags_any_set</a> (lsp-&gt;<a class="code" href="structisis__lsp.html#a96d155dbf3bbd20256cf7a68c8d9fd20">SRMflags</a>) == 0)
<a name="l02517"></a>02517         {
<a name="l02518"></a>02518           <span class="comment">/*</span>
<a name="l02519"></a>02519 <span class="comment">           * need to remember when we were last sent</span>
<a name="l02520"></a>02520 <span class="comment">           */</span>
<a name="l02521"></a>02521           lsp-&gt;<a class="code" href="structisis__lsp.html#af7c4e460bdbf8301b65213ca256581e0">last_sent</a> = time (<a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02522"></a>02522         }
<a name="l02523"></a>02523         }
<a name="l02524"></a>02524       <span class="keywordflow">else</span>
<a name="l02525"></a>02525         {
<a name="l02526"></a>02526           <a class="code" href="log_8h.html#af1f70c8ab8e089840180553abf361296">zlog_debug</a> (<span class="stringliteral">&quot;sending of level %d link state failed&quot;</span>, lsp-&gt;<a class="code" href="structisis__lsp.html#ab719e4479e4fc861c4cfa7a3c9d403c6">level</a>);
<a name="l02527"></a>02527         }
<a name="l02528"></a>02528     }
<a name="l02529"></a>02529       <span class="keywordflow">else</span>
<a name="l02530"></a>02530     {
<a name="l02531"></a>02531       <span class="comment">/* my belief is that if it wasn&#39;t his time, the lsp can be removed</span>
<a name="l02532"></a>02532 <span class="comment">       * from the queue</span>
<a name="l02533"></a>02533 <span class="comment">       */</span>
<a name="l02534"></a>02534     dontsend:
<a name="l02535"></a>02535       <a class="code" href="linklist_8c.html#a44569d4d868c60e29b21409612a5df05">list_delete_node</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a3540c30e2a6967daf9f9e1b76b00e2be">lsp_queue</a>, node);
<a name="l02536"></a>02536     }
<a name="l02537"></a>02537 <span class="preprocessor">#if 0</span>
<a name="l02538"></a>02538 <span class="preprocessor"></span>      <span class="comment">/*</span>
<a name="l02539"></a>02539 <span class="comment">       * If there are still LSPs send next one after lsp-interval (33 msecs)</span>
<a name="l02540"></a>02540 <span class="comment">       */</span>
<a name="l02541"></a>02541       <span class="keywordflow">if</span> (<a class="code" href="linklist_8h.html#a0429e6385b31a314cc64432a906201e5">listcount</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a3540c30e2a6967daf9f9e1b76b00e2be">lsp_queue</a>) &gt; 0)
<a name="l02542"></a>02542     <a class="code" href="thread_8h.html#aca77b3bbd166d3573de5ecd9756a590c">thread_add_timer</a> (master, <a class="code" href="isis__pdu_8c.html#a23b42a7925a367125e6e0fa3db33f597">send_lsp</a>, circuit, 1);
<a name="l02543"></a>02543 <span class="preprocessor">#endif</span>
<a name="l02544"></a>02544 <span class="preprocessor"></span>    }
<a name="l02545"></a>02545 
<a name="l02546"></a>02546   <span class="keywordflow">return</span> retval;
<a name="l02547"></a>02547 }
<a name="l02548"></a>02548 
<a name="l02549"></a>02549 <span class="keywordtype">int</span>
<a name="l02550"></a><a class="code" href="isis__pdu_8h.html#a92677d57850d42c168f35387f9bcaeb8">02550</a> <a class="code" href="isis__pdu_8c.html#a92677d57850d42c168f35387f9bcaeb8">ack_lsp</a> (<span class="keyword">struct</span> <a class="code" href="structisis__link__state__hdr.html">isis_link_state_hdr</a> *hdr, <span class="keyword">struct</span> <a class="code" href="structisis__circuit.html">isis_circuit</a> *circuit,
<a name="l02551"></a>02551      <span class="keywordtype">int</span> level)
<a name="l02552"></a>02552 {
<a name="l02553"></a>02553   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> lenp;
<a name="l02554"></a>02554   <span class="keywordtype">int</span> retval;
<a name="l02555"></a>02555   u_int16_t <a class="code" href="isis__pdu_8h.html#a64ed70bbcb4536e2af22a1aaf5209d18">length</a>;
<a name="l02556"></a>02556   <span class="keyword">struct </span><a class="code" href="structisis__fixed__hdr.html">isis_fixed_hdr</a> fixed_hdr;
<a name="l02557"></a>02557 
<a name="l02558"></a>02558   <span class="keywordflow">if</span> (!circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>)
<a name="l02559"></a>02559     circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a> = <a class="code" href="stream_8c.html#a7117cdad9fa5e5ae633e0cf08d047459">stream_new</a> (<a class="code" href="isis__constants_8h.html#aa507eb18af6ca6d6db6e3db750ab0737">ISO_MTU</a> (circuit));
<a name="l02560"></a>02560   <span class="keywordflow">else</span>
<a name="l02561"></a>02561     <a class="code" href="stream_8c.html#aee8fd31485ebc2f0a556a6a5d5c2d1e6">stream_reset</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>);
<a name="l02562"></a>02562 
<a name="l02563"></a>02563 <span class="comment">//  fill_llc_hdr (stream);</span>
<a name="l02564"></a>02564   <span class="keywordflow">if</span> (level == 1)
<a name="l02565"></a>02565     <a class="code" href="isis__pdu_8c.html#adec6ead19bda8ae8f106249935b71552">fill_fixed_hdr_andstream</a> (&amp;fixed_hdr, <a class="code" href="isis__pdu_8h.html#acb5235709fbb83fee17285736e47f228">L1_PARTIAL_SEQ_NUM</a>,
<a name="l02566"></a>02566                   circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>);
<a name="l02567"></a>02567   <span class="keywordflow">else</span>
<a name="l02568"></a>02568     <a class="code" href="isis__pdu_8c.html#adec6ead19bda8ae8f106249935b71552">fill_fixed_hdr_andstream</a> (&amp;fixed_hdr, <a class="code" href="isis__pdu_8h.html#a711a885da413c85c2add3efefec3a69f">L2_PARTIAL_SEQ_NUM</a>,
<a name="l02569"></a>02569                   circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>);
<a name="l02570"></a>02570 
<a name="l02571"></a>02571 
<a name="l02572"></a>02572   lenp = <a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>);
<a name="l02573"></a>02573   <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>, 0); <span class="comment">/* PDU length  */</span>
<a name="l02574"></a>02574   <a class="code" href="stream_8c.html#a2f540a71efdf46e8c3a923f73e9f3b73">stream_put</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>, isis-&gt;<a class="code" href="structisis.html#a769d4d051a0f424e8c0568b4eeef748e">sysid</a>, <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a>);
<a name="l02575"></a>02575   <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>, circuit-&gt;<a class="code" href="structisis__circuit.html#abac1ddd5e6459cc84fe32064f6643471">idx</a>);
<a name="l02576"></a>02576   <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>, 9); <span class="comment">/* code */</span>
<a name="l02577"></a>02577   <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>, 16);    <span class="comment">/* len */</span>
<a name="l02578"></a>02578 
<a name="l02579"></a>02579   <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>, ntohs (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a21ef956c03ac1cb9f67cbef6faa12052">rem_lifetime</a>));
<a name="l02580"></a>02580   <a class="code" href="stream_8c.html#a2f540a71efdf46e8c3a923f73e9f3b73">stream_put</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>, hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a6e6f2ce4d1b33c3280827272009a5af2">lsp_id</a>, <a class="code" href="isis__constants_8h.html#aeda8abfdcc24dfb0ab327ea79ce453fc">ISIS_SYS_ID_LEN</a> + 2);
<a name="l02581"></a>02581   <a class="code" href="stream_8c.html#af366d780a14cb8de53279378a8a4faeb">stream_putl</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>, ntohl (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#a10657aa355e049b928c9b1cea37bd9d9">seq_num</a>));
<a name="l02582"></a>02582   <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>, ntohs (hdr-&gt;<a class="code" href="structisis__link__state__hdr.html#afb16ee6cc606527cc2705773cc2b79c4">checksum</a>));
<a name="l02583"></a>02583 
<a name="l02584"></a>02584   length = (u_int16_t) <a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>);
<a name="l02585"></a>02585   <span class="comment">/* Update PDU length */</span>
<a name="l02586"></a>02586   <a class="code" href="stream_8c.html#a41de70a7383bac6220b787d740c0b261">stream_putw_at</a> (circuit-&gt;<a class="code" href="structisis__circuit.html#a282678da28cc5e426019913c913ea490">snd_stream</a>, lenp, length);
<a name="l02587"></a>02587 
<a name="l02588"></a>02588   retval = circuit-&gt;<a class="code" href="structisis__circuit.html#af17faf994f21d75da89129ed100cb71d">tx</a> (circuit, level);
<a name="l02589"></a>02589 
<a name="l02590"></a>02590   <span class="keywordflow">return</span> retval;
<a name="l02591"></a>02591 }
<a name="l02592"></a>02592 
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="isis__pdu_8c.html">isis_pdu.c</a>      </li>

    <li class="footer">Generated on Tue Apr 24 2012 10:41:04 for OSPFN by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.5.1 </li>
   </ul>
 </div>


</body>
</html>
