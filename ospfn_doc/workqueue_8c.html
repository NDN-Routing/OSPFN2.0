<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>OSPFN: lib/workqueue.c File Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>


</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">OSPFN
   &#160;<span id="projectnumber">1.1</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('workqueue_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#define-members">Defines</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">lib/workqueue.c File Reference</div>  </div>
</div>
<div class="contents">
<div class="textblock"><code>#include &lt;<a class="el" href="zebra_8h_source.html">lib/zebra.h</a>&gt;</code><br/>
<code>#include &quot;<a class="el" href="thread_8h_source.html">thread.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="memory_8h_source.html">memory.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="workqueue_8h_source.html">workqueue.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="linklist_8h_source.html">linklist.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="command_8h_source.html">command.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="log_8h_source.html">log.h</a>&quot;</code><br/>
</div><div class="textblock"><div class="dynheader">
Include dependency graph for workqueue.c:</div>
<div class="dyncontent">
<div class="center"><img src="workqueue_8c__incl.png" border="0" usemap="#lib_2workqueue_8c" alt=""/></div>
<map name="lib_2workqueue_8c" id="lib_2workqueue_8c">
<area shape="rect" id="node3" href="zebra_8h.html" title="lib/zebra.h" alt="" coords="1337,80,1420,107"/><area shape="rect" id="node61" href="thread_8h.html" title="thread.h" alt="" coords="2881,229,2953,256"/><area shape="rect" id="node63" href="memory_8h.html" title="memory.h" alt="" coords="2849,80,2932,107"/><area shape="rect" id="node67" href="workqueue_8h.html" title="workqueue.h" alt="" coords="2957,80,3056,107"/><area shape="rect" id="node69" href="linklist_8h.html" title="linklist.h" alt="" coords="3081,80,3151,107"/><area shape="rect" id="node71" href="command_8h.html" title="command.h" alt="" coords="3175,80,3267,107"/><area shape="rect" id="node78" href="log_8h.html" title="log.h" alt="" coords="3085,229,3136,256"/><area shape="rect" id="node57" href="zassert_8h.html" title="zassert.h" alt="" coords="2623,155,2700,181"/><area shape="rect" id="node59" href="str_8h.html" title="str.h" alt="" coords="2725,155,2773,181"/><area shape="rect" id="node65" href="memtypes_8h.html" title="lib/memtypes.h" alt="" coords="2849,155,2964,181"/><area shape="rect" id="node73" href="vector_8h.html" title="vector.h" alt="" coords="2988,155,3060,181"/><area shape="rect" id="node75" href="vty_8h.html" title="vty.h" alt="" coords="3085,155,3136,181"/><area shape="rect" id="node81" href="route__types_8h.html" title="lib/route_types.h" alt="" coords="3161,155,3284,181"/></map>
</div>
</div>
<p><a href="workqueue_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="define-members"></a>
Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="workqueue_8c.html#a70ae9b5a5f4e3a8315a9b8886b1fc3b2">WORK_QUEUE_MIN_GRANULARITY</a>&#160;&#160;&#160;1</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="workqueue_8c.html#a99873717482e56d5ec2efadec01805f3">WQ_HYSTERIS_FACTOR</a>&#160;&#160;&#160;2</td></tr>
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structwork__queue__item.html">work_queue_item</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="workqueue_8c.html#ab3d2e7f11c70d7199c6f647acf19ca9b">work_queue_item_new</a> (struct <a class="el" href="structwork__queue.html">work_queue</a> *wq)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="workqueue_8c.html#a7bb0b38c0628be0a01058cec1c19c6cc">work_queue_item_free</a> (struct <a class="el" href="structwork__queue__item.html">work_queue_item</a> *item)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="structwork__queue.html">work_queue</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="workqueue_8c.html#a8b50511bbc60426f371822c0c7aee5cc">work_queue_new</a> (struct <a class="el" href="structthread__master.html">thread_master</a> *<a class="el" href="spgrid_8c.html#a5175b356eac1d83a42608b42a25d00b9">m</a>, const char *queue_name)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="workqueue_8c.html#a4e3dc7060c6ee963d3d202f4b9a7fe3d">work_queue_free</a> (struct <a class="el" href="structwork__queue.html">work_queue</a> *wq)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="workqueue_8c.html#aa732b3b09b4d45c9167eb7e6bb97ac22">work_queue_schedule</a> (struct <a class="el" href="structwork__queue.html">work_queue</a> *wq, unsigned int delay)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="workqueue_8c.html#a193fb769a4d04f3c160c623fd07dfb21">work_queue_add</a> (struct <a class="el" href="structwork__queue.html">work_queue</a> *wq, void *data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="workqueue_8c.html#abb2634fd42a197c9f214d8543e23980d">work_queue_item_remove</a> (struct <a class="el" href="structwork__queue.html">work_queue</a> *wq, struct <a class="el" href="structlistnode.html">listnode</a> *ln)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="workqueue_8c.html#ad7b4ca345f9604d44b3d487105e18c9a">work_queue_item_requeue</a> (struct <a class="el" href="structwork__queue.html">work_queue</a> *wq, struct <a class="el" href="structlistnode.html">listnode</a> *ln)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="workqueue_8c.html#a27a252afc19405291b0c78a96497ea30">DEFUN</a> (show_work_queues, <a class="el" href="workqueue_8h.html#ab2779e59766ef7735389a1d0edd08a9e">show_work_queues_cmd</a>,&quot;show work-queues&quot;, SHOW_STR&quot;Work Queue information\<a class="el" href="spgrid_8c.html#abe63e991a7bf5d666068b15c9064428d">n</a>&quot;)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="workqueue_8c.html#ae01d17ef2cd86436b8feb75c470c501a">work_queue_plug</a> (struct <a class="el" href="structwork__queue.html">work_queue</a> *wq)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="workqueue_8c.html#ac421962a00d94a292cb4097a4df7a2c9">work_queue_unplug</a> (struct <a class="el" href="structwork__queue.html">work_queue</a> *wq)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="workqueue_8c.html#aee320c3071f774ffa32770b52f5a6494">work_queue_run</a> (struct <a class="el" href="structthread.html">thread</a> *<a class="el" href="structthread.html">thread</a>)</td></tr>
<tr><td colspan="2"><h2><a name="var-members"></a>
Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structlist.html">list</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="workqueue_8c.html#a4d24d005d0b0547df065125f766a7f85">work_queues</a></td></tr>
</table>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="a70ae9b5a5f4e3a8315a9b8886b1fc3b2"></a><!-- doxytag: member="workqueue.c::WORK_QUEUE_MIN_GRANULARITY" ref="a70ae9b5a5f4e3a8315a9b8886b1fc3b2" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define WORK_QUEUE_MIN_GRANULARITY&#160;&#160;&#160;1</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="workqueue_8c_source.html#l00035">35</a> of file <a class="el" href="workqueue_8c_source.html">workqueue.c</a>.</p>

</div>
</div>
<a class="anchor" id="a99873717482e56d5ec2efadec01805f3"></a><!-- doxytag: member="workqueue.c::WQ_HYSTERIS_FACTOR" ref="a99873717482e56d5ec2efadec01805f3" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define WQ_HYSTERIS_FACTOR&#160;&#160;&#160;2</td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a27a252afc19405291b0c78a96497ea30"></a><!-- doxytag: member="workqueue.c::DEFUN" ref="a27a252afc19405291b0c78a96497ea30" args="(show_work_queues, show_work_queues_cmd,&quot;show work&#45;queues&quot;, SHOW_STR&quot;Work Queue information\n&quot;)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">DEFUN </td>
          <td>(</td>
          <td class="paramtype">show_work_queues&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="workqueue_8h.html#ab2779e59766ef7735389a1d0edd08a9e">show_work_queues_cmd</a>&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&quot;show work-queues&quot;&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">SHOW_STR&quot;Work Queue information\<a class="el" href="spgrid_8c.html#abe63e991a7bf5d666068b15c9064428d">n</a>&quot;&#160;</td>
          <td class="paramname">&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="workqueue_8c_source.html#l00167">167</a> of file <a class="el" href="workqueue_8c_source.html">workqueue.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keyword">struct </span><a class="code" href="structlistnode.html">listnode</a> *node;
  <span class="keyword">struct </span><a class="code" href="structwork__queue.html">work_queue</a> *wq;
  
  <a class="code" href="vty_8c.html#a3725db0ec6ad3ffdd31f68abc807ee34">vty_out</a> (<a class="code" href="structvty.html">vty</a>, 
           <span class="stringliteral">&quot;%c %8s %5s %8s %21s%s&quot;</span>,
           <span class="charliteral">&#39; &#39;</span>, <span class="stringliteral">&quot;List&quot;</span>,<span class="stringliteral">&quot;(ms) &quot;</span>,<span class="stringliteral">&quot;Q. Runs&quot;</span>,<span class="stringliteral">&quot;Cycle Counts   &quot;</span>,
           <a class="code" href="vty_8h.html#a3be8ca867e2953936a95c68dc64824b6">VTY_NEWLINE</a>);
  <a class="code" href="vty_8c.html#a3725db0ec6ad3ffdd31f68abc807ee34">vty_out</a> (<a class="code" href="structvty.html">vty</a>,
           <span class="stringliteral">&quot;%c %8s %5s %8s %7s %6s %6s %s%s&quot;</span>,
           <span class="charliteral">&#39;P&#39;</span>,
           <span class="stringliteral">&quot;Items&quot;</span>,
           <span class="stringliteral">&quot;Hold&quot;</span>,
           <span class="stringliteral">&quot;Total&quot;</span>,
           <span class="stringliteral">&quot;Best&quot;</span>,<span class="stringliteral">&quot;Gran.&quot;</span>,<span class="stringliteral">&quot;Avg.&quot;</span>, 
           <span class="stringliteral">&quot;Name&quot;</span>, 
           <a class="code" href="vty_8h.html#a3be8ca867e2953936a95c68dc64824b6">VTY_NEWLINE</a>);
 
  <span class="keywordflow">for</span> (<a class="code" href="linklist_8h.html#a80a3f4035be83abbb709d17412993226">ALL_LIST_ELEMENTS_RO</a> ((&amp;<a class="code" href="workqueue_8c.html#a4d24d005d0b0547df065125f766a7f85">work_queues</a>), node, wq))
    {
      <a class="code" href="vty_8c.html#a3725db0ec6ad3ffdd31f68abc807ee34">vty_out</a> (<a class="code" href="structvty.html">vty</a>,<span class="stringliteral">&quot;%c %8d %5d %8ld %7d %6d %6u %s%s&quot;</span>,
               (<a class="code" href="zebra_8h.html#a9310812ac92febfb7d1eb10127aea1a8">CHECK_FLAG</a> (wq-&gt;<a class="code" href="structwork__queue.html#a35d9311d951ad4ca2d9497482467445f">flags</a>, <a class="code" href="workqueue_8h.html#a28aab240a6eaab4d2feb2eb97d2ab671">WQ_UNPLUGGED</a>) ? <span class="charliteral">&#39; &#39;</span> : <span class="charliteral">&#39;P&#39;</span>),
               <a class="code" href="linklist_8h.html#a0429e6385b31a314cc64432a906201e5">listcount</a> (wq-&gt;<a class="code" href="structwork__queue.html#a563ee1f1f6983b2a7a6dfb6624fd4942">items</a>),
               wq-&gt;<a class="code" href="structwork__queue.html#ae9c11795e9b293839422dd2c6ebfa493">spec</a>.<a class="code" href="structwork__queue.html#a6f998e18d62286e5b77844faf7c3ded2">hold</a>,
               wq-&gt;<a class="code" href="structwork__queue.html#abc672c3cb4692cbc67fec570e8c94485">runs</a>,
               wq-&gt;<a class="code" href="structwork__queue.html#a077cdf65a4429efc9d7fa6c51d72e67f">cycles</a>.<a class="code" href="structwork__queue.html#aba6bd3f6f97fbdecf4ae0835410f43ca">best</a>, wq-&gt;<a class="code" href="structwork__queue.html#a077cdf65a4429efc9d7fa6c51d72e67f">cycles</a>.<a class="code" href="structwork__queue.html#ab01cb6e83c330ca80c63b397a46694fe">granularity</a>,
                 (wq-&gt;<a class="code" href="structwork__queue.html#abc672c3cb4692cbc67fec570e8c94485">runs</a>) ? 
                   (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) (wq-&gt;<a class="code" href="structwork__queue.html#a077cdf65a4429efc9d7fa6c51d72e67f">cycles</a>.<a class="code" href="structwork__queue.html#ae3d83725e098fb7288bf6eb59c7e4668">total</a> / wq-&gt;<a class="code" href="structwork__queue.html#abc672c3cb4692cbc67fec570e8c94485">runs</a>) : 0,
               wq-&gt;<a class="code" href="structwork__queue.html#af3a23c738bc1ebb51b0904ac1cccb0f1">name</a>,
               <a class="code" href="vty_8h.html#a3be8ca867e2953936a95c68dc64824b6">VTY_NEWLINE</a>);
    }
    
  <span class="keywordflow">return</span> <a class="code" href="command_8h.html#aa2008c1bc36d9ef42571a6ec52516d02">CMD_SUCCESS</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a193fb769a4d04f3c160c623fd07dfb21"></a><!-- doxytag: member="workqueue.c::work_queue_add" ref="a193fb769a4d04f3c160c623fd07dfb21" args="(struct work_queue *wq, void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void work_queue_add </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structwork__queue.html">work_queue</a> *&#160;</td>
          <td class="paramname"><em>wq</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>data</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="workqueue_8c_source.html#l00123">123</a> of file <a class="el" href="workqueue_8c_source.html">workqueue.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keyword">struct </span><a class="code" href="structwork__queue__item.html">work_queue_item</a> *item;
  
  <a class="code" href="regex_8c.html#ad6d5aaa966ca7424f7cb9bd01f2c838b">assert</a> (wq);

  <span class="keywordflow">if</span> (!(item = <a class="code" href="workqueue_8c.html#ab3d2e7f11c70d7199c6f647acf19ca9b">work_queue_item_new</a> (wq)))
    {
      <a class="code" href="log_8h.html#aaf50b52a949696adb9e77153b08545ad">zlog_err</a> (<span class="stringliteral">&quot;%s: unable to get new queue item&quot;</span>, __func__);
      <span class="keywordflow">return</span>;
    }
  
  item-&gt;<a class="code" href="structwork__queue__item.html#aba6c356bbcf47612f80c690961518aa7">data</a> = <a class="code" href="dict_8c.html#a43a278d13284fb3412e9eee1db1d967e">data</a>;
  <a class="code" href="linklist_8c.html#adb2a0478aba995441aaf691d1f6fe5db">listnode_add</a> (wq-&gt;<a class="code" href="structwork__queue.html#a563ee1f1f6983b2a7a6dfb6624fd4942">items</a>, item);
  
  <a class="code" href="workqueue_8c.html#aa732b3b09b4d45c9167eb7e6bb97ac22">work_queue_schedule</a> (wq, wq-&gt;<a class="code" href="structwork__queue.html#ae9c11795e9b293839422dd2c6ebfa493">spec</a>.<a class="code" href="structwork__queue.html#a6f998e18d62286e5b77844faf7c3ded2">hold</a>);
  
  <span class="keywordflow">return</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a4e3dc7060c6ee963d3d202f4b9a7fe3d"></a><!-- doxytag: member="workqueue.c::work_queue_free" ref="a4e3dc7060c6ee963d3d202f4b9a7fe3d" args="(struct work_queue *wq)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void work_queue_free </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structwork__queue.html">work_queue</a> *&#160;</td>
          <td class="paramname"><em>wq</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="workqueue_8c_source.html#l00092">92</a> of file <a class="el" href="workqueue_8c_source.html">workqueue.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordflow">if</span> (wq-&gt;<a class="code" href="structwork__queue.html#aa7a1097e517f22c4a289a8db9e91005d">thread</a> != <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
    <a class="code" href="thread_8c.html#aceb89c1157b6a1d8bb3afa5021f1ab6d">thread_cancel</a>(wq-&gt;<a class="code" href="structwork__queue.html#aa7a1097e517f22c4a289a8db9e91005d">thread</a>);
  
  <span class="comment">/* list_delete frees items via callback */</span>
  <a class="code" href="linklist_8c.html#ab5fdf1a904264be077ce19a432b1b119">list_delete</a> (wq-&gt;<a class="code" href="structwork__queue.html#a563ee1f1f6983b2a7a6dfb6624fd4942">items</a>);
  <a class="code" href="linklist_8c.html#a8cbdaa18db1ceacaadbc457a0c634e02">listnode_delete</a> (&amp;<a class="code" href="workqueue_8c.html#a4d24d005d0b0547df065125f766a7f85">work_queues</a>, wq);
  
  <a class="code" href="memory_8h.html#a29f1ce2c850a3163cd6b1b0bd460705d">XFREE</a> (<a class="code" href="memtypes_8h.html#a7ff5f2dff38e7639981794c43dc9167ba53693e92d00466f3d482d0fbde3a04d2">MTYPE_WORK_QUEUE_NAME</a>, wq-&gt;<a class="code" href="structwork__queue.html#af3a23c738bc1ebb51b0904ac1cccb0f1">name</a>);
  <a class="code" href="memory_8h.html#a29f1ce2c850a3163cd6b1b0bd460705d">XFREE</a> (<a class="code" href="memtypes_8h.html#a7ff5f2dff38e7639981794c43dc9167ba4afb71edb3d48305829a2dba60f7c353">MTYPE_WORK_QUEUE</a>, wq);
  <span class="keywordflow">return</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a7bb0b38c0628be0a01058cec1c19c6cc"></a><!-- doxytag: member="workqueue.c::work_queue_item_free" ref="a7bb0b38c0628be0a01058cec1c19c6cc" args="(struct work_queue_item *item)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void work_queue_item_free </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structwork__queue__item.html">work_queue_item</a> *&#160;</td>
          <td class="paramname"><em>item</em></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="workqueue_8c_source.html#l00050">50</a> of file <a class="el" href="workqueue_8c_source.html">workqueue.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <a class="code" href="memory_8h.html#a29f1ce2c850a3163cd6b1b0bd460705d">XFREE</a> (<a class="code" href="memtypes_8h.html#a7ff5f2dff38e7639981794c43dc9167bac1c081e2d37bb5116d7f063bb625c5c3">MTYPE_WORK_QUEUE_ITEM</a>, item);
  <span class="keywordflow">return</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ab3d2e7f11c70d7199c6f647acf19ca9b"></a><!-- doxytag: member="workqueue.c::work_queue_item_new" ref="ab3d2e7f11c70d7199c6f647acf19ca9b" args="(struct work_queue *wq)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structwork__queue__item.html">work_queue_item</a>* work_queue_item_new </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structwork__queue.html">work_queue</a> *&#160;</td>
          <td class="paramname"><em>wq</em></td><td>)</td>
          <td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="workqueue_8c_source.html#l00038">38</a> of file <a class="el" href="workqueue_8c_source.html">workqueue.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keyword">struct </span><a class="code" href="structwork__queue__item.html">work_queue_item</a> *item;
  <a class="code" href="regex_8c.html#ad6d5aaa966ca7424f7cb9bd01f2c838b">assert</a> (wq);

  item = <a class="code" href="memory_8h.html#a7826e4ed1d152cad0666dcf43f11f663">XCALLOC</a> (<a class="code" href="memtypes_8h.html#a7ff5f2dff38e7639981794c43dc9167bac1c081e2d37bb5116d7f063bb625c5c3">MTYPE_WORK_QUEUE_ITEM</a>, 
                  <span class="keyword">sizeof</span> (<span class="keyword">struct</span> <a class="code" href="structwork__queue__item.html">work_queue_item</a>));
  
  <span class="keywordflow">return</span> item;
}
</pre></div>
</div>
</div>
<a class="anchor" id="abb2634fd42a197c9f214d8543e23980d"></a><!-- doxytag: member="workqueue.c::work_queue_item_remove" ref="abb2634fd42a197c9f214d8543e23980d" args="(struct work_queue *wq, struct listnode *ln)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void work_queue_item_remove </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structwork__queue.html">work_queue</a> *&#160;</td>
          <td class="paramname"><em>wq</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlistnode.html">listnode</a> *&#160;</td>
          <td class="paramname"><em>ln</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="workqueue_8c_source.html#l00144">144</a> of file <a class="el" href="workqueue_8c_source.html">workqueue.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keyword">struct </span><a class="code" href="structwork__queue__item.html">work_queue_item</a> *item = <a class="code" href="linklist_8h.html#a574f1b7acbcea848771bd5ddc61e430a">listgetdata</a> (ln);

  <a class="code" href="regex_8c.html#ad6d5aaa966ca7424f7cb9bd01f2c838b">assert</a> (item &amp;&amp; item-&gt;<a class="code" href="structwork__queue__item.html#aba6c356bbcf47612f80c690961518aa7">data</a>);

  <span class="comment">/* call private data deletion callback if needed */</span>  
  <span class="keywordflow">if</span> (wq-&gt;<a class="code" href="structwork__queue.html#ae9c11795e9b293839422dd2c6ebfa493">spec</a>.<a class="code" href="structwork__queue.html#ae2fdda0df1d6e600e2b4e7849740e9d2">del_item_data</a>)
    wq-&gt;<a class="code" href="structwork__queue.html#ae9c11795e9b293839422dd2c6ebfa493">spec</a>.<a class="code" href="structwork__queue.html#ae2fdda0df1d6e600e2b4e7849740e9d2">del_item_data</a> (wq, item-&gt;<a class="code" href="structwork__queue__item.html#aba6c356bbcf47612f80c690961518aa7">data</a>);

  <a class="code" href="linklist_8c.html#a44569d4d868c60e29b21409612a5df05">list_delete_node</a> (wq-&gt;<a class="code" href="structwork__queue.html#a563ee1f1f6983b2a7a6dfb6624fd4942">items</a>, ln);
  <a class="code" href="workqueue_8c.html#a7bb0b38c0628be0a01058cec1c19c6cc">work_queue_item_free</a> (item);
  
  <span class="keywordflow">return</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ad7b4ca345f9604d44b3d487105e18c9a"></a><!-- doxytag: member="workqueue.c::work_queue_item_requeue" ref="ad7b4ca345f9604d44b3d487105e18c9a" args="(struct work_queue *wq, struct listnode *ln)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void work_queue_item_requeue </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structwork__queue.html">work_queue</a> *&#160;</td>
          <td class="paramname"><em>wq</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlistnode.html">listnode</a> *&#160;</td>
          <td class="paramname"><em>ln</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="workqueue_8c_source.html#l00161">161</a> of file <a class="el" href="workqueue_8c_source.html">workqueue.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <a class="code" href="linklist_8h.html#a5eddb5f71ca3e7eebf20e4af45c4a98d">LISTNODE_DETACH</a> (wq-&gt;<a class="code" href="structwork__queue.html#a563ee1f1f6983b2a7a6dfb6624fd4942">items</a>, ln);
  <a class="code" href="linklist_8h.html#ac42ea544a64b2473b67317978c856e69">LISTNODE_ATTACH</a> (wq-&gt;<a class="code" href="structwork__queue.html#a563ee1f1f6983b2a7a6dfb6624fd4942">items</a>, ln); <span class="comment">/* attach to end of list */</span>
}
</pre></div>
</div>
</div>
<a class="anchor" id="a8b50511bbc60426f371822c0c7aee5cc"></a><!-- doxytag: member="workqueue.c::work_queue_new" ref="a8b50511bbc60426f371822c0c7aee5cc" args="(struct thread_master *m, const char *queue_name)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structwork__queue.html">work_queue</a>* work_queue_new </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structthread__master.html">thread_master</a> *&#160;</td>
          <td class="paramname"><em>m</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>queue_name</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="workqueue_8c_source.html#l00058">58</a> of file <a class="el" href="workqueue_8c_source.html">workqueue.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keyword">struct </span><a class="code" href="structwork__queue.html">work_queue</a> *<span class="keyword">new</span>;
  
  <span class="keyword">new</span> = <a class="code" href="memory_8h.html#a7826e4ed1d152cad0666dcf43f11f663">XCALLOC</a> (<a class="code" href="memtypes_8h.html#a7ff5f2dff38e7639981794c43dc9167ba4afb71edb3d48305829a2dba60f7c353">MTYPE_WORK_QUEUE</a>, <span class="keyword">sizeof</span> (<span class="keyword">struct</span> <a class="code" href="structwork__queue.html">work_queue</a>));

  <span class="keywordflow">if</span> (<span class="keyword">new</span> == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
    <span class="keywordflow">return</span> <span class="keyword">new</span>;
  
  <span class="keyword">new</span>-&gt;name = <a class="code" href="memory_8h.html#aa7c561b5824edc16351f22b8df155c0e">XSTRDUP</a> (<a class="code" href="memtypes_8h.html#a7ff5f2dff38e7639981794c43dc9167ba53693e92d00466f3d482d0fbde3a04d2">MTYPE_WORK_QUEUE_NAME</a>, queue_name);
  <span class="keyword">new</span>-&gt;master = <a class="code" href="spgrid_8c.html#a5175b356eac1d83a42608b42a25d00b9">m</a>;
  <a class="code" href="zebra_8h.html#a7c593725d5bbf27a37a922ae84b02333">SET_FLAG</a> (new-&gt;flags, <a class="code" href="workqueue_8h.html#a28aab240a6eaab4d2feb2eb97d2ab671">WQ_UNPLUGGED</a>);
  
  <span class="keywordflow">if</span> ( (new-&gt;items = <a class="code" href="linklist_8c.html#af156f4ae343ef4a625f75b6c38845aef">list_new</a> ()) == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
    {
      <a class="code" href="memory_8h.html#a29f1ce2c850a3163cd6b1b0bd460705d">XFREE</a> (<a class="code" href="memtypes_8h.html#a7ff5f2dff38e7639981794c43dc9167ba53693e92d00466f3d482d0fbde3a04d2">MTYPE_WORK_QUEUE_NAME</a>, new-&gt;name);
      <a class="code" href="memory_8h.html#a29f1ce2c850a3163cd6b1b0bd460705d">XFREE</a> (<a class="code" href="memtypes_8h.html#a7ff5f2dff38e7639981794c43dc9167ba4afb71edb3d48305829a2dba60f7c353">MTYPE_WORK_QUEUE</a>, <span class="keyword">new</span>);
      
      <span class="keywordflow">return</span> <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
    }
  
  <span class="keyword">new</span>-&gt;items-&gt;del = (void (*)(<span class="keywordtype">void</span> *)) <a class="code" href="workqueue_8c.html#a7bb0b38c0628be0a01058cec1c19c6cc">work_queue_item_free</a>;  
  
  <a class="code" href="linklist_8c.html#adb2a0478aba995441aaf691d1f6fe5db">listnode_add</a> (&amp;<a class="code" href="workqueue_8c.html#a4d24d005d0b0547df065125f766a7f85">work_queues</a>, <span class="keyword">new</span>);
  
  <span class="keyword">new</span>-&gt;cycles.granularity = <a class="code" href="workqueue_8c.html#a70ae9b5a5f4e3a8315a9b8886b1fc3b2">WORK_QUEUE_MIN_GRANULARITY</a>;

  <span class="comment">/* Default values, can be overriden by caller */</span>
  <span class="keyword">new</span>-&gt;spec.hold = <a class="code" href="workqueue_8h.html#aadc610f042b208e17219436f143c8585">WORK_QUEUE_DEFAULT_HOLD</a>;
    
  <span class="keywordflow">return</span> <span class="keyword">new</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ae01d17ef2cd86436b8feb75c470c501a"></a><!-- doxytag: member="workqueue.c::work_queue_plug" ref="ae01d17ef2cd86436b8feb75c470c501a" args="(struct work_queue *wq)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void work_queue_plug </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structwork__queue.html">work_queue</a> *&#160;</td>
          <td class="paramname"><em>wq</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="workqueue_8c_source.html#l00211">211</a> of file <a class="el" href="workqueue_8c_source.html">workqueue.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordflow">if</span> (wq-&gt;<a class="code" href="structwork__queue.html#aa7a1097e517f22c4a289a8db9e91005d">thread</a>)
    <a class="code" href="thread_8c.html#aceb89c1157b6a1d8bb3afa5021f1ab6d">thread_cancel</a> (wq-&gt;<a class="code" href="structwork__queue.html#aa7a1097e517f22c4a289a8db9e91005d">thread</a>);
  
  wq-&gt;<a class="code" href="structwork__queue.html#aa7a1097e517f22c4a289a8db9e91005d">thread</a> = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
  
  <a class="code" href="zebra_8h.html#ab1ec1b6701a70280e13876cf1f6ae51d">UNSET_FLAG</a> (wq-&gt;<a class="code" href="structwork__queue.html#a35d9311d951ad4ca2d9497482467445f">flags</a>, <a class="code" href="workqueue_8h.html#a28aab240a6eaab4d2feb2eb97d2ab671">WQ_UNPLUGGED</a>);
}
</pre></div>
</div>
</div>
<a class="anchor" id="aee320c3071f774ffa32770b52f5a6494"></a><!-- doxytag: member="workqueue.c::work_queue_run" ref="aee320c3071f774ffa32770b52f5a6494" args="(struct thread *thread)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int work_queue_run </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structthread.html">thread</a> *&#160;</td>
          <td class="paramname"><em>thread</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="workqueue_8c_source.html#l00238">238</a> of file <a class="el" href="workqueue_8c_source.html">workqueue.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keyword">struct </span><a class="code" href="structwork__queue.html">work_queue</a> *wq;
  <span class="keyword">struct </span><a class="code" href="structwork__queue__item.html">work_queue_item</a> *item;
  <a class="code" href="workqueue_8h.html#a0e78d42489413cdb20b75485932a3885">wq_item_status</a> ret;
  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycles = 0;
  <span class="keyword">struct </span><a class="code" href="structlistnode.html">listnode</a> *node, *nnode;
  <span class="keywordtype">char</span> yielded = 0;

  wq = <a class="code" href="thread_8h.html#a78f2ae47a7a334f7f74bfed7fda48e5a">THREAD_ARG</a> (thread);
  wq-&gt;<a class="code" href="structwork__queue.html#aa7a1097e517f22c4a289a8db9e91005d">thread</a> = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;

  <a class="code" href="regex_8c.html#ad6d5aaa966ca7424f7cb9bd01f2c838b">assert</a> (wq &amp;&amp; wq-&gt;<a class="code" href="structwork__queue.html#a563ee1f1f6983b2a7a6dfb6624fd4942">items</a>);

  <span class="comment">/* calculate cycle granularity:</span>
<span class="comment">   * list iteration == 1 cycle</span>
<span class="comment">   * granularity == # cycles between checks whether we should yield.</span>
<span class="comment">   *</span>
<span class="comment">   * granularity should be &gt; 0, and can increase slowly after each run to</span>
<span class="comment">   * provide some hysteris, but not past cycles.best or 2*cycles.</span>
<span class="comment">   *</span>
<span class="comment">   * Best: starts low, can only increase</span>
<span class="comment">   *</span>
<span class="comment">   * Granularity: starts at WORK_QUEUE_MIN_GRANULARITY, can be decreased </span>
<span class="comment">   *              if we run to end of time slot, can increase otherwise </span>
<span class="comment">   *              by a small factor.</span>
<span class="comment">   *</span>
<span class="comment">   * We could use just the average and save some work, however we want to be</span>
<span class="comment">   * able to adjust quickly to CPU pressure. Average wont shift much if</span>
<span class="comment">   * daemon has been running a long time.</span>
<span class="comment">   */</span>
   <span class="keywordflow">if</span> (wq-&gt;<a class="code" href="structwork__queue.html#a077cdf65a4429efc9d7fa6c51d72e67f">cycles</a>.<a class="code" href="structwork__queue.html#ab01cb6e83c330ca80c63b397a46694fe">granularity</a> == 0)
     wq-&gt;<a class="code" href="structwork__queue.html#a077cdf65a4429efc9d7fa6c51d72e67f">cycles</a>.<a class="code" href="structwork__queue.html#ab01cb6e83c330ca80c63b397a46694fe">granularity</a> = <a class="code" href="workqueue_8c.html#a70ae9b5a5f4e3a8315a9b8886b1fc3b2">WORK_QUEUE_MIN_GRANULARITY</a>;

  <span class="keywordflow">for</span> (<a class="code" href="linklist_8h.html#a71512a873b8f0e2b4c84d3c949a9bbaf">ALL_LIST_ELEMENTS</a> (wq-&gt;<a class="code" href="structwork__queue.html#a563ee1f1f6983b2a7a6dfb6624fd4942">items</a>, node, nnode, item))
  {
    <a class="code" href="regex_8c.html#ad6d5aaa966ca7424f7cb9bd01f2c838b">assert</a> (item &amp;&amp; item-&gt;<a class="code" href="structwork__queue__item.html#aba6c356bbcf47612f80c690961518aa7">data</a>);
    
    <span class="comment">/* dont run items which are past their allowed retries */</span>
    <span class="keywordflow">if</span> (item-&gt;<a class="code" href="structwork__queue__item.html#a2ef387498560aaddedf3846babbbf177">ran</a> &gt; wq-&gt;<a class="code" href="structwork__queue.html#ae9c11795e9b293839422dd2c6ebfa493">spec</a>.<a class="code" href="structwork__queue.html#a74334af11b2e664ed8cd47fa13a76881">max_retries</a>)
      {
        <span class="comment">/* run error handler, if any */</span>
    <span class="keywordflow">if</span> (wq-&gt;<a class="code" href="structwork__queue.html#ae9c11795e9b293839422dd2c6ebfa493">spec</a>.<a class="code" href="structwork__queue.html#a4defd4b1c7ea708f3d30881057c26f61">errorfunc</a>)
      wq-&gt;<a class="code" href="structwork__queue.html#ae9c11795e9b293839422dd2c6ebfa493">spec</a>.<a class="code" href="structwork__queue.html#a4defd4b1c7ea708f3d30881057c26f61">errorfunc</a> (wq, item-&gt;<a class="code" href="structwork__queue__item.html#aba6c356bbcf47612f80c690961518aa7">data</a>);
    <a class="code" href="workqueue_8c.html#abb2634fd42a197c9f214d8543e23980d">work_queue_item_remove</a> (wq, node);
    <span class="keywordflow">continue</span>;
      }

    <span class="comment">/* run and take care of items that want to be retried immediately */</span>
    <span class="keywordflow">do</span>
      {
        ret = wq-&gt;<a class="code" href="structwork__queue.html#ae9c11795e9b293839422dd2c6ebfa493">spec</a>.<a class="code" href="structwork__queue.html#aabcb370748f886f6a167ea3b13a6d372">workfunc</a> (wq, item-&gt;<a class="code" href="structwork__queue__item.html#aba6c356bbcf47612f80c690961518aa7">data</a>);
        item-&gt;<a class="code" href="structwork__queue__item.html#a2ef387498560aaddedf3846babbbf177">ran</a>++;
      }
    <span class="keywordflow">while</span> ((ret == <a class="code" href="workqueue_8h.html#a0e78d42489413cdb20b75485932a3885ae4b9584851b2d121edce1a820c9f40ea">WQ_RETRY_NOW</a>) 
           &amp;&amp; (item-&gt;<a class="code" href="structwork__queue__item.html#a2ef387498560aaddedf3846babbbf177">ran</a> &lt; wq-&gt;<a class="code" href="structwork__queue.html#ae9c11795e9b293839422dd2c6ebfa493">spec</a>.<a class="code" href="structwork__queue.html#a74334af11b2e664ed8cd47fa13a76881">max_retries</a>));

    <span class="keywordflow">switch</span> (ret)
      {
      <span class="keywordflow">case</span> <a class="code" href="workqueue_8h.html#a0e78d42489413cdb20b75485932a3885ae7b1f6a044bfad1c23d813bb6c35b321">WQ_QUEUE_BLOCKED</a>:
        {
          <span class="comment">/* decrement item-&gt;ran again, cause this isn&#39;t an item</span>
<span class="comment">           * specific error, and fall through to WQ_RETRY_LATER</span>
<span class="comment">           */</span>
          item-&gt;<a class="code" href="structwork__queue__item.html#a2ef387498560aaddedf3846babbbf177">ran</a>--;
        }
      <span class="keywordflow">case</span> <a class="code" href="workqueue_8h.html#a0e78d42489413cdb20b75485932a3885af21f50d91fa63ac1fcc2038899d3306e">WQ_RETRY_LATER</a>:
    {
      <span class="keywordflow">goto</span> stats;
    }
      <span class="keywordflow">case</span> <a class="code" href="workqueue_8h.html#a0e78d42489413cdb20b75485932a3885ab06b16439cb8333f720a08a237c36836">WQ_REQUEUE</a>:
    {
      item-&gt;<a class="code" href="structwork__queue__item.html#a2ef387498560aaddedf3846babbbf177">ran</a>--;
      <a class="code" href="workqueue_8c.html#ad7b4ca345f9604d44b3d487105e18c9a">work_queue_item_requeue</a> (wq, node);
      <span class="keywordflow">break</span>;
    }
      <span class="keywordflow">case</span> <a class="code" href="workqueue_8h.html#a0e78d42489413cdb20b75485932a3885ae4b9584851b2d121edce1a820c9f40ea">WQ_RETRY_NOW</a>:
        <span class="comment">/* a RETRY_NOW that gets here has exceeded max_tries, same as ERROR */</span>
      <span class="keywordflow">case</span> <a class="code" href="workqueue_8h.html#a0e78d42489413cdb20b75485932a3885ace8991073868a69b568e04c471086776">WQ_ERROR</a>:
    {
      <span class="keywordflow">if</span> (wq-&gt;<a class="code" href="structwork__queue.html#ae9c11795e9b293839422dd2c6ebfa493">spec</a>.<a class="code" href="structwork__queue.html#a4defd4b1c7ea708f3d30881057c26f61">errorfunc</a>)
        wq-&gt;<a class="code" href="structwork__queue.html#ae9c11795e9b293839422dd2c6ebfa493">spec</a>.<a class="code" href="structwork__queue.html#a4defd4b1c7ea708f3d30881057c26f61">errorfunc</a> (wq, item);
    }
    <span class="comment">/* fall through here is deliberate */</span>
      <span class="keywordflow">case</span> <a class="code" href="workqueue_8h.html#a0e78d42489413cdb20b75485932a3885ac62ec0649e33ec9d6e0836fab0dec7fc">WQ_SUCCESS</a>:
      <span class="keywordflow">default</span>:
    {
      <a class="code" href="workqueue_8c.html#abb2634fd42a197c9f214d8543e23980d">work_queue_item_remove</a> (wq, node);
      <span class="keywordflow">break</span>;
    }
      }

    <span class="comment">/* completed cycle */</span>
    cycles++;

    <span class="comment">/* test if we should yield */</span>
    <span class="keywordflow">if</span> ( !(cycles % wq-&gt;<a class="code" href="structwork__queue.html#a077cdf65a4429efc9d7fa6c51d72e67f">cycles</a>.<a class="code" href="structwork__queue.html#ab01cb6e83c330ca80c63b397a46694fe">granularity</a>) 
        &amp;&amp; <a class="code" href="thread_8c.html#a88220a6a17cb0a1dc2fda0f9ff9d7b01">thread_should_yield</a> (thread))
      {
        yielded = 1;
        <span class="keywordflow">goto</span> stats;
      }
  }

stats:

<span class="preprocessor">#define WQ_HYSTERIS_FACTOR 2</span>
<span class="preprocessor"></span>
  <span class="comment">/* we yielded, check whether granularity should be reduced */</span>
  <span class="keywordflow">if</span> (yielded &amp;&amp; (cycles &lt; wq-&gt;cycles.granularity))
    {
      wq-&gt;<a class="code" href="structwork__queue.html#a077cdf65a4429efc9d7fa6c51d72e67f">cycles</a>.<a class="code" href="structwork__queue.html#ab01cb6e83c330ca80c63b397a46694fe">granularity</a> = ((cycles &gt; 0) ? cycles 
                                             : <a class="code" href="workqueue_8c.html#a70ae9b5a5f4e3a8315a9b8886b1fc3b2">WORK_QUEUE_MIN_GRANULARITY</a>);
    }
  
  <span class="keywordflow">if</span> (cycles &gt;= (wq-&gt;<a class="code" href="structwork__queue.html#a077cdf65a4429efc9d7fa6c51d72e67f">cycles</a>.<a class="code" href="structwork__queue.html#ab01cb6e83c330ca80c63b397a46694fe">granularity</a>))
    {
      <span class="keywordflow">if</span> (cycles &gt; wq-&gt;<a class="code" href="structwork__queue.html#a077cdf65a4429efc9d7fa6c51d72e67f">cycles</a>.<a class="code" href="structwork__queue.html#aba6bd3f6f97fbdecf4ae0835410f43ca">best</a>)
        wq-&gt;<a class="code" href="structwork__queue.html#a077cdf65a4429efc9d7fa6c51d72e67f">cycles</a>.<a class="code" href="structwork__queue.html#aba6bd3f6f97fbdecf4ae0835410f43ca">best</a> = cycles;
      
      <span class="comment">/* along with yielded check, provides hysteris for granularity */</span>
      <span class="keywordflow">if</span> (cycles &gt; (wq-&gt;<a class="code" href="structwork__queue.html#a077cdf65a4429efc9d7fa6c51d72e67f">cycles</a>.<a class="code" href="structwork__queue.html#ab01cb6e83c330ca80c63b397a46694fe">granularity</a> * WQ_HYSTERIS_FACTOR * 2))
        wq-&gt;<a class="code" href="structwork__queue.html#a077cdf65a4429efc9d7fa6c51d72e67f">cycles</a>.<a class="code" href="structwork__queue.html#ab01cb6e83c330ca80c63b397a46694fe">granularity</a> *= WQ_HYSTERIS_FACTOR; <span class="comment">/* quick ramp-up */</span>
      <span class="keywordflow">else</span> if (cycles &gt; (wq-&gt;<a class="code" href="structwork__queue.html#a077cdf65a4429efc9d7fa6c51d72e67f">cycles</a>.<a class="code" href="structwork__queue.html#ab01cb6e83c330ca80c63b397a46694fe">granularity</a> * WQ_HYSTERIS_FACTOR))
        wq-&gt;<a class="code" href="structwork__queue.html#a077cdf65a4429efc9d7fa6c51d72e67f">cycles</a>.<a class="code" href="structwork__queue.html#ab01cb6e83c330ca80c63b397a46694fe">granularity</a> += WQ_HYSTERIS_FACTOR;
    }
<span class="preprocessor">#undef WQ_HYSTERIS_FACTOR</span>
<span class="preprocessor"></span>  
  wq-&gt;<a class="code" href="structwork__queue.html#abc672c3cb4692cbc67fec570e8c94485">runs</a>++;
  wq-&gt;<a class="code" href="structwork__queue.html#a077cdf65a4429efc9d7fa6c51d72e67f">cycles</a>.<a class="code" href="structwork__queue.html#ae3d83725e098fb7288bf6eb59c7e4668">total</a> += cycles;

<span class="preprocessor">#if 0</span>
<span class="preprocessor"></span>  printf (<span class="stringliteral">&quot;%s: cycles %d, new: best %d, worst %d\n&quot;</span>,
            __func__, cycles, wq-&gt;<a class="code" href="structwork__queue.html#a077cdf65a4429efc9d7fa6c51d72e67f">cycles</a>.<a class="code" href="structwork__queue.html#aba6bd3f6f97fbdecf4ae0835410f43ca">best</a>, wq-&gt;<a class="code" href="structwork__queue.html#a077cdf65a4429efc9d7fa6c51d72e67f">cycles</a>.<a class="code" href="structwork__queue.html#ab01cb6e83c330ca80c63b397a46694fe">granularity</a>);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>  
  <span class="comment">/* Is the queue done yet? If it is, call the completion callback. */</span>
  <span class="keywordflow">if</span> (<a class="code" href="linklist_8h.html#a0429e6385b31a314cc64432a906201e5">listcount</a> (wq-&gt;<a class="code" href="structwork__queue.html#a563ee1f1f6983b2a7a6dfb6624fd4942">items</a>) &gt; 0)
    <a class="code" href="workqueue_8c.html#aa732b3b09b4d45c9167eb7e6bb97ac22">work_queue_schedule</a> (wq, 0);
  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (wq-&gt;<a class="code" href="structwork__queue.html#ae9c11795e9b293839422dd2c6ebfa493">spec</a>.<a class="code" href="structwork__queue.html#a8f91d98335cfc0e547c01194575a9558">completion_func</a>)
    wq-&gt;<a class="code" href="structwork__queue.html#ae9c11795e9b293839422dd2c6ebfa493">spec</a>.<a class="code" href="structwork__queue.html#a8f91d98335cfc0e547c01194575a9558">completion_func</a> (wq);
  
  <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="aa732b3b09b4d45c9167eb7e6bb97ac22"></a><!-- doxytag: member="workqueue.c::work_queue_schedule" ref="aa732b3b09b4d45c9167eb7e6bb97ac22" args="(struct work_queue *wq, unsigned int delay)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int work_queue_schedule </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structwork__queue.html">work_queue</a> *&#160;</td>
          <td class="paramname"><em>wq</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&#160;</td>
          <td class="paramname"><em>delay</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="workqueue_8c_source.html#l00107">107</a> of file <a class="el" href="workqueue_8c_source.html">workqueue.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="comment">/* if appropriate, schedule work queue thread */</span>
  <span class="keywordflow">if</span> ( <a class="code" href="zebra_8h.html#a9310812ac92febfb7d1eb10127aea1a8">CHECK_FLAG</a> (wq-&gt;<a class="code" href="structwork__queue.html#a35d9311d951ad4ca2d9497482467445f">flags</a>, <a class="code" href="workqueue_8h.html#a28aab240a6eaab4d2feb2eb97d2ab671">WQ_UNPLUGGED</a>)
       &amp;&amp; (wq-&gt;<a class="code" href="structwork__queue.html#aa7a1097e517f22c4a289a8db9e91005d">thread</a> == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
       &amp;&amp; (<a class="code" href="linklist_8h.html#a0429e6385b31a314cc64432a906201e5">listcount</a> (wq-&gt;<a class="code" href="structwork__queue.html#a563ee1f1f6983b2a7a6dfb6624fd4942">items</a>) &gt; 0) )
    {
      wq-&gt;<a class="code" href="structwork__queue.html#aa7a1097e517f22c4a289a8db9e91005d">thread</a> = <a class="code" href="thread_8h.html#ad0054011ef431feb7c0c5f867ab35ef7">thread_add_background</a> (wq-&gt;<a class="code" href="structwork__queue.html#ae71751954c96d57c40b624ef93044d4f">master</a>, <a class="code" href="workqueue_8c.html#aee320c3071f774ffa32770b52f5a6494">work_queue_run</a>, 
                                          wq, delay);
      <span class="keywordflow">return</span> 1;
    }
  <span class="keywordflow">else</span>
    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ac421962a00d94a292cb4097a4df7a2c9"></a><!-- doxytag: member="workqueue.c::work_queue_unplug" ref="ac421962a00d94a292cb4097a4df7a2c9" args="(struct work_queue *wq)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void work_queue_unplug </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structwork__queue.html">work_queue</a> *&#160;</td>
          <td class="paramname"><em>wq</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="workqueue_8c_source.html#l00225">225</a> of file <a class="el" href="workqueue_8c_source.html">workqueue.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <a class="code" href="zebra_8h.html#a7c593725d5bbf27a37a922ae84b02333">SET_FLAG</a> (wq-&gt;<a class="code" href="structwork__queue.html#a35d9311d951ad4ca2d9497482467445f">flags</a>, <a class="code" href="workqueue_8h.html#a28aab240a6eaab4d2feb2eb97d2ab671">WQ_UNPLUGGED</a>);

  <span class="comment">/* if thread isnt already waiting, add one */</span>
  <a class="code" href="workqueue_8c.html#aa732b3b09b4d45c9167eb7e6bb97ac22">work_queue_schedule</a> (wq, wq-&gt;<a class="code" href="structwork__queue.html#ae9c11795e9b293839422dd2c6ebfa493">spec</a>.<a class="code" href="structwork__queue.html#a6f998e18d62286e5b77844faf7c3ded2">hold</a>);
}
</pre></div>
</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="a4d24d005d0b0547df065125f766a7f85"></a><!-- doxytag: member="workqueue.c::work_queues" ref="a4d24d005d0b0547df065125f766a7f85" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structlist.html">list</a> <a class="el" href="workqueue_8c.html#a4d24d005d0b0547df065125f766a7f85">work_queues</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="workqueue_8c_source.html#l00033">33</a> of file <a class="el" href="workqueue_8c_source.html">workqueue.c</a>.</p>

</div>
</div>
</div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="workqueue_8c.html">workqueue.c</a>      </li>

    <li class="footer">Generated on Tue Apr 24 2012 10:41:25 for OSPFN by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.5.1 </li>
   </ul>
 </div>


</body>
</html>
