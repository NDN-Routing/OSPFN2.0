<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>OSPFN: zebra/rtread_getmsg.c File Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>


</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">OSPFN
   &#160;<span id="projectnumber">1.1</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('rtread__getmsg_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#define-members">Defines</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">zebra/rtread_getmsg.c File Reference</div>  </div>
</div>
<div class="contents">
<div class="textblock"><code>#include &lt;<a class="el" href="zebra_8h_source.html">zebra.h</a>&gt;</code><br/>
<code>#include &quot;<a class="el" href="prefix_8h_source.html">prefix.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="log_8h_source.html">log.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="if_8h_source.html">if.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="rib_8h_source.html">zebra/rib.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="zserv_8h_source.html">zebra/zserv.h</a>&quot;</code><br/>
<code>#include &lt;sys/stream.h&gt;</code><br/>
<code>#include &lt;sys/tihdr.h&gt;</code><br/>
<code>#include &lt;inet/common.h&gt;</code><br/>
<code>#include &lt;inet/ip.h&gt;</code><br/>
<code>#include &lt;inet/mib2.h&gt;</code><br/>
</div><div class="textblock"><div class="dynheader">
Include dependency graph for rtread_getmsg.c:</div>
<div class="dyncontent">
<div class="center"><img src="rtread__getmsg_8c__incl.png" border="0" usemap="#zebra_2rtread__getmsg_8c" alt=""/></div>
<map name="zebra_2rtread__getmsg_8c" id="zebra_2rtread__getmsg_8c">
<area shape="rect" id="node3" href="zebra_8h.html" title="zebra.h" alt="" coords="1419,80,1485,107"/><area shape="rect" id="node61" href="prefix_8h.html" title="prefix.h" alt="" coords="2866,229,2933,256"/><area shape="rect" id="node65" href="log_8h.html" title="log.h" alt="" coords="2765,80,2816,107"/><area shape="rect" id="node68" href="if_8h.html" title="if.h" alt="" coords="3131,155,3171,181"/><area shape="rect" id="node72" href="rib_8h.html" title="zebra/rib.h" alt="" coords="2898,155,2981,181"/><area shape="rect" id="node75" href="zserv_8h.html" title="zebra/zserv.h" alt="" coords="2963,80,3064,107"/><area shape="rect" id="node57" href="zassert_8h.html" title="zassert.h" alt="" coords="2117,155,2195,181"/><area shape="rect" id="node59" href="str_8h.html" title="str.h" alt="" coords="2219,155,2268,181"/><area shape="rect" id="node63" href="sockunion_8h.html" title="sockunion.h" alt="" coords="2853,304,2947,331"/><area shape="rect" id="node70" href="linklist_8h.html" title="linklist.h" alt="" coords="3115,229,3185,256"/><area shape="rect" id="node79" href="workqueue_8h.html" title="workqueue.h" alt="" coords="3006,155,3105,181"/></map>
</div>
</div>
<p><a href="rtread__getmsg_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="define-members"></a>
Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rtread__getmsg_8c.html#ad498f21cbbcd46419536193a040185c3">_PATH_GETMSG_ROUTE</a>&#160;&#160;&#160;&quot;/dev/<a class="el" href="spgrid_8c.html#addd335afdb9230f431842ebb6cbbce62">ip</a>&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rtread__getmsg_8c.html#afd8d213d4c14058a46d3386f8eea2d75">RT_BUFSIZ</a>&#160;&#160;&#160;8192</td></tr>
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rtread__getmsg_8c.html#adb03cb8d727e6bb333163656678fa0e5">handle_route_entry</a> (mib2_ipRouteEntry_t *routeEntry)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rtread__getmsg_8c.html#a7aaf8ffe18dfb22ce045f52cd845efa2">route_read</a> (void)</td></tr>
</table>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="ad498f21cbbcd46419536193a040185c3"></a><!-- doxytag: member="rtread_getmsg.c::_PATH_GETMSG_ROUTE" ref="ad498f21cbbcd46419536193a040185c3" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define _PATH_GETMSG_ROUTE&#160;&#160;&#160;&quot;/dev/<a class="el" href="spgrid_8c.html#addd335afdb9230f431842ebb6cbbce62">ip</a>&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="rtread__getmsg_8c_source.html#l00064">64</a> of file <a class="el" href="rtread__getmsg_8c_source.html">rtread_getmsg.c</a>.</p>

</div>
</div>
<a class="anchor" id="afd8d213d4c14058a46d3386f8eea2d75"></a><!-- doxytag: member="rtread_getmsg.c::RT_BUFSIZ" ref="afd8d213d4c14058a46d3386f8eea2d75" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define RT_BUFSIZ&#160;&#160;&#160;8192</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="rtread__getmsg_8c_source.html#l00067">67</a> of file <a class="el" href="rtread__getmsg_8c_source.html">rtread_getmsg.c</a>.</p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="adb03cb8d727e6bb333163656678fa0e5"></a><!-- doxytag: member="rtread_getmsg.c::handle_route_entry" ref="adb03cb8d727e6bb333163656678fa0e5" args="(mib2_ipRouteEntry_t *routeEntry)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void handle_route_entry </td>
          <td>(</td>
          <td class="paramtype">mib2_ipRouteEntry_t *&#160;</td>
          <td class="paramname"><em>routeEntry</em></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="rtread__getmsg_8c_source.html#l00070">70</a> of file <a class="el" href="rtread__getmsg_8c_source.html">rtread_getmsg.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keyword">struct </span><a class="code" href="structprefix__ipv4.html">prefix_ipv4</a>  <a class="code" href="structprefix.html">prefix</a>;
    <span class="keyword">struct </span>in_addr      tmpaddr, gateway;
    u_char          zebra_flags = 0;

    <span class="keywordflow">if</span> (routeEntry-&gt;ipRouteInfo.re_ire_type &amp; IRE_CACHETABLE)
        <span class="keywordflow">return</span>;

    <span class="keywordflow">if</span> (routeEntry-&gt;ipRouteInfo.re_ire_type &amp; IRE_HOST_REDIRECT)
        zebra_flags |= <a class="code" href="zebra_8h.html#a31c75681286a8a6a7311c55d8db8409e">ZEBRA_FLAG_SELFROUTE</a>;

    <a class="code" href="structprefix.html">prefix</a>.<a class="code" href="structprefix.html#a3848d44348192dc4de7ac89e317399bd">family</a> = AF_INET;

    tmpaddr.s_addr = routeEntry-&gt;ipRouteDest;
    <a class="code" href="structprefix.html">prefix</a>.<a class="code" href="structprefix.html#af508982a05429729278c96708bd9e337">prefix</a> = tmpaddr;

    tmpaddr.s_addr = routeEntry-&gt;ipRouteMask;
    <a class="code" href="structprefix.html">prefix</a>.<a class="code" href="structprefix.html#aae8dafba4797d25cf1d141780d87ff02">prefixlen</a> = <a class="code" href="prefix_8c.html#ab83ffad6b766ddd0ef87e4da228c322d">ip_masklen</a> (tmpaddr);

    gateway.s_addr = routeEntry-&gt;ipRouteNextHop;

    <a class="code" href="rib_8h.html#a9f8cbb8feedf49125b4da9b87c36fedb">rib_add_ipv4</a> (<a class="code" href="zebra_8h.html#a742710c29f8b3e8dc06ce7a5965c097c">ZEBRA_ROUTE_KERNEL</a>, zebra_flags, &amp;<a class="code" href="structprefix.html">prefix</a>,
              &amp;gateway, <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, 0, 0, 0);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a7aaf8ffe18dfb22ce045f52cd845efa2"></a><!-- doxytag: member="rtread_getmsg.c::route_read" ref="a7aaf8ffe18dfb22ce045f52cd845efa2" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void route_read </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="rtread__getmsg_8c_source.html#l00097">97</a> of file <a class="el" href="rtread__getmsg_8c_source.html">rtread_getmsg.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span>            storage[<a class="code" href="rtread__getmsg_8c.html#afd8d213d4c14058a46d3386f8eea2d75">RT_BUFSIZ</a>];

    <span class="keyword">struct </span>T_optmgmt_req    *TLIreq = (<span class="keyword">struct </span>T_optmgmt_req *) storage;
    <span class="keyword">struct </span>T_optmgmt_ack    *TLIack = (<span class="keyword">struct </span>T_optmgmt_ack *) storage;
    <span class="keyword">struct </span>T_error_ack  *TLIerr = (<span class="keyword">struct </span>T_error_ack *) storage;

    <span class="keyword">struct </span>opthdr       *MIB2hdr;

    mib2_ipRouteEntry_t *routeEntry, *lastRouteEntry;

    <span class="keyword">struct </span>strbuf       msgdata;
    <span class="keywordtype">int</span>         <a class="code" href="structflags.html">flags</a>, dev, retval, process;

    <span class="keywordflow">if</span> ((dev = open (<a class="code" href="rtread__getmsg_8c.html#ad498f21cbbcd46419536193a040185c3">_PATH_GETMSG_ROUTE</a>, O_RDWR)) == -1) {
        <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;can&#39;t open %s: %s&quot;</span>, <a class="code" href="rtread__getmsg_8c.html#ad498f21cbbcd46419536193a040185c3">_PATH_GETMSG_ROUTE</a>,
            <a class="code" href="log_8c.html#a5292a9aa20fcddbb3998241685e18279">safe_strerror</a> (errno));
        <span class="keywordflow">return</span>;
    }

    TLIreq-&gt;PRIM_type = T_OPTMGMT_REQ;
    TLIreq-&gt;OPT_offset = <span class="keyword">sizeof</span> (<span class="keyword">struct </span>T_optmgmt_req);
    TLIreq-&gt;OPT_length = <span class="keyword">sizeof</span> (<span class="keyword">struct </span>opthdr);
    TLIreq-&gt;MGMT_flags = T_CURRENT;

    MIB2hdr = (<span class="keyword">struct </span>opthdr *) &amp;TLIreq[1];

    MIB2hdr-&gt;level = MIB2_IP;
    MIB2hdr-&gt;name = 0;
    MIB2hdr-&gt;len = 0;
    
    msgdata.buf = storage;
    msgdata.len = <span class="keyword">sizeof</span> (<span class="keyword">struct </span>T_optmgmt_req) + sizeof (struct opthdr);

    flags = 0;

    <span class="keywordflow">if</span> (putmsg (dev, &amp;msgdata, <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, flags) == -1) {
        <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;putmsg failed: %s&quot;</span>, <a class="code" href="log_8c.html#a5292a9aa20fcddbb3998241685e18279">safe_strerror</a> (errno));
        <span class="keywordflow">goto</span> <a class="code" href="vtysh_8c.html#afa5f6ba5518772e1487b961507e2a570">exit</a>;
    }

    MIB2hdr = (<span class="keyword">struct </span>opthdr *) &amp;TLIack[1];
    msgdata.maxlen = <span class="keyword">sizeof</span> (storage);

    <span class="keywordflow">while</span> (1) {
        flags = 0;
        retval = getmsg (dev, &amp;msgdata, <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;flags);

        <span class="keywordflow">if</span> (retval == -1) {
            <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;getmsg(ctl) failed: %s&quot;</span>, <a class="code" href="log_8c.html#a5292a9aa20fcddbb3998241685e18279">safe_strerror</a> (errno));
            <span class="keywordflow">goto</span> <a class="code" href="vtysh_8c.html#afa5f6ba5518772e1487b961507e2a570">exit</a>;
        }

        <span class="comment">/* This is normal loop termination */</span>
        <span class="keywordflow">if</span> (retval == 0 &amp;&amp;
            msgdata.len &gt;= sizeof (<span class="keyword">struct</span> T_optmgmt_ack) &amp;&amp;
            TLIack-&gt;PRIM_type == T_OPTMGMT_ACK &amp;&amp;
            TLIack-&gt;MGMT_flags == T_SUCCESS &amp;&amp;
            MIB2hdr-&gt;len == 0)
            <span class="keywordflow">break</span>;

        <span class="keywordflow">if</span> (msgdata.len &gt;= sizeof (<span class="keyword">struct</span> T_error_ack) &amp;&amp;
            TLIerr-&gt;PRIM_type == T_ERROR_ACK) {
            <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;getmsg(ctl) returned T_ERROR_ACK: %s&quot;</span>,
                <a class="code" href="log_8c.html#a5292a9aa20fcddbb3998241685e18279">safe_strerror</a> ((TLIerr-&gt;TLI_error == TSYSERR)
                ? TLIerr-&gt;UNIX_error : EPROTO));
            <span class="keywordflow">break</span>;
        }

        <span class="comment">/* should dump more debugging info to the log statement,</span>
<span class="comment">           like what GateD does in this instance, but not</span>
<span class="comment">           critical yet. */</span>
        <span class="keywordflow">if</span> (retval != MOREDATA ||
            msgdata.len &lt; sizeof (<span class="keyword">struct</span> T_optmgmt_ack) ||
            TLIack-&gt;PRIM_type != T_OPTMGMT_ACK ||
            TLIack-&gt;MGMT_flags != T_SUCCESS) {
            errno = ENOMSG;
            <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;getmsg(ctl) returned bizarreness&quot;</span>);
            <span class="keywordflow">break</span>;
        }

        <span class="comment">/* MIB2_IP_21 is the the pseudo-MIB2 ipRouteTable</span>
<span class="comment">           entry, see &lt;inet/mib2.h&gt;. &quot;This isn&#39;t the MIB data</span>
<span class="comment">           you&#39;re looking for.&quot; */</span>
        process = (MIB2hdr-&gt;level == MIB2_IP &amp;&amp;
            MIB2hdr-&gt;name == MIB2_IP_21) ? 1 : 0;

        <span class="comment">/* getmsg writes the data buffer out completely, not</span>
<span class="comment">           to the closest smaller multiple. Unless reassembling</span>
<span class="comment">           data structures across buffer boundaries is your idea</span>
<span class="comment">           of a good time, set maxlen to the closest smaller</span>
<span class="comment">           multiple of the size of the datastructure you&#39;re</span>
<span class="comment">           retrieving. */</span>
        msgdata.maxlen = <span class="keyword">sizeof</span> (storage) - (<span class="keyword">sizeof</span> (storage)
            % <span class="keyword">sizeof</span> (mib2_ipRouteEntry_t));

        msgdata.len = 0;
        flags = 0;

        <span class="keywordflow">do</span> {
            retval = getmsg (dev, <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;msgdata, &amp;flags);

            <span class="keywordflow">if</span> (retval == -1) {
                <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;getmsg(data) failed: %s&quot;</span>,
                    <a class="code" href="log_8c.html#a5292a9aa20fcddbb3998241685e18279">safe_strerror</a> (errno));
                <span class="keywordflow">goto</span> <a class="code" href="vtysh_8c.html#afa5f6ba5518772e1487b961507e2a570">exit</a>;
            }

            <span class="keywordflow">if</span> (!(retval == 0 || retval == MOREDATA)) {
                <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;getmsg(data) returned %d&quot;</span>, retval);
                <span class="keywordflow">goto</span> <a class="code" href="vtysh_8c.html#afa5f6ba5518772e1487b961507e2a570">exit</a>;
            }

            <span class="keywordflow">if</span> (process) {
                <span class="keywordflow">if</span> (msgdata.len %
                    sizeof (mib2_ipRouteEntry_t) != 0) {
                    <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;getmsg(data) returned &quot;</span>
<span class="stringliteral">&quot;msgdata.len = %d (%% sizeof (mib2_ipRouteEntry_t) != 0)&quot;</span>, msgdata.len);
                    <span class="keywordflow">goto</span> <a class="code" href="vtysh_8c.html#afa5f6ba5518772e1487b961507e2a570">exit</a>;
                }

                routeEntry = (mib2_ipRouteEntry_t *)
                    msgdata.buf;
                lastRouteEntry = (mib2_ipRouteEntry_t *)
                    (msgdata.buf + msgdata.len);
                <span class="keywordflow">do</span> {
                    <a class="code" href="rtread__getmsg_8c.html#adb03cb8d727e6bb333163656678fa0e5">handle_route_entry</a> (routeEntry);
                } <span class="keywordflow">while</span> (++routeEntry &lt; lastRouteEntry);
            }
        } <span class="keywordflow">while</span> (retval == MOREDATA);
    }

<a class="code" href="vtysh_8c.html#afa5f6ba5518772e1487b961507e2a570">exit</a>:
    close (dev);
}
</pre></div>
</div>
</div>
</div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="rtread__getmsg_8c.html">rtread_getmsg.c</a>      </li>

    <li class="footer">Generated on Tue Apr 24 2012 10:41:38 for OSPFN by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.5.1 </li>
   </ul>
 </div>


</body>
</html>
