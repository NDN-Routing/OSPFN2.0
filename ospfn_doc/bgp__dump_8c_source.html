<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>OSPFN: bgpd/bgp_dump.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>


</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">OSPFN
   &#160;<span id="projectnumber">1.1</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('bgp__dump_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">bgpd/bgp_dump.c</div>  </div>
</div>
<div class="contents">
<a href="bgp__dump_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* BGP-4 dump routine</span>
<a name="l00002"></a>00002 <span class="comment">   Copyright (C) 1999 Kunihiro Ishiguro</span>
<a name="l00003"></a>00003 <span class="comment"></span>
<a name="l00004"></a>00004 <span class="comment">This file is part of GNU Zebra.</span>
<a name="l00005"></a>00005 <span class="comment"></span>
<a name="l00006"></a>00006 <span class="comment">GNU Zebra is free software; you can redistribute it and/or modify it</span>
<a name="l00007"></a>00007 <span class="comment">under the terms of the GNU General Public License as published by the</span>
<a name="l00008"></a>00008 <span class="comment">Free Software Foundation; either version 2, or (at your option) any</span>
<a name="l00009"></a>00009 <span class="comment">later version.</span>
<a name="l00010"></a>00010 <span class="comment"></span>
<a name="l00011"></a>00011 <span class="comment">GNU Zebra is distributed in the hope that it will be useful, but</span>
<a name="l00012"></a>00012 <span class="comment">WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00013"></a>00013 <span class="comment">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<a name="l00014"></a>00014 <span class="comment">General Public License for more details.</span>
<a name="l00015"></a>00015 <span class="comment"></span>
<a name="l00016"></a>00016 <span class="comment">You should have received a copy of the GNU General Public License</span>
<a name="l00017"></a>00017 <span class="comment">along with GNU Zebra; see the file COPYING.  If not, write to the Free</span>
<a name="l00018"></a>00018 <span class="comment">Software Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA</span>
<a name="l00019"></a>00019 <span class="comment">02111-1307, USA.  */</span>
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;<a class="code" href="zebra_8h.html">zebra.h</a>&gt;</span>
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="log_8h.html">log.h</a>&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="stream_8h.html">stream.h</a>&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="sockunion_8h.html">sockunion.h</a>&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="command_8h.html">command.h</a>&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="prefix_8h.html">prefix.h</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="thread_8h.html">thread.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="linklist_8h.html">linklist.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="bgp__table_8h.html">bgpd/bgp_table.h</a>&quot;</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="bgpd_8h.html">bgpd/bgpd.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="bgp__route_8h.html">bgpd/bgp_route.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="bgp__attr_8h.html">bgpd/bgp_attr.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="bgp__dump_8h.html">bgpd/bgp_dump.h</a>&quot;</span>
<a name="l00036"></a>00036 
<a name="l00037"></a><a class="code" href="bgp__dump_8c.html#af5c4c5c58c06e9e0da028895448608ab">00037</a> <span class="keyword">enum</span> <a class="code" href="bgp__dump_8c.html#af5c4c5c58c06e9e0da028895448608ab">bgp_dump_type</a>
<a name="l00038"></a>00038 {
<a name="l00039"></a><a class="code" href="bgp__dump_8c.html#af5c4c5c58c06e9e0da028895448608abad3ea5d7423efba6d550de303f4c535bd">00039</a>   <a class="code" href="bgp__dump_8c.html#af5c4c5c58c06e9e0da028895448608abad3ea5d7423efba6d550de303f4c535bd">BGP_DUMP_ALL</a>,
<a name="l00040"></a><a class="code" href="bgp__dump_8c.html#af5c4c5c58c06e9e0da028895448608abad4305596c9de6b42129a894800dc2a4b">00040</a>   <a class="code" href="bgp__dump_8c.html#af5c4c5c58c06e9e0da028895448608abad4305596c9de6b42129a894800dc2a4b">BGP_DUMP_UPDATES</a>,
<a name="l00041"></a><a class="code" href="bgp__dump_8c.html#af5c4c5c58c06e9e0da028895448608aba8da7006d79a833ea2d2d60d3c0f44ecd">00041</a>   <a class="code" href="bgp__dump_8c.html#af5c4c5c58c06e9e0da028895448608aba8da7006d79a833ea2d2d60d3c0f44ecd">BGP_DUMP_ROUTES</a>
<a name="l00042"></a>00042 };
<a name="l00043"></a>00043 
<a name="l00044"></a><a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083a">00044</a> <span class="keyword">enum</span> <a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083a">MRT_MSG_TYPES</a> {
<a name="l00045"></a><a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa13078c6ece92b3953cde3dd3b97256c7">00045</a>    <a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa13078c6ece92b3953cde3dd3b97256c7">MSG_NULL</a>,
<a name="l00046"></a><a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa702fa26f01731d4e6f62ec9865ae6364">00046</a>    <a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa702fa26f01731d4e6f62ec9865ae6364">MSG_START</a>,                   <span class="comment">/* sender is starting up */</span>
<a name="l00047"></a><a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aac9b00665fd37f5e562216ed3b27a7120">00047</a>    <a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aac9b00665fd37f5e562216ed3b27a7120">MSG_DIE</a>,                     <span class="comment">/* receiver should shut down */</span>
<a name="l00048"></a><a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa7b9ee67104832ffa180539a80169f58d">00048</a>    <a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa7b9ee67104832ffa180539a80169f58d">MSG_I_AM_DEAD</a>,               <span class="comment">/* sender is shutting down */</span>
<a name="l00049"></a><a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa9e8ddd1e79894b86041c109e1148019a">00049</a>    <a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa9e8ddd1e79894b86041c109e1148019a">MSG_PEER_DOWN</a>,               <span class="comment">/* sender&#39;s peer is down */</span>
<a name="l00050"></a><a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa8ed26ebdf07446e8ad9ff3b4c36f5152">00050</a>    <a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa8ed26ebdf07446e8ad9ff3b4c36f5152">MSG_PROTOCOL_BGP</a>,            <span class="comment">/* msg is a BGP packet */</span>
<a name="l00051"></a><a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa6dd84f574b387bb119a6c244571c80d1">00051</a>    <a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa6dd84f574b387bb119a6c244571c80d1">MSG_PROTOCOL_RIP</a>,            <span class="comment">/* msg is a RIP packet */</span>
<a name="l00052"></a><a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa9ff740459ab6f3820f85e8a437f3faba">00052</a>    <a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa9ff740459ab6f3820f85e8a437f3faba">MSG_PROTOCOL_IDRP</a>,           <span class="comment">/* msg is an IDRP packet */</span>
<a name="l00053"></a><a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa10519cd845f91bedc69a44cd217c0c23">00053</a>    <a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa10519cd845f91bedc69a44cd217c0c23">MSG_PROTOCOL_RIPNG</a>,          <span class="comment">/* msg is a RIPNG packet */</span>
<a name="l00054"></a><a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa0d6c1d1a74f658dc83125c0f029bbeab">00054</a>    <a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa0d6c1d1a74f658dc83125c0f029bbeab">MSG_PROTOCOL_BGP4PLUS</a>,       <span class="comment">/* msg is a BGP4+ packet */</span>
<a name="l00055"></a><a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa6f151d9aeccc6655cbeaeaaff2be0b17">00055</a>    <a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa6f151d9aeccc6655cbeaeaaff2be0b17">MSG_PROTOCOL_BGP4PLUS_01</a>,    <span class="comment">/* msg is a BGP4+ (draft 01) packet */</span>
<a name="l00056"></a><a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa85206ff6abf8a3cd4ef073816778825c">00056</a>    <a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa85206ff6abf8a3cd4ef073816778825c">MSG_PROTOCOL_OSPF</a>,           <span class="comment">/* msg is an OSPF packet */</span>
<a name="l00057"></a><a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aaa0777352feb887450fbe079f4588d6f4">00057</a>    <a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aaa0777352feb887450fbe079f4588d6f4">MSG_TABLE_DUMP</a>,              <span class="comment">/* routing table dump */</span>
<a name="l00058"></a><a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa799d1ad00cfd330f5752175079f075c0">00058</a>    <a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa799d1ad00cfd330f5752175079f075c0">MSG_TABLE_DUMP_V2</a>            <span class="comment">/* routing table dump, version 2 */</span>
<a name="l00059"></a>00059 };
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="bgp__dump_8c.html#a03e20f1079916f8b199d845d7e9290ec">bgp_dump_interval_func</a> (<span class="keyword">struct</span> <a class="code" href="structthread.html">thread</a> *);
<a name="l00062"></a>00062 
<a name="l00063"></a><a class="code" href="structbgp__dump.html">00063</a> <span class="keyword">struct </span><a class="code" href="structbgp__dump.html">bgp_dump</a>
<a name="l00064"></a>00064 {
<a name="l00065"></a><a class="code" href="structbgp__dump.html#a0a26a007ae667dea94fc4e5cd7cffd37">00065</a>   <span class="keyword">enum</span> <a class="code" href="bgp__dump_8c.html#af5c4c5c58c06e9e0da028895448608ab">bgp_dump_type</a> <a class="code" href="structbgp__dump.html#a0a26a007ae667dea94fc4e5cd7cffd37">type</a>;
<a name="l00066"></a>00066 
<a name="l00067"></a><a class="code" href="structbgp__dump.html#a9b85be4d92c696e0cfdb38d8ca8705c6">00067</a>   <span class="keywordtype">char</span> *<a class="code" href="structbgp__dump.html#a9b85be4d92c696e0cfdb38d8ca8705c6">filename</a>;
<a name="l00068"></a>00068 
<a name="l00069"></a><a class="code" href="structbgp__dump.html#a39e52c350128e7df6c3c1582121be402">00069</a>   FILE *<a class="code" href="structbgp__dump.html#a39e52c350128e7df6c3c1582121be402">fp</a>;
<a name="l00070"></a>00070 
<a name="l00071"></a><a class="code" href="structbgp__dump.html#aa47b11c732f512a63663c56976687f18">00071</a>   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structbgp__dump.html#aa47b11c732f512a63663c56976687f18">interval</a>;
<a name="l00072"></a>00072 
<a name="l00073"></a><a class="code" href="structbgp__dump.html#a5f69c1d41e0fdafd5ade563b5458045c">00073</a>   <span class="keywordtype">char</span> *<a class="code" href="structbgp__dump.html#a5f69c1d41e0fdafd5ade563b5458045c">interval_str</a>;
<a name="l00074"></a>00074 
<a name="l00075"></a><a class="code" href="structbgp__dump.html#abf41ec887f001277014534e163588475">00075</a>   <span class="keyword">struct </span><a class="code" href="structthread.html">thread</a> *<a class="code" href="structbgp__dump.html#abf41ec887f001277014534e163588475">t_interval</a>;
<a name="l00076"></a>00076 };
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 <span class="comment">/* BGP packet dump output buffer. */</span>
<a name="l00079"></a><a class="code" href="bgp__dump_8c.html#a1d11a40e549767e660a25317d84233e2">00079</a> <span class="keyword">struct </span><a class="code" href="structstream.html">stream</a> *<a class="code" href="bgp__dump_8c.html#a1d11a40e549767e660a25317d84233e2">bgp_dump_obuf</a>;
<a name="l00080"></a>00080 
<a name="l00081"></a>00081 <span class="comment">/* BGP dump strucuture for &#39;dump bgp all&#39; */</span>
<a name="l00082"></a><a class="code" href="bgp__dump_8c.html#a893516e440b8519ca09ed2b808373234">00082</a> <span class="keyword">struct </span><a class="code" href="structbgp__dump.html">bgp_dump</a> <a class="code" href="bgp__dump_8c.html#a893516e440b8519ca09ed2b808373234">bgp_dump_all</a>;
<a name="l00083"></a>00083 
<a name="l00084"></a>00084 <span class="comment">/* BGP dump structure for &#39;dump bgp updates&#39; */</span>
<a name="l00085"></a><a class="code" href="bgp__dump_8c.html#aacab64cf07b4180898b9d032bdc5fef7">00085</a> <span class="keyword">struct </span><a class="code" href="structbgp__dump.html">bgp_dump</a> <a class="code" href="bgp__dump_8c.html#aacab64cf07b4180898b9d032bdc5fef7">bgp_dump_updates</a>;
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 <span class="comment">/* BGP dump structure for &#39;dump bgp routes&#39; */</span>
<a name="l00088"></a><a class="code" href="bgp__dump_8c.html#a7b4b628fda6c31730228e04aacd18e5b">00088</a> <span class="keyword">struct </span><a class="code" href="structbgp__dump.html">bgp_dump</a> <a class="code" href="bgp__dump_8c.html#a7b4b628fda6c31730228e04aacd18e5b">bgp_dump_routes</a>;
<a name="l00089"></a>00089 
<a name="l00090"></a>00090 <span class="comment">/* Dump whole BGP table is very heavy process.  */</span>
<a name="l00091"></a><a class="code" href="bgp__dump_8c.html#ad83105d839fc720128fa304d481982a8">00091</a> <span class="keyword">struct </span><a class="code" href="structthread.html">thread</a> *<a class="code" href="bgp__dump_8c.html#ad83105d839fc720128fa304d481982a8">t_bgp_dump_routes</a>;
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 <span class="comment">/* Some define for BGP packet dump. */</span>
<a name="l00094"></a>00094 <span class="keyword">static</span> FILE *
<a name="l00095"></a><a class="code" href="bgp__dump_8c.html#a83a98e4dd07ab8ab3065e9fa4c7cfde5">00095</a> <a class="code" href="bgp__dump_8c.html#a83a98e4dd07ab8ab3065e9fa4c7cfde5">bgp_dump_open_file</a> (<span class="keyword">struct</span> <a class="code" href="structbgp__dump.html">bgp_dump</a> *<a class="code" href="structbgp__dump.html">bgp_dump</a>)
<a name="l00096"></a>00096 {
<a name="l00097"></a>00097   <span class="keywordtype">int</span> ret;
<a name="l00098"></a>00098   time_t clock;
<a name="l00099"></a>00099   <span class="keyword">struct </span>tm *tm;
<a name="l00100"></a>00100   <span class="keywordtype">char</span> fullpath[MAXPATHLEN];
<a name="l00101"></a>00101   <span class="keywordtype">char</span> realpath[MAXPATHLEN];
<a name="l00102"></a>00102   mode_t oldumask;
<a name="l00103"></a>00103 
<a name="l00104"></a>00104   time (&amp;clock);
<a name="l00105"></a>00105   tm = localtime (&amp;clock);
<a name="l00106"></a>00106 
<a name="l00107"></a>00107   <span class="keywordflow">if</span> (bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a9b85be4d92c696e0cfdb38d8ca8705c6">filename</a>[0] != <a class="code" href="vty_8h.html#af5bb38799561e2bd96aa97ac3fde28ee">DIRECTORY_SEP</a>)
<a name="l00108"></a>00108     {
<a name="l00109"></a>00109       sprintf (fullpath, <span class="stringliteral">&quot;%s/%s&quot;</span>, <a class="code" href="vty_8c.html#a6f4339c73034bde3cba10481ee9d5286">vty_get_cwd</a> (), bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a9b85be4d92c696e0cfdb38d8ca8705c6">filename</a>);
<a name="l00110"></a>00110       ret = strftime (realpath, MAXPATHLEN, fullpath, tm);
<a name="l00111"></a>00111     }
<a name="l00112"></a>00112   <span class="keywordflow">else</span>
<a name="l00113"></a>00113     ret = strftime (realpath, MAXPATHLEN, bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a9b85be4d92c696e0cfdb38d8ca8705c6">filename</a>, tm);
<a name="l00114"></a>00114 
<a name="l00115"></a>00115   <span class="keywordflow">if</span> (ret == 0)
<a name="l00116"></a>00116     {
<a name="l00117"></a>00117       <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;bgp_dump_open_file: strftime error&quot;</span>);
<a name="l00118"></a>00118       <span class="keywordflow">return</span> <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00119"></a>00119     }
<a name="l00120"></a>00120 
<a name="l00121"></a>00121   <span class="keywordflow">if</span> (bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a39e52c350128e7df6c3c1582121be402">fp</a>)
<a name="l00122"></a>00122     fclose (bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a39e52c350128e7df6c3c1582121be402">fp</a>);
<a name="l00123"></a>00123 
<a name="l00124"></a>00124 
<a name="l00125"></a>00125   oldumask = umask(0777 &amp; ~LOGFILE_MASK);
<a name="l00126"></a>00126   bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a39e52c350128e7df6c3c1582121be402">fp</a> = fopen (realpath, <span class="stringliteral">&quot;w&quot;</span>);
<a name="l00127"></a>00127 
<a name="l00128"></a>00128   <span class="keywordflow">if</span> (bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a39e52c350128e7df6c3c1582121be402">fp</a> == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00129"></a>00129     {
<a name="l00130"></a>00130       <a class="code" href="log_8h.html#a4a2ed409bf1559d9ea3c664f70420df7">zlog_warn</a> (<span class="stringliteral">&quot;bgp_dump_open_file: %s: %s&quot;</span>, realpath, strerror (errno));
<a name="l00131"></a>00131       umask(oldumask);
<a name="l00132"></a>00132       <span class="keywordflow">return</span> <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00133"></a>00133     }
<a name="l00134"></a>00134   umask(oldumask);  
<a name="l00135"></a>00135 
<a name="l00136"></a>00136   <span class="keywordflow">return</span> bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a39e52c350128e7df6c3c1582121be402">fp</a>;
<a name="l00137"></a>00137 }
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00140"></a><a class="code" href="bgp__dump_8c.html#a394c2d5e40a37005a6246a168d45cb0e">00140</a> <a class="code" href="bgp__dump_8c.html#a394c2d5e40a37005a6246a168d45cb0e">bgp_dump_interval_add</a> (<span class="keyword">struct</span> <a class="code" href="structbgp__dump.html">bgp_dump</a> *<a class="code" href="structbgp__dump.html">bgp_dump</a>, <span class="keywordtype">int</span> <a class="code" href="isis__circuit_8c.html#a900b5f9651c07bafd5d81cc876b93885">interval</a>)
<a name="l00141"></a>00141 {
<a name="l00142"></a>00142   <span class="keywordtype">int</span> secs_into_day;
<a name="l00143"></a>00143   time_t <a class="code" href="test-sig_8c.html#ab4ed0bba3292270af8ad67b45a21280d">t</a>;
<a name="l00144"></a>00144   <span class="keyword">struct </span>tm *tm;
<a name="l00145"></a>00145 
<a name="l00146"></a>00146   <span class="keywordflow">if</span> (interval &gt; 0)
<a name="l00147"></a>00147     {
<a name="l00148"></a>00148       <span class="comment">/* Periodic dump every interval seconds */</span>
<a name="l00149"></a>00149       <span class="keywordflow">if</span> ((interval &lt; 86400) &amp;&amp; ((86400 % interval) == 0))
<a name="l00150"></a>00150     {
<a name="l00151"></a>00151       <span class="comment">/* Dump at predictable times: if a day has a whole number of</span>
<a name="l00152"></a>00152 <span class="comment">       * intervals, dump every interval seconds starting from midnight</span>
<a name="l00153"></a>00153 <span class="comment">       */</span>
<a name="l00154"></a>00154       (void) time(&amp;t);
<a name="l00155"></a>00155       tm = localtime(&amp;t);
<a name="l00156"></a>00156       secs_into_day = tm-&gt;tm_sec + 60*tm-&gt;tm_min + 60*60*tm-&gt;tm_hour;
<a name="l00157"></a>00157       interval = interval - secs_into_day % <a class="code" href="isis__circuit_8c.html#a900b5f9651c07bafd5d81cc876b93885">interval</a>; <span class="comment">/* always &gt; 0 */</span>
<a name="l00158"></a>00158     }
<a name="l00159"></a>00159       bgp_dump-&gt;<a class="code" href="structbgp__dump.html#abf41ec887f001277014534e163588475">t_interval</a> = <a class="code" href="thread_8h.html#aca77b3bbd166d3573de5ecd9756a590c">thread_add_timer</a> (<a class="code" href="bgp__main_8c.html#af7f9077bc08df049beb65a1c09cde5fa">master</a>, <a class="code" href="bgp__dump_8c.html#a03e20f1079916f8b199d845d7e9290ec">bgp_dump_interval_func</a>, 
<a name="l00160"></a>00160                            bgp_dump, interval);
<a name="l00161"></a>00161     }
<a name="l00162"></a>00162   <span class="keywordflow">else</span>
<a name="l00163"></a>00163     {
<a name="l00164"></a>00164       <span class="comment">/* One-off dump: execute immediately, don&#39;t affect any scheduled dumps */</span>
<a name="l00165"></a>00165       bgp_dump-&gt;<a class="code" href="structbgp__dump.html#abf41ec887f001277014534e163588475">t_interval</a> = <a class="code" href="thread_8h.html#a1067157ad59ad46f29bf87158dffc3de">thread_add_event</a> (<a class="code" href="bgp__main_8c.html#af7f9077bc08df049beb65a1c09cde5fa">master</a>, <a class="code" href="bgp__dump_8c.html#a03e20f1079916f8b199d845d7e9290ec">bgp_dump_interval_func</a>,
<a name="l00166"></a>00166                            bgp_dump, 0);
<a name="l00167"></a>00167     }
<a name="l00168"></a>00168 
<a name="l00169"></a>00169   <span class="keywordflow">return</span> 0;
<a name="l00170"></a>00170 }
<a name="l00171"></a>00171 
<a name="l00172"></a>00172 <span class="comment">/* Dump common header. */</span>
<a name="l00173"></a>00173 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00174"></a><a class="code" href="bgp__dump_8c.html#ac6384bad2fc6676ba026779420d0fc3e">00174</a> <a class="code" href="bgp__dump_8c.html#ac6384bad2fc6676ba026779420d0fc3e">bgp_dump_header</a> (<span class="keyword">struct</span> <a class="code" href="structstream.html">stream</a> *obuf, <span class="keywordtype">int</span> <a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a>, <span class="keywordtype">int</span> subtype)
<a name="l00175"></a>00175 {
<a name="l00176"></a>00176   time_t now;
<a name="l00177"></a>00177 
<a name="l00178"></a>00178   <span class="comment">/* Set header. */</span>
<a name="l00179"></a>00179   time (&amp;now);
<a name="l00180"></a>00180 
<a name="l00181"></a>00181   <span class="comment">/* Put dump packet header. */</span>
<a name="l00182"></a>00182   <a class="code" href="stream_8c.html#af366d780a14cb8de53279378a8a4faeb">stream_putl</a> (obuf, now);  
<a name="l00183"></a>00183   <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a> (obuf, type);
<a name="l00184"></a>00184   <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a> (obuf, subtype);
<a name="l00185"></a>00185 
<a name="l00186"></a>00186   <a class="code" href="stream_8c.html#af366d780a14cb8de53279378a8a4faeb">stream_putl</a> (obuf, 0);    <span class="comment">/* len */</span>
<a name="l00187"></a>00187 }
<a name="l00188"></a>00188 
<a name="l00189"></a>00189 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00190"></a><a class="code" href="bgp__dump_8c.html#aeea4aaf739360141366d24b3a0a2c32c">00190</a> <a class="code" href="bgp__dump_8c.html#aeea4aaf739360141366d24b3a0a2c32c">bgp_dump_set_size</a> (<span class="keyword">struct</span> <a class="code" href="structstream.html">stream</a> *<a class="code" href="spgrid_8c.html#a5d97d3b42a0d6c9ec9a3e56f2616a6a5">s</a>, <span class="keywordtype">int</span> <a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a>)
<a name="l00191"></a>00191 {
<a name="l00192"></a>00192   <a class="code" href="stream_8c.html#ac25eaf59cd64ec23012f50a7d37a9f4a">stream_putl_at</a> (s, 8, <a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (s) - <a class="code" href="bgp__dump_8h.html#ac06b815d8ee149eee8c8891d61222104">BGP_DUMP_HEADER_SIZE</a>);
<a name="l00193"></a>00193 }
<a name="l00194"></a>00194 
<a name="l00195"></a>00195 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00196"></a><a class="code" href="bgp__dump_8c.html#ac3d2bfc128c220eba4e77782b563bfb2">00196</a> <a class="code" href="bgp__dump_8c.html#ac3d2bfc128c220eba4e77782b563bfb2">bgp_dump_routes_index_table</a>(<span class="keyword">struct</span> <a class="code" href="structbgp.html">bgp</a> *<a class="code" href="structbgp.html">bgp</a>)
<a name="l00197"></a>00197 {
<a name="l00198"></a>00198   <span class="keyword">struct </span><a class="code" href="structpeer.html">peer</a> *<a class="code" href="structpeer.html">peer</a>;
<a name="l00199"></a>00199   <span class="keyword">struct </span><a class="code" href="structlistnode.html">listnode</a> *node;
<a name="l00200"></a>00200   uint16_t peerno = 0;
<a name="l00201"></a>00201   <span class="keyword">struct </span><a class="code" href="structstream.html">stream</a> *obuf;
<a name="l00202"></a>00202 
<a name="l00203"></a>00203   obuf = <a class="code" href="bgp__dump_8c.html#a1d11a40e549767e660a25317d84233e2">bgp_dump_obuf</a>;
<a name="l00204"></a>00204   <a class="code" href="stream_8c.html#aee8fd31485ebc2f0a556a6a5d5c2d1e6">stream_reset</a> (obuf);
<a name="l00205"></a>00205 
<a name="l00206"></a>00206   <span class="comment">/* MRT header */</span>
<a name="l00207"></a>00207   <a class="code" href="bgp__dump_8c.html#ac6384bad2fc6676ba026779420d0fc3e">bgp_dump_header</a> (obuf, <a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa799d1ad00cfd330f5752175079f075c0">MSG_TABLE_DUMP_V2</a>, <a class="code" href="bgp__dump_8h.html#acebd6bfb4107e92415af72916c8523fd">TABLE_DUMP_V2_PEER_INDEX_TABLE</a>);
<a name="l00208"></a>00208 
<a name="l00209"></a>00209   <span class="comment">/* Collector BGP ID */</span>
<a name="l00210"></a>00210   <a class="code" href="stream_8c.html#a9019a5de70c1b6c2715cf24103109632">stream_put_in_addr</a> (obuf, &amp;bgp-&gt;<a class="code" href="structbgp.html#ac85364afca7a6afc7c184148355318a7">router_id</a>);
<a name="l00211"></a>00211 
<a name="l00212"></a>00212   <span class="comment">/* View name */</span>
<a name="l00213"></a>00213   <span class="keywordflow">if</span>(bgp-&gt;<a class="code" href="structbgp.html#ac321205b3775d3cf7c70affd935c3a72">name</a>)
<a name="l00214"></a>00214     {
<a name="l00215"></a>00215       <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a> (obuf, strlen(bgp-&gt;<a class="code" href="structbgp.html#ac321205b3775d3cf7c70affd935c3a72">name</a>));
<a name="l00216"></a>00216       <a class="code" href="stream_8c.html#a2f540a71efdf46e8c3a923f73e9f3b73">stream_put</a>(obuf, bgp-&gt;<a class="code" href="structbgp.html#ac321205b3775d3cf7c70affd935c3a72">name</a>, strlen(bgp-&gt;<a class="code" href="structbgp.html#ac321205b3775d3cf7c70affd935c3a72">name</a>));
<a name="l00217"></a>00217     }
<a name="l00218"></a>00218   <span class="keywordflow">else</span>
<a name="l00219"></a>00219     {
<a name="l00220"></a>00220       <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a>(obuf, 0);
<a name="l00221"></a>00221     }
<a name="l00222"></a>00222 
<a name="l00223"></a>00223   <span class="comment">/* Peer count */</span>
<a name="l00224"></a>00224   <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a> (obuf, <a class="code" href="linklist_8h.html#a0429e6385b31a314cc64432a906201e5">listcount</a>(bgp-&gt;<a class="code" href="structbgp.html#a99704607de62cd6d36eb8674f921ba8a">peer</a>));
<a name="l00225"></a>00225 
<a name="l00226"></a>00226   <span class="comment">/* Walk down all peers */</span>
<a name="l00227"></a>00227   <span class="keywordflow">for</span>(<a class="code" href="linklist_8h.html#a80a3f4035be83abbb709d17412993226">ALL_LIST_ELEMENTS_RO</a> (bgp-&gt;<a class="code" href="structbgp.html#a99704607de62cd6d36eb8674f921ba8a">peer</a>, node, peer))
<a name="l00228"></a>00228     {
<a name="l00229"></a>00229 
<a name="l00230"></a>00230       <span class="comment">/* Peer&#39;s type */</span>
<a name="l00231"></a>00231       <span class="keywordflow">if</span> (<a class="code" href="sockunion_8h.html#ac361ce9c3dca3e5b0e903c2c4fcc300c">sockunion_family</a>(&amp;peer-&gt;<a class="code" href="structpeer.html#ab793b0acdca7d325f32edc25503b83b9">su</a>) == AF_INET)
<a name="l00232"></a>00232         {
<a name="l00233"></a>00233           <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (obuf, <a class="code" href="bgp__dump_8h.html#a884b9798da9461c3a0abb2194e362ad1">TABLE_DUMP_V2_PEER_INDEX_TABLE_AS4</a>+<a class="code" href="bgp__dump_8h.html#a41d86668f4b75e0dde045ac4b412e541">TABLE_DUMP_V2_PEER_INDEX_TABLE_IP</a>);
<a name="l00234"></a>00234         }
<a name="l00235"></a>00235 <span class="preprocessor">#ifdef HAVE_IPV6</span>
<a name="l00236"></a>00236 <span class="preprocessor"></span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="sockunion_8h.html#ac361ce9c3dca3e5b0e903c2c4fcc300c">sockunion_family</a>(&amp;peer-&gt;<a class="code" href="structpeer.html#ab793b0acdca7d325f32edc25503b83b9">su</a>) == AF_INET6)
<a name="l00237"></a>00237         {
<a name="l00238"></a>00238           <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (obuf, <a class="code" href="bgp__dump_8h.html#a884b9798da9461c3a0abb2194e362ad1">TABLE_DUMP_V2_PEER_INDEX_TABLE_AS4</a>+<a class="code" href="bgp__dump_8h.html#a89cf2ae1acfe5e3ef26b6d3893323659">TABLE_DUMP_V2_PEER_INDEX_TABLE_IP6</a>);
<a name="l00239"></a>00239         }
<a name="l00240"></a>00240 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_IPV6 */</span>
<a name="l00241"></a>00241 
<a name="l00242"></a>00242       <span class="comment">/* Peer&#39;s BGP ID */</span>
<a name="l00243"></a>00243       <a class="code" href="stream_8c.html#a9019a5de70c1b6c2715cf24103109632">stream_put_in_addr</a> (obuf, &amp;peer-&gt;<a class="code" href="structpeer.html#ae620d85ff35b31ba9eb6073b81731b5b">remote_id</a>);
<a name="l00244"></a>00244 
<a name="l00245"></a>00245       <span class="comment">/* Peer&#39;s IP address */</span>
<a name="l00246"></a>00246       <span class="keywordflow">if</span> (<a class="code" href="sockunion_8h.html#ac361ce9c3dca3e5b0e903c2c4fcc300c">sockunion_family</a>(&amp;peer-&gt;<a class="code" href="structpeer.html#ab793b0acdca7d325f32edc25503b83b9">su</a>) == AF_INET)
<a name="l00247"></a>00247         {
<a name="l00248"></a>00248           <a class="code" href="stream_8c.html#a9019a5de70c1b6c2715cf24103109632">stream_put_in_addr</a> (obuf, &amp;peer-&gt;<a class="code" href="structpeer.html#ab793b0acdca7d325f32edc25503b83b9">su</a>.<a class="code" href="unionsockunion.html#a50fab1a37b798a49a085f78351680ab7">sin</a>.sin_addr);
<a name="l00249"></a>00249         }
<a name="l00250"></a>00250 <span class="preprocessor">#ifdef HAVE_IPV6</span>
<a name="l00251"></a>00251 <span class="preprocessor"></span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="sockunion_8h.html#ac361ce9c3dca3e5b0e903c2c4fcc300c">sockunion_family</a>(&amp;peer-&gt;<a class="code" href="structpeer.html#ab793b0acdca7d325f32edc25503b83b9">su</a>) == AF_INET6)
<a name="l00252"></a>00252         {
<a name="l00253"></a>00253           <a class="code" href="stream_8c.html#a39121b19ef0be09e9a5598a1ea1371c0">stream_write</a> (obuf, (u_char *)&amp;peer-&gt;<a class="code" href="structpeer.html#ab793b0acdca7d325f32edc25503b83b9">su</a>.sin6.sin6_addr,
<a name="l00254"></a>00254                         <a class="code" href="prefix_8h.html#ac2642af4f4d7a4209ad6261e72c658f9">IPV6_MAX_BYTELEN</a>);
<a name="l00255"></a>00255         }
<a name="l00256"></a>00256 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_IPV6 */</span>
<a name="l00257"></a>00257 
<a name="l00258"></a>00258       <span class="comment">/* Peer&#39;s AS number. */</span>
<a name="l00259"></a>00259       <span class="comment">/* Note that, as this is an AS4 compliant quagga, the RIB is always AS4 */</span>
<a name="l00260"></a>00260       <a class="code" href="stream_8c.html#af366d780a14cb8de53279378a8a4faeb">stream_putl</a> (obuf, peer-&gt;<a class="code" href="structpeer.html#aa35fab1a77bb496d8377a62cad372314">as</a>);
<a name="l00261"></a>00261 
<a name="l00262"></a>00262       <span class="comment">/* Store the peer number for this peer */</span>
<a name="l00263"></a>00263       peer-&gt;<a class="code" href="structpeer.html#abbff1c8ba5633b76e20d2746f773916c">table_dump_index</a> = peerno;
<a name="l00264"></a>00264       peerno++;
<a name="l00265"></a>00265     }
<a name="l00266"></a>00266 
<a name="l00267"></a>00267   <a class="code" href="bgp__dump_8c.html#aeea4aaf739360141366d24b3a0a2c32c">bgp_dump_set_size</a>(obuf, <a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa799d1ad00cfd330f5752175079f075c0">MSG_TABLE_DUMP_V2</a>);
<a name="l00268"></a>00268 
<a name="l00269"></a>00269   fwrite (<a class="code" href="stream_8h.html#afde5f5db208a43da6faf7b830f26d7fc">STREAM_DATA</a> (obuf), <a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (obuf), 1, <a class="code" href="bgp__dump_8c.html#a7b4b628fda6c31730228e04aacd18e5b">bgp_dump_routes</a>.<a class="code" href="structbgp__dump.html#a39e52c350128e7df6c3c1582121be402">fp</a>);
<a name="l00270"></a>00270   fflush (<a class="code" href="bgp__dump_8c.html#a7b4b628fda6c31730228e04aacd18e5b">bgp_dump_routes</a>.<a class="code" href="structbgp__dump.html#a39e52c350128e7df6c3c1582121be402">fp</a>);
<a name="l00271"></a>00271 }
<a name="l00272"></a>00272 
<a name="l00273"></a>00273 
<a name="l00274"></a>00274 <span class="comment">/* Runs under child process. */</span>
<a name="l00275"></a>00275 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>
<a name="l00276"></a><a class="code" href="bgp__dump_8c.html#a804d21aa1878059e1a7eefa32a228e83">00276</a> <a class="code" href="bgp__dump_8c.html#a804d21aa1878059e1a7eefa32a228e83">bgp_dump_routes_func</a> (<span class="keywordtype">int</span> afi, <span class="keywordtype">int</span> first_run, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> seq)
<a name="l00277"></a>00277 {
<a name="l00278"></a>00278   <span class="keyword">struct </span><a class="code" href="structstream.html">stream</a> *obuf;
<a name="l00279"></a>00279   <span class="keyword">struct </span><a class="code" href="structbgp__info.html">bgp_info</a> *info;
<a name="l00280"></a>00280   <span class="keyword">struct </span><a class="code" href="structbgp__node.html">bgp_node</a> *rn;
<a name="l00281"></a>00281   <span class="keyword">struct </span><a class="code" href="structbgp.html">bgp</a> *<a class="code" href="bgp__capability__test_8c.html#a528a1146825f30f8df2ae2e9d61dd7be">bgp</a>;
<a name="l00282"></a>00282   <span class="keyword">struct </span><a class="code" href="structbgp__table.html">bgp_table</a> *table;
<a name="l00283"></a>00283 
<a name="l00284"></a>00284   bgp = <a class="code" href="bgpd_8c.html#ae19787bc29126d524ac261d00bacc13d">bgp_get_default</a> ();
<a name="l00285"></a>00285   <span class="keywordflow">if</span> (!bgp)
<a name="l00286"></a>00286     <span class="keywordflow">return</span> seq;
<a name="l00287"></a>00287 
<a name="l00288"></a>00288   <span class="keywordflow">if</span> (<a class="code" href="bgp__dump_8c.html#a7b4b628fda6c31730228e04aacd18e5b">bgp_dump_routes</a>.<a class="code" href="structbgp__dump.html#a39e52c350128e7df6c3c1582121be402">fp</a> == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00289"></a>00289     <span class="keywordflow">return</span> seq;
<a name="l00290"></a>00290 
<a name="l00291"></a>00291   <span class="comment">/* Note that bgp_dump_routes_index_table will do ipv4 and ipv6 peers,</span>
<a name="l00292"></a>00292 <span class="comment">     so this should only be done on the first call to bgp_dump_routes_func.</span>
<a name="l00293"></a>00293 <span class="comment">     ( this function will be called once for ipv4 and once for ipv6 ) */</span>
<a name="l00294"></a>00294   <span class="keywordflow">if</span>(first_run)
<a name="l00295"></a>00295     <a class="code" href="bgp__dump_8c.html#ac3d2bfc128c220eba4e77782b563bfb2">bgp_dump_routes_index_table</a>(bgp);
<a name="l00296"></a>00296 
<a name="l00297"></a>00297   obuf = <a class="code" href="bgp__dump_8c.html#a1d11a40e549767e660a25317d84233e2">bgp_dump_obuf</a>;
<a name="l00298"></a>00298   <a class="code" href="stream_8c.html#aee8fd31485ebc2f0a556a6a5d5c2d1e6">stream_reset</a>(obuf);
<a name="l00299"></a>00299 
<a name="l00300"></a>00300   <span class="comment">/* Walk down each BGP route. */</span>
<a name="l00301"></a>00301   table = bgp-&gt;<a class="code" href="structbgp.html#a165710ce04dcbf78397c514707c15f3b">rib</a>[<a class="code" href="structbgp__table.html#a65e5c5b62b7afc22106369584ecefd5d">afi</a>][<a class="code" href="zebra_8h.html#afb8a63d76f4951ff8d73c32256b4a497">SAFI_UNICAST</a>];
<a name="l00302"></a>00302 
<a name="l00303"></a>00303   <span class="keywordflow">for</span> (rn = <a class="code" href="bgp__table_8c.html#af8ce42494729d03a8c7ca41ded487bb2">bgp_table_top</a> (table); rn; rn = <a class="code" href="bgp__table_8c.html#abdeced48b9b4aad614c88dc63ea0a4cf">bgp_route_next</a> (rn))
<a name="l00304"></a>00304     {
<a name="l00305"></a>00305       <span class="keywordflow">if</span>(!rn-&gt;<a class="code" href="structbgp__node.html#aa7efb6473eab6666b1aba83e4da90429">info</a>)
<a name="l00306"></a>00306         <span class="keywordflow">continue</span>;
<a name="l00307"></a>00307 
<a name="l00308"></a>00308       <a class="code" href="stream_8c.html#aee8fd31485ebc2f0a556a6a5d5c2d1e6">stream_reset</a>(obuf);
<a name="l00309"></a>00309 
<a name="l00310"></a>00310       <span class="comment">/* MRT header */</span>
<a name="l00311"></a>00311       <span class="keywordflow">if</span> (afi == <a class="code" href="zebra_8h.html#a192fcc8cbfb7b9d03c6562c48941a4bd">AFI_IP</a>)
<a name="l00312"></a>00312         {
<a name="l00313"></a>00313           <a class="code" href="bgp__dump_8c.html#ac6384bad2fc6676ba026779420d0fc3e">bgp_dump_header</a> (obuf, <a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa799d1ad00cfd330f5752175079f075c0">MSG_TABLE_DUMP_V2</a>, <a class="code" href="bgp__dump_8h.html#ac5adbb4bab2e80bfe5334082b9e08f35">TABLE_DUMP_V2_RIB_IPV4_UNICAST</a>);
<a name="l00314"></a>00314         }
<a name="l00315"></a>00315 <span class="preprocessor">#ifdef HAVE_IPV6</span>
<a name="l00316"></a>00316 <span class="preprocessor"></span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (afi == <a class="code" href="zebra_8h.html#ad10f30457e426e1d269466d3b6603c3c">AFI_IP6</a>)
<a name="l00317"></a>00317         {
<a name="l00318"></a>00318           <a class="code" href="bgp__dump_8c.html#ac6384bad2fc6676ba026779420d0fc3e">bgp_dump_header</a> (obuf, <a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa799d1ad00cfd330f5752175079f075c0">MSG_TABLE_DUMP_V2</a>, <a class="code" href="bgp__dump_8h.html#abe1d7ba1b817adc62ab5668a8f2b14f0">TABLE_DUMP_V2_RIB_IPV6_UNICAST</a>);
<a name="l00319"></a>00319         }
<a name="l00320"></a>00320 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_IPV6 */</span>
<a name="l00321"></a>00321 
<a name="l00322"></a>00322       <span class="comment">/* Sequence number */</span>
<a name="l00323"></a>00323       <a class="code" href="stream_8c.html#af366d780a14cb8de53279378a8a4faeb">stream_putl</a>(obuf, seq);
<a name="l00324"></a>00324 
<a name="l00325"></a>00325       <span class="comment">/* Prefix length */</span>
<a name="l00326"></a>00326       <a class="code" href="stream_8c.html#a8a00e56e71aed4753ee4a21f8dd2aa65">stream_putc</a> (obuf, rn-&gt;<a class="code" href="structbgp__node.html#a61c7e08de23a3c64f8dd738448567cde">p</a>.<a class="code" href="structprefix.html#aae8dafba4797d25cf1d141780d87ff02">prefixlen</a>);
<a name="l00327"></a>00327 
<a name="l00328"></a>00328       <span class="comment">/* Prefix */</span>
<a name="l00329"></a>00329       <span class="keywordflow">if</span> (afi == <a class="code" href="zebra_8h.html#a192fcc8cbfb7b9d03c6562c48941a4bd">AFI_IP</a>)
<a name="l00330"></a>00330         {
<a name="l00331"></a>00331           <span class="comment">/* We&#39;ll dump only the useful bits (those not 0), but have to align on 8 bits */</span>
<a name="l00332"></a>00332           <a class="code" href="stream_8c.html#a39121b19ef0be09e9a5598a1ea1371c0">stream_write</a>(obuf, (u_char *)&amp;rn-&gt;<a class="code" href="structbgp__node.html#a61c7e08de23a3c64f8dd738448567cde">p</a>.u.<a class="code" href="structprefix.html#ab37b8922554b41b7dc2417d8f37e7829">prefix4</a>, (rn-&gt;<a class="code" href="structbgp__node.html#a61c7e08de23a3c64f8dd738448567cde">p</a>.<a class="code" href="structprefix.html#aae8dafba4797d25cf1d141780d87ff02">prefixlen</a>+7)/8);
<a name="l00333"></a>00333         }
<a name="l00334"></a>00334 <span class="preprocessor">#ifdef HAVE_IPV6</span>
<a name="l00335"></a>00335 <span class="preprocessor"></span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (afi == <a class="code" href="zebra_8h.html#ad10f30457e426e1d269466d3b6603c3c">AFI_IP6</a>)
<a name="l00336"></a>00336         {
<a name="l00337"></a>00337           <span class="comment">/* We&#39;ll dump only the useful bits (those not 0), but have to align on 8 bits */</span>
<a name="l00338"></a>00338           <a class="code" href="stream_8c.html#a39121b19ef0be09e9a5598a1ea1371c0">stream_write</a> (obuf, (u_char *)&amp;rn-&gt;<a class="code" href="structbgp__node.html#a61c7e08de23a3c64f8dd738448567cde">p</a>.u.prefix6, (rn-&gt;<a class="code" href="structbgp__node.html#a61c7e08de23a3c64f8dd738448567cde">p</a>.<a class="code" href="structprefix.html#aae8dafba4797d25cf1d141780d87ff02">prefixlen</a>+7)/8);
<a name="l00339"></a>00339         }
<a name="l00340"></a>00340 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_IPV6 */</span>
<a name="l00341"></a>00341 
<a name="l00342"></a>00342       <span class="comment">/* Save where we are now, so we can overwride the entry count later */</span>
<a name="l00343"></a>00343       <span class="keywordtype">int</span> sizep = <a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a>(obuf);
<a name="l00344"></a>00344 
<a name="l00345"></a>00345       <span class="comment">/* Entry count */</span>
<a name="l00346"></a>00346       uint16_t entry_count = 0;
<a name="l00347"></a>00347 
<a name="l00348"></a>00348       <span class="comment">/* Entry count, note that this is overwritten later */</span>
<a name="l00349"></a>00349       <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a>(obuf, 0);
<a name="l00350"></a>00350 
<a name="l00351"></a>00351       <span class="keywordflow">for</span> (info = rn-&gt;<a class="code" href="structbgp__node.html#aa7efb6473eab6666b1aba83e4da90429">info</a>; info; info = info-&gt;<a class="code" href="structbgp__info.html#a7a49886b20a2c95c08baa23149501a2a">next</a>)
<a name="l00352"></a>00352         {
<a name="l00353"></a>00353           entry_count++;
<a name="l00354"></a>00354 
<a name="l00355"></a>00355           <span class="comment">/* Peer index */</span>
<a name="l00356"></a>00356           <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a>(obuf, info-&gt;<a class="code" href="structbgp__info.html#a367917f671400c20f33e512fa2c435dc">peer</a>-&gt;<a class="code" href="structpeer.html#abbff1c8ba5633b76e20d2746f773916c">table_dump_index</a>);
<a name="l00357"></a>00357 
<a name="l00358"></a>00358           <span class="comment">/* Originated */</span>
<a name="l00359"></a>00359           <a class="code" href="stream_8c.html#af366d780a14cb8de53279378a8a4faeb">stream_putl</a> (obuf, info-&gt;<a class="code" href="structbgp__info.html#adb8b5aba2ea49640e700fa870b7f5426">uptime</a>);
<a name="l00360"></a>00360 
<a name="l00361"></a>00361           <span class="comment">/* Dump attribute. */</span>
<a name="l00362"></a>00362           <span class="comment">/* Skip prefix &amp; AFI/SAFI for MP_NLRI */</span>
<a name="l00363"></a>00363           <a class="code" href="bgp__attr_8c.html#a1a02efc1fa4f47e5fa5b9ee42edd6d57">bgp_dump_routes_attr</a> (obuf, info-&gt;<a class="code" href="structbgp__info.html#ac08a1276a0597228115a0f26aa9fe27a">attr</a>, &amp;rn-&gt;<a class="code" href="structbgp__node.html#a61c7e08de23a3c64f8dd738448567cde">p</a>);
<a name="l00364"></a>00364         }
<a name="l00365"></a>00365 
<a name="l00366"></a>00366       <span class="comment">/* Overwrite the entry count, now that we know the right number */</span>
<a name="l00367"></a>00367       <a class="code" href="stream_8c.html#a41de70a7383bac6220b787d740c0b261">stream_putw_at</a> (obuf, sizep, entry_count);
<a name="l00368"></a>00368 
<a name="l00369"></a>00369       seq++;
<a name="l00370"></a>00370 
<a name="l00371"></a>00371       <a class="code" href="bgp__dump_8c.html#aeea4aaf739360141366d24b3a0a2c32c">bgp_dump_set_size</a>(obuf, <a class="code" href="bgp__dump_8c.html#a40efcecf46bdb61ee74514861374083aa799d1ad00cfd330f5752175079f075c0">MSG_TABLE_DUMP_V2</a>);
<a name="l00372"></a>00372       fwrite (<a class="code" href="stream_8h.html#afde5f5db208a43da6faf7b830f26d7fc">STREAM_DATA</a> (obuf), <a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (obuf), 1, <a class="code" href="bgp__dump_8c.html#a7b4b628fda6c31730228e04aacd18e5b">bgp_dump_routes</a>.<a class="code" href="structbgp__dump.html#a39e52c350128e7df6c3c1582121be402">fp</a>);
<a name="l00373"></a>00373 
<a name="l00374"></a>00374     }
<a name="l00375"></a>00375 
<a name="l00376"></a>00376   fflush (<a class="code" href="bgp__dump_8c.html#a7b4b628fda6c31730228e04aacd18e5b">bgp_dump_routes</a>.<a class="code" href="structbgp__dump.html#a39e52c350128e7df6c3c1582121be402">fp</a>);
<a name="l00377"></a>00377 
<a name="l00378"></a>00378   <span class="keywordflow">return</span> seq;
<a name="l00379"></a>00379 }
<a name="l00380"></a>00380 
<a name="l00381"></a>00381 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00382"></a><a class="code" href="bgp__dump_8c.html#a03e20f1079916f8b199d845d7e9290ec">00382</a> <a class="code" href="bgp__dump_8c.html#a03e20f1079916f8b199d845d7e9290ec">bgp_dump_interval_func</a> (<span class="keyword">struct</span> <a class="code" href="structthread.html">thread</a> *<a class="code" href="test-sig_8c.html#ab4ed0bba3292270af8ad67b45a21280d">t</a>)
<a name="l00383"></a>00383 {
<a name="l00384"></a>00384   <span class="keyword">struct </span><a class="code" href="structbgp__dump.html">bgp_dump</a> *<a class="code" href="structbgp__dump.html">bgp_dump</a>;
<a name="l00385"></a>00385   bgp_dump = <a class="code" href="thread_8h.html#a78f2ae47a7a334f7f74bfed7fda48e5a">THREAD_ARG</a> (t);
<a name="l00386"></a>00386   bgp_dump-&gt;<a class="code" href="structbgp__dump.html#abf41ec887f001277014534e163588475">t_interval</a> = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00387"></a>00387 
<a name="l00388"></a>00388   <span class="comment">/* Reschedule dump even if file couldn&#39;t be opened this time... */</span>
<a name="l00389"></a>00389   <span class="keywordflow">if</span> (<a class="code" href="bgp__dump_8c.html#a83a98e4dd07ab8ab3065e9fa4c7cfde5">bgp_dump_open_file</a> (bgp_dump) != <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00390"></a>00390     {
<a name="l00391"></a>00391       <span class="comment">/* In case of bgp_dump_routes, we need special route dump function. */</span>
<a name="l00392"></a>00392       <span class="keywordflow">if</span> (bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a0a26a007ae667dea94fc4e5cd7cffd37">type</a> == <a class="code" href="bgp__dump_8c.html#af5c4c5c58c06e9e0da028895448608aba8da7006d79a833ea2d2d60d3c0f44ecd">BGP_DUMP_ROUTES</a>)
<a name="l00393"></a>00393     {
<a name="l00394"></a>00394       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> seq = <a class="code" href="bgp__dump_8c.html#a804d21aa1878059e1a7eefa32a228e83">bgp_dump_routes_func</a> (<a class="code" href="zebra_8h.html#a192fcc8cbfb7b9d03c6562c48941a4bd">AFI_IP</a>, 1, 0);
<a name="l00395"></a>00395 <span class="preprocessor">#ifdef HAVE_IPV6</span>
<a name="l00396"></a>00396 <span class="preprocessor"></span>      <a class="code" href="bgp__dump_8c.html#a804d21aa1878059e1a7eefa32a228e83">bgp_dump_routes_func</a> (<a class="code" href="zebra_8h.html#ad10f30457e426e1d269466d3b6603c3c">AFI_IP6</a>, 0, seq);
<a name="l00397"></a>00397 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_IPV6 */</span>
<a name="l00398"></a>00398       <span class="comment">/* Close the file now. For a RIB dump there&#39;s no point in leaving</span>
<a name="l00399"></a>00399 <span class="comment">       * it open until the next scheduled dump starts. */</span>
<a name="l00400"></a>00400       fclose(bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a39e52c350128e7df6c3c1582121be402">fp</a>); bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a39e52c350128e7df6c3c1582121be402">fp</a> = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00401"></a>00401     }
<a name="l00402"></a>00402     }
<a name="l00403"></a>00403 
<a name="l00404"></a>00404   <span class="comment">/* if interval is set reschedule */</span>
<a name="l00405"></a>00405   <span class="keywordflow">if</span> (bgp_dump-&gt;<a class="code" href="structbgp__dump.html#aa47b11c732f512a63663c56976687f18">interval</a> &gt; 0)
<a name="l00406"></a>00406     <a class="code" href="bgp__dump_8c.html#a394c2d5e40a37005a6246a168d45cb0e">bgp_dump_interval_add</a> (bgp_dump, bgp_dump-&gt;<a class="code" href="structbgp__dump.html#aa47b11c732f512a63663c56976687f18">interval</a>);
<a name="l00407"></a>00407 
<a name="l00408"></a>00408   <span class="keywordflow">return</span> 0;
<a name="l00409"></a>00409 }
<a name="l00410"></a>00410 
<a name="l00411"></a>00411 <span class="comment">/* Dump common information. */</span>
<a name="l00412"></a>00412 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00413"></a><a class="code" href="bgp__dump_8c.html#a4793b761f0d6e7dba96ab4e32ededcaa">00413</a> <a class="code" href="bgp__dump_8c.html#a4793b761f0d6e7dba96ab4e32ededcaa">bgp_dump_common</a> (<span class="keyword">struct</span> <a class="code" href="structstream.html">stream</a> *obuf, <span class="keyword">struct</span> <a class="code" href="structpeer.html">peer</a> *<a class="code" href="structpeer.html">peer</a>, <span class="keywordtype">int</span> forceas4)
<a name="l00414"></a>00414 {
<a name="l00415"></a>00415   <span class="keywordtype">char</span> empty[16] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
<a name="l00416"></a>00416 
<a name="l00417"></a>00417   <span class="comment">/* Source AS number and Destination AS number. */</span>
<a name="l00418"></a>00418   <span class="keywordflow">if</span> (forceas4 || <a class="code" href="zebra_8h.html#a9310812ac92febfb7d1eb10127aea1a8">CHECK_FLAG</a> (peer-&gt;<a class="code" href="structpeer.html#a64eadd546a8c50dfe6a6dcb635c3822d">cap</a>, <a class="code" href="bgpd_8h.html#a82052903fe3d209e1216d4ea86b84c6f">PEER_CAP_AS4_RCV</a>) )
<a name="l00419"></a>00419     {
<a name="l00420"></a>00420       <a class="code" href="stream_8c.html#af366d780a14cb8de53279378a8a4faeb">stream_putl</a> (obuf, peer-&gt;<a class="code" href="structpeer.html#aa35fab1a77bb496d8377a62cad372314">as</a>);
<a name="l00421"></a>00421       <a class="code" href="stream_8c.html#af366d780a14cb8de53279378a8a4faeb">stream_putl</a> (obuf, peer-&gt;<a class="code" href="structpeer.html#a4d33d4449107287106341b423f5a7498">local_as</a>);
<a name="l00422"></a>00422     }
<a name="l00423"></a>00423   <span class="keywordflow">else</span>
<a name="l00424"></a>00424     {
<a name="l00425"></a>00425       <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a> (obuf, peer-&gt;<a class="code" href="structpeer.html#aa35fab1a77bb496d8377a62cad372314">as</a>);
<a name="l00426"></a>00426       <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a> (obuf, peer-&gt;<a class="code" href="structpeer.html#a4d33d4449107287106341b423f5a7498">local_as</a>);
<a name="l00427"></a>00427     }
<a name="l00428"></a>00428 
<a name="l00429"></a>00429   <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structpeer.html#ab793b0acdca7d325f32edc25503b83b9">su</a>.<a class="code" href="unionsockunion.html#a696d7d44e90274cc3bb86231cd51cfd4">sa</a>.sa_family == AF_INET)
<a name="l00430"></a>00430     {
<a name="l00431"></a>00431       <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a> (obuf, peer-&gt;<a class="code" href="structpeer.html#a959523b5b0a6ed9a0b87825e42545ec0">ifindex</a>);
<a name="l00432"></a>00432       <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a> (obuf, <a class="code" href="zebra_8h.html#a192fcc8cbfb7b9d03c6562c48941a4bd">AFI_IP</a>);
<a name="l00433"></a>00433 
<a name="l00434"></a>00434       <a class="code" href="stream_8c.html#a2f540a71efdf46e8c3a923f73e9f3b73">stream_put</a> (obuf, &amp;peer-&gt;<a class="code" href="structpeer.html#ab793b0acdca7d325f32edc25503b83b9">su</a>.<a class="code" href="unionsockunion.html#a50fab1a37b798a49a085f78351680ab7">sin</a>.sin_addr, <a class="code" href="prefix_8h.html#a013983d7a5267a63023c50ab32a85c24">IPV4_MAX_BYTELEN</a>);
<a name="l00435"></a>00435 
<a name="l00436"></a>00436       <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structpeer.html#a063537a13602c890880e9c4f1d6fccd3">su_local</a>)
<a name="l00437"></a>00437     <a class="code" href="stream_8c.html#a2f540a71efdf46e8c3a923f73e9f3b73">stream_put</a> (obuf, &amp;peer-&gt;<a class="code" href="structpeer.html#a063537a13602c890880e9c4f1d6fccd3">su_local</a>-&gt;<a class="code" href="unionsockunion.html#a50fab1a37b798a49a085f78351680ab7">sin</a>.sin_addr, <a class="code" href="prefix_8h.html#a013983d7a5267a63023c50ab32a85c24">IPV4_MAX_BYTELEN</a>);
<a name="l00438"></a>00438       <span class="keywordflow">else</span>
<a name="l00439"></a>00439     <a class="code" href="stream_8c.html#a2f540a71efdf46e8c3a923f73e9f3b73">stream_put</a> (obuf, empty, <a class="code" href="prefix_8h.html#a013983d7a5267a63023c50ab32a85c24">IPV4_MAX_BYTELEN</a>);
<a name="l00440"></a>00440     }
<a name="l00441"></a>00441 <span class="preprocessor">#ifdef HAVE_IPV6</span>
<a name="l00442"></a>00442 <span class="preprocessor"></span>  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structpeer.html#ab793b0acdca7d325f32edc25503b83b9">su</a>.<a class="code" href="unionsockunion.html#a696d7d44e90274cc3bb86231cd51cfd4">sa</a>.sa_family == AF_INET6)
<a name="l00443"></a>00443     {
<a name="l00444"></a>00444       <span class="comment">/* Interface Index and Address family. */</span>
<a name="l00445"></a>00445       <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a> (obuf, peer-&gt;<a class="code" href="structpeer.html#a959523b5b0a6ed9a0b87825e42545ec0">ifindex</a>);
<a name="l00446"></a>00446       <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a> (obuf, <a class="code" href="zebra_8h.html#ad10f30457e426e1d269466d3b6603c3c">AFI_IP6</a>);
<a name="l00447"></a>00447 
<a name="l00448"></a>00448       <span class="comment">/* Source IP Address and Destination IP Address. */</span>
<a name="l00449"></a>00449       <a class="code" href="stream_8c.html#a2f540a71efdf46e8c3a923f73e9f3b73">stream_put</a> (obuf, &amp;peer-&gt;<a class="code" href="structpeer.html#ab793b0acdca7d325f32edc25503b83b9">su</a>.sin6.sin6_addr, <a class="code" href="prefix_8h.html#ac2642af4f4d7a4209ad6261e72c658f9">IPV6_MAX_BYTELEN</a>);
<a name="l00450"></a>00450 
<a name="l00451"></a>00451       <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structpeer.html#a063537a13602c890880e9c4f1d6fccd3">su_local</a>)
<a name="l00452"></a>00452     <a class="code" href="stream_8c.html#a2f540a71efdf46e8c3a923f73e9f3b73">stream_put</a> (obuf, &amp;peer-&gt;<a class="code" href="structpeer.html#a063537a13602c890880e9c4f1d6fccd3">su_local</a>-&gt;sin6.sin6_addr, <a class="code" href="prefix_8h.html#ac2642af4f4d7a4209ad6261e72c658f9">IPV6_MAX_BYTELEN</a>);
<a name="l00453"></a>00453       <span class="keywordflow">else</span>
<a name="l00454"></a>00454     <a class="code" href="stream_8c.html#a2f540a71efdf46e8c3a923f73e9f3b73">stream_put</a> (obuf, empty, <a class="code" href="prefix_8h.html#ac2642af4f4d7a4209ad6261e72c658f9">IPV6_MAX_BYTELEN</a>);
<a name="l00455"></a>00455     }
<a name="l00456"></a>00456 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_IPV6 */</span>
<a name="l00457"></a>00457 }
<a name="l00458"></a>00458 
<a name="l00459"></a>00459 <span class="comment">/* Dump BGP status change. */</span>
<a name="l00460"></a>00460 <span class="keywordtype">void</span>
<a name="l00461"></a><a class="code" href="bgp__dump_8h.html#a2991bb296589e23ec8f601ec99bb3db4">00461</a> <a class="code" href="bgp__dump_8c.html#a583bbdd359820c2e8ecd9c64c39e3998">bgp_dump_state</a> (<span class="keyword">struct</span> <a class="code" href="structpeer.html">peer</a> *<a class="code" href="structpeer.html">peer</a>, <span class="keywordtype">int</span> status_old, <span class="keywordtype">int</span> status_new)
<a name="l00462"></a>00462 {
<a name="l00463"></a>00463   <span class="keyword">struct </span><a class="code" href="structstream.html">stream</a> *obuf;
<a name="l00464"></a>00464 
<a name="l00465"></a>00465   <span class="comment">/* If dump file pointer is disabled return immediately. */</span>
<a name="l00466"></a>00466   <span class="keywordflow">if</span> (<a class="code" href="bgp__dump_8c.html#a893516e440b8519ca09ed2b808373234">bgp_dump_all</a>.<a class="code" href="structbgp__dump.html#a39e52c350128e7df6c3c1582121be402">fp</a> == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00467"></a>00467     <span class="keywordflow">return</span>;
<a name="l00468"></a>00468 
<a name="l00469"></a>00469   <span class="comment">/* Make dump stream. */</span>
<a name="l00470"></a>00470   obuf = <a class="code" href="bgp__dump_8c.html#a1d11a40e549767e660a25317d84233e2">bgp_dump_obuf</a>;
<a name="l00471"></a>00471   <a class="code" href="stream_8c.html#aee8fd31485ebc2f0a556a6a5d5c2d1e6">stream_reset</a> (obuf);
<a name="l00472"></a>00472 
<a name="l00473"></a>00473   <a class="code" href="bgp__dump_8c.html#ac6384bad2fc6676ba026779420d0fc3e">bgp_dump_header</a> (obuf, <a class="code" href="bgp__dump_8h.html#ad124357d2cf2c7d99d0cb19f228fec15">MSG_PROTOCOL_BGP4MP</a>, <a class="code" href="bgp__dump_8h.html#ace3bfe470f956397bdac00db7747b6e7">BGP4MP_STATE_CHANGE_AS4</a>);
<a name="l00474"></a>00474   <a class="code" href="bgp__dump_8c.html#a4793b761f0d6e7dba96ab4e32ededcaa">bgp_dump_common</a> (obuf, peer, 1);<span class="comment">/* force this in as4speak*/</span>
<a name="l00475"></a>00475 
<a name="l00476"></a>00476   <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a> (obuf, status_old);
<a name="l00477"></a>00477   <a class="code" href="stream_8c.html#a03459a9331e0333d2b396636eca3c2e4">stream_putw</a> (obuf, status_new);
<a name="l00478"></a>00478 
<a name="l00479"></a>00479   <span class="comment">/* Set length. */</span>
<a name="l00480"></a>00480   <a class="code" href="bgp__dump_8c.html#aeea4aaf739360141366d24b3a0a2c32c">bgp_dump_set_size</a> (obuf, <a class="code" href="bgp__dump_8h.html#ad124357d2cf2c7d99d0cb19f228fec15">MSG_PROTOCOL_BGP4MP</a>);
<a name="l00481"></a>00481 
<a name="l00482"></a>00482   <span class="comment">/* Write to the stream. */</span>
<a name="l00483"></a>00483   fwrite (<a class="code" href="stream_8h.html#afde5f5db208a43da6faf7b830f26d7fc">STREAM_DATA</a> (obuf), <a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (obuf), 1, <a class="code" href="bgp__dump_8c.html#a893516e440b8519ca09ed2b808373234">bgp_dump_all</a>.<a class="code" href="structbgp__dump.html#a39e52c350128e7df6c3c1582121be402">fp</a>);
<a name="l00484"></a>00484   fflush (<a class="code" href="bgp__dump_8c.html#a893516e440b8519ca09ed2b808373234">bgp_dump_all</a>.<a class="code" href="structbgp__dump.html#a39e52c350128e7df6c3c1582121be402">fp</a>);
<a name="l00485"></a>00485 }
<a name="l00486"></a>00486 
<a name="l00487"></a>00487 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00488"></a><a class="code" href="bgp__dump_8c.html#a155c4167ced1f77e1e0dbc00395a5744">00488</a> <a class="code" href="bgp__dump_8c.html#a155c4167ced1f77e1e0dbc00395a5744">bgp_dump_packet_func</a> (<span class="keyword">struct</span> <a class="code" href="structbgp__dump.html">bgp_dump</a> *<a class="code" href="structbgp__dump.html">bgp_dump</a>, <span class="keyword">struct</span> <a class="code" href="structpeer.html">peer</a> *<a class="code" href="structpeer.html">peer</a>,
<a name="l00489"></a>00489               <span class="keyword">struct</span> <a class="code" href="structstream.html">stream</a> *packet)
<a name="l00490"></a>00490 {
<a name="l00491"></a>00491   <span class="keyword">struct </span><a class="code" href="structstream.html">stream</a> *obuf;
<a name="l00492"></a>00492 
<a name="l00493"></a>00493   <span class="comment">/* If dump file pointer is disabled return immediately. */</span>
<a name="l00494"></a>00494   <span class="keywordflow">if</span> (bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a39e52c350128e7df6c3c1582121be402">fp</a> == <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00495"></a>00495     <span class="keywordflow">return</span>;
<a name="l00496"></a>00496 
<a name="l00497"></a>00497   <span class="comment">/* Make dump stream. */</span>
<a name="l00498"></a>00498   obuf = <a class="code" href="bgp__dump_8c.html#a1d11a40e549767e660a25317d84233e2">bgp_dump_obuf</a>;
<a name="l00499"></a>00499   <a class="code" href="stream_8c.html#aee8fd31485ebc2f0a556a6a5d5c2d1e6">stream_reset</a> (obuf);
<a name="l00500"></a>00500 
<a name="l00501"></a>00501   <span class="comment">/* Dump header and common part. */</span>
<a name="l00502"></a>00502   <span class="keywordflow">if</span> (<a class="code" href="zebra_8h.html#a9310812ac92febfb7d1eb10127aea1a8">CHECK_FLAG</a> (peer-&gt;<a class="code" href="structpeer.html#a64eadd546a8c50dfe6a6dcb635c3822d">cap</a>, <a class="code" href="bgpd_8h.html#a82052903fe3d209e1216d4ea86b84c6f">PEER_CAP_AS4_RCV</a>) )
<a name="l00503"></a>00503     { 
<a name="l00504"></a>00504       <a class="code" href="bgp__dump_8c.html#ac6384bad2fc6676ba026779420d0fc3e">bgp_dump_header</a> (obuf, <a class="code" href="bgp__dump_8h.html#ad124357d2cf2c7d99d0cb19f228fec15">MSG_PROTOCOL_BGP4MP</a>, <a class="code" href="bgp__dump_8h.html#a09d282b6328f4e8efa7e86cc288630ea">BGP4MP_MESSAGE_AS4</a>);
<a name="l00505"></a>00505     }
<a name="l00506"></a>00506   <span class="keywordflow">else</span>
<a name="l00507"></a>00507     {
<a name="l00508"></a>00508       <a class="code" href="bgp__dump_8c.html#ac6384bad2fc6676ba026779420d0fc3e">bgp_dump_header</a> (obuf, <a class="code" href="bgp__dump_8h.html#ad124357d2cf2c7d99d0cb19f228fec15">MSG_PROTOCOL_BGP4MP</a>, <a class="code" href="bgp__dump_8h.html#a30fa3ac5df0e94803f626704364cf969">BGP4MP_MESSAGE</a>);
<a name="l00509"></a>00509     }
<a name="l00510"></a>00510   <a class="code" href="bgp__dump_8c.html#a4793b761f0d6e7dba96ab4e32ededcaa">bgp_dump_common</a> (obuf, peer, 0);
<a name="l00511"></a>00511 
<a name="l00512"></a>00512   <span class="comment">/* Packet contents. */</span>
<a name="l00513"></a>00513   <a class="code" href="stream_8c.html#a2f540a71efdf46e8c3a923f73e9f3b73">stream_put</a> (obuf, <a class="code" href="stream_8h.html#afde5f5db208a43da6faf7b830f26d7fc">STREAM_DATA</a> (packet), <a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (packet));
<a name="l00514"></a>00514   
<a name="l00515"></a>00515   <span class="comment">/* Set length. */</span>
<a name="l00516"></a>00516   <a class="code" href="bgp__dump_8c.html#aeea4aaf739360141366d24b3a0a2c32c">bgp_dump_set_size</a> (obuf, <a class="code" href="bgp__dump_8h.html#ad124357d2cf2c7d99d0cb19f228fec15">MSG_PROTOCOL_BGP4MP</a>);
<a name="l00517"></a>00517 
<a name="l00518"></a>00518   <span class="comment">/* Write to the stream. */</span>
<a name="l00519"></a>00519   fwrite (<a class="code" href="stream_8h.html#afde5f5db208a43da6faf7b830f26d7fc">STREAM_DATA</a> (obuf), <a class="code" href="stream_8c.html#ac1d2c72755840ea194301a5447ff721a">stream_get_endp</a> (obuf), 1, bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a39e52c350128e7df6c3c1582121be402">fp</a>);
<a name="l00520"></a>00520   fflush (bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a39e52c350128e7df6c3c1582121be402">fp</a>);
<a name="l00521"></a>00521 }
<a name="l00522"></a>00522 
<a name="l00523"></a>00523 <span class="comment">/* Called from bgp_packet.c when BGP packet is received. */</span>
<a name="l00524"></a>00524 <span class="keywordtype">void</span>
<a name="l00525"></a><a class="code" href="bgp__dump_8h.html#a1379116a8413d9c393ee07d7efee638c">00525</a> <a class="code" href="bgp__dump_8c.html#aa97689fd779f7eaaaad6d74bb3ffc837">bgp_dump_packet</a> (<span class="keyword">struct</span> <a class="code" href="structpeer.html">peer</a> *<a class="code" href="structpeer.html">peer</a>, <span class="keywordtype">int</span> <a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a>, <span class="keyword">struct</span> <a class="code" href="structstream.html">stream</a> *packet)
<a name="l00526"></a>00526 {
<a name="l00527"></a>00527   <span class="comment">/* bgp_dump_all. */</span>
<a name="l00528"></a>00528   <a class="code" href="bgp__dump_8c.html#a155c4167ced1f77e1e0dbc00395a5744">bgp_dump_packet_func</a> (&amp;<a class="code" href="bgp__dump_8c.html#a893516e440b8519ca09ed2b808373234">bgp_dump_all</a>, peer, packet);
<a name="l00529"></a>00529 
<a name="l00530"></a>00530   <span class="comment">/* bgp_dump_updates. */</span>
<a name="l00531"></a>00531   <span class="keywordflow">if</span> (type == <a class="code" href="bgpd_8h.html#a295372f9038c0a36cb9622d5d7f5ff7e">BGP_MSG_UPDATE</a>)
<a name="l00532"></a>00532     <a class="code" href="bgp__dump_8c.html#a155c4167ced1f77e1e0dbc00395a5744">bgp_dump_packet_func</a> (&amp;<a class="code" href="bgp__dump_8c.html#aacab64cf07b4180898b9d032bdc5fef7">bgp_dump_updates</a>, peer, packet);
<a name="l00533"></a>00533 }
<a name="l00534"></a>00534 
<a name="l00535"></a>00535 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>
<a name="l00536"></a><a class="code" href="bgp__dump_8c.html#a1165f68741bdba80dc77f0f2027794f4">00536</a> <a class="code" href="bgp__dump_8c.html#a1165f68741bdba80dc77f0f2027794f4">bgp_dump_parse_time</a> (<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="rip__zebra_8c.html#af25d6dc49269fa2003ac7c7fa6f13915">str</a>)
<a name="l00537"></a>00537 {
<a name="l00538"></a>00538   <span class="keywordtype">int</span> <a class="code" href="spgrid_8c.html#a139066bd9e344a8daae82c5ca919fffe">i</a>;
<a name="l00539"></a>00539   <span class="keywordtype">int</span> len;
<a name="l00540"></a>00540   <span class="keywordtype">int</span> seen_h;
<a name="l00541"></a>00541   <span class="keywordtype">int</span> seen_m;
<a name="l00542"></a>00542   <span class="keywordtype">int</span> time;
<a name="l00543"></a>00543   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> total;
<a name="l00544"></a>00544 
<a name="l00545"></a>00545   time = 0;
<a name="l00546"></a>00546   total = 0;
<a name="l00547"></a>00547   seen_h = 0;
<a name="l00548"></a>00548   seen_m = 0;
<a name="l00549"></a>00549   len = strlen (str);
<a name="l00550"></a>00550 
<a name="l00551"></a>00551   <span class="keywordflow">for</span> (i = 0; i &lt; len; i++)
<a name="l00552"></a>00552     {
<a name="l00553"></a>00553       <span class="keywordflow">if</span> (isdigit ((<span class="keywordtype">int</span>) str[i]))
<a name="l00554"></a>00554     {
<a name="l00555"></a>00555       time *= 10;
<a name="l00556"></a>00556       time += str[<a class="code" href="spgrid_8c.html#a139066bd9e344a8daae82c5ca919fffe">i</a>] - <span class="charliteral">&#39;0&#39;</span>;
<a name="l00557"></a>00557     }
<a name="l00558"></a>00558       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (str[i] == <span class="charliteral">&#39;H&#39;</span> || str[i] == <span class="charliteral">&#39;h&#39;</span>)
<a name="l00559"></a>00559     {
<a name="l00560"></a>00560       <span class="keywordflow">if</span> (seen_h)
<a name="l00561"></a>00561         <span class="keywordflow">return</span> 0;
<a name="l00562"></a>00562       <span class="keywordflow">if</span> (seen_m)
<a name="l00563"></a>00563         <span class="keywordflow">return</span> 0;
<a name="l00564"></a>00564       total += time * 60 *60;
<a name="l00565"></a>00565       time = 0;
<a name="l00566"></a>00566       seen_h = 1;
<a name="l00567"></a>00567     }
<a name="l00568"></a>00568       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (str[i] == <span class="charliteral">&#39;M&#39;</span> || str[i] == <span class="charliteral">&#39;m&#39;</span>)
<a name="l00569"></a>00569     {
<a name="l00570"></a>00570       <span class="keywordflow">if</span> (seen_m)
<a name="l00571"></a>00571         <span class="keywordflow">return</span> 0;
<a name="l00572"></a>00572       total += time * 60;
<a name="l00573"></a>00573       time = 0;
<a name="l00574"></a>00574       seen_h = 1;
<a name="l00575"></a>00575     }
<a name="l00576"></a>00576       <span class="keywordflow">else</span>
<a name="l00577"></a>00577     <span class="keywordflow">return</span> 0;
<a name="l00578"></a>00578     }
<a name="l00579"></a>00579   <span class="keywordflow">return</span> total + time;
<a name="l00580"></a>00580 }
<a name="l00581"></a>00581 
<a name="l00582"></a>00582 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00583"></a><a class="code" href="bgp__dump_8c.html#aff02bb19df804283759645e5eda910cc">00583</a> <a class="code" href="bgp__dump_8c.html#aff02bb19df804283759645e5eda910cc">bgp_dump_set</a> (<span class="keyword">struct</span> <a class="code" href="structvty.html">vty</a> *<a class="code" href="structvty.html">vty</a>, <span class="keyword">struct</span> <a class="code" href="structbgp__dump.html">bgp_dump</a> *<a class="code" href="structbgp__dump.html">bgp_dump</a>,
<a name="l00584"></a>00584               <span class="keyword">enum</span> <a class="code" href="bgp__dump_8c.html#af5c4c5c58c06e9e0da028895448608ab">bgp_dump_type</a> <a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *path,
<a name="l00585"></a>00585               <span class="keyword">const</span> <span class="keywordtype">char</span> *interval_str)
<a name="l00586"></a>00586 {
<a name="l00587"></a>00587   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="isis__circuit_8c.html#a900b5f9651c07bafd5d81cc876b93885">interval</a>;
<a name="l00588"></a>00588   
<a name="l00589"></a>00589   <span class="keywordflow">if</span> (interval_str)
<a name="l00590"></a>00590     {
<a name="l00591"></a>00591       
<a name="l00592"></a>00592       <span class="comment">/* Check interval string. */</span>
<a name="l00593"></a>00593       interval = <a class="code" href="bgp__dump_8c.html#a1165f68741bdba80dc77f0f2027794f4">bgp_dump_parse_time</a> (interval_str);
<a name="l00594"></a>00594       <span class="keywordflow">if</span> (interval == 0)
<a name="l00595"></a>00595     {
<a name="l00596"></a>00596       <a class="code" href="vty_8c.html#a3725db0ec6ad3ffdd31f68abc807ee34">vty_out</a> (vty, <span class="stringliteral">&quot;Malformed interval string%s&quot;</span>, <a class="code" href="vty_8h.html#a3be8ca867e2953936a95c68dc64824b6">VTY_NEWLINE</a>);
<a name="l00597"></a>00597       <span class="keywordflow">return</span> <a class="code" href="command_8h.html#a92dc6dc30d8ef3651eb9d47a6083b025">CMD_WARNING</a>;
<a name="l00598"></a>00598     }
<a name="l00599"></a>00599 
<a name="l00600"></a>00600       <span class="comment">/* Don&#39;t schedule duplicate dumps if the dump command is given twice */</span>
<a name="l00601"></a>00601       <span class="keywordflow">if</span> (interval == bgp_dump-&gt;<a class="code" href="structbgp__dump.html#aa47b11c732f512a63663c56976687f18">interval</a> &amp;&amp;
<a name="l00602"></a>00602       type == bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a0a26a007ae667dea94fc4e5cd7cffd37">type</a> &amp;&amp;
<a name="l00603"></a>00603           path &amp;&amp; bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a9b85be4d92c696e0cfdb38d8ca8705c6">filename</a> &amp;&amp; !strcmp (path, bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a9b85be4d92c696e0cfdb38d8ca8705c6">filename</a>))
<a name="l00604"></a>00604     {
<a name="l00605"></a>00605           <span class="keywordflow">return</span> <a class="code" href="command_8h.html#aa2008c1bc36d9ef42571a6ec52516d02">CMD_SUCCESS</a>;
<a name="l00606"></a>00606     }
<a name="l00607"></a>00607 
<a name="l00608"></a>00608       <span class="comment">/* Set interval. */</span>
<a name="l00609"></a>00609       bgp_dump-&gt;<a class="code" href="structbgp__dump.html#aa47b11c732f512a63663c56976687f18">interval</a> = <a class="code" href="isis__circuit_8c.html#a900b5f9651c07bafd5d81cc876b93885">interval</a>;
<a name="l00610"></a>00610       <span class="keywordflow">if</span> (bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a5f69c1d41e0fdafd5ade563b5458045c">interval_str</a>)
<a name="l00611"></a>00611     free (bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a5f69c1d41e0fdafd5ade563b5458045c">interval_str</a>);
<a name="l00612"></a>00612       bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a5f69c1d41e0fdafd5ade563b5458045c">interval_str</a> = strdup (interval_str);
<a name="l00613"></a>00613       
<a name="l00614"></a>00614     }
<a name="l00615"></a>00615   <span class="keywordflow">else</span>
<a name="l00616"></a>00616     {
<a name="l00617"></a>00617       interval = 0;
<a name="l00618"></a>00618     }
<a name="l00619"></a>00619     
<a name="l00620"></a>00620   <span class="comment">/* Create interval thread. */</span>
<a name="l00621"></a>00621   <a class="code" href="bgp__dump_8c.html#a394c2d5e40a37005a6246a168d45cb0e">bgp_dump_interval_add</a> (bgp_dump, interval);
<a name="l00622"></a>00622 
<a name="l00623"></a>00623   <span class="comment">/* Set type. */</span>
<a name="l00624"></a>00624   bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a0a26a007ae667dea94fc4e5cd7cffd37">type</a> = <a class="code" href="bgp__open_8h.html#abbb4c0b967acba158c34c110d81b3ab4">type</a>;
<a name="l00625"></a>00625 
<a name="l00626"></a>00626   <span class="comment">/* Set file name. */</span>
<a name="l00627"></a>00627   <span class="keywordflow">if</span> (bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a9b85be4d92c696e0cfdb38d8ca8705c6">filename</a>)
<a name="l00628"></a>00628     free (bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a9b85be4d92c696e0cfdb38d8ca8705c6">filename</a>);
<a name="l00629"></a>00629   bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a9b85be4d92c696e0cfdb38d8ca8705c6">filename</a> = strdup (path);
<a name="l00630"></a>00630 
<a name="l00631"></a>00631   <span class="comment">/* This should be called when interval is expired. */</span>
<a name="l00632"></a>00632   <a class="code" href="bgp__dump_8c.html#a83a98e4dd07ab8ab3065e9fa4c7cfde5">bgp_dump_open_file</a> (bgp_dump);
<a name="l00633"></a>00633 
<a name="l00634"></a>00634   <span class="keywordflow">return</span> <a class="code" href="command_8h.html#aa2008c1bc36d9ef42571a6ec52516d02">CMD_SUCCESS</a>;
<a name="l00635"></a>00635 }
<a name="l00636"></a>00636 
<a name="l00637"></a>00637 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00638"></a><a class="code" href="bgp__dump_8c.html#a59037b6c33622bac74c406f6b01c955f">00638</a> <a class="code" href="bgp__dump_8c.html#a59037b6c33622bac74c406f6b01c955f">bgp_dump_unset</a> (<span class="keyword">struct</span> <a class="code" href="structvty.html">vty</a> *<a class="code" href="structvty.html">vty</a>, <span class="keyword">struct</span> <a class="code" href="structbgp__dump.html">bgp_dump</a> *<a class="code" href="structbgp__dump.html">bgp_dump</a>)
<a name="l00639"></a>00639 {
<a name="l00640"></a>00640   <span class="comment">/* Set file name. */</span>
<a name="l00641"></a>00641   <span class="keywordflow">if</span> (bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a9b85be4d92c696e0cfdb38d8ca8705c6">filename</a>)
<a name="l00642"></a>00642     {
<a name="l00643"></a>00643       free (bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a9b85be4d92c696e0cfdb38d8ca8705c6">filename</a>);
<a name="l00644"></a>00644       bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a9b85be4d92c696e0cfdb38d8ca8705c6">filename</a> = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00645"></a>00645     }
<a name="l00646"></a>00646 
<a name="l00647"></a>00647   <span class="comment">/* This should be called when interval is expired. */</span>
<a name="l00648"></a>00648   <span class="keywordflow">if</span> (bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a39e52c350128e7df6c3c1582121be402">fp</a>)
<a name="l00649"></a>00649     {
<a name="l00650"></a>00650       fclose (bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a39e52c350128e7df6c3c1582121be402">fp</a>);
<a name="l00651"></a>00651       bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a39e52c350128e7df6c3c1582121be402">fp</a> = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00652"></a>00652     }
<a name="l00653"></a>00653 
<a name="l00654"></a>00654   <span class="comment">/* Create interval thread. */</span>
<a name="l00655"></a>00655   <span class="keywordflow">if</span> (bgp_dump-&gt;<a class="code" href="structbgp__dump.html#abf41ec887f001277014534e163588475">t_interval</a>)
<a name="l00656"></a>00656     {
<a name="l00657"></a>00657       <a class="code" href="thread_8c.html#aceb89c1157b6a1d8bb3afa5021f1ab6d">thread_cancel</a> (bgp_dump-&gt;<a class="code" href="structbgp__dump.html#abf41ec887f001277014534e163588475">t_interval</a>);
<a name="l00658"></a>00658       bgp_dump-&gt;<a class="code" href="structbgp__dump.html#abf41ec887f001277014534e163588475">t_interval</a> = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00659"></a>00659     }
<a name="l00660"></a>00660 
<a name="l00661"></a>00661   bgp_dump-&gt;<a class="code" href="structbgp__dump.html#aa47b11c732f512a63663c56976687f18">interval</a> = 0;
<a name="l00662"></a>00662 
<a name="l00663"></a>00663   <span class="keywordflow">if</span> (bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a5f69c1d41e0fdafd5ade563b5458045c">interval_str</a>)
<a name="l00664"></a>00664     {
<a name="l00665"></a>00665       free (bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a5f69c1d41e0fdafd5ade563b5458045c">interval_str</a>);
<a name="l00666"></a>00666       bgp_dump-&gt;<a class="code" href="structbgp__dump.html#a5f69c1d41e0fdafd5ade563b5458045c">interval_str</a> = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00667"></a>00667     }
<a name="l00668"></a>00668   
<a name="l00669"></a>00669 
<a name="l00670"></a>00670   <span class="keywordflow">return</span> <a class="code" href="command_8h.html#aa2008c1bc36d9ef42571a6ec52516d02">CMD_SUCCESS</a>;
<a name="l00671"></a>00671 }
<a name="l00672"></a>00672 
<a name="l00673"></a><a class="code" href="bgp__dump_8c.html#a6123815185ba65e14fdf131ba719e12c">00673</a> <a class="code" href="command_8h.html#acc29190d35966eddbcfeceed3aab6d25">DEFUN</a> (dump_bgp_all,
<a name="l00674"></a>00674        dump_bgp_all_cmd,
<a name="l00675"></a>00675        <span class="stringliteral">&quot;dump bgp all PATH&quot;</span>,
<a name="l00676"></a>00676        <span class="stringliteral">&quot;Dump packet\n&quot;</span>
<a name="l00677"></a>00677        <span class="stringliteral">&quot;BGP packet dump\n&quot;</span>
<a name="l00678"></a>00678        <span class="stringliteral">&quot;Dump all BGP packets\n&quot;</span>
<a name="l00679"></a>00679        <span class="stringliteral">&quot;Output filename\n&quot;</span>)
<a name="l00680"></a>00680 {
<a name="l00681"></a>00681   <span class="keywordflow">return</span> <a class="code" href="bgp__dump_8c.html#aff02bb19df804283759645e5eda910cc">bgp_dump_set</a> (<a class="code" href="structvty.html">vty</a>, &amp;<a class="code" href="bgp__dump_8c.html#a893516e440b8519ca09ed2b808373234">bgp_dump_all</a>, <a class="code" href="bgp__dump_8c.html#af5c4c5c58c06e9e0da028895448608abad3ea5d7423efba6d550de303f4c535bd">BGP_DUMP_ALL</a>, argv[0], <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00682"></a>00682 }
<a name="l00683"></a>00683 
<a name="l00684"></a><a class="code" href="bgp__dump_8c.html#a33dd7b4f47fada217342aee6127150f0">00684</a> <a class="code" href="command_8h.html#acc29190d35966eddbcfeceed3aab6d25">DEFUN</a> (dump_bgp_all_interval,
<a name="l00685"></a>00685        dump_bgp_all_interval_cmd,
<a name="l00686"></a>00686        <span class="stringliteral">&quot;dump bgp all PATH INTERVAL&quot;</span>,
<a name="l00687"></a>00687        <span class="stringliteral">&quot;Dump packet\n&quot;</span>
<a name="l00688"></a>00688        <span class="stringliteral">&quot;BGP packet dump\n&quot;</span>
<a name="l00689"></a>00689        <span class="stringliteral">&quot;Dump all BGP packets\n&quot;</span>
<a name="l00690"></a>00690        <span class="stringliteral">&quot;Output filename\n&quot;</span>
<a name="l00691"></a>00691        <span class="stringliteral">&quot;Interval of output\n&quot;</span>)
<a name="l00692"></a>00692 {
<a name="l00693"></a>00693   <span class="keywordflow">return</span> <a class="code" href="bgp__dump_8c.html#aff02bb19df804283759645e5eda910cc">bgp_dump_set</a> (<a class="code" href="structvty.html">vty</a>, &amp;<a class="code" href="bgp__dump_8c.html#a893516e440b8519ca09ed2b808373234">bgp_dump_all</a>, <a class="code" href="bgp__dump_8c.html#af5c4c5c58c06e9e0da028895448608abad3ea5d7423efba6d550de303f4c535bd">BGP_DUMP_ALL</a>, argv[0], argv[1]);
<a name="l00694"></a>00694 }
<a name="l00695"></a>00695 
<a name="l00696"></a><a class="code" href="bgp__dump_8c.html#ad346163ef8df1fd4f257a4b349a50b81">00696</a> <a class="code" href="command_8h.html#acc29190d35966eddbcfeceed3aab6d25">DEFUN</a> (no_dump_bgp_all,
<a name="l00697"></a>00697        no_dump_bgp_all_cmd,
<a name="l00698"></a>00698        <span class="stringliteral">&quot;no dump bgp all [PATH] [INTERVAL]&quot;</span>,
<a name="l00699"></a>00699        <a class="code" href="command_8h.html#a5b14384572729c1d1b3755d1bea1f17d">NO_STR</a>
<a name="l00700"></a>00700        <span class="stringliteral">&quot;Dump packet\n&quot;</span>
<a name="l00701"></a>00701        <span class="stringliteral">&quot;BGP packet dump\n&quot;</span>
<a name="l00702"></a>00702        <span class="stringliteral">&quot;Dump all BGP packets\n&quot;</span>)
<a name="l00703"></a>00703 {
<a name="l00704"></a>00704   <span class="keywordflow">return</span> <a class="code" href="bgp__dump_8c.html#a59037b6c33622bac74c406f6b01c955f">bgp_dump_unset</a> (<a class="code" href="structvty.html">vty</a>, &amp;<a class="code" href="bgp__dump_8c.html#a893516e440b8519ca09ed2b808373234">bgp_dump_all</a>);
<a name="l00705"></a>00705 }
<a name="l00706"></a>00706 
<a name="l00707"></a><a class="code" href="bgp__dump_8c.html#af051666167a337659d4415ad3e25b57a">00707</a> <a class="code" href="command_8h.html#acc29190d35966eddbcfeceed3aab6d25">DEFUN</a> (dump_bgp_updates,
<a name="l00708"></a>00708        dump_bgp_updates_cmd,
<a name="l00709"></a>00709        <span class="stringliteral">&quot;dump bgp updates PATH&quot;</span>,
<a name="l00710"></a>00710        <span class="stringliteral">&quot;Dump packet\n&quot;</span>
<a name="l00711"></a>00711        <span class="stringliteral">&quot;BGP packet dump\n&quot;</span>
<a name="l00712"></a>00712        <span class="stringliteral">&quot;Dump BGP updates only\n&quot;</span>
<a name="l00713"></a>00713        <span class="stringliteral">&quot;Output filename\n&quot;</span>)
<a name="l00714"></a>00714 {
<a name="l00715"></a>00715   <span class="keywordflow">return</span> <a class="code" href="bgp__dump_8c.html#aff02bb19df804283759645e5eda910cc">bgp_dump_set</a> (<a class="code" href="structvty.html">vty</a>, &amp;<a class="code" href="bgp__dump_8c.html#aacab64cf07b4180898b9d032bdc5fef7">bgp_dump_updates</a>, <a class="code" href="bgp__dump_8c.html#af5c4c5c58c06e9e0da028895448608abad4305596c9de6b42129a894800dc2a4b">BGP_DUMP_UPDATES</a>, argv[0], <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00716"></a>00716 }
<a name="l00717"></a>00717 
<a name="l00718"></a><a class="code" href="bgp__dump_8c.html#a1f5f4445c659a139e1240b4be5798198">00718</a> <a class="code" href="command_8h.html#acc29190d35966eddbcfeceed3aab6d25">DEFUN</a> (dump_bgp_updates_interval,
<a name="l00719"></a>00719        dump_bgp_updates_interval_cmd,
<a name="l00720"></a>00720        <span class="stringliteral">&quot;dump bgp updates PATH INTERVAL&quot;</span>,
<a name="l00721"></a>00721        <span class="stringliteral">&quot;Dump packet\n&quot;</span>
<a name="l00722"></a>00722        <span class="stringliteral">&quot;BGP packet dump\n&quot;</span>
<a name="l00723"></a>00723        <span class="stringliteral">&quot;Dump BGP updates only\n&quot;</span>
<a name="l00724"></a>00724        <span class="stringliteral">&quot;Output filename\n&quot;</span>
<a name="l00725"></a>00725        <span class="stringliteral">&quot;Interval of output\n&quot;</span>)
<a name="l00726"></a>00726 {
<a name="l00727"></a>00727   <span class="keywordflow">return</span> <a class="code" href="bgp__dump_8c.html#aff02bb19df804283759645e5eda910cc">bgp_dump_set</a> (<a class="code" href="structvty.html">vty</a>, &amp;<a class="code" href="bgp__dump_8c.html#aacab64cf07b4180898b9d032bdc5fef7">bgp_dump_updates</a>, <a class="code" href="bgp__dump_8c.html#af5c4c5c58c06e9e0da028895448608abad4305596c9de6b42129a894800dc2a4b">BGP_DUMP_UPDATES</a>, argv[0], argv[1]);
<a name="l00728"></a>00728 }
<a name="l00729"></a>00729 
<a name="l00730"></a><a class="code" href="bgp__dump_8c.html#aa3dd1c3f62b82fc9cdf584eff62da4e6">00730</a> <a class="code" href="command_8h.html#acc29190d35966eddbcfeceed3aab6d25">DEFUN</a> (no_dump_bgp_updates,
<a name="l00731"></a>00731        no_dump_bgp_updates_cmd,
<a name="l00732"></a>00732        <span class="stringliteral">&quot;no dump bgp updates [PATH] [INTERVAL]&quot;</span>,
<a name="l00733"></a>00733        <a class="code" href="command_8h.html#a5b14384572729c1d1b3755d1bea1f17d">NO_STR</a>
<a name="l00734"></a>00734        <span class="stringliteral">&quot;Dump packet\n&quot;</span>
<a name="l00735"></a>00735        <span class="stringliteral">&quot;BGP packet dump\n&quot;</span>
<a name="l00736"></a>00736        <span class="stringliteral">&quot;Dump BGP updates only\n&quot;</span>)
<a name="l00737"></a>00737 {
<a name="l00738"></a>00738   <span class="keywordflow">return</span> <a class="code" href="bgp__dump_8c.html#a59037b6c33622bac74c406f6b01c955f">bgp_dump_unset</a> (<a class="code" href="structvty.html">vty</a>, &amp;<a class="code" href="bgp__dump_8c.html#aacab64cf07b4180898b9d032bdc5fef7">bgp_dump_updates</a>);
<a name="l00739"></a>00739 }
<a name="l00740"></a>00740 
<a name="l00741"></a><a class="code" href="bgp__dump_8c.html#a467f5bf35144c7f819157199fc0a5641">00741</a> <a class="code" href="command_8h.html#acc29190d35966eddbcfeceed3aab6d25">DEFUN</a> (dump_bgp_routes,
<a name="l00742"></a>00742        dump_bgp_routes_cmd,
<a name="l00743"></a>00743        <span class="stringliteral">&quot;dump bgp routes-mrt PATH&quot;</span>,
<a name="l00744"></a>00744        <span class="stringliteral">&quot;Dump packet\n&quot;</span>
<a name="l00745"></a>00745        <span class="stringliteral">&quot;BGP packet dump\n&quot;</span>
<a name="l00746"></a>00746        <span class="stringliteral">&quot;Dump whole BGP routing table\n&quot;</span>
<a name="l00747"></a>00747        <span class="stringliteral">&quot;Output filename\n&quot;</span>)
<a name="l00748"></a>00748 {
<a name="l00749"></a>00749   <span class="keywordflow">return</span> <a class="code" href="bgp__dump_8c.html#aff02bb19df804283759645e5eda910cc">bgp_dump_set</a> (<a class="code" href="structvty.html">vty</a>, &amp;<a class="code" href="bgp__dump_8c.html#a7b4b628fda6c31730228e04aacd18e5b">bgp_dump_routes</a>, <a class="code" href="bgp__dump_8c.html#af5c4c5c58c06e9e0da028895448608aba8da7006d79a833ea2d2d60d3c0f44ecd">BGP_DUMP_ROUTES</a>, argv[0], <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00750"></a>00750 }
<a name="l00751"></a>00751 
<a name="l00752"></a><a class="code" href="bgp__dump_8c.html#a79d20719255900af67da91992eee9739">00752</a> <a class="code" href="command_8h.html#acc29190d35966eddbcfeceed3aab6d25">DEFUN</a> (dump_bgp_routes_interval,
<a name="l00753"></a>00753        dump_bgp_routes_interval_cmd,
<a name="l00754"></a>00754        <span class="stringliteral">&quot;dump bgp routes-mrt PATH INTERVAL&quot;</span>,
<a name="l00755"></a>00755        <span class="stringliteral">&quot;Dump packet\n&quot;</span>
<a name="l00756"></a>00756        <span class="stringliteral">&quot;BGP packet dump\n&quot;</span>
<a name="l00757"></a>00757        <span class="stringliteral">&quot;Dump whole BGP routing table\n&quot;</span>
<a name="l00758"></a>00758        <span class="stringliteral">&quot;Output filename\n&quot;</span>
<a name="l00759"></a>00759        <span class="stringliteral">&quot;Interval of output\n&quot;</span>)
<a name="l00760"></a>00760 {
<a name="l00761"></a>00761   <span class="keywordflow">return</span> <a class="code" href="bgp__dump_8c.html#aff02bb19df804283759645e5eda910cc">bgp_dump_set</a> (<a class="code" href="structvty.html">vty</a>, &amp;<a class="code" href="bgp__dump_8c.html#a7b4b628fda6c31730228e04aacd18e5b">bgp_dump_routes</a>, <a class="code" href="bgp__dump_8c.html#af5c4c5c58c06e9e0da028895448608aba8da7006d79a833ea2d2d60d3c0f44ecd">BGP_DUMP_ROUTES</a>, argv[0], argv[1]);
<a name="l00762"></a>00762 }
<a name="l00763"></a>00763 
<a name="l00764"></a><a class="code" href="bgp__dump_8c.html#a70c826ae3c03c440f2cccad7dbb99f2e">00764</a> <a class="code" href="command_8h.html#acc29190d35966eddbcfeceed3aab6d25">DEFUN</a> (no_dump_bgp_routes,
<a name="l00765"></a>00765        no_dump_bgp_routes_cmd,
<a name="l00766"></a>00766        <span class="stringliteral">&quot;no dump bgp routes-mrt [PATH] [INTERVAL]&quot;</span>,
<a name="l00767"></a>00767        <a class="code" href="command_8h.html#a5b14384572729c1d1b3755d1bea1f17d">NO_STR</a>
<a name="l00768"></a>00768        <span class="stringliteral">&quot;Dump packet\n&quot;</span>
<a name="l00769"></a>00769        <span class="stringliteral">&quot;BGP packet dump\n&quot;</span>
<a name="l00770"></a>00770        <span class="stringliteral">&quot;Dump whole BGP routing table\n&quot;</span>)
<a name="l00771"></a>00771 {
<a name="l00772"></a>00772   <span class="keywordflow">return</span> <a class="code" href="bgp__dump_8c.html#a59037b6c33622bac74c406f6b01c955f">bgp_dump_unset</a> (<a class="code" href="structvty.html">vty</a>, &amp;<a class="code" href="bgp__dump_8c.html#a7b4b628fda6c31730228e04aacd18e5b">bgp_dump_routes</a>);
<a name="l00773"></a>00773 }
<a name="l00774"></a>00774 
<a name="l00775"></a>00775 <span class="comment">/* BGP node structure. */</span>
<a name="l00776"></a><a class="code" href="bgp__dump_8c.html#adb205c2384f08bce1d15368029538232">00776</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structcmd__node.html">cmd_node</a> <a class="code" href="bgp__dump_8c.html#adb205c2384f08bce1d15368029538232">bgp_dump_node</a> =
<a name="l00777"></a>00777 {
<a name="l00778"></a>00778   <a class="code" href="command_8h.html#a6a276b85e2da28c5f9c3dbce61c55682aae9c95dff07c83c8e7bf4791a9bae0a6">DUMP_NODE</a>,
<a name="l00779"></a>00779   <span class="stringliteral">&quot;&quot;</span>,
<a name="l00780"></a>00780   1
<a name="l00781"></a>00781 };
<a name="l00782"></a>00782 
<a name="l00783"></a>00783 <span class="preprocessor">#if 0</span>
<a name="l00784"></a>00784 <span class="preprocessor"></span><span class="keywordtype">char</span> *
<a name="l00785"></a>00785 config_time2str (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="isis__circuit_8c.html#a900b5f9651c07bafd5d81cc876b93885">interval</a>)
<a name="l00786"></a>00786 {
<a name="l00787"></a>00787   <span class="keyword">static</span> <span class="keywordtype">char</span> buf[BUFSIZ];
<a name="l00788"></a>00788 
<a name="l00789"></a>00789   buf[0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00790"></a>00790 
<a name="l00791"></a>00791   <span class="keywordflow">if</span> (interval / 3600)
<a name="l00792"></a>00792     {
<a name="l00793"></a>00793       sprintf (buf, <span class="stringliteral">&quot;%dh&quot;</span>, interval / 3600);
<a name="l00794"></a>00794       interval %= 3600;
<a name="l00795"></a>00795     }
<a name="l00796"></a>00796   <span class="keywordflow">if</span> (interval / 60)
<a name="l00797"></a>00797     {
<a name="l00798"></a>00798       sprintf (buf + strlen (buf), <span class="stringliteral">&quot;%dm&quot;</span>, interval /60);
<a name="l00799"></a>00799       interval %= 60;
<a name="l00800"></a>00800     }
<a name="l00801"></a>00801   <span class="keywordflow">if</span> (interval)
<a name="l00802"></a>00802     {
<a name="l00803"></a>00803       sprintf (buf + strlen (buf), <span class="stringliteral">&quot;%d&quot;</span>, interval);
<a name="l00804"></a>00804     }
<a name="l00805"></a>00805   <span class="keywordflow">return</span> buf;
<a name="l00806"></a>00806 }
<a name="l00807"></a>00807 <span class="preprocessor">#endif</span>
<a name="l00808"></a>00808 <span class="preprocessor"></span>
<a name="l00809"></a>00809 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00810"></a><a class="code" href="bgp__dump_8c.html#a38ab48bf42d33009c6320fbcb6936a23">00810</a> <a class="code" href="bgp__dump_8c.html#a38ab48bf42d33009c6320fbcb6936a23">config_write_bgp_dump</a> (<span class="keyword">struct</span> <a class="code" href="structvty.html">vty</a> *<a class="code" href="structvty.html">vty</a>)
<a name="l00811"></a>00811 {
<a name="l00812"></a>00812   <span class="keywordflow">if</span> (<a class="code" href="bgp__dump_8c.html#a893516e440b8519ca09ed2b808373234">bgp_dump_all</a>.<a class="code" href="structbgp__dump.html#a9b85be4d92c696e0cfdb38d8ca8705c6">filename</a>)
<a name="l00813"></a>00813     {
<a name="l00814"></a>00814       <span class="keywordflow">if</span> (<a class="code" href="bgp__dump_8c.html#a893516e440b8519ca09ed2b808373234">bgp_dump_all</a>.<a class="code" href="structbgp__dump.html#a5f69c1d41e0fdafd5ade563b5458045c">interval_str</a>)
<a name="l00815"></a>00815     <a class="code" href="vty_8c.html#a3725db0ec6ad3ffdd31f68abc807ee34">vty_out</a> (vty, <span class="stringliteral">&quot;dump bgp all %s %s%s&quot;</span>, 
<a name="l00816"></a>00816          <a class="code" href="bgp__dump_8c.html#a893516e440b8519ca09ed2b808373234">bgp_dump_all</a>.<a class="code" href="structbgp__dump.html#a9b85be4d92c696e0cfdb38d8ca8705c6">filename</a>, <a class="code" href="bgp__dump_8c.html#a893516e440b8519ca09ed2b808373234">bgp_dump_all</a>.<a class="code" href="structbgp__dump.html#a5f69c1d41e0fdafd5ade563b5458045c">interval_str</a>,
<a name="l00817"></a>00817          <a class="code" href="vty_8h.html#a3be8ca867e2953936a95c68dc64824b6">VTY_NEWLINE</a>);
<a name="l00818"></a>00818       <span class="keywordflow">else</span>
<a name="l00819"></a>00819     <a class="code" href="vty_8c.html#a3725db0ec6ad3ffdd31f68abc807ee34">vty_out</a> (vty, <span class="stringliteral">&quot;dump bgp all %s%s&quot;</span>, 
<a name="l00820"></a>00820          <a class="code" href="bgp__dump_8c.html#a893516e440b8519ca09ed2b808373234">bgp_dump_all</a>.<a class="code" href="structbgp__dump.html#a9b85be4d92c696e0cfdb38d8ca8705c6">filename</a>, <a class="code" href="vty_8h.html#a3be8ca867e2953936a95c68dc64824b6">VTY_NEWLINE</a>);
<a name="l00821"></a>00821     }
<a name="l00822"></a>00822   <span class="keywordflow">if</span> (<a class="code" href="bgp__dump_8c.html#aacab64cf07b4180898b9d032bdc5fef7">bgp_dump_updates</a>.<a class="code" href="structbgp__dump.html#a9b85be4d92c696e0cfdb38d8ca8705c6">filename</a>)
<a name="l00823"></a>00823     {
<a name="l00824"></a>00824       <span class="keywordflow">if</span> (<a class="code" href="bgp__dump_8c.html#aacab64cf07b4180898b9d032bdc5fef7">bgp_dump_updates</a>.<a class="code" href="structbgp__dump.html#a5f69c1d41e0fdafd5ade563b5458045c">interval_str</a>)
<a name="l00825"></a>00825     <a class="code" href="vty_8c.html#a3725db0ec6ad3ffdd31f68abc807ee34">vty_out</a> (vty, <span class="stringliteral">&quot;dump bgp updates %s %s%s&quot;</span>, 
<a name="l00826"></a>00826          <a class="code" href="bgp__dump_8c.html#aacab64cf07b4180898b9d032bdc5fef7">bgp_dump_updates</a>.<a class="code" href="structbgp__dump.html#a9b85be4d92c696e0cfdb38d8ca8705c6">filename</a>, <a class="code" href="bgp__dump_8c.html#aacab64cf07b4180898b9d032bdc5fef7">bgp_dump_updates</a>.<a class="code" href="structbgp__dump.html#a5f69c1d41e0fdafd5ade563b5458045c">interval_str</a>,
<a name="l00827"></a>00827          <a class="code" href="vty_8h.html#a3be8ca867e2953936a95c68dc64824b6">VTY_NEWLINE</a>);
<a name="l00828"></a>00828       <span class="keywordflow">else</span>
<a name="l00829"></a>00829     <a class="code" href="vty_8c.html#a3725db0ec6ad3ffdd31f68abc807ee34">vty_out</a> (vty, <span class="stringliteral">&quot;dump bgp updates %s%s&quot;</span>, 
<a name="l00830"></a>00830          <a class="code" href="bgp__dump_8c.html#aacab64cf07b4180898b9d032bdc5fef7">bgp_dump_updates</a>.<a class="code" href="structbgp__dump.html#a9b85be4d92c696e0cfdb38d8ca8705c6">filename</a>, <a class="code" href="vty_8h.html#a3be8ca867e2953936a95c68dc64824b6">VTY_NEWLINE</a>);
<a name="l00831"></a>00831     }
<a name="l00832"></a>00832   <span class="keywordflow">if</span> (<a class="code" href="bgp__dump_8c.html#a7b4b628fda6c31730228e04aacd18e5b">bgp_dump_routes</a>.<a class="code" href="structbgp__dump.html#a9b85be4d92c696e0cfdb38d8ca8705c6">filename</a>)
<a name="l00833"></a>00833     {
<a name="l00834"></a>00834       <span class="keywordflow">if</span> (<a class="code" href="bgp__dump_8c.html#a7b4b628fda6c31730228e04aacd18e5b">bgp_dump_routes</a>.<a class="code" href="structbgp__dump.html#a5f69c1d41e0fdafd5ade563b5458045c">interval_str</a>)
<a name="l00835"></a>00835     <a class="code" href="vty_8c.html#a3725db0ec6ad3ffdd31f68abc807ee34">vty_out</a> (vty, <span class="stringliteral">&quot;dump bgp routes-mrt %s %s%s&quot;</span>, 
<a name="l00836"></a>00836          <a class="code" href="bgp__dump_8c.html#a7b4b628fda6c31730228e04aacd18e5b">bgp_dump_routes</a>.<a class="code" href="structbgp__dump.html#a9b85be4d92c696e0cfdb38d8ca8705c6">filename</a>, <a class="code" href="bgp__dump_8c.html#a7b4b628fda6c31730228e04aacd18e5b">bgp_dump_routes</a>.<a class="code" href="structbgp__dump.html#a5f69c1d41e0fdafd5ade563b5458045c">interval_str</a>,
<a name="l00837"></a>00837          <a class="code" href="vty_8h.html#a3be8ca867e2953936a95c68dc64824b6">VTY_NEWLINE</a>);
<a name="l00838"></a>00838       <span class="keywordflow">else</span>
<a name="l00839"></a>00839     <a class="code" href="vty_8c.html#a3725db0ec6ad3ffdd31f68abc807ee34">vty_out</a> (vty, <span class="stringliteral">&quot;dump bgp routes-mrt %s%s&quot;</span>, 
<a name="l00840"></a>00840          <a class="code" href="bgp__dump_8c.html#a7b4b628fda6c31730228e04aacd18e5b">bgp_dump_routes</a>.<a class="code" href="structbgp__dump.html#a9b85be4d92c696e0cfdb38d8ca8705c6">filename</a>, <a class="code" href="vty_8h.html#a3be8ca867e2953936a95c68dc64824b6">VTY_NEWLINE</a>);
<a name="l00841"></a>00841     }
<a name="l00842"></a>00842   <span class="keywordflow">return</span> 0;
<a name="l00843"></a>00843 }
<a name="l00844"></a>00844 
<a name="l00845"></a>00845 <span class="comment">/* Initialize BGP packet dump functionality. */</span>
<a name="l00846"></a>00846 <span class="keywordtype">void</span>
<a name="l00847"></a><a class="code" href="bgp__dump_8h.html#afa613c770fb199232be285cb5061f765">00847</a> <a class="code" href="bgp__dump_8c.html#afa613c770fb199232be285cb5061f765">bgp_dump_init</a> (<span class="keywordtype">void</span>)
<a name="l00848"></a>00848 {
<a name="l00849"></a>00849   memset (&amp;<a class="code" href="bgp__dump_8c.html#a893516e440b8519ca09ed2b808373234">bgp_dump_all</a>, 0, <span class="keyword">sizeof</span> (<span class="keyword">struct</span> <a class="code" href="structbgp__dump.html">bgp_dump</a>));
<a name="l00850"></a>00850   memset (&amp;<a class="code" href="bgp__dump_8c.html#aacab64cf07b4180898b9d032bdc5fef7">bgp_dump_updates</a>, 0, <span class="keyword">sizeof</span> (<span class="keyword">struct</span> <a class="code" href="structbgp__dump.html">bgp_dump</a>));
<a name="l00851"></a>00851   memset (&amp;<a class="code" href="bgp__dump_8c.html#a7b4b628fda6c31730228e04aacd18e5b">bgp_dump_routes</a>, 0, <span class="keyword">sizeof</span> (<span class="keyword">struct</span> <a class="code" href="structbgp__dump.html">bgp_dump</a>));
<a name="l00852"></a>00852 
<a name="l00853"></a>00853   bgp_dump_obuf = <a class="code" href="stream_8c.html#a7117cdad9fa5e5ae633e0cf08d047459">stream_new</a> (<a class="code" href="bgpd_8h.html#a87f2b928735fc26743eecf3ff55c065f">BGP_MAX_PACKET_SIZE</a> + <a class="code" href="bgp__dump_8h.html#abdf8e79afefff2a371634fcbd788b1df">BGP_DUMP_MSG_HEADER</a>
<a name="l00854"></a>00854                               + <a class="code" href="bgp__dump_8h.html#ac06b815d8ee149eee8c8891d61222104">BGP_DUMP_HEADER_SIZE</a>);
<a name="l00855"></a>00855 
<a name="l00856"></a>00856   <a class="code" href="command_8c.html#a7ee8a7c258e1e5a6e3ff6173dd1658e3">install_node</a> (&amp;bgp_dump_node, <a class="code" href="bgp__dump_8c.html#a38ab48bf42d33009c6320fbcb6936a23">config_write_bgp_dump</a>);
<a name="l00857"></a>00857 
<a name="l00858"></a>00858   <a class="code" href="command_8c.html#af8546e314a1538d53ef78e4b02804f40">install_element</a> (<a class="code" href="command_8h.html#a6a276b85e2da28c5f9c3dbce61c55682a50754044f565f7421a152eaa411eebcc">CONFIG_NODE</a>, &amp;dump_bgp_all_cmd);
<a name="l00859"></a>00859   <a class="code" href="command_8c.html#af8546e314a1538d53ef78e4b02804f40">install_element</a> (<a class="code" href="command_8h.html#a6a276b85e2da28c5f9c3dbce61c55682a50754044f565f7421a152eaa411eebcc">CONFIG_NODE</a>, &amp;dump_bgp_all_interval_cmd);
<a name="l00860"></a>00860   <a class="code" href="command_8c.html#af8546e314a1538d53ef78e4b02804f40">install_element</a> (<a class="code" href="command_8h.html#a6a276b85e2da28c5f9c3dbce61c55682a50754044f565f7421a152eaa411eebcc">CONFIG_NODE</a>, &amp;no_dump_bgp_all_cmd);
<a name="l00861"></a>00861   <a class="code" href="command_8c.html#af8546e314a1538d53ef78e4b02804f40">install_element</a> (<a class="code" href="command_8h.html#a6a276b85e2da28c5f9c3dbce61c55682a50754044f565f7421a152eaa411eebcc">CONFIG_NODE</a>, &amp;dump_bgp_updates_cmd);
<a name="l00862"></a>00862   <a class="code" href="command_8c.html#af8546e314a1538d53ef78e4b02804f40">install_element</a> (<a class="code" href="command_8h.html#a6a276b85e2da28c5f9c3dbce61c55682a50754044f565f7421a152eaa411eebcc">CONFIG_NODE</a>, &amp;dump_bgp_updates_interval_cmd);
<a name="l00863"></a>00863   <a class="code" href="command_8c.html#af8546e314a1538d53ef78e4b02804f40">install_element</a> (<a class="code" href="command_8h.html#a6a276b85e2da28c5f9c3dbce61c55682a50754044f565f7421a152eaa411eebcc">CONFIG_NODE</a>, &amp;no_dump_bgp_updates_cmd);
<a name="l00864"></a>00864   <a class="code" href="command_8c.html#af8546e314a1538d53ef78e4b02804f40">install_element</a> (<a class="code" href="command_8h.html#a6a276b85e2da28c5f9c3dbce61c55682a50754044f565f7421a152eaa411eebcc">CONFIG_NODE</a>, &amp;dump_bgp_routes_cmd);
<a name="l00865"></a>00865   <a class="code" href="command_8c.html#af8546e314a1538d53ef78e4b02804f40">install_element</a> (<a class="code" href="command_8h.html#a6a276b85e2da28c5f9c3dbce61c55682a50754044f565f7421a152eaa411eebcc">CONFIG_NODE</a>, &amp;dump_bgp_routes_interval_cmd);
<a name="l00866"></a>00866   <a class="code" href="command_8c.html#af8546e314a1538d53ef78e4b02804f40">install_element</a> (<a class="code" href="command_8h.html#a6a276b85e2da28c5f9c3dbce61c55682a50754044f565f7421a152eaa411eebcc">CONFIG_NODE</a>, &amp;no_dump_bgp_routes_cmd);
<a name="l00867"></a>00867 }
<a name="l00868"></a>00868 
<a name="l00869"></a>00869 <span class="keywordtype">void</span>
<a name="l00870"></a><a class="code" href="bgp__dump_8h.html#a9011f2abe3c40483e04714cc3189475e">00870</a> <a class="code" href="bgp__dump_8c.html#a9011f2abe3c40483e04714cc3189475e">bgp_dump_finish</a> (<span class="keywordtype">void</span>)
<a name="l00871"></a>00871 {
<a name="l00872"></a>00872   <a class="code" href="stream_8c.html#ac25ca0f9b32a76b4ea34ecb3c9d62481">stream_free</a> (bgp_dump_obuf);
<a name="l00873"></a>00873   bgp_dump_obuf = <a class="code" href="getopt1_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00874"></a>00874 }
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="bgp__dump_8c.html">bgp_dump.c</a>      </li>

    <li class="footer">Generated on Tue Apr 24 2012 10:41:02 for OSPFN by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.5.1 </li>
   </ul>
 </div>


</body>
</html>
